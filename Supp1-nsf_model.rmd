---
title: "Supplementary 1 - Data preparation"
author: "Camille M. Crapart"
date: "29 9 2021"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, error = F, fig.align = "center", collapse = T)
options(knitr.kable.NA="", knitr.table.format = "html")
```

```{r libraries}
library(DBI)
library(sf)
library(dplyr)
library(gimms)
library(raster)

library(ncdf4)
library(rgdal)

library(stringr)
library(ggplot2)
library(cowplot)
library(spdep)
library(tibble)

library(kableExtra)

source("f_plotspatial.R")
```

```{r function-effect-size}
compute.effect.size <- function(df.coef){

df.es <- df.coef[,1:3]
n <- length(df.es$Parameter)
m <- df.es$Parameter


for(i in 1:n){
  if(grepl("log",m[i])==T){
    df.es[i,2] <- 1.01^(df.coef[i,2])
    df.es[i,3] <- 1.01^(df.coef[i,2])*log(1.01)*df.coef[i,3]
  }else if(m[i] %in% c("NDVI","Bog","Arable","Forest","Temp")){
    df.es[i,2] <- exp(df.coef[i,2]*0.01)
    df.es[i,3] <- 0.01*df.coef[i,2]*df.coef[i,3]
  }else if(m[i] %in% c("TNdep","TSdep")){
    df.es[i,2] <- exp(df.coef[i,2]*25)
    df.es[i,3] <- 25*exp(df.coef[i,2]*25)*df.coef[i,3]
  } else {
    df.es[i,2] <- exp(df.coef) # effect size for temperature???
  }
}

df.es$Percent <- 100*(df.es$Estimate-1)

return(df.es)

}

# other es
eslog <- 1.01
es <- 0.01
```

```{r fig-num-function}
library(captioner)
fig_nums <- captioner() 
table_nums <- captioner(prefix = "Table")
```

# Catchment data for Norway, Sweden and Finland


## Catchment polygons

The catchment and TOC data are stored on the PostgreSQL database ecco_biwa, accessed through Rstudio using the st_read function (sf package @Pebesma2021) and the dplyr package @Wickhman2021. 
Each catchment polygon is linked to the corresponding TOC concentration via an "ebint" (identifyer), internal to the ecco_biwa database.

The catchment polygons were designed by an elevation model and are assigned to the studied lake based on the distance to the sampling coordinates.


```{r load-data, eval = F}
con <- dbConnect(RPostgreSQL::PostgreSQL(),user = "camille.crapart", password = "camille",host = "vm-srv-wallace.vm.ntnu.no", dbname = "nofa")
#catchment.geom <- tbl(con,sql("SELECT ebint, geom FROM catchments.lake_catchments"))

ebint.tbl <- tbl(con,sql("SELECT ebint FROM catchments.lake_catchments")) 
ebint.catch <- pull(ebint.tbl,ebint)

ebint.waterchem <- tbl(con,sql("SELECT ebint,nation FROM environmental.north_euro_lake_surv_1995")) %>% tbl_df()

ebint <- intersect(ebint.waterchem$ebint, ebint.catch)

country <- filter(ebint.waterchem, ebint %in% ebint)
saveRDS(country,"country.Rdata")
```

```{r catchment-poly, eval = F}
catchment.poly.1000 <- st_read(con,query = "SELECT ebint, geom FROM catchments.lake_catchments WHERE ebint IN (SELECT ebint FROM environmental.north_euro_lake_surv_1995)")
saveRDS(catchment.poly.1000,"catchment.poly.1000.Rdata")
```

The catchment polygons were reprojected in WGS84 to match the satellite data that will be extracted later, and in EPSG:3035 (European projection) to match the CORINE land cover data. 

```{r catchment-plot, eval = F}
catchment.poly <- st_transform(catchment.poly.1000, CRS("EPSG:4326"))
saveRDS(catchment.poly,"catchment.poly.Rdata")
catchment.poly.corine <- st_transform(catchment.poly.1000, CRS("EPSG:3035"))
saveRDS(catchment.poly.corine, "Fennoscandia_NTNU/catchment.poly.Rdata")
```

## TOC

The TOC data was measured after the Northern Lake Survey 1995 @Henriksen1998. It was stored in the ecco_biwa database.

```{r toc, eval = F}

toc.tbl <- tbl(con,sql("SELECT ebint,toc_mg_l,longitude,latitude,dist_closest_ebint,dist_2nd_closest_ebint FROM environmental.north_euro_lake_surv_1995"))
toc.df <- as.data.frame(toc.tbl)
saveRDS(toc.df,"toc.df.Rdata")

```


## NDVI

NDVI values are extracted from the GIMMS NDVI3g dataset @TheNationalCenterForAtmosphericResearch2018, stored on http://poles.tpdc.ac.cn/en/data/9775f2b4-7370-4e5e-a537-3482c9a83d88/, in the "ecocast" dataset and accessed via the "gimms" package @Destch2021 on Rstudio. 

Data is taken bi-monthly @Tucker2005. Raster layers of all slices are downloaded using the gimmsdownload function, then monthly composite are calculated using the monthlyComposites function. The maximum NDVI value is taken for each pixel. Afterwards the NDVI values for each catchment polygon are extracted using the extract function from the raster package @Hijmans2018. 

The values stored in the ecocast dataset are composed of the ndvi value and a flag value indicating the goodness of the data @Detsch2021. All the NDVI values extracted, corresponding to the values for the studied catchments, had a flag of 1, indicating a good value. The NDVI value was retrieved from the stored value using the formula "floor(ndvi3g/10)/1000" @Detsch2021, and then the mean of the 3 summer values (june, july and august) was computed for each catchment. 


```{r summer-ndvi, eval = F}

# Download Gimms NDVI
# http://poles.tpdc.ac.cn/en/data/9775f2b4-7370-4e5e-a537-3482c9a83d88/

ndvi.1994 <- downloadGimms(x= 1994,y=1994,dsn = "NDVI")
ndvi.max <- monthlyComposite(ndvi.1994,monthlyIndices(ndvi.1994))
saveRDS(ndvi.max,"ndvi.max.rds")

# NDVI extraction

ndvi.max <- readRDS("ndvi.max.rds")
catchment.poly <- readRDS("catchment.poly.Rdata")

summer.mean <- raster::stack(ndvi.max[[6]],ndvi.max[[7]],ndvi.max[[8]]) %>% mean()

summer.scandinavia <- raster::crop(summer.mean,c(0,35,55,73))

summer.scan <- reclassify(summer.scandinavia, cbind(-Inf, 0, NA), right=FALSE)
saveRDS(summer.scan, "summer.scan.rds")

summer.ndvi <- raster::extract(summer.mean,catchment.poly, fun = mean, df = T, sp = T)
names(summer.ndvi) <- c("ebint","ndvi")
summer.ndvi$ndvi.value <- floor(summer.ndvi$ndvi/10)/1000
summer.ndvi$flag.value <- summer.ndvi$ndvi - floor(summer.ndvi$ndvi/10)*10 + 1 

saveRDS(summer.ndvi, "summer.ndvi.Rdata")
write.csv(summer.ndvi,"summer.ndvi.csv")
```

```{r maps-ndvi, eval = F}
summer.scan <- readRDS("summer.scan.rds")
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")

ndvi.plot <- (floor(summer.scan)/10)/1000

ndvi.plot.spdf <- ndvi.plot %>% as("SpatialPixelsDataFrame") %>% spTransform(projection(wr.sf.95)) %>% as.data.frame()

map.ndvi <- ggplot() + geom_tile(data = ndvi.plot.spdf, aes(x = x, y = y, fill = layer, width = 10000, height = 10000))+
  scale_fill_distiller(type = "seq", palette = 2, direction = 1)+labs(fill = "Summer NDVI 1995", subtitle = "a)")+
  theme_void(base_size = 8)+
  theme(legend.position = "bottom")
ggsave(plot = map.ndvi, filename = "NDVI/map.ndvi.nsf.png", dpi = "retina", units = "cm")
```

## CORDEX: runoff data

The runoff data was downloaded from the CORDEX database @CORDEXvERC. The data is available at https://esg-dn1.nsc.liu.se/projects/esgf-liu/.

The names of the variables in the CORDEX project follow the CF Metadata convention: http://cfconventions.org/

THe mean of the 30 years between 1960 and 1990 is used (p11 on EURO-CORDEX guidelines https://www.euro-cordex.net/imperia/md/content/csc/cordex/guidance_for_euro-cordex_climate_projections_data_use__2021-02_1_.pdf).

```{r runoff, eval = F}
#runoff.tbl <- tbl(con,sql("SELECT ebint,mrros FROM public.cordex_prelim"))
#runoff.df <- runoff.tbl %>% as.data.frame()

runoff.raster <- "CORDEX/mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"
runoff.nc <- nc_open(runoff.raster)

runoff.stack <- raster::stack(runoff.raster, bands = c(1441:1812))
runoff.mean <- runoff.stack %>% mean() 

catchment.poly <- readRDS("catchment.poly.Rdata")
runoff.fennoscandia <- raster::extract(runoff.mean, catchment.poly, fun = mean, df = T, sp = T, na.rm = T)
names(runoff.fennoscandia) <- c("ebint","runoff")
saveRDS(runoff.fennoscandia,"CORDEX/runoff.fennoscandia.rds")

ggplot(st_as_sf(runoff.fennoscandia))+geom_sf(aes(fill=layer,col=layer))

```

```{r runoff-2015, eval = F}
#runoff.tbl <- tbl(con,sql("SELECT ebint,mrros FROM public.cordex_prelim"))
#runoff.df <- runoff.tbl %>% as.data.frame()

runoff.raster <- "CORDEX/mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"
runoff.nc <- nc_open(runoff.raster)

runoff.stack <- raster::stack(runoff.raster, bands = c(1501:1980)) # from 1975 to 2015, not included
runoff.mean <- runoff.stack %>% mean() 

catchment.poly <- readRDS("catchment.poly.Rdata")
runoff.fennoscandia.2015 <- raster::extract(runoff.mean, catchment.poly, fun = mean, df = T, sp = T, na.rm = T)
names(runoff.fennoscandia.2015) <- c("ebint","Runoff")
saveRDS(runoff.fennoscandia.2015,"CORDEX/runoff.fennoscandia.2015.rds")

ggplot(st_as_sf(runoff.fennoscandia))+geom_sf(aes(fill=layer,col=layer))

```

## Temperature,precipitation and slope

Temperature and precipitation are downloaded from the database Worldclim. Temperature is the mean annual temperature from 1970 to 2000 in C, or bio1 in the bioclimatic dataset. The original data is in C*10 so the data is divided by 10 before use. Precipitation is the mean annual precipitation in mm or bio12 in the bioclimatic dataset : https://www.worldclim.org/data/worldclim21.html 

```{r temp-prec, eval = F}
#monthly mean temperature for 1970-2000
bio.fennoscandia <- raster::getData(name = "worldclim", var = "bio", res = 2.5)
annual.temp <- raster::extract(bio.fennoscandia[[1]], catchment.poly, fun = mean, df = T, sp = T)
saveRDS(annual.temp,"annual.temp.Rdata")

annual.prec <- raster::extract(bio.fennoscandia$bio12, catchment.poly, fun = mean, df = T, sp = T)
saveRDS(annual.prec,"annual.prec.Rdata")
boxplot(annual.prec$bio12)
```

The altitude data was accessed through the "getData" function, and comes from the NASA digital elevation model (SRTM 90 m). The slope was then computed using the "terrain" function from the raster package.  

```{r altitude-slope, eval = F}
alt.nor <- getData("alt",country = "NOR", mask = T)
alt.swe <- getData("alt",country = "SWE", mask = T)
alt.fin <- getData("alt",country = "FIN", mask = T)

alt.list <- list(alt.nor,alt.swe,alt.fin)
alt <- do.call(raster::merge,alt.list)

alt.fennoscandia <- extract(alt,remote.set[,c("longitude","latitude")])
alt.df <- data.frame(ebint = remote.set$ebint, alt = alt.fennoscandia )
saveRDS(alt.df, "alt.df.Rdata")

slope.nor <- terrain(alt.nor, unit = "degrees")
slope.swe <- terrain(alt.swe, unit = "degrees")
slope.fin <- terrain(alt.fin, unit = "degrees")
slope.list <- list(slope.nor,slope.swe,slope.fin)
slope <- do.call(raster::merge,slope.list)

plot(slope)
slope.nona <- reclassify(slope,cbind(NA,100), right = NA)
plot(slope.nona)

slope.fennoscandia <- raster::extract(slope,catchment.poly, sp = T, df = T, fun = mean)
saveRDS(slope.df, "slope.df.Rdata")
```

## Land cover

The Land Cover data was downloaded from https://land.copernicus.eu/pan-european/corine-land-cover/lcc-2000-2006. The previous version (1995-2000) excludes Norway so the 2000 version was preferred. 

The land cover data was downloaded as a raster (.tiff file), which included the legend recording the code for each land use. The raster and legend were assembled in QGIS before being imported as a shapefile in R. The codes (corresponding to the line in the extracted dataframe) of the categories of interest were:

Arable land:
* 12: non-irrigated arable land
* 16: fruit trees and berries plantations
* 18: pastures
* 19: annual crops associated with permanent crops
* 20: Complex cultivation patterns

Bogs:
* 36: peat bogs
* 35: inland marshes, excluded because all zeros in the studied area.

Forest:
* 23: Broad-leaved forest
* 24: Coniferous forest
* 25: Mixed forest

Bare:
31: Bare rocks
32: Sparsely vegetated areas
33: Burnt areas

```{r extract-land-cover, eval = F}
corine <- raster::raster("Corine_Land_Cover/U2006_CLC2000_V2020_20u1.tif")
plot(corine)
library(rgdal)
corine_spdf <- readOGR(dsn= paste0(getwd(),"/Corine_Land_Cover/corine-land-cover.shp"))

clc.remote <- raster::extract(corine,catchment.poly.corine)
saveRDS(clc.remote,"clc.remote.Rdata")

clc.tab <- sapply(clc.remote, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- catchment.poly.corine$ebint
saveRDS(clc.tab.prop,"clc.tab.prop.Rdata")

clc.tab.prop <- readRDS("clc.tab.prop.Rdata") %>% as.data.frame()
bogs <- clc.tab.prop[36,] %>% t() %>% as.data.frame() %>% setNames("bogs") %>% tibble::rownames_to_column(var = "ebint")
saveRDS(bogs,"bogs.rds")
arable <- colSums(clc.tab.prop[c(12,18,19,10),]) %>% as.data.frame() %>% setNames("arable") %>% tibble::rownames_to_column(var = "ebint")
saveRDS(arable,"arable.rds")
forest <- colSums(clc.tab.prop[c(23,24,25),]) %>% as.data.frame() %>% setNames("forest") %>% tibble::rownames_to_column(var = "ebint")
saveRDS(forest,"forest.rds")
bare <- colSums(clc.tab.prop[c(31,32,33),]) %>% as.data.frame() %>% setNames("bare") %>% tibble::rownames_to_column(var = "ebint")
saveRDS(bare,"bare.rds")

```

## Nitrogen and sulfur deposition

The nitrogen and sulfur deposition data were extracted from the EMEP database (https://emep.int/mscw/mscw_moddata.html#Comp). 

N-deposition (NOx and NH3) is the sum of: 
+ Dry deposition of oxidized nitrogen per m2 grid DDEP_OXN_m2Grid
+ Wet deposition of oxidized nitrogen WDEP_OXN
+ Dry deposition of oxidized nitrogen per m2 grid DDEP_RDN_m2Grid
+ Wet deposition of reduced nitrogen WDEP_RDN

```{r extract Ndep, eval = F}
library(ncdf4)
EMEP_file <- "EMEP/EMEP01_rv4.42_year.2000met_2000emis_rep2021.nc"
catchment_poly <- readRDS("catchment.poly.Rdata")

woxn <- raster(EMEP_file, varname = "WDEP_OXN") 
doxn <- raster(EMEP_file, varname = "DDEP_OXN_m2Grid")
wrdn <- raster(EMEP_file, varname = "WDEP_RDN")
drdn <- raster(EMEP_file, varname = "DDEP_RDN_m2Grid")

woxn_df <- extract(woxn,catchment.poly, sp = T, df = T, na.rm = T, fun = mean) 
names(woxn_df) <- c("ebint","woxn")
doxn_df <- extract(doxn,catchment.poly, sp = T, df = T, na.rm = T, fun = mean)
names(doxn_df) <- c("ebint","doxn")
wrdn_df <- extract(wrdn,catchment.poly, sp = T, df = T, na.rm = T, fun = mean)
names(wrdn_df) <- c("ebint","wrdn")
drdn_df <- extract(drdn,catchment.poly, sp = T, df = T, na.rm = T, fun = mean)
names(drdn_df) <- c("ebint","drdn")

ndep.df <- merge(woxn_df,doxn_df, by = "ebint") %>% merge(wrdn_df, by = "ebint") %>% merge(drdn_df, by = "ebint")
ndep.df$tndep <- rowSums(ndep.df@data[,c(2:5)])

saveRDS(ndep.df,"ndep.df.Rdata")
```

The S-deposition is composed of the sum of wet and dry deposition of SOx. 

```{r extract-Sdep, eval = F}
library(ncdf4)
EMEP_file <- "EMEP/EMEP01_rv4.42_year.2000met_2000emis_rep2021.nc"
catchment_poly <- readRDS("catchment.poly.Rdata")

wsox <- raster(EMEP_file, varname = "WDEP_SOX") 
dsox <- raster(EMEP_file, varname = "DDEP_SOX_m2Grid")

wsox_df <- extract(wsox,catchment_poly, sp = T, df = T, na.rm = T, fun = mean) 
names(wsox_df) <- c("ebint","wsox")

dsox_df <- extract(dsox,catchment_poly, sp = T, df = T, na.rm = T, fun = mean)
names(dsox_df) <- c("ebint","dsox")

sdep.df <- merge(wsox_df,dsox_df, by = "ebint")
sdep.df$tsdep <- rowSums(sdep.df@data[,c(2:3)])

saveRDS(sdep.df,"sdep.df.rds")
```


## Gathering and cleaning the data

The data was gathered and merged into a single dataframe, based on the catchment identifyer ("ebint").

```{r gather-data, eval = F}
country <- readRDS("country.Rdata")
toc.df <- readRDS("toc.df.Rdata")
summer.ndvi <- readRDS("summer.ndvi.Rdata")
runoff.fennoscandia <- readRDS("CORDEX/runoff.fennoscandia.rds")

annual.temp <- readRDS("annual.temp.Rdata")
names(annual.temp) <- c("ebint","temp")

annual.prec <- readRDS("annual.prec.Rdata")
names(annual.prec) <- c("ebint","prec")

slope.fennoscandia <- readRDS("slope.fennoscandia.Rdata")
names(slope.fennoscandia) <- c("ebint","slope")

alt.df <- readRDS("alt.df.Rdata")

bogs <- readRDS("bogs.rds")
arable <- readRDS("arable.rds")
forest <- readRDS("forest.rds")
bare <- readRDS("bare.rds")

ndep <- readRDS("ndep.df.Rdata")
sdep <- readRDS("sdep.df.rds")

fennoscandia_raw <- merge(country,toc.df, by = "ebint") %>% 
  merge(summer.ndvi, by = "ebint") %>% 
  merge(runoff.fennoscandia,by = "ebint") %>% 
  merge(annual.temp, by ="ebint") %>% 
  merge(annual.prec, by = "ebint") %>%
  merge(slope.fennoscandia, by = "ebint") %>%
  merge(alt.df, by = "ebint") %>%
  merge(bogs, by = "ebint") %>%
  merge(arable, by = "ebint")%>%
  merge(forest,by = "ebint") %>%
  merge(bare, by = "ebint") %>%
  merge(ndep, by = "ebint") %>% 
  merge(sdep, by = "ebint")

fennoscandia_raw$uncertain <- ifelse(fennoscandia_raw$dist_closest_ebint/fennoscandia_raw$dist_2nd_closest_ebint > 0.5, FALSE, TRUE)
fennoscandia_raw$uncertain[which(is.na(fennoscandia_raw$uncertain)==TRUE)] <- FALSE

fennoscandia_raw <- fennoscandia_raw %>% filter(toc_mg_l >= 0)
fennoscandia_raw <- fennoscandia_raw %>% filter(runoff > 0)
fennoscandia_raw <- fennoscandia_raw %>% filter(ndvi.value > 0)
fennoscandia_raw <- fennoscandia_raw %>% filter(is.na(slope) == F)
fennoscandia_raw <- fennoscandia_raw %>% filter(alt != 0)
fennoscandia_raw <- fennoscandia_raw %>% filter(uncertain == FALSE)
fennoscandia_raw$uncertain <- NULL

saveRDS(fennoscandia_raw,"fennoscandia_raw.rds")
```

### Data cleaning

### Histogram

The distribution of the variables were checked with histograms.

```{r hist, results = F, fig.dim = c(24,48)}
fennoscandia_raw <- readRDS("fennoscandia_raw.rds")

h_list <- c()

for (i in names(fennoscandia_raw[,-c(1:2)])){
  if(IQR(fennoscandia_raw[[i]], na.rm = T) > 0.1){
    hi <- ggplot(data = fennoscandia_raw,aes_string(i))+geom_histogram(stat = "bin",na.rm = T,binwidth = function(x) 2*IQR(x, na.rm = T)/(length(x)^(1/3)))+labs(y="",title = i)+theme_light(base_size = 20)
  }else{
    hi <- ggplot(data = fennoscandia_raw,aes_string(i))+geom_histogram(stat = "bin",na.rm = T)+labs(y="",title = i)+theme_light(base_size = 20)
  }
  h_list[[i]] <- hi
}

cowplot::plot_grid(plotlist = h_list,ncol=3)
```


### Transformation of variables

TOC, Runoff, Precipitation and Slope are skewed to the right so they are log-transformed. N-dep, S-dep, Bog and Arable included many zero, so they were not transformed even if they were skewed. 

Moreover, all the variables were scaled and centered.

```{r log-transform, eval = F}
fennoscandia <- readRDS("fennoscandia_raw.rds")

v <- c("toc_mg_l","runoff","temp","prec","slope","alt","bogs","arable","forest","bare","tndep","tsdep")
names(fennoscandia)[which(names(fennoscandia) %in% v)] <- c("TOC", "Runoff","Temp","Precip","Slope","Alt","Bog","Arable","Forest","Bare","TNdep","TSdep")

fennoscandia$logTOC <- log(fennoscandia$TOC) 
fennoscandia$s.logTOC <- scale(fennoscandia$logTOC) 
fennoscandia$Runoff <- fennoscandia$Runoff*365*24*60*60 # from kg/m2/s to kg/m2/year
fennoscandia$logRunoff <- log(fennoscandia$Runoff)  
fennoscandia$s.logRunoff <- scale(fennoscandia$logRunoff)
fennoscandia$NDVI <- fennoscandia$ndvi.value
fennoscandia$s.NDVI <- scale(fennoscandia$NDVI)
fennoscandia$s.Bog <- scale(fennoscandia$Bog)
fennoscandia$s.Arable <- scale(fennoscandia$Arable)
fennoscandia$s.Forest <- scale(fennoscandia$Forest)
fennoscandia$Temp <- fennoscandia$Temp / 10 # divided by 10 because the temperature is stored in C*10
fennoscandia$s.Temp <-  scale(fennoscandia$Temp) 
fennoscandia$logPrecip <- log(fennoscandia$Precip+1e-5)
fennoscandia$s.logPrecip <- scale(fennoscandia$logPrec)
fennoscandia$s.Slope <- scale(fennoscandia$Slope)
fennoscandia$s.TNdep <- scale(fennoscandia$TNdep)
fennoscandia$s.TSdep <- scale(fennoscandia$TSdep)
fennoscandia$rdn <- fennoscandia$drdn+fennoscandia$wrdn
fennoscandia$oxn <- fennoscandia$doxn+fennoscandia$woxn
fennoscandia$s.rdn <- scale(fennoscandia$rdn)
fennoscandia$s.oxn <- scale(fennoscandia$oxn)

fennoscandia.spdf <- SpatialPointsDataFrame(fennoscandia[,c("longitude","latitude")],fennoscandia)

fennoscandia$ndvi <- NULL


saveRDS(fennoscandia, "fennoscandia.rds")
saveRDS(fennoscandia.spdf,"fennoscandia.spdf.rds")

norge <- filter(fennoscandia,nation == "Norway")
saveRDS(norge, "norge.rds")
```

```{r convert-CRS, eval = F}
catchment.poly <- readRDS("catchment.poly.Rdata")
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")
fennoscandia.cat <- merge(fennoscandia,catchment.poly, by = "ebint") %>% st_as_sf()
fennoscandia.33 <- st_transform(fennoscandia.cat,st_crs(wr.sf.95))
saveRDS(fennoscandia.33, "fennoscandia.33.rds")
```

# Mapping of predictor and response variable

The TOC concentration and the predictor variables were plotted by catchment. 

```{r map-cat-variable, eval = F}
fennoscandia.33 <- readRDS("fennoscandia.33.rds")
m <- c("TOC","NDVI","Runoff","Precip","Temp","Bog","Arable","Forest","TNdep","TSdep")
u <- c("a) TOC concentration, mgC/L", "b) NDVI on scale 0 to 1", "c) Mean Runoff, mm/y","d) Mean annual precipitation,\n mm/y","e) Mean annual temperature,\n Â°C","f) Proportion of bogs","g) Proportion of\narable land","h) Proportion of forest","i) Total nitrogen\ndeposition, ug/m2", "j) Total sulphur\ndeposition, ug/m2")
couleurs <- c("YlOrRd","Greens","Blues","Blues","RdYlBu","YlOrBr","RdYlGn","RdYlGn","PuRd","PuRd")
dir <- c(T,T,T,T,F,T,T,T,T,T)

for(i in m[2]){
  
 mysf <- fennoscandia.33
 mypal <- brewer.pal(name = couleurs[which(m == i)], n = 9)
 display.brewer.pal(name = couleurs[which(m == i)], n = 9)
 midcol <- median(mysf[[i]])

 if(dir[which(m == i)] == T){
 map <- ggplot(mysf)+geom_sf(aes(fill = .data[[i]], col = .data[[i]]))+
                     scale_fill_gradient2(low = mypal[1], mid = mypal[5], high = mypal[9],
                                          midpoint = midcol,
                                          aesthetics = c("colour","fill"), 
                                          name = paste(u[grep(i,m)],"\n(",i,")",sep=""))+
    theme_minimal(base_size = 6)+
    theme(legend.position = "bottom")
    
  filename_i <- paste("map",i,"png",sep = ".")
  ggsave(plot = map, filename = filename_i, dpi = "retina", width = 6, height = 8, units = "cm")
  
 } else if(dir[which(m == i)] == F){
   map <- ggplot(mysf)+geom_sf(aes(fill = .data[[i]], col = .data[[i]]))+
                     scale_fill_gradient2(low = mypal[9], mid = mypal[5], high = mypal[1],
                                          midpoint = midcol,
                                          aesthetics = c("colour","fill"), 
                                          name = paste(u[grep(i,m)],"\n(",i,")",sep=""))+
    theme_minimal(base_size = 6)+
    theme(legend.position = "bottom")
    
  filename_i <- paste("map",i,"png",sep = ".")
  ggsave(plot = map, filename = filename_i, dpi = "retina", width = 6, height = 8, units = "cm")
   
 }
}
```

```{r include-maps, hold = T}
knitr::include_graphics(c("map.TOC.png","map.NDVI.png","map.Runoff.png","map.Precip.png","map.Temp.png","map.Bog.png","map.Arable.png","map.Forest.png","map.TNdep.png","map.TSdep.png"))
```

# Spatial autocorrelation & VIF

The spatial autocorrelation of the response and predictor variables were computed using Moran's I (see Supplementary 4). The neighbor matrix was computed first. 

```{r neighbour-matrix,  eval = F}
library(spdep)
k.neigh.w <- knearneigh(fennoscandia.spdf, k = 100) %>% knn2nb() %>% nb2listw()
saveRDS(k.neigh.w,"k.neigh.w.rds")
```

```{r spatial-autocorrelation, eval = T}
k.neigh.w <- readRDS("k.neigh.w.rds")
fennoscandia <- readRDS("fennoscandia.rds")

moran.list <- c() 

m <- c("logTOC","NDVI","logRunoff","logPrecip","Temp","Bog","Arable","Forest","TNdep","TSdep")

for (i in m){
  moran.list[[i]] <- moran.test(fennoscandia[,i],k.neigh.w, na.action = na.omit, alternative = "two.sided")
}

moran.df <- data.frame(m) %>% setNames("parameter")
moran.df$moran.I <- NA
moran.df$p.value <- NA

for (i in 1:length(moran.list)){
  moran.df$moran.I[i] <- moran.list[[i]]$estimate[1]
  moran.df$p.value[i] <- moran.list[[i]]$p.value
}

saveRDS(moran.df,"moran.df.rds")
```

```{r vif-table}
moran.df <- readRDS("moran.df.rds")
moran.df %>% arrange(desc(moran.I)) %>% kable %>% kable_styling(bootstrap_options = "bordered", position = "center")
```

# Comparison of linear model and spatial error model 

Two statistical models were applied on our dataset (see Supplementary 4). The linear model does not take into account the geographical correlation between the variables, so a Spatial Error Model (or spatial error linear model, SELM) was tested too. 

Both models were fitted with 9 predictors (including predictors correlated to each other or having a high Variance Inflation Factor) and then with the 6 models less correlated. 

## Linear model on NSF, 9 predictors

```{r lm-fennoscandia-full, results = T}
k.neigh.w <- readRDS("k.neigh.w.rds")

fm.s <- s.logTOC~s.NDVI+s.logRunoff+s.Bog+s.Arable+s.Forest+s.TNdep+s.TSdep+s.Temp+s.logPrecip
s.lm.fennoscandia.full <- lm(fm.s, data = fennoscandia, na.action = na.exclude)
saveRDS(s.lm.fennoscandia.full,"s.lm.fennoscandia.full.rds")

fm <- logTOC~NDVI+logRunoff+Bog+Arable+Forest+TNdep+TSdep+Temp+logPrecip
lm.fennoscandia.full <- lm(fm, data = fennoscandia, na.action = na.exclude)
saveRDS(lm.fennoscandia.full,"lm.fennoscandia.full.rds")

s.lm.r2 <- summary(s.lm.fennoscandia.full)$adj.r.squared
s.moran.I.res.lm <- lm.morantest(s.lm.fennoscandia.full, k.neigh.w, alternative = "two.sided")

lm.r2 <- summary(lm.fennoscandia.full)$adj.r.squared
moran.I.res.lm <- lm.morantest(lm.fennoscandia.full, k.neigh.w, alternative = "two.sided")

moran.limit.fennoscandia <- 1/(dim(fennoscandia)[1]-1)

s.lm.coef.full <- summary(s.lm.fennoscandia.full)$coefficients %>% as.data.frame()
s.lm.coef.full <- s.lm.coef.full[-1,] %>% rownames_to_column(var = "Parameter")
saveRDS(s.lm.coef.full, "s.lm.coef.full.rds")

lm.coef.full <- summary(lm.fennoscandia.full)$coefficients %>% as.data.frame()
lm.coef.full <- lm.coef.full[-1,] %>% rownames_to_column(var = "Parameter")

lm.effectsize.full <- compute.effect.size(lm.coef.full)
saveRDS(lm.effectsize.full, "lm.effectsize.full.rds")
``` 

## Spatial error linear model on NSF with 9 predictors

```{r sem-9-pred, eval = F}
k.neigh.w <- readRDS("k.neigh.w.rds")

fm.s <- s.logTOC~s.NDVI+s.logRunoff+s.Bog+s.Arable+s.Forest+s.TNdep+s.TSdep+s.Temp+s.logPrecip
s.sem.fen.9 <- errorsarlm(fm.s,fennoscandia,k.neigh.w)
saveRDS(s.sem.fen.9,"s.sem.fen.9.Rdata")

fm <- logTOC~NDVI+logRunoff+Bog+Arable+Forest+TNdep+TSdep+Temp+logPrecip
sem.fen.9 <- errorsarlm(fm,fennoscandia,k.neigh.w)
saveRDS(sem.fen.9,"sem.fen.9.Rdata")
```

```{r sem-results-9}
s.sem.fen.9 <- readRDS("s.sem.fen.9.Rdata")
sem.fen.9 <- readRDS("sem.fen.9.Rdata")
k.neigh.w <- readRDS("k.neigh.w.rds")


s.sem.coef <- s.sem.fen.9$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
s.sem.coef <- s.sem.coef %>% rownames_to_column(var = "Parameter")
s.sem.coef$std.error <- s.sem.fen.9$rest.se[-1]
saveRDS(s.sem.coef, "s.sem.coef.9.rds")

sem.coef <- sem.fen.9$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef <- sem.coef %>% rownames_to_column(var = "Parameter")
sem.coef$std.error <- sem.fen.9$rest.se[-1]


sem.effectsize <- compute.effect.size(sem.coef)
saveRDS(sem.effectsize, "sem.effectsize.9.rds")

n <- length(sem.coef$Parameter)

s.sem.AIC <- 2*(n-1)-2*s.sem.fen.9$LL
sem.AIC <- 2*(n-1)-2*sem.fen.9$LL

s.moran.I.res.sem <- moran.test(s.sem.fen.9$residuals, k.neigh.w, alternative = "two.sided")

moran.I.res.sem <- moran.test(sem.fen.9$residuals, k.neigh.w, alternative = "two.sided")

summary.table.sem <- cbind(dplyr::select(sem.coef,Parameter),s.sem.coef[,2:3],sem.coef[,2:3],sem.effectsize[,2:4]) %>%
                rbind(c("AIC",s.sem.AIC,"",sem.AIC,"","","","")) %>%
                rbind(c("Moran'I res", s.moran.I.res.sem$estimate[[1]],"", moran.I.res.sem$estimate[[1]], "","","",""))
summary.table.sem[,-1] <- apply(summary.table.sem[,-1],2,as.numeric)

saveRDS(summary.table.sem, "summary.table.sem.9.rds")
```

## Comparative plots 9

```{r compare-estimates-lm-9}
s.lm.coef.full <- readRDS("s.lm.coef.full.rds")
s.sem.coef.9 <- readRDS("s.sem.coef.9.rds")

n <- c(names(s.sem.coef.9),"Model")
m <- cbind.data.frame(s.lm.coef.full[,1:3],Model = "LM") %>% setNames(n)
o <- cbind.data.frame(s.sem.coef.9,Model = "SELM")
  
scaled.df <- rbind(m,o)
scaled.df$Parameter <- factor(scaled.df$Parameter, levels = c("s.TNdep","s.TSdep","s.Forest","s.Arable","s.Bog","s.logRunoff","s.Temp","s.logPrecip","s.NDVI"))

scaled.plot <- ggplot(scaled.df, aes(group = Model))+geom_col(aes(x=Estimate,y=Parameter, fill = Model, col = Model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Estimate-std.error,xmax=Estimate+std.error), position = "dodge", width = 0.5)+
  labs(x = "Scaled Estimate", y = "Predictor", subtitle = paste("LM: AIC =",round(AIC(s.lm.fennoscandia.full),2),"; Moran's I = ",round(s.moran.I.res.lm$estimate[[1]],2),"\nSELM: AIC =",round(s.sem.AIC,2),"; Moran's I =",round(s.moran.I.res.sem$estimate[[1]],2)))+
  theme_bw(base_size = 8)+theme(legend.position = "bottom")

```

```{r compare-effect-size-9}
lm.effectsize.full <- readRDS("lm.effectsize.full.rds")
sem.effectsize.9 <- readRDS("sem.effectsize.9.rds")

n <- c(names(sem.effectsize.9),"Model")
m <- cbind.data.frame(lm.effectsize.full,Model = "LM") %>% setNames(n)
o <- cbind.data.frame(sem.effectsize.9,Model = "SELM")
  
h.df <- rbind(m,o)
h.df$Parameter <- factor(h.df$Parameter, levels = c("TNdep","TSdep","Forest","Arable","Bog","logRunoff","Temp","logPrecip","NDVI"))

effectsize.plot <- ggplot(h.df, aes(group = Model))+
  geom_col(aes(x=Percent,y=Parameter, fill = Model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Percent-(100*std.error),xmax=Percent+(100*std.error)), position = "dodge", width = 0.5)+
  labs(x = "Effect size in %", y = "", subtitle = paste("LM: AIC =",round(AIC(lm.fennoscandia.full),2),"; Moran's I = ",round(moran.I.res.lm$estimate[[1]],2),"\nSELM: AIC =",round(sem.AIC,2),"; Moran's I =",round(moran.I.res.sem$estimate[[1]],2)))+
  theme_bw(base_size = 8)+theme(legend.position = "bottom")

```

```{r compare-plots-9, fig.dim = c(10,5)}
compare.9 <- cowplot::plot_grid(plotlist = list(scaled.plot,effectsize.plot),ncol=2)
save_plot(plot = compare.9, filename = "compare.lm.selm.9.png")
print(compare.9)
```

## Linear model on NSF, 6 predictors

* Linear model based on 6 predictors

```{r lm-fennoscandia, results = T}
k.neigh.w <- readRDS("k.neigh.w.rds")

fm.s <- s.logTOC~s.NDVI+s.logRunoff+s.Bog+s.Arable+s.Forest+s.TNdep
s.lm.fennoscandia <- lm(fm.s, data = fennoscandia, na.action = na.exclude)
saveRDS(s.lm.fennoscandia,"s.lm.fennoscandia.rds")

fm <- logTOC~NDVI+logRunoff+Bog+Arable+Forest+TNdep
lm.fennoscandia <- lm(fm, data = fennoscandia, na.action = na.exclude)
saveRDS(lm.fennoscandia,"lm.fennoscandia.rds")

s.lm.r2 <- summary(s.lm.fennoscandia)$adj.r.squared
s.moran.I.res.lm <- lm.morantest(s.lm.fennoscandia, k.neigh.w, alternative = "two.sided")

lm.r2 <- summary(lm.fennoscandia)$adj.r.squared
moran.I.res.lm <- lm.morantest(lm.fennoscandia, k.neigh.w, alternative = "two.sided")

moran.limit.fennoscandia <- 1/(dim(fennoscandia)[1]-1)

s.lm.coef <- summary(s.lm.fennoscandia)$coefficients %>% as.data.frame()
s.lm.coef <- s.lm.coef[-1,] %>% rownames_to_column(var = "Parameter")
saveRDS(s.lm.coef, "s.lm.coef.rds")

lm.coef <- summary(lm.fennoscandia)$coefficients %>% as.data.frame()
lm.coef <- lm.coef[-1,] %>% rownames_to_column(var = "Parameter")

lm.effectsize <- compute.effect.size(lm.coef)
saveRDS(lm.effectsize, "lm.effectsize.rds")
```

* Posterior distribution of coefficients to check the results of the lm.

```{r arm-sim-test-lm}
sm.fennoscandia <- arm::sim(lm.fennoscandia,n.sims = 100)

sm.coef <- sm.fennoscandia@coef[,-1]
sm.effectsize <- data.frame(parameter = colnames(sm.coef), effect.size = NA, std.error = NA)

n <- dim(sm.coef)[2]
m <- colnames(sm.coef)

for(i in 1:n){
  if(grepl("log",m[i])==T){
    sm.effectsize[i,2] <- mean(1.1^(sm.coef[,i]))
    sm.effectsize[i,3] <- sd(1.1^(sm.coef[,i])*log(1.1)*sm.coef[,i])
  }else if(m[i] %in% c("NDVI","Bog","Arable","Forest")){
    sm.effectsize[i,2] <- mean(exp(sm.coef[,i]*0.1))
    sm.effectsize[i,3] <- sd(0.1*exp(sm.coef[,i]*0.1)*sm.coef[,i])
  }else if(m[i] %in% c("TNdep","TSdep")){
    sm.effectsize[i,2] <- mean(exp(sm.coef[,i]*250))
    sm.effectsize[i,3] <- sd(250*exp(sm.coef[,i]*250)*sm.coef[,i])
  }
}

```

* Summary table

```{r summary-table-lm}
summary.table.lm <- cbind(dplyr::select(lm.coef,Parameter),s.lm.coef[,2:3],lm.coef[,2:3],lm.effectsize[,2:4],sm.effectsize[,2:3]) %>%
                rbind(c("AIC",AIC(s.lm.fennoscandia),"",AIC(lm.fennoscandia),"","","","","","")) %>%
                rbind(c("R2",s.lm.r2,"",lm.r2,"","","","","","")) %>%
                rbind(c("Moran'I res",s.moran.I.res.lm$estimate[[1]],"",moran.I.res.lm$estimate[[1]],"","","","","",""))
summary.table.lm[,-1] <- apply(summary.table.lm[,-1],2,as.numeric)

saveRDS(summary.table.lm, "summary.table.lm.rds")
```



## Spatial error linear model on NSF with 6 predictors

```{r sem-6-pred, eval = F}
k.neigh.w <- readRDS("k.neigh.w.rds")
norge.kmat <- readRDS("norge.kmat.Rdata")

#lagrange <- lm.LMtests(lm.fennoscandia,k.neigh.w,test = c("LMerr","LMlag","RLMerr","RLMlag"))

fm.s <- s.logTOC~s.NDVI+s.logRunoff+s.Bog+s.Arable+s.Forest+s.TNdep
s.sem.fennoscandia <- errorsarlm(fm.s,fennoscandia,k.neigh.w)
saveRDS(s.sem.fennoscandia,"s.sem.fennoscandia.Rdata")

fm <- logTOC~NDVI+logRunoff+Bog+Arable+Forest+TNdep
sem.fennoscandia <- errorsarlm(fm,fennoscandia,k.neigh.w)
saveRDS(sem.fennoscandia,"sem.fennoscandia.Rdata")

```

```{r sem-results-6}
s.sem.fennoscandia <- readRDS("s.sem.fennoscandia.Rdata")
sem.fennoscandia <- readRDS("sem.fennoscandia.Rdata")
k.neigh.w <- readRDS("k.neigh.w.rds")

s.sem.coef <- s.sem.fennoscandia$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
s.sem.coef <- s.sem.coef %>% rownames_to_column(var = "Parameter")
s.sem.coef$std.error <- s.sem.fennoscandia$rest.se[-1]
saveRDS(s.sem.coef, "s.sem.coef.rds")

sem.coef <- sem.fennoscandia$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef <- sem.coef %>% rownames_to_column(var = "Parameter")
sem.coef$std.error <- sem.fennoscandia$rest.se[-1]


sem.effectsize <- compute.effect.size(sem.coef)
saveRDS(sem.effectsize, "sem.effectsize.rds")

n <- length(sem.coef$Parameter)

s.sem.AIC <- 2*(n-1)-2*s.sem.fennoscandia$LL
sem.AIC <- 2*(n-1)-2*sem.fennoscandia$LL

s.moran.I.res.sem <- moran.test(s.sem.fennoscandia$residuals, k.neigh.w, alternative = "two.sided")

moran.I.res.sem <- moran.test(sem.fennoscandia$residuals, k.neigh.w, alternative = "two.sided")

summary.table.sem <- cbind(dplyr::select(sem.coef,Parameter),s.sem.coef[,2:3],sem.coef[,2:3],sem.effectsize[,2:4]) %>%
                rbind(c("AIC",s.sem.AIC,"",sem.AIC,"","","","")) %>%
                rbind(c("Moran'I res", s.moran.I.res.sem$estimate[[1]],"", moran.I.res.sem$estimate[[1]], "","","",""))
summary.table.sem[,-1] <- apply(summary.table.sem[,-1],2,as.numeric)

saveRDS(summary.table.sem, "summary.table.sem.rds")
```



## Comparative plots 6

```{r compare-estimates}
n <- c(names(s.sem.coef),"Model")
m <- cbind.data.frame(s.lm.coef[,1:3],Model = "LM") %>% setNames(n)
o <- cbind.data.frame(s.sem.coef,Model = "SELM")
  
scaled.df <- rbind(m,o)
scaled.df$Parameter <- factor(scaled.df$Parameter, levels = c("s.TNdep","s.Forest","s.Arable","s.Bog","s.logRunoff","s.NDVI"))

scaled.plot <- ggplot(scaled.df, aes(group = Model))+geom_col(aes(x=Estimate,y=Parameter, fill = Model, col = Model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Estimate-std.error,xmax=Estimate+std.error), position = "dodge", width = 0.5)+
  labs(x = "Scaled Estimate", y = "Predictor", subtitle = paste("LM: AIC =",round(AIC(s.lm.fennoscandia),2),"; Moran's I = ",round(s.moran.I.res.lm$estimate[[1]],2),"\nSELM: AIC =",round(s.sem.AIC,2),"; Moran's I =",round(s.moran.I.res.sem$estimate[[1]],2)))+
  theme_bw(base_size = 8)+theme(legend.position = "bottom")

```

```{r compare-effect-size-6}

n <- c(names(sem.effectsize),"Model")
m <- cbind.data.frame(lm.effectsize,Model = "LM") %>% setNames(n)
o <- cbind.data.frame(sem.effectsize,Model = "SELM")
  
h.df <- rbind(m,o)
h.df$Parameter <- factor(h.df$Parameter, levels = c("TNdep","Forest","Arable","Bog","logRunoff","NDVI"))

effectsize.plot <- ggplot(h.df, aes(group = Model))+
  geom_col(aes(x=Percent,y=Parameter, fill = Model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Percent-(100*std.error),xmax=Percent+(100*std.error)), position = "dodge", width = 0.5)+
  labs(x = "Effect size in %", y = "", subtitle = paste("LM: AIC =",round(AIC(lm.fennoscandia),2),"; Moran's I = ",round(moran.I.res.lm$estimate[[1]],2),"\nSELM: AIC =",round(sem.AIC,2),"; Moran's I =",round(moran.I.res.sem$estimate[[1]],2)))+
  theme_bw(base_size = 8)+theme(legend.position = "bottom")

```

```{r compare-plots-1, fig.dim = c(10,5)}
compare.1 <- cowplot::plot_grid(plotlist = list(scaled.plot,effectsize.plot),ncol=2)
save_plot(plot = compare.1, filename = "compare.lm.selm.png")
print(compare.1)
```

# Spatial error linear models with 3 predictors

## Spatial error linear model on Norwegian and Fennoscandian datasets with NDVI, Bog and logRunoff {#sem-simple}

* Model Norway

```{r kmat, eval = F}
norge.spdf <- SpatialPointsDataFrame(norge[,c("longitude","latitude")],norge)

norge.kmat <- norge.spdf %>% knearneigh(k=50) %>% knn2nb %>% nb2listw
saveRDS(norge.kmat,"norge.kmat.rds")
```

```{r sem-simple-norway, eval = F}
norge.kmat <- readRDS("norge.kmat.Rdata")

s.fm <- s.logTOC~s.NDVI+s.logRunoff+s.Bog
s.sem.norge.simple <- errorsarlm(s.fm,norge,norge.kmat)
saveRDS(s.sem.norge.simple,"s.sem.norge.simple.Rdata")

fm <- logTOC~NDVI+logRunoff+Bog
sem.norge.simple <- errorsarlm(fm,norge,norge.kmat)
saveRDS(sem.norge.simple,"sem.norge.simple.Rdata")

```

```{r sem-simple-results-norway}
s.sem.norge.simple <- readRDS("s.sem.norge.simple.Rdata")
sem.norge.simple <- readRDS("sem.norge.simple.Rdata")
norge.kmat <- readRDS("norge.kmat.Rdata")


s.sem.coef.norge <- s.sem.norge.simple$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
s.sem.coef.norge <- s.sem.coef.norge %>% rownames_to_column(var = "Parameter")
s.sem.coef.norge$std.error <- s.sem.norge.simple$rest.se[-1]

sem.coef.norge <- sem.norge.simple$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef.norge <- sem.coef.norge %>% rownames_to_column(var = "Parameter")
sem.coef.norge$std.error <- sem.norge.simple$rest.se[-1]

saveRDS(sem.coef.norge, "sem.coef.norge.rds")

sem.effectsize.norge <- compute.effect.size(sem.coef.norge)
saveRDS(sem.effectsize.norge, "sem.effectsize.norge.rds")

n <- length(sem.coef.norge$Parameter)

s.sem.AIC.norge <- 2*(n-1)-2*s.sem.norge.simple$LL
s.moran.I.res.sem.norge <- moran.test(s.sem.norge.simple$residuals, norge.kmat, alternative = "two.sided")

sem.AIC.norge <- 2*(n-1)-2*sem.norge.simple$LL
moran.I.res.sem.norge <- moran.test(sem.norge.simple$residuals, norge.kmat, alternative = "two.sided")

summary.table.sem.norge <- cbind(dplyr::select(sem.coef.norge,Parameter),s.sem.coef.norge[,2:3],sem.coef.norge[,2:3],sem.effectsize.norge[,2:4]) %>%
                rbind(c("AIC",s.sem.AIC,"",sem.AIC,"","","","")) %>%
                rbind(c("Moran'I res", s.moran.I.res.sem.norge$estimate[[1]],"",moran.I.res.sem.norge$estimate[[1]], "","","",""))
summary.table.sem.norge[,-1] <- apply(summary.table.sem.norge[,-1],2,as.numeric)

saveRDS(summary.table.sem.norge, "summary.table.sem.norge.rds")
```

* Model NSF

```{r sem-simple-fennosandia, eval = F}
k.neigh.w <- readRDS("k.neigh.w.Rdata")

s.fm <- s.logTOC~s.NDVI+s.logRunoff+s.Bog
s.sem.fen.simple <- errorsarlm(s.fm,fennoscandia,k.neigh.w)
saveRDS(s.sem.fen.simple,"s.sem.fen.simple.Rdata")

fm <- logTOC~NDVI+logRunoff+Bog
sem.fen.simple <- errorsarlm(fm,fennoscandia,k.neigh.w)
saveRDS(sem.fen.simple,"sem.fen.simple.Rdata")

```

```{r sem-simple-results}
s.sem.fen.simple <- readRDS("s.sem.fen.simple.Rdata")
sem.fen.simple <- readRDS("sem.fen.simple.Rdata")
k.neigh.w <- readRDS("k.neigh.w.Rdata")

s.sem.coef.simple <- s.sem.fen.simple$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
s.sem.coef.simple <- s.sem.coef.simple %>% rownames_to_column(var = "Parameter")
s.sem.coef.simple$std.error <- s.sem.fen.simple$rest.se[-1]

sem.coef.simple <- sem.fen.simple$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef.simple <- sem.coef.simple %>% rownames_to_column(var = "Parameter")
sem.coef.simple$std.error <- sem.fen.simple$rest.se[-1]
saveRDS(sem.coef.simple, "sem.coef.simple.rds")

sem.effectsize.fen <- compute.effect.size(sem.coef.simple)
saveRDS(sem.effectsize.fen, "sem.effectsize.fen.rds")


n <- length(sem.coef.simple$Parameter)

s.sem.AIC <- 2*(n-1)-2*s.sem.fen.simple$LL
s.moran.I.res.sem <- moran.test(s.sem.fen.simple$residuals, k.neigh.w, alternative = "two.sided")

sem.AIC <- 2*(n-1)-2*sem.fen.simple$LL
moran.I.res.sem <- moran.test(sem.fen.simple$residuals, k.neigh.w, alternative = "two.sided")

summary.table.simple.sem <- cbind(dplyr::select(sem.coef.simple,Parameter),s.sem.coef.simple[,2:3],sem.coef.simple[,2:3],sem.effectsize.fen[,2:4]) %>%
                rbind(c("AIC",s.sem.AIC,"",sem.AIC,"","","","")) %>%
                rbind(c("Moran'I res", s.moran.I.res.sem$estimate[[1]],"",moran.I.res.sem$estimate[[1]], "","","",""))
summary.table.simple.sem[,-1] <- apply(summary.table.simple.sem[,-1],2,as.numeric)

saveRDS(summary.table.simple.sem, "summary.table.simple.sem.rds")
```

* Comparative plots

```{r compare-estimates-simple}
n <- c(names(s.sem.coef.simple),"Model")
m <- cbind.data.frame(s.sem.coef.norge, Model = "Norway")
o <- cbind.data.frame(s.sem.coef.simple, Model = "Fennoscandia")
  
scaled.df <- rbind(m,o)

scaled.plot <- ggplot(scaled.df, aes(group = Model))+geom_col(aes(x=Estimate,y=Parameter, fill = Model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Estimate-std.error,xmax=Estimate+std.error), position = "dodge", width = 0.5)+
  labs(x = "Scaled estimates",y = "Predictor", subtitle = paste("Fennoscandia: AIC =",round(s.sem.AIC,2),"; Moran's I = ",round(s.moran.I.res.sem$estimate[[1]],2),"\nNorway: AIC =",round(s.sem.AIC.norge,2),"; Moran's I =",round(s.moran.I.res.sem.norge$estimate[[1]],2)))+
  theme_bw(base_size = 8)+
  theme(legend.position = "bottom")

```

```{r compare-effect-size-simple}

n <- c(names(sem.effectsize.fen),"Model")
m <- cbind.data.frame(sem.effectsize.norge,Model = "Norway")
o <- cbind.data.frame(sem.effectsize.fen,Model = "Fennoscandia")
  
h.df <- rbind(m,o)

effectsize.plot <- ggplot(h.df, aes(group = Model))+
  geom_col(aes(x=Percent,y=Parameter, fill = Model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Percent-(100*std.error),xmax=Percent+(100*std.error)), position = "dodge", width = 0.5)+
  labs(x = "Effect size in %", y = "", subtitle = paste("Fennoscandia: AIC =",round(sem.AIC,2),"; Moran's I = ",round(moran.I.res.sem$estimate[[1]],2),"\nNorway: AIC =",round(sem.AIC.norge,2),"; Moran's I =",round(moran.I.res.sem.norge$estimate[[1]],2)))+
  theme_bw(base_size = 8)+theme(legend.position = "bottom")
```

```{r compare-plots-2, fig.dim = c(10,5)}
compare.2 <- cowplot::plot_grid(plotlist = list(scaled.plot,effectsize.plot),ncol=2)
save_plot(plot = compare.2, filename = "compare.nor.fen.png" )
print(compare.2)
```

`r fig_nums(name = "compare-plots-2", caption = "Comparison of scaled estimates and effect sizes from the limited SELM  model based on the Norwegian (green) and Fennoscandian (orange) datasets.")`


## Spatial error linear model on Norwegian and Fennoscandian datasets with Forest, Bog and logRunoff {#forest}

* Model NSF

```{r sem-with-forest, eval = F}
k.neigh.w <- readRDS("k.neigh.w.Rdata")
norge.kmat <- readRDS("norge.kmat.Rdata")

fm <- logTOC ~ Forest+logRunoff+Bog

sem.forest.fen <- errorsarlm(fm, data = fennoscandia,k.neigh.w)

sem.forest.norge <- errorsarlm(fm, data = norge, norge.kmat)

saveRDS(sem.forest.fen, "sem.forest.fen.Rdata")
saveRDS(sem.forest.norge, "sem.forest.norge.Rdata")

```

```{r sem-forest-results}
k.neigh.w <- readRDS("k.neigh.w.Rdata")

sem.forest.fen <- readRDS("sem.forest.fen.Rdata")
sem.forest.norge <- readRDS("sem.forest.norge.Rdata")

sem.coef.forest <- sem.forest.fen$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef.forest <- sem.coef.forest %>% rownames_to_column(var = "Parameter")
sem.coef.forest$std.error <- sem.forest.fen$rest.se[-1]
saveRDS(sem.coef.forest,"sem.coef.forest.rds")

sem.effectsize.forest <- compute.effect.size(sem.coef.forest)
saveRDS(sem.effectsize.forest,"sem.effectsize.forest.rds")

n <- length(sem.coef.forest$Parameter)

sem.AIC <- 2*(n-1)-2*sem.forest.fen$LL
moran.I.res.sem <- moran.test(sem.forest.fen$residuals, k.neigh.w, alternative = "two.sided")

summary.table.sem.forest <- cbind(dplyr::select(sem.coef.forest,Parameter),sem.coef.forest[,2:3],sem.effectsize.forest[,2:4]) %>%
                rbind(c("AIC",sem.AIC,"","","","")) %>%
                rbind(c("Moran'I res", moran.I.res.sem$estimate[[1]], "","","",""))
summary.table.sem.forest[,-1] <- apply(summary.table.sem.forest[,-1],2,as.numeric)
saveRDS(summary.table.sem.forest,"summary.table.sem.forest.rds")
``` 

* Model Norway

```{r sem-forest-norge}
norge.kmat <- readRDS("norge.kmat.Rdata")

sem.coef.norge.forest <- sem.forest.norge$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef.norge.forest <- sem.coef.norge.forest %>% rownames_to_column(var = "Parameter")
sem.coef.norge.forest$std.error <- sem.forest.norge$rest.se[-1]
saveRDS(sem.coef.norge.forest, "sem.coef.norge.forest.rds")

sem.effectsize.forest.norge <- compute.effect.size(sem.coef.norge.forest)
saveRDS(sem.effectsize.forest.norge, "sem.effectsize.forest.norge.rds")

n <- length(sem.coef.norge.forest$Parameter)
sem.AIC.norge <- 2*(n-1)-2*sem.forest.norge$LL
moran.I.res.sem.norge <- moran.test(sem.forest.norge$residuals, norge.kmat, alternative = "two.sided")

summary.table.sem.forest.norge <- cbind(dplyr::select(sem.coef.norge.forest,Parameter),sem.coef.norge.forest[,2:3],sem.effectsize.forest.norge[,2:4]) %>%
                rbind(c("AIC",sem.AIC.norge,"","","","")) %>%
                rbind(c("Moran'I res", moran.I.res.sem.norge$estimate[[1]], "","","",""))
summary.table.sem.forest.norge[,-1] <- apply(summary.table.sem.forest.norge[,-1],2,as.numeric)
saveRDS(summary.table.sem.forest.norge, "summary.table.sem.forest.norge.rds")
```

* Comparative plots

```{r compare-effect-size-simple-forest}

n <- c(names(sem.effectsize.forest),"model")
m <- cbind.data.frame(sem.effectsize.forest,model = "Fennoscandia") %>% setNames(n)
o <- cbind.data.frame(sem.effectsize.forest.norge,model = "Norway")
  
h.df <- rbind(m,o)
h.df$Parameter <- factor(h.df$Parameter, levels = c("Bog","logRunoff","Forest"))

effectsize.plot <- ggplot(h.df, aes(group = model))+
  geom_col(aes(x=Percent,y=Parameter, fill = model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Percent-(100*std.error),xmax=Percent+(100*std.error)), position = "dodge", width = 0.5)+
  labs(x = "Effect size in %", y = "Predictor", subtitle = paste("Fennoscandia: AIC =",round(sem.AIC,2),"; Moran's I = ",round(moran.I.res.sem$estimate[[1]],2),"\nNorway: AIC =",round(sem.AIC.norge,2),"; Moran's I =",round(moran.I.res.sem.norge$estimate[[1]],2)))+
  theme_bw(base_size = 6)+theme(legend.position = "bottom")
ggsave(plot = effectsize.plot,filename = "effectsize.forest.plot.png", dpi = "retina", width = 7, height = 8, units = "cm")
print(effectsize.plot)
```

`r fig_nums("compare-effect-size-simple-forest", "Effect size for SELM model with forest as predictor instead of NDVI")`

## Summary table LM and SELM Fennoscandia

```{r lm-table-results}
summary.table.lm <- readRDS("summary.table.lm.rds")
summary.table.sem <- readRDS("summary.table.sem.rds")

n <- 6

knitr::kable(summary.table.lm,digits = 3) %>%
  add_header_above(c("Model"=1,"Scaled LM" = 2, "LM" = 2, "Effect size" = 3,"SIM" = 2),italic = T) %>%
  column_spec(column = 8, bold = T) %>% 
  kable_styling(bootstrap_options = "bordered") %>%
  group_rows(group_label = "Model Evaluation", start_row = n+1,end_row=n+3)

knitr::kable(summary.table.sem,digits = 4) %>%
  add_header_above(c("Model"=1,"Scaled SELM" = 2, "SELM" = 2, "Effect size" = 3),italic = T) %>%
  kable_styling(bootstrap_options = "bordered") %>%
  column_spec(column = 8, bold = T) %>% 
  group_rows(group_label = "Model Evaluation", start_row = n+1,end_row=n+2)
```

## Summary tables simple model Norway

```{r summary-table-norway}
summary.table.sem.norge <- readRDS("summary.table.sem.norge.rds")
n <- 3

knitr::kable(summary.table.sem.norge,digits = 4) %>%
  add_header_above(c("Model"=1,"Scaled SELM" = 2,"SELM" = 2, "Effect size" = 3),italic = T) %>%
  kable_styling(bootstrap_options = "bordered") %>%
  column_spec(column = 8, bold = T) %>% 
  group_rows(group_label = "Model Evaluation", start_row = n+1,end_row=n+2)
```

## Summary tables simple model Fennoscandia

```{r summary-table-simple-fen}
summary.table.simple.sem <- readRDS("summary.table.simple.sem.rds")
n <- 3

knitr::kable(summary.table.simple.sem,digits = 4) %>%
  add_header_above(c("Model"=1,"Scaled SELM" = 2,"SELM" = 2, "Effect size" = 3),italic = T) %>%
  kable_styling(bootstrap_options = "bordered") %>%
  column_spec(column = 8, bold = T) %>% 
  group_rows(group_label = "Model Evaluation", start_row = n+1,end_row=n+2)
```
## Residual plots

```{r residual-plots}
# lm models: s.lm.fennoscandia and lm.fennoscandia
norge <- readRDS("norge.rds")

s.lm.fennoscandia <- readRDS("s.lm.fennoscandia.rds")
lm.fennoscandia <- readRDS("lm.fennoscandia.rds")

s.sem.fennoscandia <- readRDS("s.sem.fennoscandia.Rdata")
sem.fennoscandia <- readRDS("sem.fennoscandia.Rdata")

sem.norge.simple <- readRDS("sem.norge.simple.Rdata")
sem.fen.simple <- readRDS("sem.fen.simple.Rdata")

sem.forest.fen <- readRDS("sem.forest.fen.Rdata")
sem.forest.norge <- readRDS("sem.forest.norge.Rdata")

f_plotspatial(data = fennoscandia,var = s.lm.fennoscandia$residuals, plottitle = "Residuals for scaled LM")
f_plotspatial(data = fennoscandia,var = s.sem.fennoscandia$residuals, plottitle = "Residuals for scaled SELM")
f_plotspatial(data = fennoscandia,var = lm.fennoscandia$residuals, plottitle = "Residuals for LM")
f_plotspatial(data = fennoscandia,var = sem.fennoscandia$residuals, plottitle = "Residuals for SELM")
f_plotspatial(data = fennoscandia,var = sem.fen.simple$residuals, plottitle = "Residuals for SELM with ndvi, runoff et bogs for Fennoscandia")
f_plotspatial(data = norge,var = sem.norge.simple$residuals, plottitle = "Residuals for SELM with ndvi, runoff et bogs for Norway")
f_plotspatial(data = fennoscandia,var = sem.forest.fen$residuals, plottitle = "Residuals for SELM with forest")
f_plotspatial(data = norge,var = sem.forest.norge$residuals, plottitle = "Residuals for SELM with forest for Norway")

```

`r knitr::knit_exit()`

# Appendix: Geographically Weighted Regression

A geographically weighted regression (GWR) model was fitted using the Fennoscandian dataset. The objective was to examine regional differences in relationships between response and predictor variables. It was hypothesized that the main explanatory factor for the DOM levels in surface waters differs between regions due to differences in the spatial ranges of the predictors. The local regression coefficients (slope, a) are shown on  `r fig_nums("gwr-results",display = "c")`. The map of measured logTOC concentration is also presented for reference.

## GWR with NDVI as predictor variable

```{r GWR-fennoscandia, eval = F}
fm <- logTOC~NDVI+logRunoff+Bog

library(GWmodel)
#bw.fennoscandia <- bw.gwr(fm, data = fennoscandia.spdf, kernel = "gaussian", adaptive = T)
gwr.fennoscandia <- gwr.basic(fm, data = fennoscandia.spdf, bw = 500, kernel = "gaussian", adaptive = T)

#saveRDS(bw.fennoscandia, "bw.fennoscandia.Rdata")
saveRDS(gwr.fennoscandia, "gwr.fennoscandia.Rdata")
```


```{r gwr-results, fig.dim = c(10,6)}
#bw.fennoscandia <- readRDS("bw.fennoscandia.Rdata")
gwr.fennoscandia <- readRDS("gwr.fennoscandia.Rdata")
k.neigh.w <- readRDS("k.neigh.w.Rdata")

gwr.coef <- gwr.fennoscandia$SDF@data

m <- c("NDVI","logRunoff","Bog")
n <- length(m)

gwr.effectsize <- gwr.coef[,2:(n+1)]

for(i in 1:dim(gwr.effectsize)[1]){
  for(j in 1:n){
  if(grepl("log",m[j])==T){
    gwr.effectsize[i,j] <- eslog^(gwr.coef[i,j+1])
  }else if(m[j] %in% c("NDVI","Bog","arable","forest")){
    gwr.effectsize[i,j] <- exp(gwr.coef[i,j+1]*es)
  }
  }
}

gwr.effectsize.percent <- 100*(gwr.effectsize-1)

saveRDS(gwr.effectsize.percent,"gwr.ndvi.effectsize.percent.rds")


coef.plot <- lapply(m,FUN = function(x)  f_plotspatial(data=fennoscandia,var=gwr.effectsize.percent[[x]],plottitle = x))
coef.plot$toc <- f_plotspatial(fennoscandia,var=gwr.coef$y,plottitle = "Observed toc (log)")
cowplot::plot_grid(plotlist = coef.plot,ncol=2)
```
`r fig_nums("gwr-results","Spatial distribution of local explanatory parameter coefficients from the GWR")`

```{r gwr-table}
gwr.AIC <- gwr.fennoscandia$GW.diagnostic$AICc
gwr.r2 <- gwr.fennoscandia$GW.diagnostic$gwR2.adj
gwr.moran <- moran.test(gwr.coef$Stud_residual,k.neigh.w,alternative = "two.sided")

summary.table.gwr <- data.frame(AIC = gwr.AIC,R2 = gwr.r2,Moran.I =gwr.moran$estimate[[1]])

knitr::kable(summary.table.gwr,digits = 3, caption = table_nums("gwr-results","GWR Model performance: Relative model fit (AIC), mean Variance (R2) and Spatial autocorrelation (Moranâs I) of residuals."), label = NA, col.names = c("AIC","R2","Moran's I")) %>%
  kable_styling(bootstrap_options = "bordered")
```

NDVI sustains its role as main predictor for the concentration of DOM in GWR. Local effect sizes range from 0 to +50%. In regions that are basically completely forested, such as south-east Finland (Figure 1g), or completely agricultural, such as southernmost Sweden (Figure 1h), the effect size of a 0.1 increase in NDVI is close to 0%. While in southern Norway and the northern parts of Norway, Sweden and Finland, where there is less forest and arable land, an increase of 0.1 unit NDVI is estimated to have a significant relative impact on TOC concentration (`r fig_nums("gwr-results", display = "c")`).

As also found for the SELM model the effect size of a 10% increase in runoff is mainly negative, though ranges from `r round(min(gwr.effectsize.percent$log.runoff),0)` % to `r round(max(gwr.effectsize.percent$log.runoff),0)`%.  The south-eastern Finland it the only region with low runoff intensity (`r fig_nums("insert-maps", display = "c")`c) where the effect size for the log of runoff is positive. The most negative effects are located in the south-west region of Norway , where there are the highest runoff intensities.

An unlikely change in the proportion of bogs has practically no effect,  except for a minor area in south-east Finland where both the highest (+`r round(min(gwr.effectsize.percent$Bog),0)` %) and the lowest (r round(min(gwr.effectsize.percent$Bog),0)`%) effect sizes are found. This local spot is not related to the original proportion of bogs (see Supplementary 2). 

## GWR with forest as predictor instead of NDVI

```{r GWR-fennoscandia-forest, eval = F}
fm <- logTOC~Forest+logRunoff+Bog

library(GWmodel)
#bw.fennoscandia.forest <- bw.gwr(fm, data = fennoscandia.spdf, kernel = "gaussian", adaptive = T)
gwr.fennoscandia.forest <- gwr.basic(fm, data = fennoscandia.spdf, bw = 500, kernel = "gaussian", adaptive = T)

#saveRDS(bw.fennoscandia.forest, "bw.fennoscandia.forest.Rdata")
saveRDS(gwr.fennoscandia.forest, "gwr.fennoscandia.forest.Rdata")
```

```{r gwr-results-forest, fig.dim = c(10,6)}
#bw.fennoscandia.forest <- readRDS("bw.fennoscandia.forest.Rdata")
gwr.fennoscandia.forest <- readRDS("gwr.fennoscandia.forest.Rdata")
k.neigh.w <- readRDS("k.neigh.w.Rdata")

gwr.coef <- gwr.fennoscandia.forest$SDF@data

m <- c("Forest","logRunoff","Bog")
n <- length(m)

gwr.effectsize <- gwr.coef[,2:(n+1)]

for(i in 1:dim(gwr.effectsize)[1]){
  for(j in 1:n){
  if(grepl("log",m[j])==T){
    gwr.effectsize[i,j] <- eslog^(gwr.coef[i,j+1])
  }else if(m[j] %in% c("NDVI","Bog","Forest")){
    gwr.effectsize[i,j] <- exp(gwr.coef[i,j+1]*es)
  }
  }
}

gwr.effectsize.percent <- 100*(gwr.effectsize-1)
saveRDS(gwr.effectsize.percent,"gwr.forest.effectsize.percent.rds")

coef.plot <- lapply(m,FUN = function(x)  f_plotspatial(data=fennoscandia,var=gwr.effectsize.percent[[x]],plottitle = x))
coef.plot$toc <- f_plotspatial(fennoscandia,var=gwr.coef$y,plottitle = "Observed toc (log)")
cowplot::plot_grid(plotlist = coef.plot,ncol=2)
```

`r fig_nums("gwr-results-forest","Spatial distribution of local explanatory parameter coefficients from the GWR, with forest as predictor instead of NDVI.")`

```{r gwr-forest-table}
gwr.AIC <- gwr.fennoscandia.forest$GW.diagnostic$AICc
gwr.r2 <- gwr.fennoscandia.forest$GW.diagnostic$gwR2.adj
gwr.moran <- moran.test(gwr.coef$Stud_residual,k.neigh.w,alternative = "two.sided")

summary.table.gwr.forest <- data.frame(AIC = gwr.AIC,R2 = gwr.r2,Moran.I =gwr.moran$estimate[[1]])
                                
knitr::kable(summary.table.gwr.forest,digits = 3, caption = table_nums("gwr-results-forest","GWR Model performance with Forest land covers instead of NDVI: Relative model fit AIC, mean Variance (R2) and Spatial autocorrelation (Moranâs I) of residuals."),label = NA, col.names = c("AIC","R2","Moran's I")) %>%
  kable_styling(bootstrap_options = "bordered")
```

Replacing NDVI in the GWR model with the proportion of forest does not change the local effect sizes of runoff in the model, and a similar spot of very high and very low effect sizes appears for the proportion of bogs. A similar spot is visible on the map representing the local effect sizes for an increase in forest proportion, but the effect sizes values are not unusual there. Once again, this spot is not explained by an unusual original proportion of forest (see Supplementary 2). The range of effect sizes goes from `r round(min(gwr.effectsize.percent$forest),0)` % to `r round(max(gwr.effectsize.percent$forest),0)`%.

## GWR additional plots

```{r explore-bogs}
gwr.effectsize.percent <- readRDS("gwr.ndvi.effectsize.percent.rds")
plot(fennoscandia$bogs*100,gwr.effectsize.percent$bogs, xlab = "Proportion of bogs, %", ylab = "Effect size of a 10% increase in bogs, %")
```

```{r explore-forest}
gwr.effectsize.percent <- readRDS("gwr.forest.effectsize.percent.rds")
plot(fennoscandia$forest*100,gwr.effectsize.percent$forest, xlab = "Proportion of forest, %", ylab = "Effect size of a 10% increase in forest, %")
```

## Conclusion GWR

GWR models are interesting to investigate local relationships between the response and predictor variables, but the results might be complicated to interpret. The strength of a GWR model is also a drawback: by giving more weight to the closest neighbors, it also "artificially" emphasizes the local features of the data points, like a magnifying lens, resulting in an potentially exaggerated version of the reality. 
If the local effect sizes of an increase of NDVI, forest and runoff could be explained by the original conditions, the effect sizes of an increase in bogs were more diverse and there is no good explanation for the spot observed in Finland.
