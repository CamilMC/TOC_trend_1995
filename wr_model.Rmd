---
title: "TOC model extended"
author: "Camille M. Crapart"
date: "5 1 2022"
output: 
  bookdown::html_document2:
   toc: true
   toc_float: true
   number_sections: true
   fig_caption: true
bibliography: C:\\Users\\raine\\Documents\\UiO\\Bibtex\\Finstad.bib
link-citations: yes

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, error = F, fig.align = "center")
options(knitr.kable.NA="", knitr.kable.format ="html")
```
```{r library}
library(dplyr)
library(tibble)

library(DBI)
library(sf)
library(gimms)

library(ncdf4)
library(rgdal)

library(stringr)
library(ggplot2)
library(cowplot)
library(spdep)
library(spatialreg)

library(kableExtra)

source("f_plotspatial.R")

memory.limit(size = 160000)

```
# Water regions data

## Connections to database

```{r download-water-regions, eval = F}
con <- dbConnect(RPostgreSQL::PostgreSQL(),user = "camille.crapart", password = "camille",host = "vm-srv-wallace.vm.ntnu.no", dbname = "nofa")
query <- paste("SELECT gid,geom FROM ","\"Hydrography\"",".waterregions_dem_10m_nosefi",sep = "")
query.2 <- paste("SELECT * FROM ","\"Hydrography\"",".Fenoscandia_LakeRegister",sep = "")
water.regions <- st_read(con,query = query)
lake.register <- st_read(con,query = query.2)
saveRDS(water.regions,"water.regions.Rdata")
```

```{r plot-regions, eval = F}
water.regions <- readRDS("water.regions.Rdata")
ggplot()+geom_sf(data=water.regions,aes(fill = gid))
```

```{r select-polygons, eval = F}
water.regions <- readRDS("water.regions.Rdata")
water.regions$area <- st_area(water.regions) %>% as.numeric()
area1 <- sum(water.regions$area)

wr.quantile <- quantile(water.regions$area, probs = c(0.99,0.995,0.999))
wr.sf <- water.regions %>% filter(area > wr.quantile[3])
area2 <- sum(wr.sf$area)

ratio <- area2/area1*100

map.wr <- ggplot(wr.sf) + geom_sf(aes(fill=gid,col=gid))
ggsave(plot = map.wr, filename = "WR/wr.sf.png",dpi = "retina", width = 10, height = 15, units = "cm")

saveRDS(wr.sf,"WR/wr.sf.rds")
```


The water regions polygons were computed with a seamless digital elevation model for Fennoscandia @ninanor. The model resulted in more than 200 000 water regions, most of them being extremely small polygons covering the coastal regions. In order to simplify the model and reduce the amount of data, we keep only the 0,001 % of the water regions that are the biggest. They account to more than 93% of the total surface covered by the initial amount of polygons.  

## NDVI

```{r extract-ndvi-wr, eval = F}
ndvi.max <- readRDS("ndvi.max.Rdata")
wr.sf <- readRDS("WR/wr.sf.rds")

summer.mean <- raster::stack(ndvi.max[[6]],ndvi.max[[7]],ndvi.max[[8]]) %>% mean()
summer.ndvi <- reclassify(summer.mean,cbind(-Inf, 0, NA), right=FALSE)
summer.scandinavia <- raster::crop(summer.ndvi,c(0,35,55,73))
writeRaster(summer.mean,"ndvi1994.tif",overwrite = T)

ndvi.wr <- raster::extract(summer.ndvi,wr.sf,fun = mean, df = T, sp = T, na.rm = T)
ndvi.wr$area <- NA
ndvi.wr$ndvi <- (floor(ndvi.wr$layer)/10)/1000
saveRDS(ndvi.wr, "WR/ndvi.wr.rds")

ggplot(ndvi.wr)+geom_sf(aes(fill=ndvi,col=ndvi))
```

```{r summer-ndvi-waterregions-old, eval = F}
# http://poles.tpdc.ac.cn/en/data/9775f2b4-7370-4e5e-a537-3482c9a83d88/
water.regions <- readRDS("water.regions.Rdata")

ndvi.1994 <- downloadGimms(x= 1994,y=1994,dsn = "NDVI")
ndvi.max <- monthlyComposite(ndvi.1994,monthlyIndices(ndvi.1994))
saveRDS(ndvi.max,"ndvi.max.Rdata")
ndvi.max <- readRDS("ndvi.max.Rdata")
summer.mean <- raster::stack(ndvi.max[[6]],ndvi.max[[7]],ndvi.max[[8]]) %>% mean()
summer.scandinavia <- raster::crop(summer.mean,c(0,35,55,73))
summer.scan <- reclassify(summer.scandinavia, cbind(-Inf, 0, NA), right=FALSE)
summer.scan.ndvi <- (floor(summer.scan)/10)/1000
writeRaster(summer.mean,"ndvi1994.tif")

png("NDVI/ndvi.fen.png", width = 30, height = 30, units = "cm", res = 300)
plot(summer.scan.ndvi, axes = F, box = F, main = "NDVI 1995",)
dev.off()

for(x in 0:287){
  start.x <- (x-1)*1000+1
  end.x <- x*1000
  ndvi <- raster::extract(summer.scan,water.regions[start.x:end.x,], fun = mean, df = T, sp = T)
  name.x <- paste("WR/NDVI/summer.ndvi.wr",x,"Rdata",sep = ".")
saveRDS(ndvi,name.x)
}

start.x <- (288-1)*1000+1
summer.ndvi.wr.288 <- raster::extract(summer.scan,water.regions[start.x:287886,], fun = mean, df = T, sp = T)
saveRDS(summer.ndvi.wr.288,"summer.ndvi.wr.288.Rdata")

summer.ndvi.wr.165 <- raster::extract(summer.scan,water.regions[164100:165000,], fun = mean, df = T, sp = T)
saveRDS(summer.ndvi.wr.165,"WR/NDVI/summer.ndvi.wr.165.Rdata")

list.ndvi.files <- list.files("WR/NDVI", full.names = T)
list.ndvi <- lapply(list.ndvi.files[-165],readRDS)

summer.ndvi.wr <- summer.ndvi.wr.165@data
for(x in 1:length(list.ndvi)){
  df <- list.ndvi[[x]]@data
  summer.ndvi.wr <<- rbind(summer.ndvi.wr, df)
  
}
names(summer.ndvi.wr) <- c("gid","ndvi")
summer.ndvi.wr$ndvi.value <- (floor(summer.ndvi.wr$ndvi)/10)/1000
summer.ndvi.wr$flag.value <- summer.ndvi.wr$ndvi - (floor(summer.ndvi.wr$ndvi)/10*10+1) 

saveRDS(summer.ndvi.wr, "summer.ndvi.wr.Rdata")
```

```{r check-values-nvi, eval = F}
summer.ndvi.wr <- readRDS("summer.ndvi.wr.Rdata")
water.regions <- readRDS("water.regions.Rdata")

missing.ndvi <- summer.ndvi.wr$gid[which(is.na(summer.ndvi.wr$ndvi.value)==T)]
missing.lines <- which(water.regions$gid %in% missing.ndvi)

ndvi.max <- readRDS("ndvi.max.Rdata")
summer.mean <- raster::stack(ndvi.max[[6]],ndvi.max[[7]],ndvi.max[[8]]) %>% mean()
summer.scandinavia <- raster::crop(summer.mean,c(0,35,55,73))
summer.scan <- reclassify(summer.scandinavia, cbind(-Inf, 0, NA), right=FALSE)
plot(summer.scan)
ndvi <- raster::extract(summer.scan,water.regions[missing.lines,], fun = mean, df = T, sp = T, na.rm = T,buffer=10,small = T)
saveRDS(ndvi,"missing.ndvi.Rdata")

ndvi.sf <- st_as_sf(ndvi)
summer.scan.df <-as.data.frame(summer.scan,xy=T) 
ggplot()+geom_sf(data=ndvi.sf,aes(fill=layer))

missing.ndvi.df <- ndvi@data
names(missing.ndvi.df) <- c("gid","ndvi")
missing.ndvi.df$ndvi.value <- (floor(missing.ndvi.df$ndvi)/10)/1000
missing.ndvi.df$flag.value <- missing.ndvi.df$ndvi - (floor(missing.ndvi.df$ndvi)/10*10+1) 

saveRDS(missing.ndvi.df, "missing.ndvi.df.Rdata")
```
```{r join-ndvi, eval = F}
missing.ndvi <- readRDS("missing.ndvi.Rdata")
summer.ndvi.total <- rbind(filter(summer.ndvi.wr,!is.na(ndvi)),missing.ndvi.df)
saveRDS(summer.ndvi.total,"summer.ndvi.total.Rdata")

summer.ndvi.sf <- merge(water.regions,summer.ndvi.total,by.x = "gid", by.y = "gid")
saveRDS(summer.ndvi.sf,"summer.ndvi.sf.Rdata")
ggplot()+geom_sf(data=summer.ndvi.sf,aes(fill=ndvi.value))
```
```{r plot-ndvi, eval = F}
summer.ndvi.sf <- readRDS("WR/summer.ndvi.sf.Rdata")
ggplot()+geom_sf(data=summer.ndvi.sf,aes(fill=ndvi.value))
```

## Runoff
```{r runoff-wr, eval = F}

runoff.raster <- "CORDEX/mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"
runoff.nc <- nc_open(runoff.raster)

runoff.stack <- raster::stack(runoff.raster, bands = c(1441:1812))
runoff.mean <- runoff.stack %>% mean() 

wr.sf <- readRDS("WR/wr.sf.rds")
runoff.wr95 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)
names(runoff.wr95) <- c("gid","area","runoff")
saveRDS(runoff.wr95,"WR/runoff.wr95.rds")

ggplot(st_as_sf(runoff.wr95))+geom_sf(aes(fill=runoff,col=runoff))

```

```{r runoff-wr-old, eval = F}
#runoff.tbl <- tbl(con,sql("SELECT ebint,mrros FROM public.cordex_prelim"))
#runoff.df <- runoff.tbl %>% as.data.frame()

water.regions <- readRDS("water.regions.Rdata")

runoff.file.60s <- "CORDEX/mrros_EUR-11_NCC-NorESM1-M_historical_r1i1p1_DMI-HIRHAM5_v3_mon_196101-197012.nc"
runoff.file.70s <- "CORDEX/mrros_EUR-11_NCC-NorESM1-M_historical_r1i1p1_DMI-HIRHAM5_v3_mon_197101-198012.nc"
runoff.file.80s <- "CORDEX/mrros_EUR-11_NCC-NorESM1-M_historical_r1i1p1_DMI-HIRHAM5_v3_mon_198101-199012.nc"
#runoff.file.80s <- "CORDEX/mrros_EUR-11_NCC-NorESM1-M_historical_r1i1p1_DMI-HIRHAM5_v3_mon_19101-199012.nc"


# get coordinates
runoff.nc <- nc_open(runoff.file.60s)
runoff.info <- GDALinfo(runoff.nc)
attr.runoff <- attr(runoff.info,"mdata")

rot.info <- attr.runoff[grep("^rotated",attr(runoff.info,"mdata"))]
coord <- sapply(rot.info, FUN = function(x) {
  unlist(str_split(x, pattern = "="))[2]})
coord.num<- round(as.numeric(coord[2:3]),2)

y <- coord.num[1]
x <- coord.num[2]

target.crs <- paste0("+proj=ob_tran +o_proj=longlat +o_lon_p=" , 
                     x, " +o_lat_p=", y, 
                     " +lon_0=180 +to_meter=0.0174532925199433")

# 60s
runoff.60.stack <- stack(runoff.file.60s, varname = "mrros")
runoff.60.mean  <- mean(runoff.60.stack)

projection(runoff.60.mean) <- CRS("EPSG:4326")
runoff.60.rotated <- projectRaster(runoff.60.mean,crs = target.crs)
runoff.60.wgs84 <- runoff.60.rotated
projection(runoff.60.wgs84) <- CRS("EPSG:4326")

for(x in 1:287){
  start.x <- (x-1)*1000+1
  end.x <- x*1000
  runoff.60s <- raster::extract(runoff.60.wgs84,water.regions[start.x:end.x,], fun = mean, na.rm = T, df = T, exact = F, sp = T)
  runoff.60.df <- runoff.60s@data
  names(runoff.60.df) <- c("ebint","runoff.60s")
  name.x <- paste("WR/runoff/runoff.60",x,"Rdata",sep = ".")
  saveRDS(runoff.60.df,name.x)
}

start.x <- (288-1)*1000+1
runoff.60.288 <- raster::extract(runoff.60.wgs84,water.regions[start.x:287886,], fun = mean, df = T, sp = T)
saveRDS(runoff.60.288,"WR/runoff/runoff.60.288.Rdata")



# 70s
runoff.70.stack <- stack(runoff.file.70s, varname = "mrros")
runoff.70.mean  <- mean(runoff.70.stack)

projection(runoff.70.mean) <- CRS("EPSG:4326")
runoff.70.rotated <- projectRaster(runoff.70.mean,crs = target.crs)
runoff.70.wgs84 <- runoff.70.rotated
projection(runoff.70.wgs84) <- CRS("EPSG:4326")

for(x in 99:287){
	start.x <- (x-1)*1000+1
	end.x <- x*1000
	runoff.70s <- raster::extract(runoff.70.wgs84,water.regions[start.x:end.x,],fun = mean, na.rM = T, df = T, exact = F, sp = T)
	runoff.70.df <- runoff.70s@data
	names(runoff.70.df) <- c("ebint","runoff.70")
	name.x <- paste("WR/runoff/runoff.70",x,"Rdata",sep = ".")
	saveRDS(runoff.70.df,name.x)
}

start.x <- (288-1)*1000+1
runoff.70.288 <- raster::extract(runoff.70.wgs84,water.regions[start.x:287886,],fun = mean, na.rM = T, df = T, exact = F, sp = T)
saveRDS(runoff.70.288,"WR/runoff/runoff.70.288.Rdata")



# 80s
runoff.80.stack <- stack(runoff.file.80s, varname = "mrros")
runoff.80.mean  <- mean(runoff.80.stack)

projection(runoff.80.mean) <- CRS("EPSG:4326")
runoff.80.rotated <- projectRaster(runoff.80.mean,crs = target.crs)
runoff.80.wgs84 <- runoff.80.rotated
projection(runoff.80.wgs84) <- CRS("EPSG:4326")


for(x in 1:287){
	start.x <- (x-1)*1000+1
	end.x <- x*1000
	runoff.80s <- raster::extract(runoff.80.wgs84,water.regions[start.x:end.x,],fun = mean, na.rM = T, df = T, exact = F, sp = T)
	runoff.80.df <- runoff.80s@data
	names(runoff.80.df) <- c("ebint","runoff.80")
	name.x <- paste("WR/runoff/runoff.80",x,"Rdata",sep = ".")
	saveRDS(runoff.80.df,name.x)
}

start.x <- (288-1)*1000+1
runoff.80.288 <- raster::extract(runoff.80.wgs84,water.regions[start.x:287886,],fun = mean, na.rM = T, df = T, exact = F, sp = T)
saveRDS(runoff.80.288,"WR/runoff/runoff.80.288.Rdata")

```


```{r gather-runoff-wr-old, eval = F}
list.files.runoff.60 <- list.files("WR/runoff",pattern = "runoff.60",full.names = T)

df.runoff.60 <- readRDS(list.files.runoff.60[210])@data %>% setNames(c("ebint","runoff.60s"))
for(x in list.files.runoff.60[-210]){
  df <- readRDS(x)
  df.runoff.60 <<- rbind(df.runoff.60,df)
}

list.files.runoff.70 <- list.files("WR/runoff",pattern = "runoff.70",full.names = T)

df.runoff.70 <- readRDS(list.files.runoff.70[210])@data %>% setNames(c("ebint","runoff.70"))
for(x in list.files.runoff.70[-210]){
  df <- readRDS(x)
  df.runoff.70 <<- rbind(df.runoff.70,df)
}

list.files.runoff.80 <- list.files("WR/runoff",pattern = "runoff.80",full.names = T)

df.runoff.80 <- readRDS(list.files.runoff.80[1])
for(x in list.files.runoff.80[-1]){
  df <- readRDS(x)
  df.runoff.80 <<- rbind(df.runoff.80,df)
}

runoff.df.wr <- merge(df.runoff.60,df.runoff.70, by = "ebint") %>% merge(df.runoff.80, by = "ebint")
runoff.df.wr$mean.runoff <- rowMeans(runoff.df.wr[,2:4])
saveRDS(runoff.df.wr, "runoff.df.wr.Rdata")


runoff.sf <- merge(water.regions,runoff.df.wr,by.x = "gid", by.y = "ebint")
saveRDS(runoff.sf,"runoff.sf.Rdata")
```


## Bogs and forest

```{r wr.bogs.forest, eval = F}
library(rgdal)
water.regions <- readRDS("water.regions.Rdata")
wr.corine <- st_transform(water.regions,CRS("EPSG:3035"))
saveRDS(wr.corine,"wr.corine.Rdata")
wr.corine <- readRDS("wr.corine.Rdata")
corine <- raster::raster("Corine_Land_Cover/U2006_CLC2000_V2020_20u1.tif")

for(x in 2615:2880){
  start.x <- (x-1)*100+1
  end.x <- x*100
  clc <- raster::extract(corine,wr.corine[start.x:end.x,])
  name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
  saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[start.x:end.x,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))
}

start.x <- 287801
end.x <- 287886
clc <- raster::extract(corine,wr.corine[start.x:end.x,])
name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[start.x:end.x,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))

miss <- c(74, 91,133, 138, 161, 304, 668, 1354, 1391, 1592, 1634, 1825, 2000, 2014, 2040, 2048, 2078, 2327, 2503, 2542, 2614)

library(R.utils)

for(x in miss){
  start.x <- (x-1)*100+1
  end.x <- x*100
  wr.x <- wr.corine[start.x:end.x,]
  for (y in 1:100){
  tryCatch(expr = {
    withTimeout(expr = {
    clc <- raster::extract(corine,wr.x[y,])
    name.x <- paste("WR/clc/clc.wr",x,y,"Rdata",sep = ".")
    saveRDS(clc,name.x)
    clc.tab <- sapply(clc, function(x) tabulate(x,45))
    clc.tab.area <- clc.tab*prod(res(corine))
    catchment.area <- colSums(clc.tab.area)
    clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
    names(clc.tab.prop) <- wr.x[y,]$gid
    saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,y,"Rdata",sep="."))
  }, 
  substitute = F, timeout = 15*60, onTimeout = "error")
  },
  
  finally = TimeoutException(next)
  )
  }
}

big <- c(91.18,91.19,133.51,138.89,161.61,304.92,668.15,1391.8,1592.6,1634.63,1825.60,2000.90,2040.26,2048.29,2078.63,2503.89,2542.2,2614.78)


x <- big[18]
start.x <- (trunc(x)-1)*100+(x-floor(x))*100
clc <- raster::extract(corine,wr.corine[start.x,])
name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[start.x,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))

```
```{r missing again, eval = F}
wr.corine <- readRDS("wr.corine.Rdata")


#missing by 100: 48,1727
for(x in c(1727)){
  start.x <- (x-1)*100+1
  end.x <- x*100
  wr.x <- wr.corine[start.x:end.x,]
  for (y in 1:100){
  tryCatch(expr = {
    withTimeout(expr = {
    clc <- raster::extract(corine,wr.x[y,])
    name.x <- paste("WR/clc/clc.wr",x,y,"Rdata",sep = ".")
    saveRDS(clc,name.x)
    clc.tab <- sapply(clc, function(x) tabulate(x,45))
    clc.tab.area <- clc.tab*prod(res(corine))
    catchment.area <- colSums(clc.tab.area)
    clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
    names(clc.tab.prop) <- wr.x[y,]$gid
    saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,y,"Rdata",sep="."))
  }, 
  substitute = F, timeout = 15*60, onTimeout = "error")
  },
  
  finally = TimeoutException(next)
  )
  }
}

missing.bis <- c(48.46,74.78,1391.9,1727.37,1825.60,2000.90,2014.83,2327.36)

x <- missing.bis[8]
start.x <- (trunc(x)-1)*100+(x-floor(x))*100
clc <- raster::extract(corine,wr.corine[start.x,])
name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[start.x,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))

# missing again: 74.78, 1825.60, 2000.90, + a hundred missing Only run 74.78
x <- 74.78
start.x <- (trunc(x)-1)*100+(x-floor(x))*100
clc <- raster::extract(corine,wr.corine[start.x,])
name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[start.x,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))

last.missing <- setdiff(wr.corine$gid,clc.wr.sf$gid) 

for(x in last.missing){
  line <- which(wr.corine$gid == x) 
  clc <- raster::extract(corine,wr.corine[line,])
  name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
  saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[line,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))
}

```

```{r gather-clc-wr, eval = F}
list.clc.tabs <- list.files("WR/clc",pattern = "clc.tab.prop", full.names = T)
list.clc <- lapply(list.clc.tabs,readRDS)

clc.wr <- list.clc[[1]] %>% t() %>% as.data.frame()
clc.wr$gid <- attr(list.clc[[1]],"names")[1:100]
for(x in 2:length(list.clc)){
  m <- list.clc[[x]] 
  df <- m %>% t() %>% as.data.frame() 
  df$gid <- attr(m,"names")[1:dim(df)[1]]
  clc.wr <<- rbind(clc.wr, df)
  }

saveRDS(clc.wr,"WR/clc/clc.wr.Rdata")


```
```{r get-forest-bogs, eval = F}
clc.wr <- readRDS("WR/clc/clc.wr.Rdata")
clc.wr.bogs <- select(clc.wr, c("gid","V36")) %>% setNames(c("gid","bogs"))
clc.wr.forest <- select(clc.wr,c("V23","V24","V25")) %>% rowSums() %>% as.data.frame() %>% setNames("forest")

clc.wr.sum <- cbind(clc.wr.bogs, clc.wr.forest)
saveRDS(clc.wr.sum,"WR/clc/clc.wr.sum.Rdata")

clc.wr.sf <- merge(water.regions,clc.wr.sum,by.x.= "gid",by.y = "gid")
saveRDS(clc.wr.sf,"clc.wr.sf.Rdata")
clc.wr.sf <- readRDS("clc.wr.sf.Rdata")
```
```{r plot-forest, eval = F}
clc.wr.sf <- readRDS("WR/clc.wr.sf.Rdata")
wr.forest <- ggplot()+geom_sf(data=clc.wr.sf,aes(fill=forest, col = forest))+
  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1, 
                       name = "Forest proportion")+
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = wr.forest, filename = "WR/wr.forest.png",dpi = "retina", width = 6, height = 8, units = "cm")
```

## Temperature and precipitation

Temperature in historical worldclim is in °C * 10 (to reduce file size). Precipitation are average monthly precipitation in mm. Here we use the mean monthly precipitation and temperature for the period 1970-2000. 

```{r model-ndvi-past, eval = F}
wr.sf <- readRDS("WR/wr.sf.rds")

bio.fennoscandia <- raster::getData(name = "worldclim", var = "bio", res = 2.5)

temp.wr <- raster::extract(bio.fennoscandia$bio1, wr.sf, fun = mean, df = T, sp = T, na.rm = T)
names(temp.wr) <- c("gid","area","temp")
temp.wr$temp <- temp.wr$temp / 10
saveRDS(temp.wr,"WR/temp.wr.rds")
#temp.wr <- readRDS("WR/temp.wr.rds")

prec.wr <- raster::extract(bio.fennoscandia$bio12, wr.sf, fun = mean, df = T, sp = T, na.rm = T)
names(prec.wr) <- c("gid","area","prec")
saveRDS(prec.wr,"WR/prec.wr.rds")
#prec.wr <- readRDS("WR/prec.wr.rds")

tp <- cbind(wr.sf[,1],temp.wr[,3]) %>% cbind(prec.wr[,3])
saveRDS(tp,"WR/tp.rds")

```

## Elevation
```{r altitude-wr}
wr.sf <- readRDS("WR/wr.sf.rds")
alt.nor <- raster::getData("alt",country = "NOR", mask = T)
alt.swe <- raster::getData("alt",country = "SWE", mask = T)
alt.fin <- raster::getData("alt",country = "FIN", mask = T)

alt.list <- list(alt.nor,alt.swe,alt.fin)
alt <- do.call(raster::merge,alt.list)

alt.wr <- raster::extract(alt, dplyr::select(wr.sf, c("gid","geom")), sp = T, fun = mean, df = T, na.rm = T)
names(alt.wr) <- c("gid","alt")
saveRDS(alt.wr,"WR/alt.wr.rds")
```
## Gathers wr dataset

```{r gather-dataset, eval = F}
ndvi.wr <- readRDS("WR/ndvi.wr.rds")
runoff.wr95 <- readRDS("WR/runoff.wr95.rds")
clc.wr.sum <- readRDS("WR/clc/clc.wr.sum.Rdata")
tp <- readRDS("WR/tp.rds")
wr.sf <- readRDS("WR/wr.sf.rds")

all.wr.sf <- merge(wr.sf,runoff.wr95,by = "gid") %>% merge(ndvi.wr,by="gid") %>% merge(clc.wr.sum,by = "gid") %>% merge(st_drop_geometry(tp),by = "gid") %>% merge(alt.wr, by = "gid")
all.wr.sf$area.x <- NULL
all.wr.sf$area.y <- NULL

saveRDS(all.wr.sf, "WR/all.wr.sf.rds")

```

## WR dataframe


```{r final-df, eval = F}

all.wr.sf <- readRDS("WR/all.wr.sf.rds")

wr.sf.95 <- all.wr.sf %>% filter(ndvi != 0) %>% filter(runoff > 0) %>% filter(is.na(bogs) == F) %>% filter(is.na(alt) == F)
wr.sf.95 <- wr.sf.95[!duplicated(wr.sf.95$gid),]
wr.sf.95$log.runoff <- log(wr.sf.95$runoff)


#map.wr95 <- ggplot()+geom_sf(data = wr.sf.95, aes(fill = ndvi, col = ndvi))+
#  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1, 
#                       name = "NDVI 1995")+
#  theme_minimal(base_size = 6)+
#  theme(legend.position = "bottom")
#ggsave(plot = map.wr95, filename = "WR/wr95.png",dpi = "retina", width = 10, height = 15, units = "cm")

sfc_point_to_matrix = function(x) {
  matrix(
    unlist(x, use.names = FALSE),
    nrow = length(x),
    byrow = TRUE,
    dimnames = list(1:length(x))
  )
}

wr.centroid <- st_centroid(wr.sf.95, of.largest.polygon = T)
coord <- sfc_point_to_matrix(wr.centroid$geometry) %>% as.data.frame() %>% setNames(c("Longitude","Latitude"))
wr.sf.95 <- cbind(wr.sf.95, coord)

saveRDS(wr.sf.95, "WR/wr.sf.95.rds")
```

```{r coordinates-wr}

saveRDS(wr.sf.95,"WR/wr.sf.95.rds")
```

```{r plot-variables, eval = F}
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")

wr.bogs.plot <- ggplot()+geom_sf(data = wr.sf.95,aes(fill=bogs,col=bogs))+ 
  scale_fill_gradient2(low="#CCCCCC",mid="#FFCC66",high = "#663300",midpoint = 0, aesthetics = c("fill","col"), name = "Proportion of bogs")+
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = wr.bogs.plot , filename = "WR/wr.bogs.plot.png",dpi = "retina", width = 6, height = 8, units = "cm")

wr.ndvi.plot <- ggplot()+geom_sf(data = wr.sf.95,aes(fill=ndvi,col=ndvi))+ 
 scale_fill_gradient2(low="#EEE9E9",mid="#FFFFBF",high = "#008B45",midpoint = 0, aesthetics = c("fill","col"),
                       name = "NDVI 1995") + 
   theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = wr.ndvi.plot , filename = "WR/wr.ndvi.plot.png",dpi = "retina", width = 6, height = 8, units = "cm")

wr.runoff.plot <- ggplot()+geom_sf(data = wr.sf.95,aes(fill=runoff,col=runoff))+ 
  scale_fill_gradient2(low="#CCCCCC",mid="#CCFFFF",high = "#003399",midpoint = 0, aesthetics = c("fill","col"))+
   theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = wr.runoff.plot , filename = "WR/wr.runoff.plot.png",dpi = "retina", width = 6, height = 8, units = "cm")

wr.log.runoff <- ggplot()+geom_sf(data = wr.sf.95,aes(fill=log.runoff,col=log.runoff))+ 
  scale_fill_gradient2(low="#CCCCCC",mid="#CCFFFF",high = "#003399",midpoint = 0, aesthetics = c("fill","col"))+
   theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = wr.log.runoff , filename = "WR/wr.log.runoff.png",dpi = "retina", width = 6, height = 8, units = "cm")

```



# Model prediction 1995

We model the mean TOC concentration in all the water region in 1995 based on the simple SEM model of the previous section, using NDVI, bogs and runoff as predictors.

## Neighbour matrix

```{r wr-km, eval = F}
wr.centroid <- st_centroid(wr.sf.95, of_largest_polygon = T)

wr.neigh.set <- knearneigh(wr.centroid, k = 100)
wr.neigh.nb <- knn2nb(wr.neigh.set)
wr.kmat <- nb2listw(wr.neigh.nb)
saveRDS(wr.kmat,"WR/wr.kmat.rds")

```

## Model TOC

```{r sem-model-toc-wr-95, eval = F}
library(spatialreg)
sem.fen.simple <- readRDS("sem.fen.simple.Rdata")
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")
fm <- log.toc~ndvi+log.runoff+bogs
wr.pred <- predict(sem.fen.simple,wr.sf.95,wr.kmat, pred.type = "TS",legacy.mixed = F, zero.policy = T) %>% as.data.frame()

sem.pred.wr <- cbind(wr.sf.95,wr.pred$fit)
sem.pred.wr$toc95 <- exp(sem.pred.wr$wr.pred.fit)

saveRDS(sem.pred.wr,"WR/sem.pred.wr.rds")

map.fit <- ggplot()+geom_sf(data = st_as_sf(sem.pred.wr), aes(fill = toc95, col = toc95))+
  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1, 
                       name = "Modelled TOC 1995 (mg/L)")+
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = map.fit, filename = "WR/wr.toc.png",dpi = "retina", width = 6, height = 8, units = "cm")

map.log <- ggplot()+geom_sf(data = sem.pred.wr, aes(fill = wr.pred.fit, col = wr.pred.fit))+
  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1, 
                       name = "Modelled log(TOC)")+
   theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
  
ggsave(plot = map.log, filename = "WR/wr.log.toc.png",dpi = "retina", width = 6, height = 8, units = "cm")
```


# Forecast

## Extract temperature and precipitation 

```{r extract-future-temp, eval = F}
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")

ssp126.cnrm.temp <- raster::raster("worldclim_future/wc2.1_2.5m_bioc_CNRM-CM6-1_ssp126_2041-2060.tif", band = 1)
ssp370.cnrm.temp <- raster::raster("worldclim_future/wc2.1_2.5m_bioc_CNRM-CM6-1_ssp370_2041-2060.tif", band = 1)

ssp126.temp.wr <- raster::extract(ssp126.cnrm.temp,select(wr.sf.95,c("gid","geometry")),fun=mean,df = T, sp = T, na.rm =T)
names(ssp126.temp.wr) <- c("gid", "temp126")
saveRDS(ssp126.temp.wr,"WR/ssp126.temp.wr.rds")

ssp370.temp.wr <- raster::extract(ssp370.cnrm.temp,select(wr.sf.95,c("gid","geometry")),fun=mean,df = T, sp = T, na.rm = T)
names(ssp370.temp.wr) <- c("gid", "temp370")
saveRDS(ssp370.temp.wr,"WR/ssp370.temp.wr.rds")
```

```{r extract-future-prec, eval = F}
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")

ssp126.cnrm.prec <- raster::raster("worldclim_future/wc2.1_2.5m_bioc_CNRM-CM6-1_ssp126_2041-2060.tif", band = 12)
ssp370.cnrm.prec <- raster::raster("worldclim_future/wc2.1_2.5m_bioc_CNRM-CM6-1_ssp370_2041-2060.tif", band = 12)

ssp126.prec.wr <- raster::extract(ssp126.cnrm.prec,select(wr.sf.95,c("gid","geometry")),fun=mean,df = T, sp = T, na.rm = T)
names(ssp126.prec.wr) <- c("gid", "prec126")
saveRDS(ssp126.prec.wr,"WR/ssp126.prec.wr.rds")

ssp370.prec.wr <- raster::extract(ssp370.cnrm.prec,dplyr::select(wr.sf.95,c("gid","geometry")),fun=mean,df = T, sp = T, na.rm = T)
names(ssp370.prec.wr) <- c("gid", "prec370")
saveRDS(ssp370.prec.wr,"WR/ssp370.prec.wr.rds")
```

```{r merge-temp-prec, eval = F}
ssp126.temp.wr <- readRDS("WR/ssp126.temp.wr.rds")
ssp370.temp.wr <- readRDS("WR/ssp370.temp.wr.rds")
ssp126.prec.wr <- readRDS("WR/ssp126.prec.wr.rds")
ssp370.prec.wr <- readRDS("WR/ssp370.prec.wr.rds")

# SSP126
df.ssp126 <- merge(ssp126.temp.wr, ssp126.prec.wr,by = "gid") %>% setNames(c("gid","temp","prec")) %>% merge(select(wr.sf.95, c("gid","Latitude")), by = "gid")
saveRDS(df.ssp126, "WR/df.ssp126.rds")

# SSP 370
df.ssp370 <- merge(ssp370.temp.wr, ssp370.prec.wr, by = "gid") %>% setNames(c("gid","temp","prec")) %>% merge(select(wr.sf.95, c("gid","Latitude")), by = "gid")
saveRDS(df.ssp370, "WR/df.ssp370.rds")
```

## Forecast NDVI 

### NDVI model based on past temperature and precipitation values

We model NDVI based on temperature and precipitation, and use this model to predict the future NDVI in 2050. 
Choice of future data: ssp 126 as best scenario, ssp 370 as worse scenario @Hausfather2019 @CORDEX2021
CRNM according to @Raju2020



```{r lm-model-ndvi, eval = F}
wr.kmat <- readRDS("WR/wr.kmat.rds")
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")
#ndvi.model <- errorsarlm(formula = ndvi~temp+log(prec), data = wr.sf.95,wr.kmat, method = "Matrix_J")

ndvi.model <- lm(formula = ndvi~log(prec)+temp*Latitude, data = wr.sf.95)

saveRDS(ndvi.model, "WR/ndvi.model.rds")

residuals <- cbind(wr.sf.95, ndvi.model$residuals)

ndvi.residuals.plot <- ggplot(residuals)+geom_sf(aes(fill=ndvi.model.residuals,col=ndvi.model.residuals))+
  scale_fill_gradient2(low="#B03060",mid="#FFFFBF",high = "#008B45",midpoint = 0, aesthetics = c("fill","col"),
                       name = "NDVI model residuals") + 
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot =ndvi.residuals.plot,filename = "WR/ndvi.residuals.plot.png",dpi = "retina", width = 6, height = 8, units = "cm")                   
                   
```

```{r sem-model-ndvi, eval = F}
wr.kmat <- readRDS("WR/wr.kmat.rds")
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")
#ndvi.model <- errorsarlm(formula = ndvi~temp+log(prec), data = wr.sf.95,wr.kmat, method = "Matrix_J")

sem.ndvi.model <- errorsarlm(formula = ndvi~log(prec)+temp+Latitude, data = wr.sf.95, listw = wr.kmat)

saveRDS(sem.ndvi.model, "WR/sem.ndvi.model.rds")

sem.residuals <- cbind(wr.sf.95, sem.ndvi.model$residuals)

ndvi.sem.residuals.plot <- ggplot(sem.residuals)+geom_sf(aes(fill=sem.ndvi.model.residuals,col=sem.ndvi.model.residuals))+
  scale_fill_gradient2(low="#B03060",mid="#FFFFBF",high = "#008B45",midpoint = 0, aesthetics = c("fill","col"),
                       name = "NDVI model residuals") + 
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = ndvi.sem.residuals.plot,filename = "WR/ndvi.sem.residuals.plot.png",dpi = "retina", width = 6, height = 8, units = "cm")                

AIC1 <- 2*(3-1)-2*sem.ndvi.model$LL
  
  
# with altitude
sem.ndvi.model.2 <- errorsarlm(formula = ndvi~log(prec)+temp+alt, data = wr.sf.95, listw = wr.kmat)
AIC2 <- 2*(3-1)-2*sem.ndvi.model.2$LL

saveRDS(sem.ndvi.model.2, "WR/sem.ndvi.model.2.rds")

sem.residuals.2 <- cbind(wr.sf.95, sem.ndvi.model.2$residuals)

ndvi.sem.residuals.plot.2 <- ggplot(sem.residuals.2)+geom_sf(aes(fill=sem.ndvi.model.2.residuals,col=sem.ndvi.model.2.residuals))+
  scale_fill_gradient2(low="#B03060",mid="#FFFFBF",high = "#008B45",midpoint = 0, aesthetics = c("fill","col"),
                       name = "NDVI model residuals") + 
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = ndvi.sem.residuals.plot.2,filename = "WR/ndvi.sem.residuals.plot.2.png",dpi = "retina", width = 6, height = 8, units = "cm")                   
    
                   
```


### Forecast

```{r model-future-ndvi, eval = F}
df.ssp126 <- readRDS("WR/df.ssp126.rds")
df.ssp370 <- readRDS("WR/df.ssp370.rds")
ndvi.model <- readRDS("WR/sem.ndvi.model.2.rds")
wr.kmat <- readRDS("WR/wr.kmat.rds")
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")

ndvi.ssp126 <- predict(object = ndvi.model, newdata = df.ssp126, pred.type = "TS", legacy.mixed = F, zero.policy = T)

ndvi.ssp126.fit <- cbind(df.ssp126, ndvi.ssp126) %>% setNames(c("gid","temp126","prec126","Latitude","geometry","ndvi126")) %>% merge(select(st_drop_geometry(wr.sf.95),c("gid","temp","prec","ndvi")), by = "gid") %>% st_as_sf()

saveRDS(ndvi.ssp126.fit,"WR/ndvi.ssp126.fit.rds")

ndvi.ssp370 <- predict(object = ndvi.model, newdata = df.ssp370, listw = wr.kmat, pred.type = "TS", legacy.mixed = F, zero.policy = T)

ndvi.ssp370.fit <- cbind(df.ssp370, ndvi.ssp370) %>% setNames(c("gid","temp370","prec370","Latitude","geometry","ndvi370")) %>% merge(select(st_drop_geometry(wr.sf.95),c("gid","temp","prec","ndvi")), by = "gid") %>% st_as_sf()

saveRDS(ndvi.ssp370.fit,"WR/ndvi.ssp370.fit.rds")
```

### Plots

```{r plot-future-temp-prec, eval = F}
ndvi.ssp126.fit <- readRDS("WR/ndvi.ssp126.fit.rds")
ndvi.ssp370.fit <- readRDS("WR/ndvi.ssp370.fit.rds")

limits.temp <- c(min(c(ndvi.ssp126.fit$temp126,ndvi.ssp370.fit$temp370)), max(c(ndvi.ssp126.fit$temp126,ndvi.ssp370.fit$temp370)))
limits.prec <- c(min(c(ndvi.ssp126.fit$prec126,ndvi.ssp370.fit$prec370)), max(c(ndvi.ssp126.fit$prec126,ndvi.ssp370.fit$prec370)))
limits.diff.temp <- c(min(c(ndvi.ssp126.fit$temp126-ndvi.ssp126.fit$temp,ndvi.ssp370.fit$temp370-ndvi.ssp370.fit$temp)), max(c(ndvi.ssp126.fit$temp126-ndvi.ssp126.fit$temp,ndvi.ssp370.fit$temp370-ndvi.ssp370.fit$temp)))
limits.diff.prec <- c(min(c(ndvi.ssp126.fit$prec126-ndvi.ssp126.fit$prec,ndvi.ssp370.fit$prec370-ndvi.ssp370.fit$prec)), max(c(ndvi.ssp126.fit$prec126-ndvi.ssp126.fit$prec,ndvi.ssp370.fit$prec370-ndvi.ssp370.fit$prec)))

ssp126.temp.plot <- ggplot()+geom_sf(data=st_as_sf(ndvi.ssp126.fit),aes(fill= temp126 , col = temp126))+
  scale_fill_gradient2(low="#EEE9E9",mid="#FFFFBF",high = "#990000",midpoint = 0, aesthetics = c("fill","col"),
                       name = "2041-2060 average temperature\n under SSP126 (°C)", limits = limits.temp) + 
  theme_minimal(base_size = 6) +
  theme(legend.position = "bottom") 
ggsave(plot = ssp126.temp.plot,filename = "WR/ssp126.temp.png",dpi = "retina", width = 6, height = 8, units = "cm")

ssp126.diff.temp <- ggplot()+geom_sf(data=st_as_sf(ndvi.ssp126.fit),aes(fill= temp126-temp , col = temp126-temp))+
  scale_fill_gradient2(low="#EEE9E9",mid="#FFFFBF",high = "#990000",midpoint = 0, aesthetics = c("fill","col"),
                       name = "Difference temperature 1995-2050\n under SSP126 (°C)", limits = limits.diff.temp) + 
  theme_minimal(base_size = 6) +
  theme(legend.position = "bottom") 
ggsave(plot = ssp126.diff.temp,filename = "WR/ssp126.diff.temp.png",dpi = "retina", width = 6, height = 8, units = "cm")

ssp370.temp.plot <- ggplot()+geom_sf(data=st_as_sf(ndvi.ssp370.fit),aes(fill= temp370 , col = temp370))+
  scale_fill_gradient2(low="#EEE9E9",mid="#FFFFBF",high = "#990000",midpoint = 0, aesthetics = c("fill","col"), 
                       name = "2041-2060 average temperature\n under SSP370 (°C)", limits = limits.temp) +
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = ssp370.temp.plot,filename = "WR/ssp370.temp.png",dpi = "retina", width = 6, height = 8, units = "cm")

ssp370.diff.temp <- ggplot()+geom_sf(data=st_as_sf(ndvi.ssp370.fit),aes(fill= temp370-temp , col = temp370-temp))+
  scale_fill_gradient2(low="#EEE9E9",mid="#FFFFBF",high = "#990000",midpoint = 0, aesthetics = c("fill","col"), 
                       name = "Difference temperature 1995-2050\n under SSP370 (°C)", limits = limits.diff.temp) +
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = ssp370.diff.temp,filename = "WR/ssp370.diff.temp.png",dpi = "retina", width = 6, height = 8, units = "cm")

ssp126.prec.plot <- ggplot()+geom_sf(data=st_as_sf(ndvi.ssp126.fit),aes(fill=prec126, col = prec126))+
  scale_fill_gradient2(low="#EEE9E9",mid="#CAE1FF",high = "#00688B",midpoint = 0, aesthetics = c("fill","col"), 
                       name = "2041-2060 average precipitation\n under SSP126 (mm/year)", limits = limits.prec) + 
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = ssp126.prec.plot,filename = "WR/ssp126.prec.png",dpi = "retina", width = 6, height = 8, units = "cm")

ssp126.diff.prec <- ggplot()+geom_sf(data=st_as_sf(ndvi.ssp126.fit),aes(fill=prec126-prec, col = prec126-prec))+
  scale_fill_gradient2(low="#B03060",mid="#CDC9C9",high = "#00688B",midpoint = 0, aesthetics = c("fill","col"), 
                       name = "Difference precipitation 1995-2050\n under SSP126 (mm/year)", limits = limits.diff.prec) + 
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = ssp126.diff.prec,filename = "WR/ssp126.diff.prec.png",dpi = "retina", width = 6, height = 8, units = "cm")

ssp370.prec.plot <- ggplot()+geom_sf(data=st_as_sf(ndvi.ssp370.fit),aes(fill=prec370, col = prec370))+
  scale_fill_gradient2(low="#EEE9E9",mid="#CAE1FF",high = "#00688B",midpoint = 0, aesthetics = c("fill","col"), 
                       name = "2041-2060 average precipitation\n under SSP370 (mm/year)", limits = limits.prec) +
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = ssp370.prec.plot,filename = "WR/ssp370.prec.png",dpi = "retina", width = 6, height = 8, units = "cm")

ssp370.diff.prec <- ggplot()+geom_sf(data=st_as_sf(ndvi.ssp370.fit),aes(fill=prec370-prec, col = prec370-prec))+
  scale_fill_gradient2(low="#B03060",mid="#CDC9C9",high = "#00688B",midpoint = 0, aesthetics = c("fill","col"), 
                       name = "Difference precipitation 1995-2050\n under SSP370 (mm/year)", limits = limits.diff.prec) +
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = ssp370.diff.prec,filename = "WR/ssp370.diff.prec.png",dpi = "retina", width = 6, height = 8, units = "cm")

```

```{r plot-future-ndvi, eval = F}
ndvi.ssp126.fit <- readRDS("WR/ndvi.ssp126.fit.rds")
ndvi.ssp370.fit <- readRDS("WR/ndvi.ssp370.fit.rds")

limits.ndvi <- c(min(c(ndvi.ssp126.fit$ndvi126,ndvi.ssp370.fit$ndvi370)), max(c(ndvi.ssp126.fit$ndvi126,ndvi.ssp370.fit$ndvi370)))
limits.diff.ndvi <- c(min(c(ndvi.ssp126.fit$ndvi126-ndvi.ssp126.fit$ndvi,ndvi.ssp370.fit$ndvi370-ndvi.ssp370.fit$ndvi)), max(c(ndvi.ssp126.fit$ndvi126-ndvi.ssp126.fit$ndvi,ndvi.ssp370.fit$ndvi370-ndvi.ssp370.fit$ndvi)))

ssp126.diff.ndvi <- ggplot()+geom_sf(data=ndvi.ssp126.fit,aes(fill=ndvi126-ndvi, col = ndvi126-ndvi)) + 
  scale_fill_gradient2(low="#B03060",mid="#FFFFBF",high = "#008B45",midpoint = 0, aesthetics = c("fill","col"),
                       name = "Difference NDVI 1995-2050\n under SSP126", limits = limits.diff.ndvi) + 
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = ssp126.diff.ndvi,filename = "WR/ssp126.ndvi.diff.png",dpi = "retina", width = 6, height = 8, units = "cm")

ssp126.ndvi <- ggplot()+geom_sf(data=ndvi.ssp126.fit,aes(fill=ndvi126, col = ndvi126)) + 
  scale_fill_gradient2(low="#EEE9E9",mid="#FFFFBF",high = "#008B45",midpoint = 0.5, aesthetics = c("fill","col"),
                       name = "NDVI 2050 under SSP126", limits = limits.ndvi) + 
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = ssp126.ndvi,filename = "WR/ssp126.ndvi.png",dpi = "retina", width = 6, height = 8, units = "cm")

ssp370.diff.ndvi <- ggplot()+geom_sf(data=ndvi.ssp370.fit,aes(fill=ndvi370-ndvi, col = ndvi370-ndvi))+ 
  scale_fill_gradient2(low="#B03060",mid="#FFFFBF",high = "#008B45",midpoint = 0, aesthetics = c("fill","col"),
                       name = "Difference NDVI 1995-2050\n under SSP370", limits = limits.diff.ndvi) + 
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = ssp370.diff.ndvi,filename = "WR/ssp370.ndvi.diff.png",dpi = "retina", width = 6, height = 8, units = "cm")

ssp370.ndvi <- ggplot()+geom_sf(data=ndvi.ssp370.fit,aes(fill=ndvi370,col=ndvi370)) + 
  scale_fill_gradient2(low="#EEE9E9",mid="#FFFFBF",high = "#008B45",midpoint = 0.5, aesthetics = c("fill","col"),
                       name = "NDVI 2050 under SSP370", limits = limits.ndvi) + 
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = ssp370.ndvi,filename = "WR/ssp370.ndvi.png",dpi = "retina", width = 6, height = 8, units = "cm")

```

## Forecast runoff

### Extraction of CMIP6 data

In the historical dataset in Worldclim, the runoff is given as a yearly average in kg/m2/s, or mm/s. 

In the CNRM-CM6 forecast we get the monthly forecast for runoff (in mm/s). 

```{r extract-future-runoff, eval = F}
wr.sf <- readRDS("WR/wr.sf.rds")

ssp126.runoff.wr <- raster::stack("CORDEX_future/mrros_Lmon_CNRM-CM6-1-HR_ssp126_r1i1p1f2_gr_201501-210012.nc", bands = c(313:552))
ssp126.runoff.wr.mean <- ssp126.runoff.wr %>% mean() 

ssp126.runoff <- raster::extract(ssp126.runoff.wr.mean,dplyr::select(wr.sf,c("gid","geom")),fun=mean,df = T, sp = T)
names(ssp126.runoff) <- c("gid","runoff126")
saveRDS(ssp126.runoff,"WR/ssp126.runoff.rds")

ssp370.runoff.wr <- raster::stack("CORDEX_future/mrros_Lmon_CNRM-CM6-1-HR_ssp370_r1i1p1f2_gr_201501-210012.nc", bands = c(313:552))
ssp370.runoff.wr.mean <- ssp370.runoff.wr %>% mean()

ssp370.runoff <- raster::extract(ssp370.runoff.wr.mean,dplyr::select(wr.sf,c("gid","geom")),fun=mean,df = T, sp = T)
names(ssp370.runoff) <- c("gid","runoff370")
saveRDS(ssp370.runoff,"WR/ssp370.runoff.rds")
```

### Plots

```{r plot-future-runoff, eval = F}
ssp126.runoff <- readRDS("WR/ssp126.runoff.rds")
ssp370.runoff <- readRDS("WR/ssp370.runoff.rds")
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")

runoff.126 <- merge(select(wr.sf.95,c("gid","runoff","log.runoff")),ssp126.runoff, by = "gid")
runoff.370 <- merge(select(wr.sf.95,c("gid","runoff","log.runoff")),ssp370.runoff, by = "gid")

limits.runoff <- c(min(c(runoff.126$runoff126,runoff.370$runoff370)), max(c(runoff.126$runoff126,runoff.370$runoff370)))
limits.diff.runoff <- c(min(c(runoff.126$runoff126-runoff.126$runoff,runoff.370$runoff370-runoff.370$runoff)), max(c(runoff.126$runoff126-runoff.126$runoff,runoff.370$runoff370-runoff.370$runoff)))

ssp126.runoff.plot <- ggplot()+geom_sf(data = runoff.126,aes(fill=runoff126,col=runoff126))+ 
  scale_fill_gradient2(low="#CCCCCC",mid="#CCFFFF",high = "#003399",midpoint = 0, aesthetics = c("fill","col"), name = "Average runoff 2041-2060\n under SSP126 in mm/s", limits = limits.runoff)+
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = ssp126.runoff.plot , filename = "WR/ssp126.runoff.png",dpi = "retina", width = 6, height = 8, units = "cm")

ssp126.runoff.diff <- ggplot()+geom_sf(data = runoff.126,aes(fill=runoff126-runoff,col=runoff126-runoff))+ 
  scale_fill_gradient2(low="#B03060",mid="#FFFAFA",high = "#003399",midpoint = 0, aesthetics = c("fill","col"), name = "Difference runoff 1995-2050\n under SSP126 in mm/s", limits = limits.diff.runoff)+
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = ssp126.runoff.diff , filename = "WR/ssp126.runoff.diff.png",dpi = "retina", width = 6, height = 8, units = "cm")

ssp370.runoff.plot <- ggplot()+geom_sf(data = runoff.370,aes(fill=runoff370,col=runoff370))+ 
  scale_fill_gradient2(low="#CCCCCC",mid="#CCFFFF",high = "#003399",midpoint = 0, aesthetics = c("fill","col"), name = "Average runoff 2041-2060\n under SSP370 in mm/s", limits = limits.runoff)+
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = ssp370.runoff.plot , filename = "WR/ssp370.runoff.png",dpi = "retina", width = 6, height = 8, units = "cm")

ssp370.runoff.diff <- ggplot()+geom_sf(data = runoff.370,aes(fill=runoff370-runoff,col=runoff370-runoff))+ 
  scale_fill_gradient2(low="#B03060",mid="#FFFAFA",high = "#003399",midpoint = 0, aesthetics = c("fill","col"), name = "Difference runoff 1995-2050\n under SSP370 in mm/s", limits = limits.diff.runoff)+
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = ssp370.runoff.diff, filename = "WR/ssp370.runoff.diff.png",dpi = "retina", width = 6, height = 8, units = "cm")

```

## Forecast TOC

### Gather datasets

```{r future-wr, eval = F}
ndvi.ssp126.fit <- readRDS("WR/ndvi.ssp126.fit.rds")
ndvi.ssp370.fit <- readRDS("WR/ndvi.ssp370.fit.rds") 
ssp126.runoff <- readRDS("WR/ssp126.runoff.rds")
ssp370.runoff <- readRDS("WR/ssp370.runoff.rds")

wr.sf.95 <- readRDS("WR/wr.sf.95.rds")

wr.sf.126 <- merge(dplyr::select(wr.sf.95, c("gid","bogs")),st_drop_geometry(ndvi.ssp126.fit), by = "gid") %>% merge(st_drop_geometry(st_as_sf(ssp126.runoff)), by = "gid")
wr.sf.370 <- merge(dplyr::select(wr.sf.95, c("gid","bogs")), st_drop_geometry(ndvi.ssp370.fit), by = "gid") %>% merge(st_drop_geometry(st_as_sf(ssp370.runoff)), by = "gid")

na.lines.126 <- which(complete.cases(st_drop_geometry(wr.sf.126))==F)
na.lines.370 <- which(complete.cases(st_drop_geometry(wr.sf.370))==F)

wr.sf.126 <- wr.sf.126[-na.lines.126,]
wr.sf.370 <- wr.sf.370[-na.lines.370,]

wr.sf.126$log.runoff <- wr.sf.126$runoff %>% log()
wr.sf.370$log.runoff <- wr.sf.370$runoff %>% log()


saveRDS(wr.sf.126, "WR/wr.sf.126.rds")
saveRDS(wr.sf.370, "WR/wr.sf.370.rds")

```


### Forecast TOC SSP126

```{r sem-model-toc-ssp126-2050, eval = F}
sem.fen.simple <- readRDS("sem.fen.simple.Rdata")
wr.sf.126 <- readRDS("WR/wr.sf.126.rds")
sem.pred.wr <- readRDS("WR/sem.pred.wr.rds")

fm <- log.toc~ndvi+log.runoff+bogs

wr.pred.ssp126 <- predict(sem.fen.simple,wr.sf.126,wr.kmat, pred.type = "TS",legacy.mixed = F, zero.policy = T) %>% as.data.frame()

wr.ssp126 <- cbind(wr.sf.126,wr.pred.ssp126)
wr.ssp126$toc <- exp(wr.ssp126$fit)
wr.ssp126 <- merge(wr.ssp126, select(st_drop_geometry(sem.pred.wr),c("gid","wr.pred.fit","toc95")))
saveRDS(wr.ssp126,"WR/wr.ssp126.rds")

```


### Forecast TOC SSP370

```{r sem-model-toc-ssp370-2050, eval = F}
sem.fen.simple <- readRDS("sem.fen.simple.Rdata")
wr.sf.370 <- readRDS("WR/wr.sf.370.rds")
sem.pred.wr <- readRDS("WR/sem.pred.wr.rds")

fm <- log.toc~ndvi+log.runoff+bogs

wr.pred.ssp370 <- predict(sem.fen.simple,wr.sf.370,wr.kmat, pred.type = "TS",legacy.mixed = F, zero.policy = T) %>% as.data.frame()

wr.ssp370 <- cbind(wr.sf.370,wr.pred.ssp370)
wr.ssp370$toc <- exp(wr.ssp370$fit)
wr.ssp370 <- merge(wr.ssp370, select(st_drop_geometry(sem.pred.wr),c("gid","wr.pred.fit","toc95")))
saveRDS(wr.ssp370,"WR/wr.ssp370.rds")
```

### Plot Forecast TOC

```{r boxplots-ssp126}
temperature <- c(sem.pred.wr$temp,wr.ssp126$temp126,wr.ssp370$temp370)
precipitation <- c(sem.pred.wr$prec,wr.ssp126$prec126,wr.ssp370$prec370)
ndvi <- c(sem.pred.wr$ndvi,wr.ssp126$ndvi126,wr.ssp370$ndvi370)
runoff <- c(sem.pred.wr$runoff,wr.ssp126$runoff126,wr.ssp370$runoff370)
toc <- c(sem.pred.wr$toc95,wr.ssp126$toc,wr.ssp370$toc)

neworder <- c("1995","SSP126","SSP370")
model <- factor(c(rep("1995",dim(sem.pred.wr)[1]),rep("SSP126", dim(wr.ssp126)[1]), rep("SSP370", dim(wr.ssp370)[1])),levels = neworder)



compare.ssp <- data.frame(value = c(temperature, precipitation, ndvi, runoff,toc), variable = c(rep("Temperature (°C(", length(temperature)), rep("Precipitation (mm)", length(precipitation)), rep("NDVI",length(ndvi)), rep("Runoff (mm/s)",length(runoff)), rep("TOC (mg/L)", length(toc))), model = rep(model,5)) 

ggplot(compare.ssp)+geom_boxplot(aes(y= value,col=variable))+
  labs(y="", x = "")+scale_color_brewer(type = "seq",palette = "Dark2",direction = -1)+
  theme_minimal()+
  theme(legend.position = "", axis.text.x = element_blank())+
  facet_grid(cols = vars(model), rows = vars(factor(variable, levels = c("Temperature","Precipitation","NDVI","Runoff","TOC"))), scales = "free_y", shrink = T)
ggsave("WR/compare.ssp.png", width = 10, height = 20, units = "cm", dpi = "retina")

```

```{r plot-forecast-toc, eval = F}
wr.ssp126 <- readRDS("WR/wr.ssp126.rds")
wr.ssp370 <- readRDS("WR/wr.ssp370.rds")

limits.toc <- c(min(c(wr.ssp126$toc,wr.ssp370$toc)), max(c(wr.ssp126$toc,wr.ssp370$toc)))
limits.log.toc <- c(min(c(wr.ssp126$fit,wr.ssp370$fit)), max(c(wr.ssp126$fit,wr.ssp370$fit)))
limits.diff.toc <- c(min(c(wr.ssp126$toc-wr.ssp126$toc95,wr.ssp370$toc-wr.ssp370$toc95)), max(c(wr.ssp126$toc-wr.ssp126$toc95,wr.ssp370$toc-wr.ssp370$toc95)))


map.toc.126 <- ggplot()+geom_sf(data = wr.ssp126, aes(fill = toc, col = toc))+
  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1, 
                       name = "Modelled TOC\n for 2041-2016\n under SSP126 (mg/L)", limits = limits.toc)+
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = map.toc.126, filename = "WR/map.toc.126.png",dpi = "retina", width = 6, height = 8, units = "cm")

map.log.toc.126 <- ggplot()+geom_sf(data = wr.ssp126, aes(fill = fit, col = fit))+
  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1,
                       name = "Modelled log(TOC)\n for 2041-2016\n under SSP126", limits = limits.log.toc)+
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = map.log.toc.126, filename = "WR/map.log.toc.126.png",dpi = "retina", width = 6, height = 8, units = "cm")

 
 map.toc.diff.126 <- ggplot()+geom_sf(data = wr.ssp126, aes(fill = toc-toc95, col = toc-toc95))+
   scale_fill_gradient2(low="#104E8B",mid="#FFFFE0",high = "#CD3700",midpoint = 0, aesthetics = c("colour","fill"),
                        name = "Difference TOC concentration\n 1995-2050 under SSP126", limits = limits.diff.toc)+
   theme_minimal(base_size = 6)+
   theme(legend.position = "bottom")
 ggsave(plot = map.toc.diff.126, filename = "WR/map.toc.diff.126.png",dpi = "retina", width = 6, height = 8, units = "cm")

map.toc.370 <- ggplot()+geom_sf(data = wr.ssp370, aes(fill = toc, col = toc))+
  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1,
                       name = "Modelled TOC\n for 2041-2016\n under SSP370 (mg/L)", limits = limits.toc)+
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = map.toc.370, filename = "WR/map.toc.370.png",dpi = "retina", width = 6, height = 8, units = "cm")

map.log.toc.370 <- ggplot()+geom_sf(data = wr.ssp370, aes(fill = fit, col = fit))+
  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1,
                       name = "Modelled log(TOC)\n for 2041-2016\n under SSP370", limits = limits.log.toc)+
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = map.log.toc.370, filename = "WR/map.log.toc.370.png",dpi = "retina", width = 6, height = 8, units = "cm")

 map.toc.diff.370 <- ggplot()+geom_sf(data = wr.ssp370, aes(fill = toc-toc95, col = toc-toc95))+
  scale_fill_gradient2(low="#104E8B",mid="#FFFFE0",high = "#CD3700",midpoint = 0, aesthetics = c("colour","fill"),
                        name = "Difference TOC concentration\n 1995-2050 under SSP370", limits = limits.diff.toc)+
   theme_minimal(base_size = 6)+
   theme(legend.position = "bottom")
 ggsave(plot = map.toc.diff.370, filename = "WR/map.toc.diff.370.png",dpi = "retina", width = 6, height = 8, units = "cm")

```

### Forecast TOC with increased forest
```{r sem-model-toc-forest, eval = F}
sem.forest.fen <- readRDS("sem.forest.fen.Rdata")
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")
fm <- log.toc~forest+log.runoff+bogs
wr.pred <- predict(sem.forest.fen,wr.sf.95,wr.kmat, pred.type = "TS",legacy.mixed = F, zero.policy = T) %>% as.data.frame()

sem.pred.forest.wr <- cbind(wr.sf.95,wr.pred$fit)
sem.pred.forest.wr$toc95 <- exp(sem.pred.forest.wr$wr.pred.fit)

saveRDS(sem.pred.forest.wr,"WR/sem.pred.forest.wr.rds")

map.fit.forest <- ggplot()+geom_sf(data = st_as_sf(sem.pred.forest.wr), aes(fill = toc95, col = toc95))+
  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1, 
                       name = "Modelled TOC 1995 (mg/L)\n using forest model")+
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = map.fit.forest, filename = "WR/wr.toc.forest.png",dpi = "retina", width = 6, height = 8, units = "cm")
```

```{r sem-forest-model-toc-2050, eval = F}
sem.forest.fen <- readRDS("sem.forest.fen.Rdata")
sem.pred.forest.wr <- readRDS("sem.pred.forest.wr.rds")
fm <- log.toc~forest+log.runoff+bogs

wr.sf.forest <- sem.pred.forest.wr
x <- sem.pred.forest.wr$forest
y <- x + (1-x)*x
wr.sf.forest$forest <- y
wr.sf.forest$forest0 <- wr.sf.95$forest



pred.forest <- predict(sem.forest.fen,wr.sf.forest,wr.kmat, pred.type = "TS",legacy.mixed = F, zero.policy = T) %>% as.data.frame()

wr.forest.pred <- cbind(wr.sf.forest,pred.forest)
wr.forest.pred$toc <- exp(wr.forest.pred$fit)

saveRDS(wr.forest.pred,"wr.forest.pred.rds")
```
```{r plot-forest}
wr.forest.pred <- readRDS("wr.forest.pred.rds")

# map.forest <- ggplot(wr.forest.pred)+geom_sf(aes(fill = forest, col = forest))+
#   scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1, 
#                        name = "Forest proportion")+
#   theme_minimal(base_size = 6)+
#   theme(legend.position = "bottom")
# ggsave(plot = map.forest, filename = "WR/map.forest.png",dpi = "retina", width = 6, height = 8, units = "cm")

map.diff.forest <- ggplot(wr.forest.pred)+geom_sf(aes(fill = forest-forest0, col = forest-forest0))+
  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1, 
                       name = "Increase of forest proportion")+
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = map.diff.forest, filename = "WR/map.diff.forest.png",dpi = "retina", width = 6, height = 8, units = "cm")

map.toc.forest <- ggplot()+geom_sf(data = wr.forest.pred, aes(fill = toc, col = toc))+
  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1, 
                       name = "Modelled TOC with\n an increase of forest cover (mg/L)")+
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")

ggsave(plot = map.toc.forest, filename = "WR/map.toc.forest.png",dpi = "retina", width = 6, height = 8, units = "cm")


map.diff.toc.forest <- ggplot()+geom_sf(data = wr.forest.pred, aes(fill = toc-toc95, col = toc-toc95))+
  scale_fill_gradient2(low="#104E8B",mid="#FFFFE0",high = "#CD3700",midpoint = 0, aesthetics = c("colour","fill"),
                        name = "Difference TOC concentration\n with an increase of forest cover")+
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = map.diff.toc.forest, filename = "WR/map.diff.toc.forest.png",dpi = "retina", width = 6, height = 8, units = "cm")

```
