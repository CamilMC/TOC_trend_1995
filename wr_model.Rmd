---
title: "TOC model extended"
author: "Camille M. Crapart"
date: "5 1 2022"
 output: 
   bookdown::html_document2:
     code_folding: hide
     toc: true
     toc_float: true
     number_sections: true
     fig_caption: true
 bibliography: C:\\Users\\raine\\Documents\\UiO\\Bibtex\\Finstad.bib
 link-citations: yes

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, error = F, fig.align = "center")
options(knitr.kable.NA="", knitr.kable.format ="html")
```
```{r library}
library(dplyr)
library(tibble)

library(DBI)
library(sf)
library(gimms)

library(ncdf4)
library(rgdal)

library(stringr)
library(ggplot2)
library(cowplot)
library(spdep)
library(spatialreg)

library(kableExtra)

source("f_plotspatial.R")
wr.df <- readRDS("wr.df.Rdata")
wr.sf <- readRDS("wr.sf.Rdata")
```
# Water regions data

## Connections to database

```{r download-water-regions, eval = F}
con <- dbConnect(RPostgreSQL::PostgreSQL(),user = "camille.crapart", password = "camille",host = "vm-srv-wallace.vm.ntnu.no", dbname = "nofa")
query <- paste("SELECT gid,geom FROM ","\"Hydrography\"",".waterregions_dem_10m_nosefi",sep = "")

water.regions <- st_read(con,query = query)
saveRDS(water.regions,"water.regions.Rdata")
```

## NDVI

```{r summer-ndvi-waterregions, eval = F}
# http://poles.tpdc.ac.cn/en/data/9775f2b4-7370-4e5e-a537-3482c9a83d88/
water.regions <- readRDS("water.regions.Rdata")

ndvi.1994 <- downloadGimms(x= 1994,y=1994,dsn = "NDVI")
ndvi.max <- monthlyComposite(ndvi.1994,monthlyIndices(ndvi.1994))
saveRDS(ndvi.max,"ndvi.max.Rdata")
ndvi.max <- readRDS("ndvi.max.Rdata")
summer.mean <- raster::stack(ndvi.max[[6]],ndvi.max[[7]],ndvi.max[[8]]) %>% mean()
summer.scandinavia <- raster::crop(summer.mean,c(0,35,55,73))

summer.scan <- reclassify(summer.scandinavia, cbind(-Inf, 0, NA), right=FALSE)
plot(summer.scan)

for(x in 0:287){
  start.x <- (x-1)*1000+1
  end.x <- x*1000
  ndvi <- raster::extract(summer.scan,water.regions[start.x:end.x,], fun = mean, df = T, sp = T)
  name.x <- paste("WR/NDVI/summer.ndvi.wr",x,"Rdata",sep = ".")
saveRDS(ndvi,name.x)
}

start.x <- (288-1)*1000+1
summer.ndvi.wr.288 <- raster::extract(summer.scan,water.regions[start.x:287886,], fun = mean, df = T, sp = T)
saveRDS(summer.ndvi.wr.288,"summer.ndvi.wr.288.Rdata")

summer.ndvi.wr.165 <- raster::extract(summer.scan,water.regions[164100:165000,], fun = mean, df = T, sp = T)
saveRDS(summer.ndvi.wr.165,"WR/NDVI/summer.ndvi.wr.165.Rdata")

list.ndvi.files <- list.files("WR/NDVI", full.names = T)
list.ndvi <- lapply(list.ndvi.files[-165],readRDS)

summer.ndvi.wr <- summer.ndvi.wr.165@data
for(x in 1:length(list.ndvi)){
  df <- list.ndvi[[x]]@data
  summer.ndvi.wr <<- rbind(summer.ndvi.wr, df)
  
}
names(summer.ndvi.wr) <- c("gid","ndvi")
summer.ndvi.wr$ndvi.value <- (floor(summer.ndvi.wr$ndvi)/10)/1000
summer.ndvi.wr$flag.value <- summer.ndvi.wr$ndvi - (floor(summer.ndvi.wr$ndvi)/10*10+1) 

saveRDS(summer.ndvi.wr, "summer.ndvi.wr.Rdata")
```

```{r check-values-nvi}
summer.ndvi.wr <- readRDS("summer.ndvi.wr.Rdata")
water.regions <- readRDS("water.regions.Rdata")



```
## Runoff

```{r runoff-wr, eval = F}
#runoff.tbl <- tbl(con,sql("SELECT ebint,mrros FROM public.cordex_prelim"))
#runoff.df <- runoff.tbl %>% as.data.frame()

water.regions <- readRDS("water.regions.Rdata")

runoff.file.60s <- "CORDEX/mrros_EUR-11_NCC-NorESM1-M_historical_r1i1p1_DMI-HIRHAM5_v3_mon_196101-197012.nc"
runoff.file.70s <- "CORDEX/mrros_EUR-11_NCC-NorESM1-M_historical_r1i1p1_DMI-HIRHAM5_v3_mon_197101-198012.nc"
runoff.file.80s <- "CORDEX/mrros_EUR-11_NCC-NorESM1-M_historical_r1i1p1_DMI-HIRHAM5_v3_mon_198101-199012.nc"
#runoff.file.80s <- "CORDEX/mrros_EUR-11_NCC-NorESM1-M_historical_r1i1p1_DMI-HIRHAM5_v3_mon_19101-199012.nc"


# get coordinates
runoff.nc <- nc_open(runoff.file.60s)
runoff.info <- GDALinfo(runoff.nc)
attr.runoff <- attr(runoff.info,"mdata")

rot.info <- attr.runoff[grep("^rotated",attr(runoff.info,"mdata"))]
coord <- sapply(rot.info, FUN = function(x) {
  unlist(str_split(x, pattern = "="))[2]})
coord.num<- round(as.numeric(coord[2:3]),2)

y <- coord.num[1]
x <- coord.num[2]

target.crs <- paste0("+proj=ob_tran +o_proj=longlat +o_lon_p=" , 
                     x, " +o_lat_p=", y, 
                     " +lon_0=180 +to_meter=0.0174532925199433")

# 60s
runoff.60.stack <- stack(runoff.file.60s, varname = "mrros")
runoff.60.mean  <- mean(runoff.60.stack)

projection(runoff.60.mean) <- CRS("EPSG:4326")
runoff.60.rotated <- projectRaster(runoff.60.mean,crs = target.crs)
runoff.60.wgs84 <- runoff.60.rotated
projection(runoff.60.wgs84) <- CRS("EPSG:4326")

for(x in 1:287){
  start.x <- (x-1)*1000+1
  end.x <- x*1000
  runoff.60s <- raster::extract(runoff.60.wgs84,water.regions[start.x:end.x,], fun = mean, na.rm = T, df = T, exact = F, sp = T)
  runoff.60.df <- runoff.60s@data
  names(runoff.60.df) <- c("ebint","runoff.60s")
  name.x <- paste("WR/runoff/runoff.60",x,"Rdata",sep = ".")
  saveRDS(runoff.60.df,name.x)
}

start.x <- (288-1)*1000+1
runoff.60.288 <- raster::extract(runoff.60.wgs84,water.regions[start.x:287886,], fun = mean, df = T, sp = T)
saveRDS(runoff.60.288,"WR/runoff/runoff.60.288.Rdata")



# 70s
runoff.70.stack <- stack(runoff.file.70s, varname = "mrros")
runoff.70.mean  <- mean(runoff.70.stack)

projection(runoff.70.mean) <- CRS("EPSG:4326")
runoff.70.rotated <- projectRaster(runoff.70.mean,crs = target.crs)
runoff.70.wgs84 <- runoff.70.rotated
projection(runoff.70.wgs84) <- CRS("EPSG:4326")

for(x in 99:287){
	start.x <- (x-1)*1000+1
	end.x <- x*1000
	runoff.70s <- raster::extract(runoff.70.wgs84,water.regions[start.x:end.x,],fun = mean, na.rM = T, df = T, exact = F, sp = T)
	runoff.70.df <- runoff.70s@data
	names(runoff.70.df) <- c("ebint","runoff.70")
	name.x <- paste("WR/runoff/runoff.70",x,"Rdata",sep = ".")
	saveRDS(runoff.70.df,name.x)
}

start.x <- (288-1)*1000+1
runoff.70.288 <- raster::extract(runoff.70.wgs84,water.regions[start.x:287886,],fun = mean, na.rM = T, df = T, exact = F, sp = T)
saveRDS(runoff.70.288,"WR/runoff/runoff.70.288.Rdata")



# 80s
runoff.80.stack <- stack(runoff.file.80s, varname = "mrros")
runoff.80.mean  <- mean(runoff.80.stack)

projection(runoff.80.mean) <- CRS("EPSG:4326")
runoff.80.rotated <- projectRaster(runoff.80.mean,crs = target.crs)
runoff.80.wgs84 <- runoff.80.rotated
projection(runoff.80.wgs84) <- CRS("EPSG:4326")


for(x in 1:287){
	start.x <- (x-1)*1000+1
	end.x <- x*1000
	runoff.80s <- raster::extract(runoff.80.wgs84,water.regions[start.x:end.x,],fun = mean, na.rM = T, df = T, exact = F, sp = T)
	runoff.80.df <- runoff.80s@data
	names(runoff.80.df) <- c("ebint","runoff.80")
	name.x <- paste("WR/runoff/runoff.80",x,"Rdata",sep = ".")
	saveRDS(runoff.80.df,name.x)
}

start.x <- (288-1)*1000+1
runoff.80.288 <- raster::extract(runoff.80.wgs84,water.regions[start.x:287886,],fun = mean, na.rM = T, df = T, exact = F, sp = T)
saveRDS(runoff.80.288,"WR/runoff/runoff.80.288.Rdata")
```

```{r gather-runoff-wr}
list.files.runoff.60 <- list.files("WR/runoff",pattern = "runoff.60",full.names = T)

df.runoff.60 <- readRDS(list.files.runoff.60[210])@data %>% setNames(c("ebint","runoff.60s"))
for(x in list.files.runoff.60[-210]){
  df <- readRDS(x)
  df.runoff.60 <<- rbind(df.runoff.60,df)
}

list.files.runoff.70 <- list.files("WR/runoff",pattern = "runoff.70",full.names = T)

df.runoff.70 <- readRDS(list.files.runoff.70[210])@data %>% setNames(c("ebint","runoff.70"))
for(x in list.files.runoff.70[-210]){
  df <- readRDS(x)
  df.runoff.70 <<- rbind(df.runoff.70,df)
}

list.files.runoff.80 <- list.files("WR/runoff",pattern = "runoff.80",full.names = T)

df.runoff.80 <- readRDS(list.files.runoff.80[1])
for(x in list.files.runoff.80[-1]){
  df <- readRDS(x)
  df.runoff.80 <<- rbind(df.runoff.80,df)
}

runoff.df.wr <- merge(df.runoff.60,df.runoff.70, by = "ebint") %>% merge(df.runoff.80, by = "ebint")
runoff.df.wr$mean.runoff <- rowMeans(runoff.df.wr[,2:4])
saveRDS(runoff.df.wr, "runoff.df.wr.Rdata")

```
## Bogs and forest

```{r wr.bogs.forest}
library(rgdal)
water.regions <- readRDS("water.regions.Rdata")
wr.corine <- st_transform(water.regions,CRS("EPSG:3035"))
saveRDS(wr.corine,"wr.corine.Rdata")
corine <- raster::raster("Corine_Land_Cover/U2006_CLC2000_V2020_20u1.tif")

for(x in 2615:2880){
  start.x <- (x-1)*100+1
  end.x <- x*100
  clc <- raster::extract(corine,wr.corine[start.x:end.x,])
  name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
  saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[start.x:end.x,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))
}

start.x <- 287801
end.x <- 287886
clc <- raster::extract(corine,wr.corine[start.x:end.x,])
name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[start.x:end.x,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))

miss <- c(74, 91,133, 138, 161, 304, 668, 1354, 1391, 1592, 1634, 1825, 2000, 2014, 2040, 2048, 2078, 2327, 2503, 2542, 2614)

library(R.utils)

for(x in miss){
  start.x <- (x-1)*100+1
  end.x <- x*100
  wr.x <- wr.corine[start.x:end.x,]
  for (y in 1:100){
  tryCatch(expr = {
    withTimeout(expr = {
    clc <- raster::extract(corine,wr.x[y,])
    name.x <- paste("WR/clc/clc.wr",x,y,"Rdata",sep = ".")
    saveRDS(clc,name.x)
    clc.tab <- sapply(clc, function(x) tabulate(x,45))
    clc.tab.area <- clc.tab*prod(res(corine))
    catchment.area <- colSums(clc.tab.area)
    clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
    names(clc.tab.prop) <- wr.x[y,]$gid
    saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,y,"Rdata",sep="."))
  }, 
  substitute = F, timeout = 15*60, onTimeout = "error")
  },
  
  finally = TimeoutException(next)
  )
  }
}

big <- c(91.18,91.19,133.51,138.89,161.61,304.92,668.15,1391.8,1592.6,1634.63,1825.60,2000.90,2040.26,2048.29,2078.63,2503.89,2542.2,2614.78)


x <- big[18]
start.x <- (trunc(x)-1)*100+(x-floor(x))*100
clc <- raster::extract(corine,wr.corine[start.x,])
name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[start.x,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))


```
```{r gather-clc-wr}

list.clc.tabs <- list.files("WR/clc",pattern = "clc.tab.prop", full.names = T)
list.clc <- lapply(list.clc.tabs,readRDS)

clc.wr <- list.clc[[1]] %>% t() %>% as.data.frame()
clc.wr$gid <- attr(list.clc[[1]],"names")[1:100]
for(x in 2:length(list.clc)){
  m <- list.clc[[x]] 
  df <- m %>% t() %>% as.data.frame() 
  df$gid <- attr(m,"names")[1:dim(df)[1]]
  clc.wr <<- rbind(clc.wr, df)
  }

saveRDS(clc.wr,"WR/clc/clc.wr.Rdata")

```
```{r get-forest-bogs}
clc.wr.bogs <- select(clc.wr, c("gid","V36")) %>% setNames(c("gid","bogs"))
clc.wr.forest <- select(clc.wr,c("V23","V24","V25")) %>% rowSums() %>% as.data.frame() %>% setNames("forest")

clc.wr.sum <- cbind(clc.wr.bogs, clc.wr.forest)
saveRDS(clc.wr.sum,"WR/clc/clc.wr.sum.Rdata")
```
## Gathers wr dataset

```{r gather-dataset}
summer.ndvi.wr <- readRDS("summer.ndvi.wr.Rdata")
runoff.df.wr <- readRDS("runoff.df.wr.Rdata")
clc.wr.sum <- readRDS("WR/clc/clc.wr.sum.Rdata")
water.regions <- readRDS("water.regions.Rdata")

wr.df <- merge(summer.ndvi.wr,runoff.df.wr, by.x = "gid",by.y = "ebint") %>% merge(clc.wr.sum, by.x = "gid", by.y = "gid")
wr.sf <- merge(water.regions,summer.ndvi.wr,by.x="gid",by.y="gid") %>% merge(runoff.df.wr,by.x = "gid", by.y="ebint") %>% merge(clc.wr.sum,by.x = "gid",by.y= "gid")

saveRDS(wr.df, "wr.df.Rdata")
saveRDS(wr.sf, "wr.sf.Rdata")
```

# WR dataframe

```{r final-df}

wr.sf$size <- st_area(wr.sf) %>% as.numeric()

ggplot()+geom_sf(data = wr.sf,aes(fill = bogs))
ggsave("wr.bogs.png")

ggplot()+geom_sf(data = wr.sf,aes(fill = ndvi.value))
ggsave("wr.ndvi.png")

ggplot()+geom_sf(data = wr.sf,aes(fill = mean.runoff))
ggsave("wr.runoff.png")


wr.sf.1 <- wr.sf %>% filter(size > 1000)
plot(wr.sf.1[,"ndvi.value"])

wr.sf.2 <- wr.sf %>% filter(is.na(bogs) == T)
plot(wr.sf.2$geom)
ggplot(wr.sf) + geom_sf(aes(col=bogs))

wr.df <- filter(wr.df, mean.runoff != 0)
wr.df$runoff <- wr.df$mean.runoff*10^6 *365*24*60*60 # converts in mg/m2.s and then to mg/m2/year

wr.df <- filter(wr.df, ndvi.value > 0)
wr.df <- wr.df[which(is.na(wr.df$bogs)==F),]

wr.df$log.runoff <- log10(wr.df$runoff)


```

# Neighbour matrix

```{r wr-km}


wr.centroid <- st_centroid(water.regions, of_largest_polygon = F)

wr.neigh.set <- knearneigh(wr.centroid, k = 100)
wr.neigh.nb <- knn2nb(wr.neigh.set)
wr.kmat <- nb2listw(wr.neigh.nb)
saveRDS(wr.kmat,"wr.kmat.Rdata")

```
We predict the toc concentration in all the lakes based on the sem model
```{r sem-model}
library(spatialreg)
sem.fen.simple <- readRDS("sem.fen.simple.Rdata")
fm <- log.toc~ndvi+log.runoff+bogs
wr.pred <- predict(sem.fen.simple,wr.df,wr.kmat)

```
We forecast the evolution of toc concentration based on the predicted values and the effect size given by the model on the Fennoscandian dataset
(toc + beta*toc)

```{r effect-size}

sem.coef <- sem.fen.simple$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
```

We model the toc export by multiplying the "new" toc concentration by the runoff. 

We match the value of toc export for each lake to the corresponding polygon and we plot. 