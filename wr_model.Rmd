---
title: "TOC model extended"
author: "Camille M. Crapart"
date: "5 1 2022"
output: 
  bookdown::html_document2:
   code_folding: hide
   toc: true
   toc_float: true
   number_sections: true
   fig_caption: true
bibliography: C:\\Users\\raine\\Documents\\UiO\\Bibtex\\Finstad.bib
link-citations: yes

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, error = F, fig.align = "center")
options(knitr.kable.NA="", knitr.kable.format ="html")
```
```{r library}
library(dplyr)
library(tibble)

library(DBI)
library(sf)
library(gimms)

library(ncdf4)
library(rgdal)

library(stringr)
library(ggplot2)
library(cowplot)
library(spdep)
library(spatialreg)

library(kableExtra)

source("f_plotspatial.R")

```
# Water regions data

## Connections to database

```{r download-water-regions, eval = F}
con <- dbConnect(RPostgreSQL::PostgreSQL(),user = "camille.crapart", password = "camille",host = "vm-srv-wallace.vm.ntnu.no", dbname = "nofa")
query <- paste("SELECT gid,geom FROM ","\"Hydrography\"",".waterregions_dem_10m_nosefi",sep = "")
query.2 <- paste("SELECT * FROM ","\"Hydrography\"",".Fenoscandia_LakeRegister",sep = "")
water.regions <- st_read(con,query = query)
lake.register <- st_read(con,query = query.2)
saveRDS(water.regions,"water.regions.Rdata")
```

```{r plot-regions}
water.regions <- readRDS("water.regions.Rdata")
ggplot()+geom_sf(data=water.regions,aes(fill = gid))

```

## NDVI

```{r summer-ndvi-waterregions, eval = F}
# http://poles.tpdc.ac.cn/en/data/9775f2b4-7370-4e5e-a537-3482c9a83d88/
water.regions <- readRDS("water.regions.Rdata")

ndvi.1994 <- downloadGimms(x= 1994,y=1994,dsn = "NDVI")
ndvi.max <- monthlyComposite(ndvi.1994,monthlyIndices(ndvi.1994))
saveRDS(ndvi.max,"ndvi.max.Rdata")
ndvi.max <- readRDS("ndvi.max.Rdata")
summer.mean <- raster::stack(ndvi.max[[6]],ndvi.max[[7]],ndvi.max[[8]]) %>% mean()
summer.scandinavia <- raster::crop(summer.mean,c(0,35,55,73))
summer.scan <- reclassify(summer.scandinavia, cbind(-Inf, 0, NA), right=FALSE)
summer.scan.ndvi <- (floor(summer.scan)/10)/1000
writeRaster(summer.mean,"ndvi1994.tif")

png("NDVI/ndvi.fen.png", width = 30, height = 30, units = "cm", res = 300)
plot(summer.scan.ndvi, axes = F, box = F, main = "NDVI 1995",)
dev.off()

for(x in 0:287){
  start.x <- (x-1)*1000+1
  end.x <- x*1000
  ndvi <- raster::extract(summer.scan,water.regions[start.x:end.x,], fun = mean, df = T, sp = T)
  name.x <- paste("WR/NDVI/summer.ndvi.wr",x,"Rdata",sep = ".")
saveRDS(ndvi,name.x)
}

start.x <- (288-1)*1000+1
summer.ndvi.wr.288 <- raster::extract(summer.scan,water.regions[start.x:287886,], fun = mean, df = T, sp = T)
saveRDS(summer.ndvi.wr.288,"summer.ndvi.wr.288.Rdata")

summer.ndvi.wr.165 <- raster::extract(summer.scan,water.regions[164100:165000,], fun = mean, df = T, sp = T)
saveRDS(summer.ndvi.wr.165,"WR/NDVI/summer.ndvi.wr.165.Rdata")

list.ndvi.files <- list.files("WR/NDVI", full.names = T)
list.ndvi <- lapply(list.ndvi.files[-165],readRDS)

summer.ndvi.wr <- summer.ndvi.wr.165@data
for(x in 1:length(list.ndvi)){
  df <- list.ndvi[[x]]@data
  summer.ndvi.wr <<- rbind(summer.ndvi.wr, df)
  
}
names(summer.ndvi.wr) <- c("gid","ndvi")
summer.ndvi.wr$ndvi.value <- (floor(summer.ndvi.wr$ndvi)/10)/1000
summer.ndvi.wr$flag.value <- summer.ndvi.wr$ndvi - (floor(summer.ndvi.wr$ndvi)/10*10+1) 

saveRDS(summer.ndvi.wr, "summer.ndvi.wr.Rdata")
```

```{r check-values-nvi, eval = F}
summer.ndvi.wr <- readRDS("summer.ndvi.wr.Rdata")
water.regions <- readRDS("water.regions.Rdata")

missing.ndvi <- summer.ndvi.wr$gid[which(is.na(summer.ndvi.wr$ndvi.value)==T)]
missing.lines <- which(water.regions$gid %in% missing.ndvi)

ndvi.max <- readRDS("ndvi.max.Rdata")
summer.mean <- raster::stack(ndvi.max[[6]],ndvi.max[[7]],ndvi.max[[8]]) %>% mean()
summer.scandinavia <- raster::crop(summer.mean,c(0,35,55,73))
summer.scan <- reclassify(summer.scandinavia, cbind(-Inf, 0, NA), right=FALSE)
plot(summer.scan)
ndvi <- raster::extract(summer.scan,water.regions[missing.lines,], fun = mean, df = T, sp = T, na.rm = T,buffer=10,small = T)
saveRDS(ndvi,"missing.ndvi.Rdata")

ndvi.sf <- st_as_sf(ndvi)
summer.scan.df <-as.data.frame(summer.scan,xy=T) 
ggplot()+geom_sf(data=ndvi.sf,aes(fill=layer))

missing.ndvi.df <- ndvi@data
names(missing.ndvi.df) <- c("gid","ndvi")
missing.ndvi.df$ndvi.value <- (floor(missing.ndvi.df$ndvi)/10)/1000
missing.ndvi.df$flag.value <- missing.ndvi.df$ndvi - (floor(missing.ndvi.df$ndvi)/10*10+1) 

saveRDS(missing.ndvi.df, "missing.ndvi.df.Rdata")
```
```{r join-ndvi, eval = F}
missing.ndvi <- readRDS("missing.ndvi.Rdata")
summer.ndvi.total <- rbind(filter(summer.ndvi.wr,!is.na(ndvi)),missing.ndvi.df)
saveRDS(summer.ndvi.total,"summer.ndvi.total.Rdata")

summer.ndvi.sf <- merge(water.regions,summer.ndvi.total,by.x = "gid", by.y = "gid")
saveRDS(summer.ndvi.sf,"summer.ndvi.sf.Rdata")
ggplot()+geom_sf(data=summer.ndvi.sf,aes(fill=ndvi.value))
```
```{r plot-ndvi}
summer.ndvi.sf <- readRDS("summer.ndvi.sf.Rdata")
ggplot()+geom_sf(data=summer.ndvi.sf,aes(fill=ndvi.value))
```

## Runoff

```{r runoff-wr, eval = F}
#runoff.tbl <- tbl(con,sql("SELECT ebint,mrros FROM public.cordex_prelim"))
#runoff.df <- runoff.tbl %>% as.data.frame()

water.regions <- readRDS("water.regions.Rdata")

runoff.file.60s <- "CORDEX/mrros_EUR-11_NCC-NorESM1-M_historical_r1i1p1_DMI-HIRHAM5_v3_mon_196101-197012.nc"
runoff.file.70s <- "CORDEX/mrros_EUR-11_NCC-NorESM1-M_historical_r1i1p1_DMI-HIRHAM5_v3_mon_197101-198012.nc"
runoff.file.80s <- "CORDEX/mrros_EUR-11_NCC-NorESM1-M_historical_r1i1p1_DMI-HIRHAM5_v3_mon_198101-199012.nc"
#runoff.file.80s <- "CORDEX/mrros_EUR-11_NCC-NorESM1-M_historical_r1i1p1_DMI-HIRHAM5_v3_mon_19101-199012.nc"


# get coordinates
runoff.nc <- nc_open(runoff.file.60s)
runoff.info <- GDALinfo(runoff.nc)
attr.runoff <- attr(runoff.info,"mdata")

rot.info <- attr.runoff[grep("^rotated",attr(runoff.info,"mdata"))]
coord <- sapply(rot.info, FUN = function(x) {
  unlist(str_split(x, pattern = "="))[2]})
coord.num<- round(as.numeric(coord[2:3]),2)

y <- coord.num[1]
x <- coord.num[2]

target.crs <- paste0("+proj=ob_tran +o_proj=longlat +o_lon_p=" , 
                     x, " +o_lat_p=", y, 
                     " +lon_0=180 +to_meter=0.0174532925199433")

# 60s
runoff.60.stack <- stack(runoff.file.60s, varname = "mrros")
runoff.60.mean  <- mean(runoff.60.stack)

projection(runoff.60.mean) <- CRS("EPSG:4326")
runoff.60.rotated <- projectRaster(runoff.60.mean,crs = target.crs)
runoff.60.wgs84 <- runoff.60.rotated
projection(runoff.60.wgs84) <- CRS("EPSG:4326")

for(x in 1:287){
  start.x <- (x-1)*1000+1
  end.x <- x*1000
  runoff.60s <- raster::extract(runoff.60.wgs84,water.regions[start.x:end.x,], fun = mean, na.rm = T, df = T, exact = F, sp = T)
  runoff.60.df <- runoff.60s@data
  names(runoff.60.df) <- c("ebint","runoff.60s")
  name.x <- paste("WR/runoff/runoff.60",x,"Rdata",sep = ".")
  saveRDS(runoff.60.df,name.x)
}

start.x <- (288-1)*1000+1
runoff.60.288 <- raster::extract(runoff.60.wgs84,water.regions[start.x:287886,], fun = mean, df = T, sp = T)
saveRDS(runoff.60.288,"WR/runoff/runoff.60.288.Rdata")



# 70s
runoff.70.stack <- stack(runoff.file.70s, varname = "mrros")
runoff.70.mean  <- mean(runoff.70.stack)

projection(runoff.70.mean) <- CRS("EPSG:4326")
runoff.70.rotated <- projectRaster(runoff.70.mean,crs = target.crs)
runoff.70.wgs84 <- runoff.70.rotated
projection(runoff.70.wgs84) <- CRS("EPSG:4326")

for(x in 99:287){
	start.x <- (x-1)*1000+1
	end.x <- x*1000
	runoff.70s <- raster::extract(runoff.70.wgs84,water.regions[start.x:end.x,],fun = mean, na.rM = T, df = T, exact = F, sp = T)
	runoff.70.df <- runoff.70s@data
	names(runoff.70.df) <- c("ebint","runoff.70")
	name.x <- paste("WR/runoff/runoff.70",x,"Rdata",sep = ".")
	saveRDS(runoff.70.df,name.x)
}

start.x <- (288-1)*1000+1
runoff.70.288 <- raster::extract(runoff.70.wgs84,water.regions[start.x:287886,],fun = mean, na.rM = T, df = T, exact = F, sp = T)
saveRDS(runoff.70.288,"WR/runoff/runoff.70.288.Rdata")



# 80s
runoff.80.stack <- stack(runoff.file.80s, varname = "mrros")
runoff.80.mean  <- mean(runoff.80.stack)

projection(runoff.80.mean) <- CRS("EPSG:4326")
runoff.80.rotated <- projectRaster(runoff.80.mean,crs = target.crs)
runoff.80.wgs84 <- runoff.80.rotated
projection(runoff.80.wgs84) <- CRS("EPSG:4326")


for(x in 1:287){
	start.x <- (x-1)*1000+1
	end.x <- x*1000
	runoff.80s <- raster::extract(runoff.80.wgs84,water.regions[start.x:end.x,],fun = mean, na.rM = T, df = T, exact = F, sp = T)
	runoff.80.df <- runoff.80s@data
	names(runoff.80.df) <- c("ebint","runoff.80")
	name.x <- paste("WR/runoff/runoff.80",x,"Rdata",sep = ".")
	saveRDS(runoff.80.df,name.x)
}

start.x <- (288-1)*1000+1
runoff.80.288 <- raster::extract(runoff.80.wgs84,water.regions[start.x:287886,],fun = mean, na.rM = T, df = T, exact = F, sp = T)
saveRDS(runoff.80.288,"WR/runoff/runoff.80.288.Rdata")

```

```{r gather-runoff-wr, eval = F}
list.files.runoff.60 <- list.files("WR/runoff",pattern = "runoff.60",full.names = T)

df.runoff.60 <- readRDS(list.files.runoff.60[210])@data %>% setNames(c("ebint","runoff.60s"))
for(x in list.files.runoff.60[-210]){
  df <- readRDS(x)
  df.runoff.60 <<- rbind(df.runoff.60,df)
}

list.files.runoff.70 <- list.files("WR/runoff",pattern = "runoff.70",full.names = T)

df.runoff.70 <- readRDS(list.files.runoff.70[210])@data %>% setNames(c("ebint","runoff.70"))
for(x in list.files.runoff.70[-210]){
  df <- readRDS(x)
  df.runoff.70 <<- rbind(df.runoff.70,df)
}

list.files.runoff.80 <- list.files("WR/runoff",pattern = "runoff.80",full.names = T)

df.runoff.80 <- readRDS(list.files.runoff.80[1])
for(x in list.files.runoff.80[-1]){
  df <- readRDS(x)
  df.runoff.80 <<- rbind(df.runoff.80,df)
}

runoff.df.wr <- merge(df.runoff.60,df.runoff.70, by = "ebint") %>% merge(df.runoff.80, by = "ebint")
runoff.df.wr$mean.runoff <- rowMeans(runoff.df.wr[,2:4])
saveRDS(runoff.df.wr, "runoff.df.wr.Rdata")


runoff.sf <- merge(water.regions,runoff.df.wr,by.x = "gid", by.y = "ebint")
saveRDS(runoff.sf,"runoff.sf.Rdata")
```

```{r plot-runoff}
runoff.sf <- readRDS("WR/runoff.sf.Rdata")
ggplot()+geom_sf(data=runoff.sf,aes(fill=mean.runoff))
```

## Bogs and forest

```{r wr.bogs.forest, eval = F}
library(rgdal)
water.regions <- readRDS("water.regions.Rdata")
wr.corine <- st_transform(water.regions,CRS("EPSG:3035"))
saveRDS(wr.corine,"wr.corine.Rdata")
wr.corine <- readRDS("wr.corine.Rdata")
corine <- raster::raster("Corine_Land_Cover/U2006_CLC2000_V2020_20u1.tif")

for(x in 2615:2880){
  start.x <- (x-1)*100+1
  end.x <- x*100
  clc <- raster::extract(corine,wr.corine[start.x:end.x,])
  name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
  saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[start.x:end.x,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))
}

start.x <- 287801
end.x <- 287886
clc <- raster::extract(corine,wr.corine[start.x:end.x,])
name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[start.x:end.x,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))

miss <- c(74, 91,133, 138, 161, 304, 668, 1354, 1391, 1592, 1634, 1825, 2000, 2014, 2040, 2048, 2078, 2327, 2503, 2542, 2614)

library(R.utils)

for(x in miss){
  start.x <- (x-1)*100+1
  end.x <- x*100
  wr.x <- wr.corine[start.x:end.x,]
  for (y in 1:100){
  tryCatch(expr = {
    withTimeout(expr = {
    clc <- raster::extract(corine,wr.x[y,])
    name.x <- paste("WR/clc/clc.wr",x,y,"Rdata",sep = ".")
    saveRDS(clc,name.x)
    clc.tab <- sapply(clc, function(x) tabulate(x,45))
    clc.tab.area <- clc.tab*prod(res(corine))
    catchment.area <- colSums(clc.tab.area)
    clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
    names(clc.tab.prop) <- wr.x[y,]$gid
    saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,y,"Rdata",sep="."))
  }, 
  substitute = F, timeout = 15*60, onTimeout = "error")
  },
  
  finally = TimeoutException(next)
  )
  }
}

big <- c(91.18,91.19,133.51,138.89,161.61,304.92,668.15,1391.8,1592.6,1634.63,1825.60,2000.90,2040.26,2048.29,2078.63,2503.89,2542.2,2614.78)


x <- big[18]
start.x <- (trunc(x)-1)*100+(x-floor(x))*100
clc <- raster::extract(corine,wr.corine[start.x,])
name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[start.x,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))

```
```{r missing again, eval = F}
wr.corine <- readRDS("wr.corine.Rdata")


#missing by 100: 48,1727
for(x in c(1727)){
  start.x <- (x-1)*100+1
  end.x <- x*100
  wr.x <- wr.corine[start.x:end.x,]
  for (y in 1:100){
  tryCatch(expr = {
    withTimeout(expr = {
    clc <- raster::extract(corine,wr.x[y,])
    name.x <- paste("WR/clc/clc.wr",x,y,"Rdata",sep = ".")
    saveRDS(clc,name.x)
    clc.tab <- sapply(clc, function(x) tabulate(x,45))
    clc.tab.area <- clc.tab*prod(res(corine))
    catchment.area <- colSums(clc.tab.area)
    clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
    names(clc.tab.prop) <- wr.x[y,]$gid
    saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,y,"Rdata",sep="."))
  }, 
  substitute = F, timeout = 15*60, onTimeout = "error")
  },
  
  finally = TimeoutException(next)
  )
  }
}

missing.bis <- c(48.46,74.78,1391.9,1727.37,1825.60,2000.90,2014.83,2327.36)

x <- missing.bis[8]
start.x <- (trunc(x)-1)*100+(x-floor(x))*100
clc <- raster::extract(corine,wr.corine[start.x,])
name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[start.x,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))

# missing again: 74.78, 1825.60, 2000.90, + a hundred missing Only run 74.78
x <- 74.78
start.x <- (trunc(x)-1)*100+(x-floor(x))*100
clc <- raster::extract(corine,wr.corine[start.x,])
name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[start.x,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))

last.missing <- setdiff(wr.corine$gid,clc.wr.sf$gid) 

for(x in last.missing){
  line <- which(wr.corine$gid == x) 
  clc <- raster::extract(corine,wr.corine[line,])
  name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
  saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[line,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))
}

```

```{r gather-clc-wr, eval = F}
list.clc.tabs <- list.files("WR/clc",pattern = "clc.tab.prop", full.names = T)
list.clc <- lapply(list.clc.tabs,readRDS)

clc.wr <- list.clc[[1]] %>% t() %>% as.data.frame()
clc.wr$gid <- attr(list.clc[[1]],"names")[1:100]
for(x in 2:length(list.clc)){
  m <- list.clc[[x]] 
  df <- m %>% t() %>% as.data.frame() 
  df$gid <- attr(m,"names")[1:dim(df)[1]]
  clc.wr <<- rbind(clc.wr, df)
  }

saveRDS(clc.wr,"WR/clc/clc.wr.Rdata")


```
```{r get-forest-bogs, eval = F}
clc.wr.bogs <- select(clc.wr, c("gid","V36")) %>% setNames(c("gid","bogs"))
clc.wr.forest <- select(clc.wr,c("V23","V24","V25")) %>% rowSums() %>% as.data.frame() %>% setNames("forest")

clc.wr.sum <- cbind(clc.wr.bogs, clc.wr.forest)
saveRDS(clc.wr.sum,"WR/clc/clc.wr.sum.Rdata")

clc.wr.sf <- merge(water.regions,clc.wr.sum,by.x.= "gid",by.y = "gid")
saveRDS(clc.wr.sf,"clc.wr.sf.Rdata")
clc.wr.sf <- readRDS("clc.wr.sf.Rdata")
```
```{r plot-bogs}
clc.wr.sf <- readRDS("clc.wr.sf.Rdata")
ggplot()+geom_sf(data=clc.wr.sf,aes(fill=bogs))
```
## Gathers wr dataset

```{r gather-dataset, eval = F}
summer.ndvi.total <- readRDS("WR/summer.ndvi.total.Rdata")
runoff.df.wr <- readRDS("WR/runoff.df.wr.Rdata")
clc.wr.sum <- readRDS("WR/clc/clc.wr.sum.Rdata")
water.regions <- readRDS("WR/water.regions.Rdata")

wr.df <- merge(summer.ndvi.total,runoff.df.wr, by.x = "gid",by.y = "ebint") %>% merge(clc.wr.sum, by.x = "gid", by.y = "gid")
wr.sf <- merge(water.regions,summer.ndvi.total,by.x="gid",by.y="gid") %>% merge(runoff.df.wr,by.x = "gid", by.y="ebint") %>% merge(clc.wr.sum,by.x = "gid",by.y= "gid")

saveRDS(wr.df, "WR/wr.df.Rdata")
saveRDS(wr.sf, "WR/wr.sf.Rdata")

```

# WR dataframe


```{r final-df, eval = F}

wr.sf <- readRDS("WR/wr.sf.Rdata")
wr.sf$area <- st_area(wr.sf) %>% as.numeric()


wr.sf.clean <- wr.sf %>% filter(ndvi.value != 0) %>% filter(mean.runoff > 1e-6) %>% filter(is.na(bogs) == F)
wr.sf.clean <- wr.sf.clean[!duplicated(wr.sf.clean$gid),]
wr.quantile <- quantile(wr.sf.clean$area, probs = c(0.99,0.991,0.992,0.995,0.999))

area.1 <- sum(wr.sf.clean$area)

wr.sf.2 <- wr.sf.clean %>% filter(area > wr.quantile[1]) # had 0.95 in all analyses - keeps only the 5% bigger regions
area.2 <- sum(wr.sf.2$area)
ratio.area <- area.2/area.1 * 100 # for 

wr.sf.2.plot <- ggplot()+geom_sf(data=wr.sf.2,aes(col = log(area), fill = log(area)))+theme_minimal(base_size = 4)
ggsave(plot = wr.sf.2.plot,filename = "WR/wr.sf.2.png", dpi = "retina", width = 6, height = 8, units = "cm")

saveRDS(wr.sf.2, "WR/wr.sf.2.rds")
```


```{r complete-wr-sf-2}
wr.sf.2 <- readRDS("WR/wr.sf.2.rds")

wr.sf.2$runoff <- wr.sf.2$mean.runoff*365*24*60*60 # converts kg/m2.s in kg/m2/year
wr.sf.2$log.runoff <- log(wr.sf.2$runoff)

wr.sf.2$ndvi <- wr.sf.2$ndvi.value

saveRDS(wr.sf.2, "WR/wr.sf.2.rds")
```

```{r plot-variables}
wr.sf.2 <- readRDS("WR/wr.sf.2.rds")

wr.bogs.plot <- ggplot()+geom_sf(data = wr.sf.2,aes(fill=bogs,col=bogs))+ 
  scale_fill_gradient2(low="#CCCCCC",mid="#FFCC66",high = "#663300",midpoint = 0, aesthetics = c("fill","col"), name = "Proportion of bogs")+
  theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")
ggsave(plot = wr.bogs.plot , filename = "WR/wr.bogs.plot.png",dpi = "retina", width = 6, height = 8, units = "cm")

wr.ndvi.plot <- ggplot()+geom_sf(data = wr.sf.2,aes(fill=ndvi,col=ndvi))+ 
 scale_fill_gradient2(low="#EEE9E9",mid="#FFFFBF",high = "#008B45",midpoint = 0, aesthetics = c("fill","col"),
                       name = "NDVI 1995") + 
   theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")
ggsave(plot = wr.ndvi.plot , filename = "WR/wr.ndvi.plot.png",dpi = "retina", width = 6, height = 8, units = "cm")

wr.runoff.plot <- ggplot()+geom_sf(data = wr.sf.2,aes(fill=runoff,col=runoff))+ 
  scale_fill_gradient2(low="#CCCCCC",mid="#CCFFFF",high = "#003399",midpoint = 0, aesthetics = c("fill","col"))+
   theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")
ggsave(plot = wr.runoff.plot , filename = "WR/wr.runoff.plot.png",dpi = "retina", width = 6, height = 8, units = "cm")

wr.log.runoff <- ggplot()+geom_sf(data = wr.sf.2,aes(fill=log.runoff,col=log.runoff))+ 
  scale_fill_gradient2(low="#CCCCCC",mid="#CCFFFF",high = "#003399",midpoint = 0, aesthetics = c("fill","col"))+
   theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")
ggsave(plot = wr.log.runoff , filename = "WR/wr.log.runoff.png",dpi = "retina", width = 6, height = 8, units = "cm")


```
# Neighbour matrix

```{r wr-km, eval = F}
wr.centroid <- st_centroid(wr.sf.2, of_largest_polygon = T)

wr.neigh.set <- knearneigh(wr.centroid, k = 100)
wr.neigh.nb <- knn2nb(wr.neigh.set)
wr.kmat <- nb2listw(wr.neigh.nb)
saveRDS(wr.kmat,"wr.kmat.Rdata")

```


# Model prediction

We model the mean TOC concentration in all the water region in 1995 based on the simple SEM model of the previous section, using NDVI, bogs and runoff as predictors.

```{r sem-model-toc-wr-95}
library(spatialreg)
sem.fen.simple <- readRDS("sem.fen.simple.Rdata")
wr.sf.2 <- readRDS("WR/wr.sf.2.rds")
fm <- log.toc~ndvi+log.runoff+bogs
wr.pred <- predict(sem.fen.simple,wr.sf.2,wr.kmat, pred.type = "TS",legacy.mixed = F, zero.policy = T) %>% as.data.frame()

sem.pred.wr <- cbind(wr.sf.2,wr.pred$fit)
sem.pred.wr$fit.toc <- exp(sem.pred.wr$wr.pred.fit)

map.fit <- ggplot()+geom_sf(data = st_as_sf(sem.pred.wr), aes(fill = fit.toc, col = fit.toc))+
  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1, 
                       name = "Modelled TOC 1995 (mg/L)")+
  theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")
ggsave(plot = map.fit, filename = "WR/wr.toc.png",dpi = "retina", width = 6, height = 8, units = "cm")

map.log <- ggplot()+geom_sf(data = sem.pred.wr, aes(fill = wr.pred.fit, col = wr.pred.fit))+
  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1, 
                       name = "Modelled log(TOC)")+
   theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")
  
ggsave(plot = map.log, filename = "WR/wr.log.toc.png",dpi = "retina", width = 6, height = 8, units = "cm")
```


# NDVI model based on past temperature and precipitation values

We model NDVI based on temperature and precipitation, and use this model to predict the future NDVI in 2050. 
Choice of future data: ssp 126 as best scenario, ssp 370 as worse scenario @Hausfather2019 @CORDEX2021
CRNM according to @Raju2020

```{r model-ndvi-past}
wr.sf.2 <- readRDS("WR/wr.sf.2.rds")

#bio.fennoscandia <- raster::getData(name = "worldclim", var = "bio", res = 2.5)

#temp.wr <- raster::extract(bio.fennoscandia$bio1, wr.sf.2, fun = mean, df = T, sp = T)
#saveRDS(temp.wr,"temp.wr.rds")

#prec.wr <- raster::extract(bio.fennoscandia$bio12, wr.sf.2, fun = mean, df = T, sp = T)
#saveRDS(prec.wr,"prec.wr.rds")

#wr.sf.3 <- wr.sf.2
#wr.sf.3$temp <- temp.wr$bio1
#wr.sf.3$prec <- prec.wr$bio12
#saveRDS(wr.sf.3,"WR/wr.sf.3.rds")

wr.sf.3 <- readRDS("WR/wr.sf.3.rds")

wr.kmat <- readRDS("WR/wr.kmat.Rdata")
ndvi.model <- errorsarlm(formula = ndvi~temp+log(prec), data = wr.sf.3,wr.kmat)
saveRDS(ndvi.model, "WR/ndvi.model.rds")

```

```{r extract-future-temp-prec, eval = F}
wr.sf.3 <- readRDS("WR/wr.sf.3.rds")

ssp126.cnrm.temp <- raster::raster("worldclim_future/wc2.1_2.5m_bioc_CNRM-CM6-1_ssp126_2041-2060.tif", band = 1)
ssp370.cnrm.temp <- raster::raster("worldclim_future/wc2.1_2.5m_bioc_CNRM-CM6-1_ssp370_2041-2060.tif", band = 1)

ssp126.temp.wr <- raster::extract(ssp126.cnrm.temp,select(wr.sf.3,c("gid","geometry")),fun=mean,df = T, sp = T, na.rm =T)
names(ssp126.temp.wr) <- c("gid", "temp126")
saveRDS(ssp126.temp.wr,"WR/ssp126.temp.wr.rds")

ssp370.temp.wr <- raster::extract(ssp370.cnrm.temp,select(wr.sf.3,c("gid","geometry")),fun=mean,df = T, sp = T, na.rm = T)
names(ssp370.temp.wr) <- c("gid", "temp370")
saveRDS(ssp370.temp.wr,"ssp370.temp.wr.rds")
```

```{r extract-future-temp-prec, eval = F}
wr.sf.3 <- readRDS("WR/wr.sf.3.rds")

ssp126.cnrm.prec <- raster::raster("worldclim_future/wc2.1_2.5m_bioc_CNRM-CM6-1_ssp126_2041-2060.tif", band = 12)
ssp370.cnrm.prec <- raster::raster("worldclim_future/wc2.1_2.5m_bioc_CNRM-CM6-1_ssp370_2041-2060.tif", band = 12)

ssp126.prec.wr <- raster::extract(ssp126.cnrm.prec,select(wr.sf.3,c("gid","geometry")),fun=mean,df = T, sp = T, na.rm = T)
names(ssp126.prec.wr) <- c("gid", "prec126")
saveRDS(ssp126.prec.wr,"WR/ssp126.prec.wr.rds")

ssp370.prec.wr <- raster::extract(ssp370.cnrm.prec,dplyr::select(wr.sf.3,c("gid","geometry")),fun=mean,df = T, sp = T, na.rm = T)
names(ssp370.prec.wr) <- c("gid", "prec370")
saveRDS(ssp370.prec.wr,"WR/ssp370.prec.wr.rds")
```

```{r merge-temp-prec}
ssp126.temp.wr <- readRDS("WR/ssp126.temp.wr.rds")
ssp370.temp.wr <- readRDS("WR/ssp370.temp.wr.rds")
ssp126.prec.wr <- readRDS("WR/ssp126.prec.wr.rds")
ssp370.prec.wr <- readRDS("WR/ssp370.prec.wr.rds")
wr.sf.3 <- readRDS("WR/wr.sf.3.rds")

# SSP126
df.ssp126 <- merge(ssp126.temp.wr, ssp126.prec.wr,by = "gid") %>% setNames(c("gid","temp","prec")) 
saveRDS(df.ssp126, "WR/df.ssp126.rds")

# SSP 370
df.ssp370 <- merge(ssp370.temp.wr, ssp370.prec.wr, by = "gid") %>% setNames(c("gid","temp","prec"))
saveRDS(df.ssp370, "WR/df.ssp370.rds")
```

```{r model-future-ndvi}
df.ssp126 <- readRDS("WR/df.ssp126.rds")
df.ssp370 <- readRDS("WR/df.ssp370.rds")
ndvi.model <- readRDS("WR/ndvi.model.rds")
wr.sf.3 <- readRDS("WR/wr.sf.3.rds")

ndvi.ssp126 <- predict(object = ndvi.model, newdata = df.ssp126,listw = wr.kmat, pred.type = "TS", legacy.mixed = F, zero.policy = T)

ndvi.ssp126.fit <- cbind(df.ssp126, ndvi.ssp126[,1]) %>% setNames(c("gid","temp","prec","fit")) %>% sp::merge(wr.sf.3[,1:2], by = "gid") %>% st_as_sf()
ndvi.ssp126.fit$ndvi.diff <- ndvi.ssp126.fit$fit-ndvi.ssp126.fit$ndvi
ndvi.ssp126.fit$percent.change <- ndvi.ssp126.fit$ndvi.diff/ndvi.ssp126.fit$ndvi

saveRDS(ndvi.ssp126.fit,"WR/ndvi.ssp126.fit.rds")

ndvi.ssp370 <- predict(object = ndvi.model, newdata = df.ssp370, listw = wr.kmat, pred.type = "TS", legacy.mixed = F, zero.policy = T)

ndvi.ssp370.fit <- cbind(df.ssp370, ndvi.ssp370[,1]) %>% setNames(c("gid","temp","prec","fit")) %>% sp::merge(wr.sf.3[,1:2], by = "gid") %>% st_as_sf()
ndvi.ssp370.fit$ndvi.diff <- ndvi.ssp370.fit$fit-ndvi.ssp370.fit$ndvi
ndvi.ssp370.fit$percent.change <- ndvi.ssp370.fit$ndvi.diff/ndvi.ssp370.fit$ndvi

saveRDS(ndvi.ssp370.fit,"WR/ndvi.ssp370.fit.rds")
```

```{r plot-future-temp-prec}
ndvi.ssp126.fit <- readRDS("WR/ndvi.ssp126.fit.rds")
ndvi.ssp370.fit <- readRDS("WR/ndvi.ssp370.fit.rds")

ssp126.temp.plot <- ggplot()+geom_sf(data=st_as_sf(ndvi.ssp126.fit),aes(fill= temp , col = temp))+
  scale_fill_gradient2(low="#EEE9E9",mid="#FFFFBF",high = "#990000",midpoint = 0, aesthetics = c("fill","col"),
                       name = "2041-2060 average temperature\n under SSP126 (°C)") + 
  theme_minimal(base_size = 4) +
  theme(legend.position = "bottom") 
ggsave(plot = ssp126.temp.plot,filename = "WR/ssp126.temp.png",dpi = "retina", width = 6, height = 8, units = "cm")

ssp370.temp.plot <- ggplot()+geom_sf(data=st_as_sf(ndvi.ssp370.fit),aes(fill= temp , col = temp))+
  scale_fill_gradient2(low="#EEE9E9",mid="#FFFFBF",high = "#990000",midpoint = 0, aesthetics = c("fill","col"), 
                       name = "2041-2060 average temperature\n under SSP370 (°C)") +
  theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")
ggsave(plot = ssp370.temp.plot,filename = "WR/ssp370.temp.png",dpi = "retina", width = 6, height = 8, units = "cm")

ssp126.prec.plot <- ggplot()+geom_sf(data=st_as_sf(ndvi.ssp126.fit),aes(fill=prec, col = prec))+
  scale_fill_gradient2(low="#EEE9E9",mid="#CAE1FF",high = "#00688B",midpoint = 0, aesthetics = c("fill","col"), 
                       name = "2041-2060 average precipitation\n under SSP126 (mm/year)") + 
  theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")
ggsave(plot = ssp126.prec.plot,filename = "WR/ssp126.prec.png",dpi = "retina", width = 6, height = 8, units = "cm")

ssp370.prec.plot <- ggplot()+geom_sf(data=st_as_sf(ndvi.ssp370.fit),aes(fill=prec, col = prec))+
  scale_fill_gradient2(low="#EEE9E9",mid="#CAE1FF",high = "#00688B",midpoint = 0, aesthetics = c("fill","col"), 
                       name = "2041-2060 average precipitation\n under SSP370 (mm/year)") +
  theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")
ggsave(plot = ssp370.prec.plot,filename = "WR/ssp370.prec.png",dpi = "retina", width = 6, height = 8, units = "cm")

```

```{r plot-future-ndvi}
ssp126.diff.ndvi <- ggplot()+geom_sf(data=ndvi.ssp126.fit,aes(fill=ndvi.diff, col = ndvi.diff)) + 
  scale_fill_gradient2(low="#EEE9E9",mid="#FFFFBF",high = "#008B45",midpoint = 0, aesthetics = c("fill","col"),
                       name = "Difference NDVI 1995-2050\n under SSP126") + 
  theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")
ggsave(plot = ssp126.diff.ndvi,filename = "WR/ssp126.ndvi.diff.png",dpi = "retina", width = 6, height = 8, units = "cm")

ssp126.ndvi <- ggplot()+geom_sf(data=ndvi.ssp126.fit,aes(fill=ndvi, col = ndvi)) + 
  scale_fill_gradient2(low="#EEE9E9",mid="#FFFFBF",high = "#008B45",midpoint = 0, aesthetics = c("fill","col"),
                       name = "NDVI 2050 under SSP126") + 
  theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")
ggsave(plot = ssp126.ndvi,filename = "WR/ssp126.ndvi.png",dpi = "retina", width = 6, height = 8, units = "cm")

ssp370.diff.ndvi <- ggplot()+geom_sf(data=ndvi.ssp370.fit,aes(fill=ndvi.diff, col = ndvi.diff))+ 
  scale_fill_gradient2(low="#EEE9E9",mid="#FFFFBF",high = "#008B45",midpoint = 0, aesthetics = c("fill","col"),
                       name = "Difference NDVI 1995-2050\n under SSP370") + 
  theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")
ggsave(plot = ssp370.diff.ndvi,filename = "WR/ssp370.ndvi.diff.png",dpi = "retina", width = 6, height = 8, units = "cm")

ssp370.ndvi <- ggplot()+geom_sf(data=ndvi.ssp370.fit,aes(fill=ndvi,col=ndvi)) + 
  scale_fill_gradient2(low="#EEE9E9",mid="#FFFFBF",high = "#008B45",midpoint = 0, aesthetics = c("fill","col"),
                       name = "NDVI 2050 under SSP370") + 
  theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")
ggsave(plot = ssp370.ndvi,filename = "WR/ssp370.ndvi.png",dpi = "retina", width = 6, height = 8, units = "cm")

```

```{r extract-future-runoff}
wr.sf.3 <- readRDS("WR/wr.sf.3.rds")

ssp126.runoff.wr <- raster::stack("CORDEX_future/mrros_Lmon_CNRM-CM6-1-HR_ssp126_r1i1p1f2_gr_201501-210012.nc", bands = c(313:552))
ssp126.runoff.wr.mean <- ssp126.runoff.wr %>% mean()

ssp126.runoff <- raster::extract(ssp126.runoff.wr.mean,dplyr::select(wr.sf.3,c("gid","geometry")),fun=mean,df = T, sp = T)
names(ssp126.runoff) <- c("gid","runoff126")
saveRDS(ssp126.runoff,"WR/ssp126.runoff.rds")

ssp370.runoff.wr <- raster::stack("CORDEX_future/mrros_Lmon_CNRM-CM6-1-HR_ssp370_r1i1p1f2_gr_201501-210012.nc", bands = c(313:552))
ssp370.runoff.wr.mean <- ssp370.runoff.wr %>% mean()

ssp370.runoff <- raster::extract(ssp370.runoff.wr.mean,dplyr::select(wr.sf.3,c("gid","geometry")),fun=mean,df = T, sp = T)
names(ssp370.runoff) <- c("gid","runoff370")
saveRDS(ssp370.runoff,"WR/ssp370.runoff.rds")
```

```{r plot-future-runoff}
ssp126.runoff <- readRDS("WR/ssp126.runoff.rds")
ssp370.runoff <- readRDS("WR/ssp370.runoff.rds")

ssp126.runoff.plot <- ggplot()+geom_sf(data = st_as_sf(ssp126.runoff),aes(fill=runoff126,col=runoff126))+ 
  scale_fill_gradient2(low="#CCCCCC",mid="#CCFFFF",high = "#003399",midpoint = 0, aesthetics = c("fill","col"), name = "Average runoff 2041-2060\n under SSP126 in mm/year")+
  theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")
ggsave(plot = ssp126.runoff.plot , filename = "WR/ssp126.runoff.png",dpi = "retina", width = 6, height = 8, units = "cm")

ssp370.runoff.plot <- ggplot()+geom_sf(data = st_as_sf(ssp370.runoff),aes(fill=runoff370,col=runoff370))+ 
  scale_fill_gradient2(low="#CCCCCC",mid="#CCFFFF",high = "#003399",midpoint = 0, aesthetics = c("fill","col"), name = "Average runoff 2041-2060\n under SSP370 in mm/year")+
  theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")
ggsave(plot = ssp370.runoff.plot , filename = "WR/ssp370.runoff.png",dpi = "retina", width = 6, height = 8, units = "cm")
```

```{r future-wr}
ndvi.ssp126.fit <- readRDS("WR/ndvi.ssp126.fit.rds")
ndvi.ssp370.fit <- readRDS("WR/ndvi.ssp370.fit.rds") 
ssp126.runoff <- readRDS("WR/ssp126.runoff.rds")
ssp370.runoff <- readRDS("WR/ssp370.runoff.rds")

sem.pred.wr <- readRDS("WR/sem.pred.wr.rds")
wr.sf.3 <- readRDS("WR/wr.sf.3.rds")

wr.sf.126 <- merge(dplyr::select(wr.sf.3, c("gid","bogs")),st_drop_geometry(ndvi.ssp126.fit), by = "gid") %>% merge(st_drop_geometry(st_as_sf(ssp126.runoff)), by = "gid")
wr.sf.370 <- merge(dplyr::select(wr.sf.3, c("gid","bogs")), st_drop_geometry(ndvi.ssp370.fit), by = "gid") %>% merge(st_drop_geometry(st_as_sf(ssp370.runoff)), by = "gid")

na.lines.126 <- which(complete.cases(st_drop_geometry(wr.sf.126))==F)
na.lines.370 <- which(complete.cases(st_drop_geometry(wr.sf.370))==F)

wr.sf.126 <- wr.sf.126[-na.lines.126,]
wr.sf.370 <- wr.sf.370[-na.lines.370,]


wr.sf.126$runoff <- wr.sf.126$runoff126*365*24*60*60 # from kg/m2/s to kg/m2/year
wr.sf.370$runoff <- wr.sf.370$runoff370*365*24*60*60 # from kg/m2/s to kg/m2/year

wr.sf.126$log.runoff <- wr.sf.126$runoff %>% log10()
wr.sf.370$log.runoff <- wr.sf.370$runoff %>% log10()


wr.sf.126$percent.runoff <- wr.sf.126$runoff/wr.sf.126$runoff * 100
wr.sf.370$percent.runoff <- wr.sf.370$runoff370/wr.sf.370$runoff * 100

saveRDS(wr.sf.126, "WR/wr.sf.126.rds")
saveRDS(wr.sf.370, "WR/wr.sf.370.rds")

```

# Prediction

Then, we forecast the evolution of toc concentration based on the predicted values and the effect size given by the model on the Fennoscandian dataset
(toc + beta*toc)

```{r sem-model-toc-ssp126-2050}
sem.fen.simple <- readRDS("sem.fen.simple.Rdata")
wr.sf.126 <- readRDS("WR/wr.sf.126.rds")

fm <- log.toc~ndvi+log.runoff+bogs

wr.pred.ssp126 <- predict(sem.fen.simple,wr.sf.126,wr.kmat, pred.type = "TS",legacy.mixed = F, zero.policy = T) %>% as.data.frame()

wr.ssp126 <- cbind(wr.sf.126,wr.pred.ssp126$fit)
wr.ssp126$toc <- exp(wr.ssp126$fit)

map.toc.126 <- ggplot()+geom_sf(data = wr.ssp126, aes(fill = toc, col = toc))+
  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1, 
                       name = "Modelled TOC in 2050 under SSP126 (mg/L)")+
  theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")
ggsave(plot = map.toc.126, filename = "WR/map.toc.126.png",dpi = "retina", width = 6, height = 8, units = "cm")

map.log.toc.126 <- ggplot()+geom_sf(data = wr.ssp126, aes(fill = fit, col = fit))+
  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1,
                       name = "Modelled log(TOC) in 2050 under SSP126")+
  theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")
ggsave(plot = map.log.toc.126, filename = "WR/map.log.toc.126.png",dpi = "retina", width = 6, height = 8, units = "cm")

# wr.ssp126.bis <- merge(wr.ssp126,st_drop_geometry(dplyr::select(sem.pred.wr, c("gid","fit.toc"))), by = "gid")
# wr.ssp126.bis$toc.diff <- wr.ssp126.bis$toc - wr.ssp126.bis$fit.toc
# 
# map.toc.diff.126 <- ggplot()+geom_sf(data = wr.ssp126.bis, aes(fill = toc.diff, col = toc.diff))+
#   scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1,
#                        name = "Difference TOC concentration 1995-2050\n under SSP126")+
#   theme_minimal(base_size = 4)+
#   theme(legend.position = "bottom")
# ggsave(plot = map.toc.diff.126, filename = "WR/map.toc.diff.126.png",dpi = "retina", width = 6, height = 8, units = "cm")
```

```{r sem-model-toc-ssp370-2050}
sem.fen.simple <- readRDS("sem.fen.simple.Rdata")
wr.sf.370 <- readRDS("WR/wr.sf.370.rds")

fm <- log.toc~ndvi+log.runoff+bogs

wr.pred.ssp370 <- predict(sem.fen.simple,wr.sf.370,wr.kmat, pred.type = "TS",legacy.mixed = F, zero.policy = T) %>% as.data.frame()

wr.ssp370 <- cbind(wr.sf.370,wr.pred.ssp370$fit)
wr.ssp370$toc <- exp(wr.ssp370$fit)

map.toc.370 <- ggplot()+geom_sf(data = wr.ssp370, aes(fill = toc, col = toc))+
  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1,
                       name = "Modelled TOC in 2050 under SSP370 (mg/L)")+
  theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")
ggsave(plot = map.toc.370, filename = "WR/map.toc.370.png",dpi = "retina", width = 6, height = 8, units = "cm")

map.log.toc.370 <- ggplot()+geom_sf(data = wr.ssp370, aes(fill = fit, col = fit))+
  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1,
                       name = "Modelled log(TOC) in 2050 under SSP370")+
  theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")
ggsave(plot = map.log.toc.370, filename = "WR/map.log.toc.370.png",dpi = "retina", width = 6, height = 8, units = "cm")

```

```{r sem-forest-model-toc-2050}
sem.forest.fen <- readRDS("sem.forest.fen.Rdata")
wr.sf.3 <- readRDS("WR/wr.sf.3.rds")
fm <- log.toc~forest+log.runoff+bogs

wr.sf.forest <- wr.sf.3
x <- wr.sf.3$forest
y <- x + (1-x)*x
wr.sf.forest$forest <- y


pred.forest <- predict(sem.forest.fen,wr.sf.forest,wr.kmat, pred.type = "TS",legacy.mixed = F, zero.policy = T) %>% as.data.frame()

wr.forest.pred <- cbind(wr.sf.forest,pred.forest$fit)
wr.forest.pred$toc <- exp(wr.forest.pred$pred.forest.fit)

map.toc.forest <- ggplot()+geom_sf(data = wr.forest.pred, aes(fill = toc, col = toc))+
  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1, 
                       name = "Modelled TOC with increase of forest cover (mg/L)")+
  theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")

ggsave(plot = map.toc.forest, filename = "WR/map.toc.forest.png",dpi = "retina", width = 6, height = 8, units = "cm")

map.log.toc.forest <- ggplot()+geom_sf(data = wr.forest.pred, aes(fill = pred.forest.fit, col = pred.forest.fit))+scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1, name = "Modelled log(TOC) with increase of forest cover")+
  theme_minimal(base_size = 4)+
  theme(legend.position = "bottom")
ggsave(plot = map.log.toc.forest, filename = "WR/map.log.toc.forest.png",dpi = "retina", width = 6, height = 8, units = "cm")

```

### Extra
```{r effect-size, eval = F}
sem.coef <- sem.fen.simple$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")

wr.sf.4$effect.ndvi.126 <- wr.sf.4$fit.log.toc*(10^(sem.coef[1,1]*wr.sf.4$percent.change126))
wr.sf.4$effect.ndvi.370 <- wr.sf.4$fit.log.toc*(10^(sem.coef[1,1]*wr.sf.4$percent.change370))
wr.sf.4$effect.runoff.126 <- wr.sf.4$fit.log.toc*(10^(sem.coef[2,1]*wr.sf.4$percent.runoff126))
wr.sf.4$effect.runoff.370 <- wr.sf.4$fit.log.toc*(10^(sem.coef[2,1]*wr.sf.4$percent.runoff370))

legend.limit <- c(0, max(c(wr.sf.4$effect.ndvi.126,wr.sf.4$effect.ndvi.370,wr.sf.4$effect.runoff.126,wr.sf.4$effect.runoff.370)))

map.ndvi <- ggplot()+geom_sf(data = wr.sf.4, aes(fill = effect.ndvi.126, col = effect.ndvi.126))+scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1, limits = legend.limit)+theme_minimal()
ggsave(plot = map.ndvi, filename = "WR/effect.ndvi.png",dpi = "retina", width = 6, height = 8, units = "cm")

map.ndvi.370 <- ggplot()+geom_sf(data = wr.sf.4, aes(fill = effect.ndvi.370, col = effect.ndvi.370))+scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1, limits = legend.limit)+theme_minimal()
ggsave(plot = map.ndvi, filename = "WR/effect.ndvi.370.png",dpi = "retina", width = 6, height = 8, units = "cm")

map.runoff.126 <- ggplot()+geom_sf(data = wr.sf.4, aes(fill = effect.runoff.126, col = effect.runoff.126))+scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1,limits = legend.limit)+theme_minimal()
ggsave(plot = map.runoff, filename = "WR/effect.runoff.126.png",dpi = "retina", width = 6, height = 8, units = "cm")

map.runoff.370 <- ggplot()+geom_sf(data = wr.sf.4, aes(fill = effect.runoff.370, col = effect.runoff.370))+scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1,limits = legend.limit)+theme_minimal()
ggsave(plot = map.runoff, filename = "WR/effect.runoff.370.png",dpi = "retina", width = 6, height = 8, units = "cm")
```
