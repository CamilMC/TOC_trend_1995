---
title: "Geographical modelling of TOC concentration"
author: "Camille M. Crapart"
date: "26 01 2022"

output: 
  bookdown::word_document2:
   toc: true
   toc_float: true
   number_sections: true
   fig_caption: true
   extra_dependencies: "subfig"
always_allow_html: true
bibliography: C:\\Users\\raine\\Documents\\UiO\\Bibtex\\Finstad.bib
csl: acs-earth-and-space-chemistry.csl
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F, error = F)
options(knitr.kable.NA="", kableExtra.auto_format = F)
```

```{r library, results = "hide"}
library(dplyr)
library(tibble)

library(DBI)
library(sf)
library(gimms)

library(ncdf4)
library(rgdal)

library(stringr)
library(png)

library(ggplot2)
library(cowplot)
library(spdep)
library(spatialreg)

library(kableExtra)

library(gridExtra)
library(captioner)

source("f_plotspatial.R")
fennoscandia <- readRDS("fennoscandia.Rdata")
fennoscandia.spdf <- readRDS("fennoscandia.spdf.Rdata")
fennoscandia.33 <- readRDS("fennoscandia.33.rds")
norge <- fennoscandia %>% filter(nation == "Norway")

memory.limit(size = 100000)
fig_nums <- captioner() 
table_nums <- captioner(prefix = "Table")
```

# Introduction 

In northern boreal lakes, the increased transport of organic matter from catchments to rivers and lakes resulted in a widespread darkening of freshwater, a phenomenon referred to as browning. This trend has been documented since the 80s @Monteith2007, as several monitoring programs were implemented to follow-up the acid deposition policies, a main environmental concern at the time. The two successive sulphur protocols of Helsinki in 1985 and in Oslo 1994 @UNECE were followed by regional surveys on water quality, one in 1986 and one in 1995 (Northern European Lake Survey in 1995 @Henriksen1998). The last survey included Norway, Sweden, Finland, Denmark, as well as Scotland, Wales and Russian Kola and Karelia. A 50% decrease of acid rains was observed between the period 76-85 and the period 95-2001 @Menz2004. Finstad et al. @Finstad2016 demonstrated that acidification negatively affects the solubility of DOC, therefore reducing the transport from terrestrial pools to lakes. As a result, the concentration of organic matter dramatically increased @DeWit2007a. 

However, other parameters play a role in the browning of the water. A main factor is climate change, with changing runoff patterns expected to lead to an increased transport of TOC @DeWit2016a. Longer growing seasons also increase the primary production on the catchments @Finstad2016. In addition, the land-use changes tend towards more intensive forestry practices. Small-scale farming used forest resources for the cattle @Myrstener2021, but the abandon of these practices resulted in increased standing forest biomass and soil organic matter production. 

Forest management is a major tool in Fennoscandian climate policies @Sundnes2020. In line with the Declaration on Forest and Land Use signed on November 2021 @UNClimateChangeConferenceUK2021, the Fennoscandian governments consider forest as a leverage for offsetting their carbon emissions and reaching their zero-emission goals. With respectively 38 @SSB2021, 70 @SwedishForestIndustries2019 and 86% @Torniainen2019 of their territories covered with forest, the Fennoscandian countries are not subject to deforestation. On the contrary, the boreal forest covering Fennoscandia is part of the largest carbon pool on Earth. According to Bradshaw et al. @Bradshaw2015, the mean value of the total carbon store in the boreal biome could be reach 1041,5 Pg compared to 500 in the tropical forests. This carbon is mostly stored in soil and peatlands. In the last centuries, boreal forests have been a sink for carbon due to their high growth rate, mainly because they extended over previously frozen area and benefited from a milder climate, with longer growing seasons. This enhanced growing rate partially compensated the CO2 emissions generated by deforestation in other parts of the world @LeNoe2021. Current policies in the Nordics largely promote the intensification of the forest industry. In Norway, MiljÃ¸direktoratet subsidies the densification of the planted area and the afforestation of new ones @Futter2019. In Sweden, where most of the forest area is productive, timber industry is a major economical resource @RoyalSwedish2015. Forestry products account for 23% of the swedish total exports and the standing biomass doubled over the last 100 years @Narin. Formas, the governement resarch council for sustainable development, promotes "bioeconomy" as a major climate mitigation tool @Fromas2012. Similarly, 20% of the Finnish goods exports come from the wood industry @Forestry2014.  The finnish forest legislation was renewed in the 2010s to improve its competitiveness while conserving its goals in terms of sustainability, and national subsidy schemes aim at intensifying the forestry sector.
The planned intensification of forest management and afforestation has raised concern over the water quality @Futter2019. In Norway, 90% of the drinking water @NorskVann and 90% of the electricity @EnergifaktaNorge2020 comes from surface waters. Nitrogen pollution and browning have potential impacts on the necessary treatments to ensure potability of water @Eikebrokk2018, as well as on the local ecosystems and the greenhouse gases emissions of the lake, especially in small lakes @DeWit2018. As a matter of fact, 90% of the total organic matter in boreal lakes is dissolved @Larsen2011 and has several roles in the lake ecosystem. DOC is the main source of food for heterotrophic bacteria. With darker waters, the light available for photosynthesis decreases, favoring heterotrophic bacteria against autotrophic bacteria and shifting the gas balance from a sink to a source of greenhouse gases. In addition, the sunlight is absorbed by the colored DOC, warming the upper layer of the lakes. Warm and dark water, with limited light availability, potentially disturb local species and fish production @Karlsson2009 @Craig2017. The current browning of freshwater lakes and rivers entails the darkening of coastal waters, delaying phytoplankton spring blooms and decreasing primary production @Opdal2019a. Understanding the drivers for TOC concentration under anthropogenic and climatic stresses is therefore essential to forecast potential damages to the water ecosystems and to water quality. 

In this article, we extend the model proposed by Larsen et al @Larsen2011a in 2011, using catchment characteristics to predict the concentration of TOC in Fennoscandian lakes. Larsen et al. used a database consisting of the Norwegian lakes sampled during the Northern European Lake Survey @Henriksen1998, and use NDVI, bogs and runoff as predictors. Here, we use the same survey but include lakes and catchments from Sweden and Finland (around 4000 lakes and catchments). Other catchment characteristics are included at first to test the assumption the NDVI, bogs and runoff are good predictors. In addition, we introduce spatial modelling tools in order to take into account the spatial autocorrelation of the response and predictor variables: a spatial error model and a geographically weighted model. Based on the model results, we compute the effect size of a relative increase of each of the predictor variables. Finally, we extend these results to the entire area of Fennoscandia by forecasting future average TOC concentration in the fennoscandian water regions (ensemble of catchments running off to the sea). These models allow us to test two hypothesis: that climate change, with increased temperature and runoff, will have a positive effect on the TOC concentration in Fennoscandian lake; and that the climate forest policy is likely to exacerbate the ongoing brownification. 



# Methods

## Data preparation 

The complete procedure for data preparation is available in Supplementary 1. An overview of variables is provided in section [Overview of variables](#overview).

## Models

Larsen et al. @Larsen2011 used a linear regression model to forecast the evolution of the toc concentration in Fennoscandian lakes. In this study, we first reproduce a similar linear regression model (LM). In addition, we take into account the spatial autocorrelation of the response and predictor variables by fitting two different spatial models: a spatial error linear model (SELM) and a geographically weighted model (GWR). The spatial error model includes the spatial autocorrelation in the error term, while the geographically weighted model computes one model for each datapoint.

The linear and spatial error models are fitted both on scaled and unscaled variables. The scaled estimates are used to compare the impact of the predictor variables on the same scale, while the unscaled estimates are used to compute the effect sizes. The GWR model is fitted only with unscaled variables, as we only show the local effect sizes. The formulas to calculate the effect size for each pair response/predictor variable are explained in Supplementary 2. 

# Results

## Overview of variables {#overview}


### Mapping of response and predictor variables

The dataset is composed of `r dim(fennoscandia)[1]` lakes sampled during the Northen Lake Survey in 1995 @Henriksen1998. The TOC concentration, which is the response variable that we aim to model, was measured by NIVA after the sampling @Henriksen1997. The 8 predictor variables were downloaded. The catchment data (NDVI, runoff, temperature, precipitation etc.) were computed as the mean value of each parameter over the catchment. The mean values are represented on `r fig_nums("insert-maps", display = "c")`. The collection and cleaning of data are detailed in data preparation section, but a summary of the variables is presented below. All logarithmic transformations use the natural logarithm. 

* The TOC concentration values come from the Northern Lake Survey and are expressed in mg/L. The TOC concentration values are log-transformed in this analysis to normalize the distribution.

* NDVI is downloaded from the GIMMS database for 1994, the year preceding the sampling @TheNationalCenterforAtmosphericResearch2018. We use the mean value of the summer months (June, July and August) over the catchment.

* The runoff values are derived from the CORDEX model, and are the average value for the model predictions from year 1960 to year 1990 @CORDEX @Kreienkamp2012. The runoff values are converted in kg/m2/year, or mm/year, and are also log-transformed. 

* Temperature and precipitation data are downloaded from the WorldClim database @WorldClim. Temperature is in degrees and precipitation in mm/year. They are the average values from 1970 to 2000, and the mean of each catchment was computed. The precipitation values are log-transformed to normalize the distribution. 

* The proportions of bogs, arable land and forested area are computed from the Corine Land Cover database @CopernicusCLC, and correspond to the 2000 data, as the raster for 1995 was not available. Several CLC category were merged to create the three categories used in this study (see Supplementary 1).None of the land cover values are transformed. A log transformation in  not possible due to many zeros in the data, and the other possible transformations (square, square roots) did not help to normalize the distribution. 

* N-deposition data is extracted from EMEP models @EMEP. We use here the total N deposition (sum of dry and wet deposition). The first available year is 2000, so data from 2000 was used. We assume the there was little change between 1995 and 2000. 




```{r map-variable, fig.dim = c(10,13), fig.cap = "Maps of response and predictor variables", eval = F}
m <- c("log.toc","ndvi","log.runoff","log.prec","temp","bogs","arable","forest","tndep")
u <- c("TOC concentration, log(mg/L)", "NDVI on scale 0 to 1", "Mean runoff, log(kg/m2/an)","Mean annual precipitation,\n log(mm)","Mean annual temperature,\n degree celsius","Proportion of bogs, %","Proportion of\narable land, %","Proportion of forest, %","Total nitrogen\ndeposition, ug/m2")
list.map <- lapply(m,FUN = function(x)  f_plotspatial(data=fennoscandia,var=fennoscandia[[x]],plottitle = "")+annotate("text", x = 10, y = 69.5, label = paste(u[grep(x,m)],"\n(",x,")",sep="")))

cowplot::plot_grid(plotlist = list.map,ncol=2)
```


```{r map-cat-variable, eval = F}
m <- c("log.toc","ndvi","log.runoff","log.prec","temp","bogs","arable","forest","tndep")

u <- c("TOC concentration, log(mg/L)", "NDVI on scale 0 to 1", "Mean runoff, log(mm/s)","Mean annual precipitation,\n log(mm)","Mean annual temperature,\n degree celsius","Proportion of bogs","Proportion of\narable land","Proportion of forest","Total nitrogen\ndeposition, ug/m2")

colors <- c("YlOrBr","Greens","Blues","Blues","OrRd","Oranges","RdYlGn","Greens","Purples")

for(i in m[c(7)]){
  map <- ggplot(fennoscandia.33)+geom_sf(aes(fill = .data[[i]], col = .data[[i]]))+
                     scale_fill_distiller(type = "seq", palette = colors[which(m == i)], aesthetics = c("colour","fill"), direction = 1, 
                     name = paste(u[grep(i,m)],"\n(",i,")",sep=""))+
    theme_minimal(base_size = 6)+
    theme(legend.position = "bottom")
  filename_i <- paste("map",i,"png",sep = ".")
  ggsave(plot = map, filename = filename_i, dpi = "retina", width = 6, height = 8, units = "cm")
}

```

```{r insert-maps, fig.dim = c(6,9)}
knitr::include_graphics(c("map.log.toc.png","map.ndvi.png","map.forest.png","map.log.runoff.png","map.log.prec.png","map.temp.png","map.tndep.png","map.arable.png","map.bogs.png"))
```

`r fig_nums("insert-maps", "Maps of response and predictor variables")`

### Correlation between predictor variables

```{r corrplot, fig.dim=c(4,4)}
m <- c("log.toc","ndvi","log.runoff","log.prec","temp","bogs","arable","forest","tndep")
cor.mat <- cor(dplyr::select(fennoscandia,m[-1]))
corrplot::corrplot(cor.mat, method = "number",type = "lower", number.cex = 0.7, tl.cex = 0.7, cl.cex = 0.7)
```

`r fig_nums("corrplot", "Correlation plot for predictor variables")`

`r fig_nums("corrplot", display = "c")` shows the Pearson correlation coefficient between the predictor variables. All the correlation are represented, independently of their p-value. NDVI has a high positive correlation with forest (r = `r round(cor(fennoscandia$ndvi,fennoscandia$forest),2)`. The highest correlation coefficient corresponds to the Pearson coefficient between temperature and N-dep (r = `r round(cor(fennoscandia$temp,fennoscandia$tndep),2)`). This may be explained by the fact that acid rains and air pollution affects mainly the southern regions of Fennoscandia. As expected, log precipitation and log runoff are correlated (r = `r round(cor(fennoscandia$log.prec,fennoscandia$log.runoff),2)`), but we expect that runoff will be a better predictor because it reflects the potential flux of TOC from soil to lakes. Precipitation can have adverse effects on TOC concentration: in colder regions, a high level of precipitations takes the form of a snow layer that prevents vegetation growth and therefore reduces the TOC production on the catchment and in situ. 


Forest and NDVI are also positively correlated (r = `r round(cor(fennoscandia$forest,fennoscandia$ndvi),2)`), but the two parameters do not provide the same information. Land cover data has a finer resolution than NDVI data (see `r fig_nums("rawndvi", display = "c")` and `r fig_nums("rawclc", display = "c")`), The minimum mapping unit in Corine Land Cover is 25 ha, for a minimum of 100 m linear feature. The mapping is realized base on satellite images country by country in a semi-automatic way, which can result in slight differences of image interpretation between countries.  Finland and Sweden, for example, use two different methods to treat the forest cover @Buttner2021. On the contrary, the NDVI is processed the same way for all countries but has a 8 km spatial resolution (the basic square can be 8x8 km, or 1600 ha), which is much coarser resolution. However, the NDVI reflects all kind of vegetation and its density, which is not taken into account in the land cover. 

```{r rawndvi, fig.dim = c(3,5)}
knitr::include_graphics("NDVI/ndvi.fen.95.png")
```

`r fig_nums("rawndvi", "Map of summer NDVI (1995) in Fennoscandia")`

```{r rawclc, fig.dim = c(8,5)}
knitr::include_graphics("Corine_Land_Cover/map-clc2.png")
```

`r fig_nums("rawclc", "Map of CORINE Land Cover (2000) in Fennoscandia")`

### Spatial autocorrelation & VIF

The spatial autocorrelation of the variables is evaluated thanks to the Moran's I index. Moreover, the collinearity between the predictor variables is assessed by using the Variance Inflation Factor (VIF). The results are presented in `r table_nums("moran-vif-table", display = "c")`.

```{r neighbour-matrix,  eval = F}
library(spdep)
k.neigh.set <- knearneigh(fennoscandia.spdf, k = 100)
k.neigh.nb.set <- knn2nb(k.neigh.set)
k.neigh.w <- nb2listw(k.neigh.nb.set)
saveRDS(k.neigh.w,"k.neigh.w.Rdata")
```

```{r spatial-autocorrelation, eval = T}
k.neigh.w <- readRDS("k.neigh.w.Rdata")
moran.list <- c() 

m <- c("log.toc","ndvi","log.runoff","log.prec","temp","bogs","arable","forest","tndep")

for (i in m){
  moran.list[[i]] <- moran.test(fennoscandia[,i],k.neigh.w, na.action = na.omit, alternative = "two.sided")
}

moran.df <- data.frame(m) %>% setNames("parameter")
moran.df$moran.I <- NA
moran.df$p.value <- NA

for (i in 1:length(moran.list)){
  moran.df$moran.I[i] <- moran.list[[i]]$estimate[1]
  moran.df$p.value[i] <- moran.list[[i]]$p.value
}

saveRDS(moran.df,"moran.df.Rdata")
```

```{r vif}
lm.all <- lm(data = fennoscandia, formula = as.formula(paste(m[1],"~",paste(m[-1],collapse = "+"))))
lm.vif <- car::vif(lm.all) %>% as.data.frame() %>% setNames("VIF")
```


```{r moran-vif-table}
moran.df <- readRDS("moran.df.Rdata")

moran.limit <- 1/(dim(fennoscandia)[1]-1)

moran.vif.df <- merge(moran.df,lm.vif, by.x = "parameter", by.y = 0)
moran.vif.df[,2:4] <- round(moran.vif.df[,2:4],2)

moran.vif.df[,-3] %>% 
  dplyr::mutate(
    VIF = cell_spec(VIF,color = ifelse(VIF > 3,"red", "black"), bold = ifelse(VIF > 5, T, F)),
    moran.I = cell_spec(moran.I,bold = ifelse(moran.I > moran.limit, T, F),color = ifelse(moran.I > 0.8, "red","black"))) %>%
  knitr::kable(digits = 2, 
    caption = table_nums("moran-vif-table",paste("Moran's I of predictor and predictor variable (limit = ", format(moran.limit,scientific = T, digits = 2),")",sep = "")),
    label = NA,
    escape = F) %>%    
  kable_styling(bootstrap_options = "bordered", position = "center")
        
```


The most auto-correlated variables (precipitation, temperature, and N deposition) are also the ones with the highest VIF. Temperature has a VIF higher than 5 (VIF = `r round(lm.vif["temp",],2)`) and was highly correlated to N-deposition (`r fig_nums("corrplot", display = "c")`), as well as with NDVI and forest to some extent. Log precipitation also has a high VIF value (VIF = `r round(lm.vif["log.prec",],2)`) and a high correlation with log.runoff. TN-dep had only low correlation coefficients with the other variables, so it will be included in the model even if it has a high VIF value. However, temperature and log(precipitation will not be included).

## Comparison of linear model and spatial error model 

A linear model (LM) and a Spatial Error Model (SELM) were fitted for the log.toc against the selected predictor variables. The Spatial Error Model takes into account the spatial autocorrelation of the predictor variables in the error term of the regression. To compare the two models, the Akaike Information Criterion was calculated.

Both models were fitted with and without scaled variables. The effect size calculated using the raw (non-scaled) coefficients according to the method explained in Supplementary 2. A comparison of the regression coefficients and effect size for each predictor variables is shown on `r fig_nums("compare-plots-1", display = "c")`. 

```{r lm-fennoscandia, results = T}
k.neigh.w <- readRDS("k.neigh.w.Rdata")

fm.s <- s.log.toc~s.ndvi+s.log.runoff+s.bogs+s.arable+s.forest+s.tndep
s.lm.fennoscandia <- lm(fm.s, data = fennoscandia, na.action = na.exclude)
saveRDS(s.lm.fennoscandia,"s.lm.fennoscandia.rds")

fm <- log.toc~ndvi+log.runoff+bogs+arable+forest+tndep
lm.fennoscandia <- lm(fm, data = fennoscandia, na.action = na.exclude)
saveRDS(lm.fennoscandia,"lm.fennoscandia.rds")

s.lm.r2 <- summary(s.lm.fennoscandia)$adj.r.squared
s.moran.I.res.lm <- lm.morantest(s.lm.fennoscandia, k.neigh.w, alternative = "two.sided")

lm.r2 <- summary(lm.fennoscandia)$adj.r.squared
moran.I.res.lm <- lm.morantest(lm.fennoscandia, k.neigh.w, alternative = "two.sided")

moran.limit.fennoscandia <- 1/(dim(fennoscandia)[1]-1)

s.lm.coef <- summary(s.lm.fennoscandia)$coefficients %>% as.data.frame()
s.lm.coef <- s.lm.coef[-1,] %>% rownames_to_column(var = "Parameter")

lm.coef <- summary(lm.fennoscandia)$coefficients %>% as.data.frame()
lm.coef <- lm.coef[-1,] %>% rownames_to_column(var = "Parameter")

lm.effectsize <- lm.coef[,1:3]

n <- length(lm.coef$Parameter)
m <- lm.coef$Parameter

for(i in 1:n){
  if(grepl("log",m[i])==T){
    lm.effectsize[i,2] <- 1.1^(lm.coef[i,2])
    lm.effectsize[i,3] <- 1.1^(lm.coef[i,2])*log(1.1)*lm.coef[i,3]
  }else if(m[i] %in% c("ndvi","bogs","arable","forest")){
    lm.effectsize[i,2] <- exp(lm.coef[i,2]*0.1)
    lm.effectsize[i,3] <- 0.1*lm.coef[i,2]*lm.coef[i,3]
  }else if(m[i] %in% c("tndep")){
    lm.effectsize[i,2] <- exp(lm.coef[i,2]*100)
    lm.effectsize[i,3] <- 100*exp(lm.coef[i,2]*100)*lm.coef[i,3]
  }
}

lm.effectsize$Percent <- 100*(lm.effectsize$Estimate-1)

```

```{r arm-sim-test-lm}
sm.fennoscandia <- arm::sim(lm.fennoscandia,n.sims = 100)

sm.coef <- sm.fennoscandia@coef[,-1]
sm.effectsize <- data.frame(parameter = colnames(sm.coef), effect.size = NA, std.error = NA)

n <- dim(sm.coef)[2]
m <- colnames(sm.coef)

for(i in 1:n){
  if(grepl("log",m[i])==T){
    sm.effectsize[i,2] <- mean(1.1^(sm.coef[,i]))
    sm.effectsize[i,3] <- sd(1.1^(sm.coef[,i])*log(1.1)*sm.coef[,i])
  }else if(m[i] %in% c("ndvi","bogs","arable","forest")){
    sm.effectsize[i,2] <- mean(exp(sm.coef[,i]*0.1))
    sm.effectsize[i,3] <- sd(0.1*exp(sm.coef[,i]*0.1)*sm.coef[,i])
  }else if(m[i] %in% c("tndep")){
    sm.effectsize[i,2] <- mean(exp(sm.coef[,i]*100))
    sm.effectsize[i,3] <- sd(100*exp(sm.coef[,i]*100)*sm.coef[,i])
  }
}

```

```{r summary-table-lm}
summary.table.lm <- cbind(dplyr::select(lm.coef,Parameter),s.lm.coef[,2:3],lm.coef[,2:3],lm.effectsize[,2:4],sm.effectsize[,2:3]) %>%
                rbind(c("AIC",AIC(s.lm.fennoscandia),"",AIC(lm.fennoscandia),"","","","","","")) %>%
                rbind(c("R2",s.lm.r2,"",lm.r2,"","","","","","")) %>%
                rbind(c("Moran'I res",s.moran.I.res.lm$estimate[[1]],"",moran.I.res.lm$estimate[[1]],"","","","","",""))
summary.table.lm[,-1] <- apply(summary.table.lm[,-1],2,as.numeric)

saveRDS(summary.table.lm, "summary.table.lm.rds")

```

```{r sem, eval = F}
k.neigh.w <- readRDS("k.neigh.w.Rdata")

#lagrange <- lm.LMtests(lm.fennoscandia,k.neigh.w,test = c("LMerr","LMlag","RLMerr","RLMlag"))

fm.s <- s.log.toc~s.ndvi+s.log.runoff+s.bogs+s.arable+s.forest+s.tndep
s.sem.fennoscandia <- errorsarlm(fm.s,fennoscandia,k.neigh.w)
saveRDS(s.sem.fennoscandia,"s.sem.fennoscandia.Rdata")

fm <- log.toc~ndvi+log.runoff+bogs+arable+forest+tndep
sem.fennoscandia <- errorsarlm(fm,fennoscandia,k.neigh.w)
saveRDS(sem.fennoscandia,"sem.fennoscandia.Rdata")
```

```{r sem-results}
s.sem.fennoscandia <- readRDS("s.sem.fennoscandia.Rdata")
sem.fennoscandia <- readRDS("sem.fennoscandia.Rdata")
k.neigh.w <- readRDS("k.neigh.w.Rdata")


s.sem.coef <- s.sem.fennoscandia$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
s.sem.coef <- s.sem.coef %>% rownames_to_column(var = "Parameter")
s.sem.coef$std.error <- s.sem.fennoscandia$rest.se[-1]

sem.coef <- sem.fennoscandia$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef <- sem.coef %>% rownames_to_column(var = "Parameter")
sem.coef$std.error <- sem.fennoscandia$rest.se[-1]

sem.effectsize <- sem.coef[,1:3]

n <- length(sem.coef$Parameter)
m <- sem.coef$Parameter

for(i in 1:n){
  if(grepl("log",m[i])==T){
    sem.effectsize[i,2] <- 1.1^(sem.coef[i,2])
    sem.effectsize[i,3] <- 1.1^(sem.coef[i,2])*log(1.1)*sem.coef[i,3]
  }else if(m[i] %in% c("ndvi","bogs","arable","forest")){
    sem.effectsize[i,2] <- exp(sem.coef[i,2]*0.1)
    sem.effectsize[i,3] <- 0.1*exp(sem.coef[i,2]*0.1)*sem.coef[i,3]
  }else if (m[i] %in% c("slope","temp")){
    sem.effectsize[i,2] <- exp(sem.coef[i,2]*1)
    sem.effectsize[i,3] <- 1*exp(sem.coef[i,2]*1)*sem.coef[i,3]
  }else if(m[i] %in% c("tndep")){
    sem.effectsize[i,2] <- exp(sem.coef[i,2]*100)
    sem.effectsize[i,3] <- 100*exp(sem.coef[i,2]*100)*sem.coef[i,3]
  }
}

sem.effectsize$Percent <- 100*(sem.effectsize$Estimate-1)

s.sem.AIC <- 2*(n-1)-2*s.sem.fennoscandia$LL
sem.AIC <- 2*(n-1)-2*sem.fennoscandia$LL

s.moran.I.res.sem <- moran.test(s.sem.fennoscandia$residuals, k.neigh.w, alternative = "two.sided")

moran.I.res.sem <- moran.test(sem.fennoscandia$residuals, k.neigh.w, alternative = "two.sided")

summary.table.sem <- cbind(dplyr::select(sem.coef,Parameter),s.sem.coef[,2:3],sem.coef[,2:3],sem.effectsize[,2:4]) %>%
                rbind(c("AIC",s.sem.AIC,"",sem.AIC,"","","","")) %>%
                rbind(c("Moran'I res", s.moran.I.res.sem$estimate[[1]],"", moran.I.res.sem$estimate[[1]], "","","",""))
summary.table.sem[,-1] <- apply(summary.table.sem[,-1],2,as.numeric)

saveRDS(summary.table.sem, "summary.table.sem.rds")
```

```{r compare-estimates}
n <- c(names(s.sem.coef),"model")
m <- cbind.data.frame(s.lm.coef[,1:3],model = "LM") %>% setNames(n)
o <- cbind.data.frame(s.sem.coef,model = "SELM")
  
scaled.df <- rbind(m,o)

scaled.plot <- ggplot(scaled.df, aes(group = model))+geom_col(aes(x=Estimate,y=Parameter, fill = model, col = model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Estimate-std.error,xmax=Estimate+std.error), position = "dodge", width = 0.5)+
  labs(x = "Scaled Estimate", y = "predictor variable", subtitle = paste("LM: AIC =",round(AIC(s.lm.fennoscandia),2),"; Moran's I = ",round(s.moran.I.res.lm$estimate[[1]],2),"\nSELM: AIC =",round(s.sem.AIC,2),"; Moran's I =",round(s.moran.I.res.sem$estimate[[1]],2)))+
  theme_bw()+theme(legend.position = "bottom")

```

```{r compare-effect-size}

n <- c(names(sem.effectsize),"model")
m <- cbind.data.frame(lm.effectsize,model = "LM") %>% setNames(n)
o <- cbind.data.frame(sem.effectsize,model = "SELM")
  
h.df <- rbind(m,o)

effectsize.plot <- ggplot(h.df, aes(group = model))+
  geom_col(aes(x=Percent,y=Parameter, fill = model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Percent-(100*std.error),xmax=Percent+(100*std.error)), position = "dodge", width = 0.5)+
  labs(x = "Effect size in %", y = "", subtitle = paste("LM: AIC =",round(AIC(lm.fennoscandia),2),"; Moran's I = ",round(moran.I.res.lm$estimate[[1]],2),"\nSELM: AIC =",round(sem.AIC,2),"; Moran's I =",round(moran.I.res.sem$estimate[[1]],2)))+
  theme_bw()+theme(legend.position = "bottom")

```

**The effect size is expressed as % change of TOC concentration for:**

**- 10% increase of runoff**

**- 0.1 unit increase of NDVI, bogs and arable land**

**- 100 ug increase of nitrogen deposition.**

**These relative changes are arbitrarily chosen in order to represent the impact of each predictor variable on a comparable basis.**

```{r compare-plots-1, fig.dim = c(10,5)}
cowplot::plot_grid(plotlist = list(scaled.plot,effectsize.plot),ncol=2)
```

`r fig_nums("compare-plots-1","Comparison of LM and SELM models")`

The SELM performs better both with scaled variables and with unscaled variables, with a lower AIC and Moran's I in both cases. The estimates values for the predictor variables are close, but the linear model tends to attribute them higher values than the spatial error model. The scaled estimates are positive for TN-dep, NDVI, forest, bogs and arable land and negative for the log runoff. 

Log runoff and NDVI have the highest scaled estimates, with a noticeable difference between the LM and the SELM. LM and SELM scaled estimates are respectively 
`r round(s.lm.coef[which(s.lm.coef$Parameter == "s.log.runoff"), which(names(s.lm.coef) == "Estimate")],2)` 
and `r round(s.sem.coef[which(s.sem.coef$Parameter == "s.log.runoff"), which(names(s.sem.coef) == "Estimate")],2)` for log(runoff) and
 `r round(s.lm.coef[which(s.lm.coef$Parameter == "s.ndvi"), which(names(s.lm.coef) == "Estimate")],2)` and `r round(s.sem.coef[which(s.sem.coef$Parameter == "s.ndvi"), which(names(s.sem.coef) == "Estimate")],2)` for NDVI. For these two parameters, the spatial lagged model gives smaller estimates, suggesting that using a linear model over a varied region may over-estimate the impact of these parameters. Log(runoff) has the highest scaled estimates but the effect size of a 10% increase in runoff is low compared to a comparable change for the other parameters (`r round(lm.effectsize[which(lm.effectsize$Parameter == "log.runoff"), which(names(lm.effectsize) == "Percent")],2)`% for LM and `r round(sem.effectsize[which(sem.effectsize$Parameter == "log.runoff"), which(names(sem.effectsize) == "Percent")],2)`%  for SELM).

Forest, bogs and TN-dep have similar scaled estimate between 0,15 and 0,21, but their effect size vary much more. A variation of the proportion of bogs could have a major impact, but a 10% increase or decrease of area is unlikely except in the case of local peat restoration project. An increase in forest cover also has a limited impact: `r round(lm.effectsize[which(lm.effectsize$Parameter == "forest"), which(names(lm.effectsize) == "Percent")],2)` for LM and `r round(sem.effectsize[which(sem.effectsize$Parameter == "forest"), which(names(sem.effectsize) == "Percent")],2)` for SELM. TN-dep has the lowest effect size with around `r round(lm.effectsize[which(lm.effectsize$Parameter == "tndep"), which(names(lm.effectsize) == "Percent")],0)` % increase for a 100 ug/m2 increase. TN-dep is expected to decrease, but the generalization of forest fertilization could keep high N-levels. **which % hypothesis can I use?**.

The proportion of arable land has a very low scaled estimate (`r round(s.lm.coef[which(s.lm.coef$Parameter == "s.arable"), which(names(s.lm.coef) == "Estimate")],2)`) for LM and `r round(s.sem.coef[which(s.sem.coef$Parameter == "s.arable"), which(names(s.sem.coef) == "Estimate")],2)` for SELM. The effect size of a 10% increase of arable land is however comparable to the effect of a 10% increase of forest for the LM model (`r round(lm.effectsize[which(lm.effectsize$Parameter == "arable"), which(names(lm.effectsize) == "Percent")],2)` %), even though it remains lower for the SELM model (`r round(sem.effectsize[which(sem.effectsize$Parameter == "arable"), which(names(sem.effectsize) == "Percent")],2)` %).  

## Spatial error models with selected predictors
### Spatial error model on Norway and Fennoscandia {#sem-simple}

To compare the results of this study to the results of Larsen et al. @Larsen2011a, we fitted two models using only three predictors: NDVI, proportion of bogs and runoff. LM and SELM models were fitted for the entire dataset as well as for the Norwegian subset. The scaled estimates and the effect size were calculated similarly to the previous section.

```{r kmat, eval = F}
norge.spdf <- SpatialPointsDataFrame(norge[,c("longitude","latitude")],norge)

norge.kmat <- norge.spdf %>% knearneigh(k=50) %>% knn2nb %>% nb2listw
saveRDS(norge.kmat,"norge.kmat.Rdata")
```

```{r sem-simple-norway, eval = F}
norge.kmat <- readRDS("norge.kmat.Rdata")

s.fm <- s.log.toc~s.ndvi+s.log.runoff+s.bogs
s.sem.norge.simple <- errorsarlm(s.fm,norge,norge.kmat)
saveRDS(s.sem.norge.simple,"s.sem.norge.simple.Rdata")

fm <- log.toc~ndvi+log.runoff+bogs
sem.norge.simple <- errorsarlm(fm,norge,norge.kmat)
saveRDS(sem.norge.simple,"sem.norge.simple.Rdata")

```

```{r sem-simple-results-norway}
s.sem.norge.simple <- readRDS("s.sem.norge.simple.Rdata")
sem.norge.simple <- readRDS("sem.norge.simple.Rdata")
norge.kmat <- readRDS("norge.kmat.Rdata")


s.sem.coef.norge <- s.sem.norge.simple$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
s.sem.coef.norge <- s.sem.coef.norge %>% rownames_to_column(var = "Parameter")
s.sem.coef.norge$std.error <- s.sem.norge.simple$rest.se[-1]

sem.coef.norge <- sem.norge.simple$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef.norge <- sem.coef.norge %>% rownames_to_column(var = "Parameter")
sem.coef.norge$std.error <- sem.norge.simple$rest.se[-1]

sem.effectsize.norge <- sem.coef.norge[,1:3]

n <- length(sem.coef.norge$Parameter)
m <- sem.coef.norge$Parameter

for(i in 1:n){
  if(grepl("log",m[i])==T){
    sem.effectsize.norge[i,2] <- 1.1^(sem.coef.norge[i,2])
    sem.effectsize.norge[i,3] <- 1.1^(sem.coef.norge[i,2])*log(1.1)*sem.coef.norge[i,3]
  }else if(m[i] %in% c("ndvi","bogs","arable")){
    sem.effectsize.norge[i,2] <- exp(sem.coef.norge[i,2]*0.1)
    sem.effectsize.norge[i,3] <- 0.1*exp(sem.coef.norge[i,2]*0.1)*sem.coef.norge[i,3]
  }else if(m[i] %in% c("slope","temp","tndep")){
    sem.effectsize.norge[i,2] <- exp(sem.coef.norge[i,2]*1)
    sem.effectsize.norge[i,3] <- 1*exp(sem.coef.norge[i,2]*1)*sem.coef.norge[i,3]
  }
}

sem.effectsize.norge$Percent <- 100*(sem.effectsize.norge$Estimate-1)

s.sem.AIC.norge <- 2*(n-1)-2*s.sem.norge.simple$LL
s.moran.I.res.sem.norge <- moran.test(s.sem.norge.simple$residuals, norge.kmat, alternative = "two.sided")

sem.AIC.norge <- 2*(n-1)-2*sem.norge.simple$LL
moran.I.res.sem.norge <- moran.test(sem.norge.simple$residuals, norge.kmat, alternative = "two.sided")

summary.table.sem.norge <- cbind(dplyr::select(sem.coef.norge,Parameter),s.sem.coef.norge[,2:3],sem.coef.norge[,2:3],sem.effectsize.norge[,2:4]) %>%
                rbind(c("AIC",s.sem.AIC,"",sem.AIC,"","","","")) %>%
                rbind(c("Moran'I res", s.moran.I.res.sem.norge$estimate[[1]],"",moran.I.res.sem.norge$estimate[[1]], "","","",""))
summary.table.sem.norge[,-1] <- apply(summary.table.sem.norge[,-1],2,as.numeric)

saveRDS(summary.table.sem.norge, "summary.table.sem.norge.rds")
```

```{r sem-simple-fennosandia, eval = F}
k.neigh.w <- readRDS("k.neigh.w.Rdata")

s.fm <- s.log.toc~s.ndvi+s.log.runoff+s.bogs
s.sem.fen.simple <- errorsarlm(s.fm,fennoscandia,k.neigh.w)
saveRDS(s.sem.fen.simple,"s.sem.fen.simple.Rdata")

fm <- log.toc~ndvi+log.runoff+bogs
sem.fen.simple <- errorsarlm(fm,fennoscandia,k.neigh.w)
saveRDS(sem.fen.simple,"sem.fen.simple.Rdata")

```

```{r sem-simple-results}
s.sem.fen.simple <- readRDS("s.sem.fen.simple.Rdata")
sem.fen.simple <- readRDS("sem.fen.simple.Rdata")
k.neigh.w <- readRDS("k.neigh.w.Rdata")

s.sem.coef <- s.sem.fen.simple$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
s.sem.coef <- s.sem.coef %>% rownames_to_column(var = "Parameter")
s.sem.coef$std.error <- s.sem.fen.simple$rest.se[-1]

sem.coef <- sem.fen.simple$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef <- sem.coef %>% rownames_to_column(var = "Parameter")
sem.coef$std.error <- sem.fen.simple$rest.se[-1]

sem.effectsize.fen <- sem.coef[,1:3]

n <- length(sem.coef$Parameter)
m <- sem.coef$Parameter

for(i in 1:n){
  if(grepl("log",m[i])==T){
    sem.effectsize.fen[i,2] <- 1.1^(sem.coef[i,2])
    sem.effectsize.fen[i,3] <- 1.1^(sem.coef[i,2])*log(1.1)*sem.coef[i,3]
  }else if(m[i] %in% c("ndvi","bogs","arable")){
    sem.effectsize.fen[i,2] <- exp(sem.coef[i,2]*0.1)
    sem.effectsize.fen[i,3] <- 0.1*exp(sem.coef[i,2]*0.1)*sem.coef[i,3]
  }
}

sem.effectsize.fen$Percent <- 100*(sem.effectsize.fen$Estimate-1)

s.sem.AIC <- 2*(n-1)-2*s.sem.fen.simple$LL
s.moran.I.res.sem <- moran.test(s.sem.fen.simple$residuals, k.neigh.w, alternative = "two.sided")

sem.AIC <- 2*(n-1)-2*sem.fen.simple$LL
moran.I.res.sem <- moran.test(sem.fen.simple$residuals, k.neigh.w, alternative = "two.sided")

summary.table.simple.sem <- cbind(dplyr::select(sem.coef,Parameter),s.sem.coef[,2:3],sem.coef[,2:3],sem.effectsize.fen[,2:4]) %>%
                rbind(c("AIC",s.sem.AIC,"",sem.AIC,"","","","")) %>%
                rbind(c("Moran'I res", s.moran.I.res.sem$estimate[[1]],"",moran.I.res.sem$estimate[[1]], "","","",""))
summary.table.simple.sem[,-1] <- apply(summary.table.simple.sem[,-1],2,as.numeric)

saveRDS(summary.table.simple.sem, "summary.table.simple.sem.rds")
```

```{r compare-estimates-simple}
n <- c(names(s.sem.coef),"model")
m <- cbind.data.frame(s.sem.coef.norge, model = "Norway")
o <- cbind.data.frame(s.sem.coef,model = "Fennoscandia")
  
scaled.df <- rbind(m,o)

scaled.plot <- ggplot(scaled.df, aes(group = model))+geom_col(aes(x=Estimate,y=Parameter, fill = model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Estimate-std.error,xmax=Estimate+std.error), position = "dodge", width = 0.5)+
  labs(x = "Scaled estimates",y = "predictor variables", subtitle = paste("Fennoscandia: AIC =",round(s.sem.AIC,2),"; Moran's I = ",round(s.moran.I.res.sem$estimate[[1]],2),"\nNorway: AIC =",round(s.sem.AIC.norge,2),"; Moran's I =",round(s.moran.I.res.sem.norge$estimate[[1]],2)))+
  theme_bw()+
  theme(legend.position = "bottom")

```

```{r compare-effect-size-simple}

n <- c(names(sem.effectsize.fen),"model")
m <- cbind.data.frame(sem.effectsize.norge,model = "Norway")
o <- cbind.data.frame(sem.effectsize.fen,model = "Fennoscandia")
  
h.df <- rbind(m,o)

effectsize.plot <- ggplot(h.df, aes(group = model))+
  geom_col(aes(x=Percent,y=Parameter, fill = model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Percent-(100*std.error),xmax=Percent+(100*std.error)), position = "dodge", width = 0.5)+
  labs(x = "Effect size in %", y = "", subtitle = paste("Fennoscandia: AIC =",round(sem.AIC,2),"; Moran's I = ",round(moran.I.res.sem$estimate[[1]],2),"\nNorway: AIC =",round(sem.AIC.norge,2),"; Moran's I =",round(moran.I.res.sem.norge$estimate[[1]],2)))+
  theme_bw()+theme(legend.position = "bottom")
```

**Once again, the effect size is expressed as % change of TOC concentration for:**

**- 10% increase of runoff**

**- 0.1 unit increase of NDVI and bogs.**

**These relative changes are arbitrarily chosen in order to represent the impact of each predictor variable on a comparable basis.**

```{r compare-plots-2, fig.dim = c(10,5)}
cowplot::plot_grid(plotlist = list(scaled.plot,effectsize.plot),ncol=2)
```

`r fig_nums("compare-plots-2","Comparison of models for the Norwegian and Fennoscandia datasets")`

The scaled estimates have slighly higher values for the Norwegian model compared to the Fennoscandia model, which is reflected in the effect size. Once again, NDVI is the predictor with the highest scaled estimate and the higher effect size. Log(runoff) has a high scale estimate but a small effect size for a 10%. change. The effect of bogs is similar for both Norway and Fennoscandia, with a little higher estimate and effect size for the norwegian subset. 

In the simpler model, NDVI effect size is higher than in the model including more variables. The SELM model predicted an `r round(sem.effectsize[which(sem.effectsize$Parameter == "ndvi"), which(names(sem.effectsize) == "Percent")],2)`%, while it predicts here `r round(sem.effectsize.fen[which(sem.effectsize.fen$Parameter == "ndvi"), which(names(sem.effectsize.fen) == "Percent")],0)` % and `r round(sem.effectsize.norge[which(sem.effectsize.norge$Parameter == "ndvi"), which(names(sem.effectsize.norge) == "Percent")],0)`% for Norway. 

The effect size of a relative change in bogs proportion and in log(runoff) are also smaller in the simpler model (`r round(sem.effectsize[which(sem.effectsize$Parameter == "bogs"), which(names(sem.effectsize) == "Percent")],0)`% and `r round(sem.effectsize.fen[which(sem.effectsize.fen$Parameter == "bogs"), which(names(sem.effectsize.fen) == "Percent")],0)` % for bogs, `r round(sem.effectsize[which(sem.effectsize$Parameter == "log.runoff"), which(names(sem.effectsize) == "Percent")],0)`% and `r round(sem.effectsize.fen[which(sem.effectsize.fen$Parameter == "log.runoff"), which(names(sem.effectsize.fen) == "Percent")],0)` % for log(runoff)  )

For the scaled model, the AIC is lower for the model fitted on Norway, but it is the contrary for the model (unscaled) used to compute the effect size.

### Spatial error model with forest as predictor  {#forest}

```{r sem-with-forest, eval = F}
k.neigh.w <- readRDS("k.neigh.w.Rdata")
norge.kmat <- readRDS("norge.kmat.Rdata")

fm <- log.toc ~ forest+log.runoff+bogs

sem.forest.fen <- errorsarlm(fm, data = fennoscandia,k.neigh.w)

sem.forest.norge <- errorsarlm(fm, data = norge, norge.kmat)

saveRDS(sem.forest.fen, "sem.forest.fen.Rdata")
saveRDS(sem.forest.norge, "sem.forest.norge.Rdata")

```

```{r sem-forest-results}

sem.forest.fen <- readRDS("sem.forest.fen.Rdata")
sem.forest.norge <- readRDS("sem.forest.norge.Rdata")

# fennoscandia
sem.coef <- sem.forest.fen$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef <- sem.coef %>% rownames_to_column(var = "Parameter")
sem.coef$std.error <- sem.forest.fen$rest.se[-1]

sem.effectsize.forest <- sem.coef[,1:3]

n <- length(sem.coef$Parameter)
m <- sem.coef$Parameter

for(i in 1:n){
  if(grepl("log",m[i])==T){
    sem.effectsize.forest[i,2] <- 1.1^(sem.coef[i,2])
    sem.effectsize.forest[i,3] <- 1.1^(sem.coef[i,2])*log(1.1)*sem.coef[i,3]
  }else if(m[i] %in% c("forest","bogs")){
    sem.effectsize.forest[i,2] <- exp(sem.coef[i,2]*0.1)
    sem.effectsize.forest[i,3] <- 0.1*exp(sem.coef[i,2]*0.1)*sem.coef[i,3]
  }
}

sem.effectsize.forest$Percent <- 100*(sem.effectsize.forest$Estimate-1)

sem.AIC <- 2*(n-1)-2*sem.forest.fen$LL
moran.I.res.sem <- moran.test(sem.forest.fen$residuals, k.neigh.w, alternative = "two.sided")

summary.table.sem.forest <- cbind(dplyr::select(sem.coef,Parameter),sem.coef[,2:3],sem.effectsize.forest[,2:4]) %>%
                rbind(c("AIC",sem.AIC,"","","","")) %>%
                rbind(c("Moran'I res", moran.I.res.sem$estimate[[1]], "","","",""))
summary.table.sem.forest[,-1] <- apply(summary.table.sem.forest[,-1],2,as.numeric)
``` 

```{r sem-forest-norge}
# norge
sem.coef.norge <- sem.forest.norge$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef.norge <- sem.coef.norge %>% rownames_to_column(var = "Parameter")
sem.coef.norge$std.error <- sem.forest.norge$rest.se[-1]

sem.effectsize.forest.norge <- sem.coef.norge[,1:3]

n <- length(sem.coef.norge$Parameter)
m <- sem.coef.norge$Parameter

for(i in 1:n){
  if(grepl("log",m[i])==T){
    sem.effectsize.forest.norge[i,2] <- 1.1^(sem.coef.norge[i,2])
    sem.effectsize.forest.norge[i,3] <- 1.1^(sem.coef[i,2])*log(1.1)*sem.coef.norge[i,3]
  }else if(m[i] %in% c("forest","bogs")){
    sem.effectsize.forest.norge[i,2] <- exp(sem.coef.norge[i,2]*0.1)
    sem.effectsize.forest.norge[i,3] <- 0.1*exp(sem.coef.norge[i,2]*0.1)*sem.coef.norge[i,3]
  }
}

sem.effectsize.forest.norge$Percent <- 100*(sem.effectsize.forest.norge$Estimate-1)


sem.AIC.norge <- 2*(n-1)-2*sem.forest.norge$LL
moran.I.res.sem.norge <- moran.test(sem.forest.norge$residuals, norge.kmat, alternative = "two.sided")

summary.table.sem.forest.norge <- cbind(dplyr::select(sem.coef.norge,Parameter),sem.coef.norge[,2:3],sem.effectsize.forest.norge[,2:4]) %>%
                rbind(c("AIC",sem.AIC.norge,"","","","")) %>%
                rbind(c("Moran'I res", moran.I.res.sem.norge$estimate[[1]], "","","",""))
summary.table.sem.forest.norge[,-1] <- apply(summary.table.sem.forest.norge[,-1],2,as.numeric)

```

```{r compare-effect-size-simple-forest}

n <- c(names(sem.effectsize.forest),"model")
m <- cbind.data.frame(sem.effectsize.forest,model = "Fennoscandia") %>% setNames(n)
o <- cbind.data.frame(sem.effectsize.forest.norge,model = "Norway")
  
h.df <- rbind(m,o)

effectsize.plot <- ggplot(h.df, aes(group = model))+
  geom_col(aes(x=Percent,y=Parameter, fill = model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Percent-(100*std.error),xmax=Percent+(100*std.error)), position = "dodge", width = 0.5)+
  labs(x = "Effect size in %", y = "", subtitle = paste("Fennoscandia: AIC =",round(sem.AIC,2),"; Moran's I = ",round(moran.I.res.sem$estimate[[1]],2),"\nNorway: AIC =",round(sem.AIC.norge,2),"; Moran's I =",round(moran.I.res.sem.norge$estimate[[1]],2)))+
  theme_bw()+theme(legend.position = "bottom")
print(effectsize.plot)
```

`r fig_nums("compare-effect-size-simple-forest", "Effect size for SEM model with forest as predictor")`

When computing SEM models with forest as a vegetation indicator instead of NDVI, the effect size of the proportion of bogs become more important than previously. The effect size of a 10% increase in forest cover is rather small  compared to a 0.1 unit increase of NDVI ((`r round(sem.effectsize.forest[which(sem.effectsize.forest$Parameter == "forest"), which(names(sem.effectsize.forest) == "Percent")],0)`% compared to `r round(sem.effectsize.fen[which(sem.effectsize.fen$Parameter == "forest"), which(names(sem.effectsize) == "Percent")],0)`% for Fennoscandia). 

On the contrary, including the forest instead of the NDVI gives more impact to the proportion of bogs (for Fennoscandia, `r round(sem.effectsize.forest[which(sem.effectsize.forest$Parameter == "bogs"), which(names(sem.effectsize.forest) == "Percent")],0)`% compared to `r round(sem.effectsize.fen[which(sem.effectsize.fen$Parameter == "bogs"), which(names(sem.effectsize) == "Percent")],0)`%, and even more for the model on the Norwegian dataset). The effect size of a 10% increase in runoff remains similar  (for Fennoscandia, `r round(sem.effectsize.forest[which(sem.effectsize.forest$Parameter == "log.runoff"), which(names(sem.effectsize.forest) == "Percent")],0)`% compared to `r round(sem.effectsize.fen[which(sem.effectsize.fen$Parameter == "log.runoff"), which(names(sem.effectsize) == "Percent")],0)`%, and even more for the model on the Norwegian dataset).

## Geographically Weighted Regression

A geographically weighted model was fitted on the Fennoscandian dataset. The objective is to examine the regional relationship with the response and predictor variables. A geographically weighted model computes a linear regression giving a stronger weight to the closest neighbors. The neighbors here are chosen to be the 500 nearest lakes, where weight for each lake is attributed following a gaussian distribution. The local regression coefficients are shown on `r fig_nums("gwr-results",display = "c")`. The map of measured TOC concentration (the concentration in mg/L is logged) is also presented for comparison.

### GWR with NDVI 

```{r GWR-fennoscandia, eval = F}
fm <- log.toc~ndvi+log.runoff+bogs

library(GWmodel)
#bw.fennoscandia <- bw.gwr(fm, data = fennoscandia.spdf, kernel = "gaussian", adaptive = T)
gwr.fennoscandia <- gwr.basic(fm, data = fennoscandia.spdf, bw = 500, kernel = "gaussian", adaptive = T)

#saveRDS(bw.fennoscandia, "bw.fennoscandia.Rdata")
saveRDS(gwr.fennoscandia, "gwr.fennoscandia.Rdata")
```

`r fig_nums("gwr-results","Maps of the GWR local coefficients")`

```{r gwr-results, fig.dim = c(10,6)}
#bw.fennoscandia <- readRDS("bw.fennoscandia.Rdata")
gwr.fennoscandia <- readRDS("gwr.fennoscandia.Rdata")
k.neigh.w <- readRDS("k.neigh.w.Rdata")

gwr.coef <- gwr.fennoscandia$SDF@data

m <- c("ndvi","log.runoff","bogs")
n <- length(m)

gwr.effectsize <- gwr.coef[,2:(n+1)]

for(i in 1:dim(gwr.effectsize)[1]){
  for(j in 1:n){
  if(grepl("log",m[j])==T){
    gwr.effectsize[i,j] <- 1.1^(gwr.coef[i,j+1])
  }else if(m[j] %in% c("ndvi","bogs","arable","forest")){
    gwr.effectsize[i,j] <- exp(gwr.coef[i,j+1]*0.1)
  }
  }
}

gwr.effectsize.percent <- 100*(gwr.effectsize-1)

coef.plot <- lapply(m,FUN = function(x)  f_plotspatial(data=fennoscandia,var=gwr.effectsize.percent[[x]],plottitle = x))
coef.plot$toc <- f_plotspatial(fennoscandia,var=gwr.coef$y,plottitle = "Observed toc (log)")
cowplot::plot_grid(plotlist = coef.plot,ncol=2)

saveRDS(gwr.effectsize.percent,"gwr.ndvi.effectsize.percent.rds")

gwr.AIC <- gwr.fennoscandia$GW.diagnostic$AICc
gwr.r2 <- gwr.fennoscandia$GW.diagnostic$gwR2.adj
gwr.moran <- moran.test(gwr.coef$Stud_residual,k.neigh.w,alternative = "two.sided")

summary.table.gwr <- data.frame(AIC = gwr.AIC,R2 = gwr.r2,Moran.I =gwr.moran$estimate[[1]])
                                
knitr::kable(summary.table.gwr,digits = 3, caption = table_nums("gwr-results","Model performance: AIC, mean R2 and Moran's I of residuals"), label = NA) %>%
  kable_styling(bootstrap_options = "bordered")
```



In GWR, NDVI remains the main predictor for the concentration of TOC. All the local effect sizes have positive values and range from 0 to +50%. In regions already forested or agricultural (southern Sweden, south-east Finland), the effect size of a 0.1 increase in NDVI is close to 0%, but in southern Norway an increase of NDVI could have a significant relative impact on TOC concentration. 

Here again the effect size of a 10% increase in runoff is mainly negative, between `r round(min(gwr.effectsize.percent$log.runoff),0)` % and  `r round(max(gwr.effectsize.percent$log.runoff),0)`%. The south-east part of Finland it the only one where the effect size is positive. The most negative effects are located in the south-west region of Norway. 

A change of the proportion of bogs has almost not effect here except for a little spot in south-east Finland where both the highest (`r round(min(gwr.effectsize.percent$bogs),0)` %) and the lowest (`r round(min(gwr.effectsize.percent$bogs),0)`%) effect sizes are found. This local spot is not related to the original proportion of bogs (see Supplementary 2). **there are rather low runoff values in this region, but no outliers of any sort. Where does this come from?**. In all the other regions, an increase in bog proportion would have a very low effect, comparable to the mean effect size calculated with the SELM model. 


### GWR with forest

```{r GWR-fennoscandia-forest, eval = F}
fm <- log.toc~forest+log.runoff+bogs

library(GWmodel)
#bw.fennoscandia.forest <- bw.gwr(fm, data = fennoscandia.spdf, kernel = "gaussian", adaptive = T)
gwr.fennoscandia.forest <- gwr.basic(fm, data = fennoscandia.spdf, bw = 500, kernel = "gaussian", adaptive = T)

#saveRDS(bw.fennoscandia.forest, "bw.fennoscandia.forest.Rdata")
saveRDS(gwr.fennoscandia.forest, "gwr.fennoscandia.forest.Rdata")
```

`r fig_nums("gwr-results-forest","Maps of the GWR local coefficients with forest as predictor")`

```{r gwr-results-forest, fig.dim = c(10,6)}
#bw.fennoscandia.forest <- readRDS("bw.fennoscandia.forest.Rdata")
gwr.fennoscandia.forest <- readRDS("gwr.fennoscandia.forest.Rdata")
k.neigh.w <- readRDS("k.neigh.w.Rdata")

gwr.coef <- gwr.fennoscandia.forest$SDF@data

m <- c("forest","log.runoff","bogs")
n <- length(m)

gwr.effectsize <- gwr.coef[,2:(n+1)]

for(i in 1:dim(gwr.effectsize)[1]){
  for(j in 1:n){
  if(grepl("log",m[j])==T){
    gwr.effectsize[i,j] <- 1.1^(gwr.coef[i,j+1])
  }else if(m[j] %in% c("ndvi","bogs","arable","forest")){
    gwr.effectsize[i,j] <- exp(gwr.coef[i,j+1]*0.1)
  }
  }
}

gwr.effectsize.percent <- 100*(gwr.effectsize-1)

coef.plot <- lapply(m,FUN = function(x)  f_plotspatial(data=fennoscandia,var=gwr.effectsize.percent[[x]],plottitle = x))
coef.plot$toc <- f_plotspatial(fennoscandia,var=gwr.coef$y,plottitle = "Observed toc (log)")
cowplot::plot_grid(plotlist = coef.plot,ncol=2)

saveRDS(gwr.effectsize.percent,"gwr.forest.effectsize.percent.rds")


gwr.AIC <- gwr.fennoscandia.forest$GW.diagnostic$AICc
gwr.r2 <- gwr.fennoscandia.forest$GW.diagnostic$gwR2.adj
gwr.moran <- moran.test(gwr.coef$Stud_residual,k.neigh.w,alternative = "two.sided")

summary.table.gwr.forest <- data.frame(AIC = gwr.AIC,R2 = gwr.r2,Moran.I =gwr.moran$estimate[[1]])
                                
knitr::kable(summary.table.gwr.forest,digits = 3, caption = table_nums("gwr-results-forest","Model performance: AIC, mean R2 and Moran's I of residuals"),label = NA) %>%
  kable_styling(bootstrap_options = "bordered")
```



Replacing NDVI by the proportion of forest does not change the local effect sizes of runoff in the model, and a similar spot of very high and very low effect sizes appears for the proportion of bogs. A similar spot is visible on the map representing the local effect sizes for an increase in forest proportion, but the effect sizes values are not unusual there. Once again, this spot is not explained by an unusual original proportion of forest (see Supplementary 2). The range of effect sizes goes from `r round(min(gwr.effectsize.percent$forest),0)` % to  `r round(max(gwr.effectsize.percent$forest),0)`%. 


### Conclusion GWR

GWR models are interesting to investigate local relationships between the response and predictor variables, but the results might be complicated to interpret. The strength of a GWR model is also a drawback: by giving more weight to the closest neighbors, it also "artificially" emphasizes the local features of the data points, like a magnifying lens, resulting in an potentially exaggerated version of the reality. 
If the local effect sizes of an increase of NDVI, forest and runoff could be explained by the original conditions, the effect sizes of an increase in bogs were more diverse and there is no good explanation for the spot observed in Finland. 


## Forecast in water regions

Based on the results from the spatial error model, we tried to forecast future changes in TOC concentration. The forecast is based on the evaluation of the future values of the three main predictors: NDVI, runoff and bogs. 

Future runoff has been predicted in the CMIP6, and we will use two different socio-economic pathways @Riahi2017: SSP1-2.6 as the best scenario (global warming limited to 2Â°C) and SSP 3-7.0 as the scenario with highest challenges for adaptation and mitigation @Hausfather2019 @CORDEX2021. In the CMIP6 project, several institutions run models to forecast future climate. Based on a review conducted by Raju et al. @Raju2020, we used the results from the model developed by the CRNM (Centre National de Recherches MÃ©tÃ©orologiques) to extract future runoff, but also future temperature and future precipitation values.  Temperature and precipitation values were used to model future NDVI, since no forecast exist for this index. The proportion of bogs is not expected to change, therefore no hypothesis is taken concerning their future evolution.

In order to cover the whole territory of Fennoscandia, and not only some lakes catchment as with the Northern lake Survey, we used the polygons representing the water regions. Water regions are the ensemble of the watercourse that drain to the sea within a coastal section @NVE. The water regions were computed from an elevation model (ref Anders). After cleaning, the dataset is composed of 1392 polygons (see Supplementary 3). 


### Modelling of mean TOC in 1995 in water regions

NDVI, runoff and land cover for 1995 were extracted the same way as for the Northern Lake Survey dataset (`r fig_nums("wr-maps-96\5", display = "c")`). The TOC concentration was predicted using the spatial error model fitted in [section 3.3](#sem-simple). 

```{r wr-maps-95, fig.scap= NA}
knitr::include_graphics(c("WR/wr.ndvi.plot.png","WR/wr.bogs.plot.png","WR/wr.runoff.plot.png","WR/wr.toc.png"))
```

`r fig_nums("wr-maps-95","Map of the mean values of predictor and response variables in water regions in 1995") `

### Forecast of predictor variables

#### Runoff 2041-2060

Future runoff annual values were extracted from the CRMP-CM6 model results and averaged for the period 2041-2060 to match the temperature and precipitation data. The average forecast and the difference compared to the period 1970-2000 is shown on `r fig_nums("future_runoff",display = "c")`.

```{r future-runoff, fig.dim= c(6,8)}
knitr::include_graphics(c("WR/ssp126.runoff.png","WR/ssp126.runoff.diff.png","WR/ssp370.runoff.png","WR/ssp370.runoff.diff.png"))
```

`r fig_nums("future-runoff","Forecast of mean runoff for 2050 (mean 2041-2060) under SSP 1-2.6 and SSP 3-7.0")`

#### NDVI 2041-2060

There is no forecast for NDVI in CMIP6. We therefore fitted a spatial error model for summer NDVI based on temperature and precipitations in 1995 (mean 1970-2000). This model is used to predict NDVI in 2050, based on forecast for temperature and precipitations in the period 2041-2060.

The average temperature and precipitation for 1995 were extracted from the Worldclim database. Future temperature and precipitation values are extracted from the CRNM-CM6 model. They are presented respectively in `r fig_nums("ssp-temp-prec",display = "c")`. The modeled future NDVI are shown in `r fig_nums("ssp-ndvi",display = "c")`. 

```{r ssp-temp-prec, fig.dim= c(6,8)}
knitr::include_graphics(c("WR/ssp126.temp.png", "WR/ssp126.diff.temp.png", "WR/ssp370.temp.png","WR/ssp370.diff.temp.png","WR/ssp126.prec.png","WR/ssp126.diff.prec.png","WR/ssp370.prec.png","WR/ssp370.diff.prec.png"))
```

`r fig_nums("ssp-temp-prec","Forecast of mean temperature and precipitation for 2050 (mean 2041-2060) under SSP 1-2.6 and SSP 3-7.0")`

```{r ssp-ndvi, fig.dim= c(6,8)}
knitr::include_graphics(c("WR/ssp126.ndvi.png","WR/ssp126.ndvi.diff.png","WR/ssp370.ndvi.png","WR/ssp370.ndvi.diff.png"))
```

`r fig_nums("ssp-ndvi","Prediction of mean NDVI for 2050")`

### Forecast of mean TOC concentration in 2041-2060

Using the Spatial Error Model fitted in [section 3.3](#sem-simple) for Fennoscandia, we used the values extracted for the two SPP to predict the TOC concentration under two different pathways. 

As a reminder, the mean TOC concentration in water regions was predicted using the same model and historical data. The results are shown in `r fig_nums("wr-maps-95", display = "c")`. 

`r fig_nums("ssp-toc",display = "c")` show the model result for SSP 1-2.6 and SSP 3-7.0

```{r ssp-toc, fig.dim= c(6,8)}
knitr::include_graphics(c("WR/map.toc.126.png", "WR/map.toc.diff.126.png","WR/map.toc.370.png","WR/map.toc.diff.370.png"))
```

`r fig_nums("ssp-toc","Forecast of TOC concentration under SSP 1-2.6 and SSP 3.7-0 (mg/L)")`

```{r compare-ssp, fig.dim = c(10,20)}
knitr::include_graphics("WR/compare.ssp.png")
```

`r fig_nums("compare-ssp","Boxplot of Temperature, Precipitation, NDVI, Runoff and TOC in 1995 and under the scenarios SSP1-2.6 and SSP3-7.0")`

### Forecast of future TOC based on forest increase

Even without climate change, an increase in forest cover would have an impact on the TOC concentration in lakes. In this section, we use the model fitted in [section 3.5](#forest) to map the TOC concentration in water regions depending on the increase in forest cover. However, the increase in the proportion of forest cover differs for all the catchments. As a matter of fact, the proportion of forest in a water region with a 100% forest cover cannot increase, and it is likely that a water region with a 0% forest cover cannot be planted (bare rocks, glaciers). Therefore, the increase of forest cover was calculated using a simple equation:

$forest_{future} = forest_{present} + (1- forest_{present}) * forest_{present}$

```{r map-increase-forest, fig.dim = c(6,8) }
knitr::include_graphics(c("WR/map.forest.png","WR/map.diff.forest.png"))
```

`r fig_nums("map-increase-forest","Predicted increase of forest cover")`

This formula attributes a larger increase of forest proportion to the catchments with 50% forest cover (50% increase), whereas the regions with 0 or 100% forest cover will not increase. 

```{r map-toc-forest, fig.dim = c(6,8) }
knitr::include_graphics(c("WR/map.toc.forest.png","WR/map.diff.toc.forest.png"))
```

`r fig_nums("map-toc-forest","Forecast of TOC concentration with an increase of forest cover")`


# Discussion


## Key predictors for TOC concentration: vegetation cover and runoff

* Summer NDVI proves to be a stronger predictor than the proportion of forest. Takes into account more variations of vegetation, even with a coarser resolution.
* Forest cover remains a good predictor and can be used to evaluate the impact of afforestation on TOC concentration in lakes. 
* The proportion of bogs is a strong predictor that cannot be replaced by another. Unlikely to change over time.
* Runoff is a major predictor, but we observe that it has a negative effect on TOC concentration. The dilution effect is therefore stronger than the mobilisation (of soil organic matter) on average. GWR shows that it nonetheless depends on the local slope: the effect size of a 10% increase in runoff is close to zero in eastern Finland and -6% in western Norway.

## Impact of climate change on TOC concentration in lakes

* In the SELM fit, the effect size of runoff is more limited than the effect size of NDVI for the same relative change (10%). 
* However, the effect of an increased runoff dominates in the forecast of TOC concentration in the scenario SSP126. In the north of Sweden and in the east of Finland, where the runoff will increase most, the average TOC concentration will decrease. On the contrary, in the south of Sweden and on the Norwegian western coast, the runoff is predicted to decrease. These are also the regions where the highest increase of TOC concentration. The increase of NDVI is highest in the northernmost catchments, but this increase is not reflected in the future TOC concentration.

* In the SSP370 scenario, the same trend is visible but the TOC concentration will increase in more water regions. The highest increases are once again visible in the south of Sweden. For many water regions, both NDVI and runoff will increase without leading to an increase of TOC concentration, rather a slight decrease, confirming the importance of the dilution effect compared to the vegetation effect. 


## Impact of afforestation / densification / fertilization

* Forest model: allows to assess the impact of afforestation
* NDVI model: allows to assess the impact of densification / fertilization
* More forest -> more TOC in lakes, up to +2 mg/L. Highest TOC concentration in water regions where the forest increases most, even considering that water regions with 100% forest will not have more forest.

Is climate forest the best way to store carbon?

*	according to LeNoe et al @LeNoe2021, limiting the harvest of wood would allow the forest to become a huge sink (more than 20 tC/ha).
*	Afforestation does not necessary lead to an increased storage of carbon in soils @TauStrand2021

# Conclusion

* NDVI is the predictor with the highest estimate in the model, but in the forecast the negative effect of runoff on TOC concentration is stronger
* Climate forest will lead to an increase in average TOC concentration, but this might be balanced but the effect of an increased runoff in the future.  

# References

`r knitr::knit_exit()`

*	The concentration of TOC in lakes a key proxy to estimate carbon fluxes from freshwater to the atmosphere, a flux often underestimated @Natchimuthu2016.


