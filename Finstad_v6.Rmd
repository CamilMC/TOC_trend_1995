---
title: "Geographical modelling of TOC concentration"
author: "Camille M. Crapart"
date: "26 01 2022"

output: 
  bookdown::word_document2:
   toc: true
   toc_float: true
   number_sections: true
   fig_caption: true
always_allow_html: true
bibliography: C:\\Users\\raine\\Documents\\UiO\\Bibtex\\Finstad.bib
csl: acs-earth-and-space-chemistry.csl
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F, error = F)
options(knitr.kable.NA="", kableExtra.auto_format = F)
```

```{r library}
library(dplyr)
library(tibble)

library(DBI)
library(sf)
library(gimms)

library(ncdf4)
library(rgdal)

library(stringr)
library(png)

library(ggplot2)
library(cowplot)
library(spdep)
library(spatialreg)

library(kableExtra)

source("f_plotspatial.R")
fennoscandia <- readRDS("fennoscandia.Rdata")
fennoscandia.spdf <- readRDS("fennoscandia.spdf.Rdata")
norge <- fennoscandia %>% filter(nation == "Norway")

```

# Introduction

In northern boreal lakes, the increased transport of organic matter from catchments to rivers and lakes resulted in a widespread phenomenon, so-called browning. This trend has been documented since the 80s @Monteith2007, as several monitoring programs were implemented to follow-up the acid deposition policies, a main environmental concern at the time. The two successive sulphur protocols of Helsinki in 1985 and in Oslo 1994 @UNECE) were followed by regional surveys on water quality, one in 1986 and one in 1995 (Northern European Lake Survey in 1995 @Henriksen1998). The last survey included Norway, Sweden, Finland, Denmark, as well as Scotland, Wales and Russian Kola and Karelia. A 50% decrease of acid rains was observed between the period 76-85 and the period 95-2001 @Menz2004. Finstad et al. @Finstad2016 demonstrated that acidification negatively affects the solubility of DOC, therefore reducing the transport from terrestrial pools to lakes. As a result, the concentration of organic matter drastically increased @DeWit2007a. 
However, other parameters play a role in the browning of the water. A main factor is climate change, with changing runoff patterns expected to lead to an increased transport of TOC @DeWit2016. In addition, longer growing seasons increase the primary production on the catchments @Finstad2016. In addition, the land-use changes tend towards more intensive forestry practices. Small-scale farming used forest resources for the cattle @Myrstener2021, but the abandon of these practices resulted in increased standing forest biomass and soil organic matter production. 
In addition, forest management is a major tool in Fennoscandian climate policies @Sundnes2020. In line with the Declaration on Forest and Land Use signed on November 2021 @ UNClimateChangeConferenceUK2021, the Fennoscandian governments consider forest as a leverage for offsetting their carbon emissions and reaching their zero-emission goals. With respectively 38 @SSB2021, 70 @SwedishForestIndustries2019 and 86% @Torniainen2019 of their territories covered with forest, the Fennoscandian countries are not subject to deforestation. On the contrary, the boreal forest covering Fennoscandia is part of the largest carbon pool on Earth. According to Bradshaw et al. @Bradshaw2015, the mean value of the total carbon store in the boreal biome could be reach 1041,5 Pg compared to 500 in the tropical forests. This carbon is mostly stored in soil and peatlands. In the last centuries, boreal forests are a sink for carbon due to their high growth rate, mainly because they extended over previously frozen area and benefited from a milder climate, with longer growing seasons. This enhanced growing rate partially compensated the CO2 emissions generated by deforestation in other parts of the world @LeNoe2021. Current policies in the Nordics largely promote the intensification of the forest industry. In Norway, Milj√∏direktoratet subsidies the densification of the planted area and the afforestation of new ones @Futter2019. In Sweden, where most of the forest area is productive, timber industry is a major economical resource @RoyalSwedish2015. 23% of the total exportations come from products coming from the forest, and the standing biomass doubled over the last 100 years @Narin. The Swedish forest industry positions itself as a major actor for climate mitigation @SwedishForestIndustries2019. Similarly, 20% of the Finnish goods exports come from the wood industry @Forestry2014.  The forest legislation was renewed in the 2010s to improve its competitivity while conserving its goals in terms of sustainability, and national subsidy schemes aim at intensifying the forestry sector.
The planned intensification of forest management and afforestation has raised concern over the water quality @Futter2019. In Norway, 90% of the drinking water @NorskVann and 90% of the electricity @EnergifaktaNorge2020 comes from surface waters. Nitrogen pollution and browning have potential impacts on the necessary treatments to ensure potability of water @Eikebrokk2018, as well as on the local ecosystems and the greenhouse gases emissions of the lake, especially in small lakes @DeWit2018. As a matter of fact, 90% of the total organic matter in boreal lakes is dissolved @Larsen2011 and has several roles in the lake ecosystem. DOC is the main source of food for heterotrophic bacteria. With darker waters, the light available for photosynthesis decreases, favouring heterotrophic bacteria against autotrophic bacteria and shifting the gas balance from a sink to a source of greenhouse gases. In addition, the sunlight is absorbed by the coloured DOC, warming the upper layer of the lakes. Warm and dark water, with limited light availability, potentially disturb local species and fish production @Karlsson2009 @Craig2007. 
** Coastal darkening**
Understanding the drivers for TOC concentration under anthropogenic and climatic stresses is therefore essential to forecast potential damages to the water ecosystems and to water quality. 
In this article, we extend the model proposed by Larsen et al @Larsen2011a in 2011, using catchment characteristics to predict the concentration of TOC in Fennoscandian lakes. Larsen et al. used a database consisting of the Norwegian lakes sampled during the Northern European Lake Survey @Henriksen1998, and use NDVI, bogs and runoff as predictors. Here, we use the same survey but include lakes and catchments from Sweden and Finland (around 4000 lakes and catchments). Other catchment characteristics are included at first to test the assumption the NDVI, bogs and runoff are good predictors. In addition, we introduce spatial modelling tools in order to take into account the spatial autocorrelation of the dependent and independent variables: a spatial error model and a geographically weighted model. In addition, we compute the effect size of a relative increase of each of the independent variables. Finally, we extend these results to the entire area of Fennoscandia by forecasting future TOC concentration on more than 6000 water regions (ensemble of catchments running off to the sea) in Fennoscandia. 

  
# Methods

## Data preparation {#datapreparation}
See data preparation

## Models
In this article we use three kind of models, two of them with geographical weighting. 

## Statistical models

Larsen et al. @Larsen2011 used a linear regression model to forecast the evolution of the toc concentration in Fennoscandian lakes. In this study, we first reproduce a similar ordinary least square regression model. In addition, we take into account the spatial autocorrelation of the dependent and independent parameter by fitting two different spatial models: a spatial error model and a geographically weighted model. 

### Ordinary least square regression

We first fit a multiple linear regression model, of the form:

$y_i = \beta_0 + \beta_1 x_{1i} + \beta_2 x_{2i} + ... + \varepsilon_i$

The regression coefficients are easy to interpret as the effect of one predictor on the dependent variable, holding all the other predictors fixed @Casella2013. It is also the model that requires the least computing. It was fitted with the base package in R. 

### Spatial error model

The spatial error model is a linear model in which the spatial autocorrelation is accounted for in the error term. More accurately, it computes the maximum likelihood estimation of the following model @Bivand2021: 
$$y = X \beta + u$$

Where $u$ is the error vector, having the form:

$u = \rho Mu +\varepsilon$

\rho is the scalar spatial autoregressive parameter. Mu is a vector of observations on the spatially lagged vector of residuals, defined thanks to the weight matrix M?

The computation was made on R with the "spatialreg" package @Bivand2019. 


### Geographically weigthed regression

Finally, we fitted a geographically weighted regression model, using the GWmodel package in R @Lu2021. A developement of the model using GWmodel is presented in @Gollini2015. A geographically weighted model computes a linear regression for each point of the dataset, giving more weight to the closest neighbours. The weight of each neighbours is defined by a weight matrix, specific to each model point. Here we chose a decreasing kernel gaussian weighting function. Instead of using an automatically selected bandwith (the bandwith parameter controls the rate of decay of the function), we defined it as the 100 closest neighbours in order to remain consistent with bandwith chosen for the spatial error model. 


## Effect size {#effect-size}

The effect size of each independent variable is expressed as the relative change of TOC depending on a given change of the independent variable. The conversion from model estimate to effect size is detailed below.

* x is the independent variable
* $\hat{\theta}$ is the regression coefficient estimate
* $h(\hat{\theta})$ is the effect size


For the non-transformed independent variables (NDVI, slope, percentage of bogs and arable land, N-deposition), the effect size was calculated taking into account that the dependent variable was logged. 

$\log ([TOC]_1) = \hat{\theta} x_1$

$\log ([TOC]_2) = \hat{\theta} x_2$

$\log ([TOC]_2) - \log ([TOC]_1) = \hat{\theta}  (x_2 - x_1)$

$\log \frac{[TOC]_2}{[TOC]_1} = \hat{\theta} \Delta x$

$\frac{[TOC]_2}{[TOC]_1} = 10^{\hat{\theta} \Delta x }$


 The delta used for NDVI, bogs and arable land was 0.1 (NDVI is indicated on a scale from 0 to 1 and "bogs" and "arable" are proportions). The delta used for slope and temperature is 1, so the effect size is calculated for an increase of 1 degree. Therefore the effect size for NDVI, bogs and arable land is: 

$h(\hat{\theta}) = 10^{\hat{\theta} \times 0.1}$

The effect size for slope and temperature is:

$h(\hat{\theta}) = 10^{\hat{\theta} \times 1}$

The evaluation of the standard error is based on the delta method @MacKenzie2018.

$Var(h(\hat{\theta})) = \left( \frac{\delta h(\theta)}{\delta \hat{\theta}} \right) ^2 \times Var(\hat{\theta})$

$Std(h(\hat{\theta})) = \sqrt{\left( \frac{\delta h(\theta)}{\delta \hat{\theta}} \right) ^2 \times Var(\hat{\theta})}$

$Std(h(\hat{\theta})) = \frac{\delta h(\hat{\theta})}{\delta \hat{\theta}} \times Std(\hat{\theta})$

$\frac{\delta h(\hat{\theta})}{\delta \hat{\theta}} = ln(10) \times 10^{\hat{\theta} \times 0.1} \times 0.1$

$Std(h(\hat{\theta})) = 0.1 \times ln(10) \times 10^{\hat{\theta} \times 0.1} \times Std(\hat{\theta})$



The effect size for the logged variables was calculated as the relative change of TOC concentration for a 10% increase of the independent variable. 

$\log([TOC]_1) = \hat{\theta} \times \log(x)$

$\log([TOC]_2) = \hat{\theta} \times \log(x \times 1.1) = \hat{\theta} \times \log(x) + \hat{\theta} \times \log(1.1)$

$\log([TOC]_2) - \log([TOC]_1) = \hat{\theta} \times \log(1.1)$

$\log([TOC]_2/[TOC]_1) = \hat{\theta} \times \log(1.1) = \log(1.1^{\hat{\theta}})$

$\frac{[TOC]_2}{[TOC]_1} = 1.1^{\hat{\theta}}$

The corresponding standard error is: 

$Var(h(\hat{\theta})) = \left( \frac{\delta h(\theta)}{\delta \hat{\theta}} \right) ^2 \times Var(\hat{\theta})$

$Std(h(\hat{\theta})) = \sqrt{ \left( \frac{\delta h(\hat{\theta})}{\delta \hat{\theta}} \right) ^2 \times Var(\hat{\theta})}$

$Std(h(\hat{\theta})) = \frac{\delta h(\hat{\theta})}{\delta \hat{\theta}} \times Std(\hat{\theta})$

$\frac{\delta h(\hat{\theta})}{\delta \hat{\theta}} = 1.1^{\hat{\theta}} \times ln(1.1) \times 0.1 \times 1$

$Std(h(\hat{\theta})) = 1.1^{\hat{\theta}} \times ln(1.1) \times 0.1 \times 1 \times Std(\hat{\theta})$

# Results

## Overview of variables

### Mapping of dependent and independent variables

The dataset is composed of `r dim(fennoscandia)[1]` lakes sampled during the Northen Lake SUrvey in 1995 @Henriksen1998. The TOC concentration, which is the dependent variable that we aim to model, was measured by NIVA after the sampling @Henriksen1997. The 9 explanatory (independent) variables were downloaded. On Figure \@ref(fig:map-variable), the data points are represented using the sampling coordinates for each lake. The catchment data (NDVI, runoff, temperature, precipitation etc.) were computed as the mean value of each parameter over the catchment, and then assigned to the corresponding data point. The collection and cleaning of data are detailed in data preparation section, but a summary of the variables is presented below:  

* The TOC concentration values come from the Northern Lake Survey and are expressed in mg/L. The TOC concentration values are logged (on base 10) in this analysis to normalize the distribution.

* NDVI is downloaded from the GIMMS database for 1994, the year preceding the sampling @TheNationalCenterforAtmosphericResearch2018. We use the mean value of the summer months (june, july and august) over the catchment.

* The runoff values are derived from the CORDEX model, and are the average value for the model predictions from year 1960 to year 1990 @CORDEX @Kreienkamp2012. The runoff values are converted in kg/m2/year, or mm/year, and are also logged (log10). 

* Temperature and precipitation data are downloaded from the WorldClim database @WorldClim. Temperature is in \uOOBOC `r expression(*~degree*C*)` and precipitation in mm/year. They are the average values from 1970 to 2000, and the mean of each catchment was computed. The precipitation values are logged (base 10) to normalize the distribution. 

* The proportions of bogs, arable land and forested area are computed from the Corine Land Cover database @CopernicusCLC, and correspond to the 2000 data, as the raster for 1995 was not available. Several CLC category were merged to create the three categories used in this study: see [data preparation]{#datapreparation}.None of the land cover values are transformed. A log transformation in  not possible due to many zeros in the data, and the other possible transformations (square, square roots) did not help to normalize the distribution. 

* N-deposition data is extracted from EMEP models @EMEP. We use here the total N deposition (sum of dry and wet deposition). The first available year is 2000, so data from 2000 was used. We assume the there was little change between 1995 and 2000. 

The color scale of the maps in Figure \@ref(fig:map-variable) goes from blue for the lower values to red for the higher values. Yellow corresponds to the median value.


```{r map-variable, fig.dim = c(10,13), fig.cap = "Maps of dependent and independent variables"}
m <- c("log.toc","ndvi","log.runoff","log.prec","temp","bogs","arable","forest","tndep")
u <- c("TOC concentration, log(mg/L)", "NDVI on scale 0 to 1", "Mean runoff, log(kg/m2/an)","Mean annual precipitation,\n log(mm)","Mean annual temperature,\n degree celsius","Proportion of bogs, %","Proportion of\narable land, %","Proportion of forest, %","Total nitrogen\ndeposition, ug/m2")
list.map <- lapply(m,FUN = function(x)  f_plotspatial(data=fennoscandia,var=fennoscandia[[x]],plottitle = "")+annotate("text", x = 10, y = 69.5, label = paste(u[grep(x,m)],"\n(",x,")",sep="")))

cowplot::plot_grid(plotlist = list.map,ncol=2)
```

### Correlation between independant variables

```{r corrplot, fig.cap = "Correlation plot of independent variables", fig.dim=c(7,7)}
cor.mat <- cor(dplyr::select(fennoscandia,m[-1]))
corrplot::corrplot(cor.mat, method = "number",type = "lower")
```

Figure \@ref(fig:corrplot) shows the Pearson correlation coefficient between the independent variables. All the correlation are represented, independently of their p value. NDVI has a high positive correlation with forest (r = `r round(cor(fennoscandia$ndvi,fennoscandia$forest),2)`. The highest correlation coefficient corresponds to the pearson coefficient between temperature and N-dep (r = `r round(cor(fennoscandia$temp,fennoscandia$tndep),2)`). This may be explained by the fact that acid rains and air pollution affects mainly the southern regions of Fennoscandia. As expected, log precipitation and log runoff are correlated (r = `r round(cor(fennoscandia$log.prec,fennoscandia$log.runoff),2)`), but we expect that runoff will be a better predictor because it reflects the potential flux of TOC from soil to lakes. Precipitation can have adverse effects on TOC concentration: in colder regions, a high level of precipitations takes the form of a snow layer that prevents vegetation growth and therefore reduces the TOC production on the catchment and in situ. 

Forest and NDVI are also positively correlated (r = `r round(cor(fennoscandia$forest,fennoscandia$ndvi),2)`), but the two parameters don't provide the same information. Land cover data has a finer resolution than NDVI data (see \@ref(fig:plot-raw-data)), The minimum mapping unit in Corine Land Cover is 25 ha, for a minimum of 100 m linear feature. The mapping is realized base on satellite images country by country in a semi-automatic way, which can result in slight differences of image interpretation between countries.  Finland and Sweden, for example, use two different methods to treat the forest cover @Buttner2021. On the contrary, the NDVI is processed the same way for all countries but has a 8 km spatial resolution (the basic square can be 8x8 km, or 1600 ha), which is much coarser resolution. However, the NDVI reflects all kind of vegetation and its density, which is not taken into account in the land cover. 

```{r plot-raw-data, fig.cap = "Map of summer NDVI and land cover in Fennoscandia"}
knitr::include_graphics("NDVI/ndvi_fennoscandia.png")
knitr::include_graphics("clc_fennoscandia.png")
````


### Spatial autocorrelation & VIF

The spatial autocorrelation of the independent variables is evaluated thanks to the Moran's I index. X is the variable of interest, N the number of spatial units, and $w_{ij}$ a diagonal weight matrix.

$$
I = \frac{N}{\Sigma_i \Sigma_j w_{ij}} \frac{\Sigma_i \Sigma_j w_{ij} (X_i-\bar{X})(X_j-\bar{X})}{\Sigma_i (X_i-\bar{X})^2}
$$

Moreover, the collinearity between the independent variables is assessed by using the Variance Inflation Factor (VIF). It is obtained by regressing each independent variables towards the others, and calculated using the resulting $R^2$.  

$$
VIF = \frac{1}{1-R_i^2}
$$

```{r neighbour-matrix,  eval = F}
library(spdep)
k.neigh.set <- knearneigh(fennoscandia.spdf, k = 100)
k.neigh.nb.set <- knn2nb(k.neigh.set)
k.neigh.w <- nb2listw(k.neigh.nb.set)
saveRDS(k.neigh.w,"k.neigh.w.Rdata")
```

```{r spatial-autocorrelation, eval = T}
k.neigh.w <- readRDS("k.neigh.w.Rdata")
moran.list <- c() 

m <- c("log.toc","ndvi","log.runoff","log.prec","temp","bogs","arable","forest","tndep")

for (i in m){
  moran.list[[i]] <- moran.test(fennoscandia[,i],k.neigh.w, na.action = na.omit, alternative = "two.sided")
}

moran.df <- data.frame(m) %>% setNames("parameter")
moran.df$moran.I <- NA
moran.df$p.value <- NA

for (i in 1:length(moran.list)){
  moran.df$moran.I[i] <- moran.list[[i]]$estimate[1]
  moran.df$p.value[i] <- moran.list[[i]]$p.value
}

saveRDS(moran.df,"moran.df.Rdata")
```

```{r vif}
lm.all <- lm(data = fennoscandia, formula = as.formula(paste(m[1],"~",paste(m[-1],collapse = "+"))))
lm.vif <- car::vif(lm.all) %>% as.data.frame() %>% setNames("VIF")
```

```{r moran-vif-table}
moran.df <- readRDS("moran.df.Rdata")

moran.limit <- 1/(dim(fennoscandia)[1]-1)

moran.vif.df <- merge(moran.df,lm.vif, by.x = "parameter", by.y = 0)
moran.vif.df[,2:4] <- round(moran.vif.df[,2:4],2)

moran.vif.df[,-3] %>% 
  dplyr::mutate(
    VIF = cell_spec(VIF,color = ifelse(VIF > 3,"red", "black"), bold = ifelse(VIF > 5, T, F)),
    moran.I = cell_spec(moran.I,bold = ifelse(moran.I > moran.limit, T, F),color = ifelse(moran.I > 0.8, "red","black"))) %>%
  knitr::kable(digits = 2, 
    caption = paste("Moran'I of dependant and independant variable (limit = ",
    format(moran.limit,scientific = T, digits = 2),")",sep = ""),
    escape = F) %>%    
  kable_styling(bootstrap_options = "bordered", position = "center")
        
```

The most auto-correlated variables (precipitation, temperature, and N deposition) are also the ones with the highest VIF. Temperature has a VIF higher than 5 (VIF = `r round(lm.vif["temp",],2)`) and was highly correlated to N-deposition (Figure \@ref(fig:corrplot)), as well as with NDVI and forest to some extent. Log precipitation also has a high VIF value (VIF = `r round(lm.vif["log.prec",],2)`) and a high correlation with log.runoff. TN-dep had only low correlation coefficients with the other variables, so it will be included in the model even if it has a high VIF value. However, temperature and log(precipitation will not be included).


## Comparison of linear model and spatial error model for the Fennoscandian dataset 

An ordinary least square regression (OLS) and a Spatial Error Model (SEM) were fitted for the log.toc against the selected independent variables. The Spatial Error Model takes into account the spatial autocorrelation of the independent variables in the error term of the regression. To compare the two models, the Akaike Information Criterion was calculated.

Both models were fitted with and without scaled variables. The effect size calculated using the raw (non-scaled) coefficients according to the method explained in \@ref(effect-size). A comparison of the regression coefficients and effect size for each independent variables is shown on figure \@ref(fig:compare-plots-1). 

```{r ols-fennoscandia, results = T}
k.neigh.w <- readRDS("k.neigh.w.Rdata")

fm.s <- s.log.toc~s.ndvi+s.log.runoff+s.bogs+s.arable+s.forest+s.tndep
s.lm.fennoscandia <- lm(fm.s, data = fennoscandia, na.action = na.exclude)

fm <- log.toc~ndvi+log.runoff+bogs+arable+forest+tndep
lm.fennoscandia <- lm(fm, data = fennoscandia, na.action = na.exclude)

s.lm.r2 <- summary(s.lm.fennoscandia)$adj.r.squared
s.moran.I.res.lm <- lm.morantest(s.lm.fennoscandia, k.neigh.w, alternative = "two.sided")

lm.r2 <- summary(lm.fennoscandia)$adj.r.squared
moran.I.res.lm <- lm.morantest(lm.fennoscandia, k.neigh.w, alternative = "two.sided")

moran.limit.fennoscandia <- 1/(dim(fennoscandia)[1]-1)

s.lm.coef <- summary(s.lm.fennoscandia)$coefficients %>% as.data.frame()
s.lm.coef <- s.lm.coef[-1,] %>% rownames_to_column(var = "Parameter")

lm.coef <- summary(lm.fennoscandia)$coefficients %>% as.data.frame()
lm.coef <- lm.coef[-1,] %>% rownames_to_column(var = "Parameter")

lm.effectsize <- lm.coef[,1:3]

n <- length(lm.coef$Parameter)
m <- lm.coef$Parameter

for(i in 1:n){
  if(grepl("log",m[i])==T){
    lm.effectsize[i,2] <- 1.1^(lm.coef[i,2])
    lm.effectsize[i,3] <- 1.1^(lm.coef[i,2])*log(1.1)*lm.coef[i,3]
  }else if(m[i] %in% c("ndvi","bogs","arable","forest")){
    lm.effectsize[i,2] <- 10^(lm.coef[i,2]*0.1)
    lm.effectsize[i,3] <- 0.1*log(10)*10^(lm.coef[i,2]*0.1)*lm.coef[i,3]
  }else if(m[i] %in% c("slope","temp")){
    lm.effectsize[i,2] <- 10^(lm.coef[i,2]*1)
    lm.effectsize[i,3] <- 1*log(10)*10^(lm.coef[i,2]*1)*lm.coef[i,3]
  }else if(m[i] %in% c("tndep")){
    lm.effectsize[i,2] <- 10^(lm.coef[i,2]*100)
    lm.effectsize[i,3] <- 100*log(10)*10^(lm.coef[i,2]*100)*lm.coef[i,3]
  }
}

lm.effectsize$Percent <- 100*(lm.effectsize$Estimate-1)

```

```{r arm-sim-test-lm}
sm.fennoscandia <- arm::sim(lm.fennoscandia,n.sims = 100)

sm.coef <- sm.fennoscandia@coef[,-1]
sm.effectsize <- data.frame(parameter = colnames(sm.coef), effect.size = NA, std.error = NA)

n <- dim(sm.coef)[2]
m <- colnames(sm.coef)

for(i in 1:n){
  if(grepl("log",m[i])==T){
    sm.effectsize[i,2] <- mean(1.1^(sm.coef[,i]))
    sm.effectsize[i,3] <- sd(1.1^(sm.coef[,i])*log(1.1)*sm.coef[,i])
  }else if(m[i] %in% c("ndvi","bogs","arable","forest")){
    sm.effectsize[i,2] <- mean(10^(sm.coef[,i]*0.1))
    sm.effectsize[i,3] <- sd(0.1*log(10)*10^(sm.coef[,i]*0.1)*sm.coef[,i])
  }else if(m[i] %in% c("slope","temp")){
    sm.effectsize[i,2] <- mean(10^(sm.coef[,i]*1))
    sm.effectsize[i,3] <- sd(1*log(10)*10^(sm.coef[,i]*1)*sm.coef[,i])
  }else if(m[i] %in% c("tndep")){
    sm.effectsize[i,2] <- mean(10^(sm.coef[,i]*100))
    sm.effectsize[i,3] <- sd(100*log(10)*10^(sm.coef[,i]*100)*sm.coef[,i])
  }
}

```

```{r summary-table-lm}
summary.table.lm <- cbind(dplyr::select(lm.coef,Parameter),s.lm.coef[,2:3],lm.coef[,2:3],lm.effectsize[,2:4],sm.effectsize[,2:3]) %>%
                rbind(c("AIC",AIC(s.lm.fennoscandia),"",AIC(lm.fennoscandia),"","","","","","")) %>%
                rbind(c("R2",s.lm.r2,"",lm.r2,"","","","","","")) %>%
                rbind(c("Moran'I res",s.moran.I.res.lm$estimate[[1]],"",moran.I.res.lm$estimate[[1]],"","","","","",""))
summary.table.lm[,-1] <- apply(summary.table.lm[,-1],2,as.numeric)

```

```{r sem, eval = F}
k.neigh.w <- readRDS("k.neigh.w.Rdata")

#lagrange <- lm.LMtests(lm.fennoscandia,k.neigh.w,test = c("LMerr","LMlag","RLMerr","RLMlag"))

fm.s <- s.log.toc~s.ndvi+s.log.runoff+s.bogs+s.arable+s.forest+s.tndep
s.sem.fennoscandia <- errorsarlm(fm.s,fennoscandia,k.neigh.w)
saveRDS(s.sem.fennoscandia,"s.sem.fennoscandia.Rdata")

fm <- log.toc~ndvi+log.runoff+bogs+arable+forest+tndep
sem.fennoscandia <- errorsarlm(fm,fennoscandia,k.neigh.w)
saveRDS(sem.fennoscandia,"sem.fennoscandia.Rdata")
```

```{r sem-results}
s.sem.fennoscandia <- readRDS("s.sem.fennoscandia.Rdata")
sem.fennoscandia <- readRDS("sem.fennoscandia.Rdata")
k.neigh.w <- readRDS("k.neigh.w.Rdata")


s.sem.coef <- s.sem.fennoscandia$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
s.sem.coef <- s.sem.coef %>% rownames_to_column(var = "Parameter")
s.sem.coef$std.error <- s.sem.fennoscandia$rest.se[-1]

sem.coef <- sem.fennoscandia$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef <- sem.coef %>% rownames_to_column(var = "Parameter")
sem.coef$std.error <- sem.fennoscandia$rest.se[-1]

sem.effectsize <- sem.coef[,1:3]

n <- length(sem.coef$Parameter)
m <- sem.coef$Parameter

for(i in 1:n){
  if(grepl("log",m[i])==T){
    sem.effectsize[i,2] <- 1.1^(sem.coef[i,2])
    sem.effectsize[i,3] <- 1.1^(sem.coef[i,2])*log(1.1)*sem.coef[i,3]
  }else if(m[i] %in% c("ndvi","bogs","arable","forest")){
    sem.effectsize[i,2] <- 10^(sem.coef[i,2]*0.1)
    sem.effectsize[i,3] <- 0.1*log(10)*10^(sem.coef[i,2]*0.1)*sem.coef[i,3]
  }else if (m[i] %in% c("slope","temp")){
    sem.effectsize[i,2] <- 10^(sem.coef[i,2]*1)
    sem.effectsize[i,3] <- 1*log(10)*10^(sem.coef[i,2]*1)*sem.coef[i,3]
  }else if(m[i] %in% c("tndep")){
    sem.effectsize[i,2] <- 10^(sem.coef[i,2]*100)
    sem.effectsize[i,3] <- 100*log(10)*10^(sem.coef[i,2]*100)*sem.coef[i,3]
  }
}

sem.effectsize$Percent <- 100*(sem.effectsize$Estimate-1)

s.sem.AIC <- 2*(n-1)-2*s.sem.fennoscandia$LL
sem.AIC <- 2*(n-1)-2*sem.fennoscandia$LL

s.moran.I.res.sem <- moran.test(s.sem.fennoscandia$residuals, k.neigh.w, alternative = "two.sided")

moran.I.res.sem <- moran.test(sem.fennoscandia$residuals, k.neigh.w, alternative = "two.sided")

summary.table.sem <- cbind(dplyr::select(sem.coef,Parameter),s.sem.coef[,2:3],sem.coef[,2:3],sem.effectsize[,2:4]) %>%
                rbind(c("AIC",s.sem.AIC,"",sem.AIC,"","","","")) %>%
                rbind(c("Moran'I res", s.moran.I.res.sem$estimate[[1]],"", moran.I.res.sem$estimate[[1]], "","","",""))
summary.table.sem[,-1] <- apply(summary.table.sem[,-1],2,as.numeric)

```

```{r compare-estimates}
n <- c(names(s.sem.coef),"model")
m <- cbind.data.frame(s.lm.coef[,1:3],model = "LM") %>% setNames(n)
o <- cbind.data.frame(s.sem.coef,model = "SEM")
  
scaled.df <- rbind(m,o)

scaled.plot <- ggplot(scaled.df, aes(group = model))+geom_col(aes(x=Estimate,y=Parameter, fill = model, col = model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Estimate-std.error,xmax=Estimate+std.error), position = "dodge", width = 0.5)+
  labs(x = "Scaled Estimate", y = "Independent variable", subtitle = paste("LM: AIC =",round(AIC(s.lm.fennoscandia),2),"; Moran's I = ",round(s.moran.I.res.lm$estimate[[1]],2),"\nSEM: AIC =",round(s.sem.AIC,2),"; Moran's I =",round(s.moran.I.res.sem$estimate[[1]],2)))+
  theme_bw()+theme(legend.position = "bottom")

```

```{r compare-effect-size}

n <- c(names(sem.effectsize),"model")
m <- cbind.data.frame(lm.effectsize,model = "LM") %>% setNames(n)
o <- cbind.data.frame(sem.effectsize,model = "SEM")
  
h.df <- rbind(m,o)

effectsize.plot <- ggplot(h.df, aes(group = model))+
  geom_col(aes(x=Percent,y=Parameter, fill = model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Percent-(100*std.error),xmax=Percent+(100*std.error)), position = "dodge", width = 0.5)+
  labs(x = "Effect size in %", y = "", subtitle = paste("LM: AIC =",round(AIC(lm.fennoscandia),2),"; Moran's I = ",round(moran.I.res.lm$estimate[[1]],2),"\nSEM: AIC =",round(sem.AIC,2),"; Moran's I =",round(moran.I.res.sem$estimate[[1]],2)))+
  theme_bw()+theme(legend.position = "bottom")

```

**The effect size is expressed as % change of TOC concentration for:**

**- 10% increase of runoff**

**- 0.1 unit increase of NDVI, bogs and arable land**

**- 100 ug increase of nitrogen deposition.**

**These relative changes are arbitrarily chosen in order to represent the impact of each independent variable on a comparable basis. However, for the forecast in section X, the effect size will be calculated on the basis of a realistic expected change for each lake catchment.**




```{r compare-plots-1, fig.dim = c(10,5), fig.cap = "Comparison of OLS and SEM models", fig.align="center"}
cowplot::plot_grid(plotlist = list(scaled.plot,effectsize.plot),ncol=2)
```

The Spatial error model performs better both with scaled variables and with unscaled variables, with a lower AIC and Moran's I in both cases. The estimates values for the predictor variables are close, but the linear model tends to attribute them higher values than the spatial error model. The scaled estimates are positive for TN-dep, NDVI, forest, bogs and arable land and negative for the log runoff. 

Log runoff and NDVI have the highest scaled estimates, with a noticeable difference between the LM and the SEM. LM and SEM scaled estimates are respectively 
`r round(s.lm.coef[which(s.lm.coef$Parameter == "s.log.runoff"), which(names(s.lm.coef) == "Estimate")],2)` 
and `r round(s.sem.coef[which(s.sem.coef$Parameter == "s.log.runoff"), which(names(s.sem.coef) == "Estimate")],2)` for log(runoff) and
 `r round(s.lm.coef[which(s.lm.coef$Parameter == "s.ndvi"), which(names(s.lm.coef) == "Estimate")],2)` and `r round(s.sem.coef[which(s.sem.coef$Parameter == "s.ndvi"), which(names(s.sem.coef) == "Estimate")],2)` for NDVI. For these two parameters, the spatial lagged model gives smaller estimates, suggesting that using a linear model over a varied region may over-estimate the impact of these parameters. Log(runoff) has the highest scaled estimates but the effect size of a 10% increase in runoff is low compared to a comparable change for the other parameters (`r round(lm.effectsize[which(lm.effectsize$Parameter == "log.runoff"), which(names(lm.effectsize) == "Percent")],2)`% for LM and `r round(sem.effectsize[which(sem.effectsize$Parameter == "log.runoff"), which(names(sem.effectsize) == "Percent")],2)`%  for SEM).

Forest, bogs and TN-dep have similar scaled estimate between 0,15 and 0,21, but their effect size vary much more. A variation of the proportion of bogs could have a major impact, but a 10% increase or decrease of area is unlikely except in the case of local peat restoration project. A variation in forest cover also has a limited impact, around 10% more TOC for both LM and SEM models. TN-dep has the lowest effect size with around `r round(lm.effectsize[which(lm.effectsize$Parameter == "tndep"), which(names(lm.effectsize) == "Percent")],0)` % increase for a 100 ug/m2 increase. N-dep is expected to decrease, but the generalization of forest fertilization could keep high N-levels. **which % hypothesis can I use?**.

The proportion of arable land has a very low scaled estimate (`r round(s.lm.coef[which(s.lm.coef$Parameter == "s.arable"), which(names(s.lm.coef) == "Estimate")],2)`) for LM and `r round(s.sem.coef[which(s.sem.coef$Parameter == "s.arable"), which(names(s.sem.coef) == "Estimate")],2)` for SEM).The effect size of a 10% increase of arable land is however comparable to the effect of a 10% increase of forest for the LM model (`r round(lm.effectsize[which(lm.effectsize$Parameter == "arable"), which(names(lm.effectsize) == "Percent")],2)` %), even though it remains lower for the SEM model (`r round(sem.effectsize[which(sem.effectsize$Parameter == "arable"), which(names(sem.effectsize) == "Percent")],2)` %).  



## Simplified models on Norway and Fennoscandia

In order to compare the results of this study to the results of Larsen et al. @Larsen2011a, we fitted two models using only three predictors: NDVI, proportion of bogs and runoff. OLS and SEM models were fitted for the entire dataset as well as for the norwegian subset.The scaled estimates and the effect size were calculated similarly to the previous section.

```{r kmat, eval = F}
norge.spdf <- SpatialPointsDataFrame(norge[,c("longitude","latitude")],norge)

norge.kmat <- norge.spdf %>% knearneigh(k=50) %>% knn2nb %>% nb2listw
saveRDS(norge.kmat,"norge.kmat.Rdata")
```

```{r sem-simple-norway, eval = F}
norge.kmat <- readRDS("norge.kmat.Rdata")

s.fm <- s.log.toc~s.ndvi+s.log.runoff+s.bogs
s.sem.norge.simple <- errorsarlm(s.fm,norge,norge.kmat)
saveRDS(s.sem.norge.simple,"s.sem.norge.simple.Rdata")

fm <- log.toc~ndvi+log.runoff+bogs
sem.norge.simple <- errorsarlm(fm,norge,norge.kmat)
saveRDS(sem.norge.simple,"sem.norge.simple.Rdata")

```

```{r sem-simple-results-norway}
s.sem.norge.simple <- readRDS("s.sem.norge.simple.Rdata")
sem.norge.simple <- readRDS("sem.norge.simple.Rdata")
norge.kmat <- readRDS("norge.kmat.Rdata")


s.sem.coef.norge <- s.sem.norge.simple$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
s.sem.coef.norge <- s.sem.coef.norge %>% rownames_to_column(var = "Parameter")
s.sem.coef.norge$std.error <- s.sem.norge.simple$rest.se[-1]

sem.coef.norge <- sem.norge.simple$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef.norge <- sem.coef.norge %>% rownames_to_column(var = "Parameter")
sem.coef.norge$std.error <- sem.norge.simple$rest.se[-1]

sem.effectsize.norge <- sem.coef.norge[,1:3]

n <- length(sem.coef.norge$Parameter)
m <- sem.coef.norge$Parameter

for(i in 1:n){
  if(grepl("log",m[i])==T){
    sem.effectsize.norge[i,2] <- 1.1^(sem.coef.norge[i,2])
    sem.effectsize.norge[i,3] <- 1.1^(sem.coef.norge[i,2])*log(1.1)*sem.coef.norge[i,3]
  }else if(m[i] %in% c("ndvi","bogs","arable")){
    sem.effectsize.norge[i,2] <- 10^(sem.coef.norge[i,2]*0.1)
    sem.effectsize.norge[i,3] <- 0.1*log(10)*10^(sem.coef.norge[i,2]*0.1)*sem.coef.norge[i,3]
  }else if(m[i] %in% c("slope","temp","tndep")){
    sem.effectsize.norge[i,2] <- 10^(sem.coef.norge[i,2]*1)
    sem.effectsize.norge[i,3] <- 1*log(10)*10^(sem.coef.norge[i,2]*1)*sem.coef.norge[i,3]
  }
}

sem.effectsize.norge$Percent <- 100*(sem.effectsize.norge$Estimate-1)

s.sem.AIC.norge <- 2*(n-1)-2*s.sem.norge.simple$LL
s.moran.I.res.sem.norge <- moran.test(s.sem.norge.simple$residuals, norge.kmat, alternative = "two.sided")

sem.AIC.norge <- 2*(n-1)-2*sem.norge.simple$LL
moran.I.res.sem.norge <- moran.test(sem.norge.simple$residuals, norge.kmat, alternative = "two.sided")

summary.table.sem.norge <- cbind(dplyr::select(sem.coef.norge,Parameter),s.sem.coef.norge[,2:3],sem.coef.norge[,2:3],sem.effectsize.norge[,2:4]) %>%
                rbind(c("AIC",s.sem.AIC,"",sem.AIC,"","","","")) %>%
                rbind(c("Moran'I res", s.moran.I.res.sem.norge$estimate[[1]],"",moran.I.res.sem.norge$estimate[[1]], "","","",""))
summary.table.sem.norge[,-1] <- apply(summary.table.sem.norge[,-1],2,as.numeric)

```

```{r sem-simple-fennosandia, eval = F}
k.neigh.w <- readRDS("k.neigh.w.Rdata")

s.fm <- s.log.toc~s.ndvi+s.log.runoff+s.bogs
s.sem.fen.simple <- errorsarlm(s.fm,fennoscandia,k.neigh.w)
saveRDS(s.sem.fen.simple,"s.sem.fen.simple.Rdata")

fm <- log.toc~ndvi+log.runoff+bogs
sem.fen.simple <- errorsarlm(fm,fennoscandia,k.neigh.w)
saveRDS(sem.fen.simple,"sem.fen.simple.Rdata")

```

```{r sem-simple-results}
s.sem.fen.simple <- readRDS("s.sem.fen.simple.Rdata")
sem.fen.simple <- readRDS("sem.fen.simple.Rdata")
k.neigh.w <- readRDS("k.neigh.w.Rdata")

s.sem.coef <- s.sem.fen.simple$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
s.sem.coef <- s.sem.coef %>% rownames_to_column(var = "Parameter")
s.sem.coef$std.error <- s.sem.fen.simple$rest.se[-1]

sem.coef <- sem.fen.simple$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef <- sem.coef %>% rownames_to_column(var = "Parameter")
sem.coef$std.error <- sem.fen.simple$rest.se[-1]

sem.effectsize.fen <- sem.coef[,1:3]

n <- length(sem.coef$Parameter)
m <- sem.coef$Parameter

for(i in 1:n){
  if(grepl("log",m[i])==T){
    sem.effectsize.fen[i,2] <- 1.1^(sem.coef[i,2])
    sem.effectsize.fen[i,3] <- 1.1^(sem.coef[i,2])*log(1.1)*sem.coef[i,3]
  }else if(m[i] %in% c("ndvi","bogs","arable")){
    sem.effectsize.fen[i,2] <- 10^(sem.coef[i,2]*0.1)
    sem.effectsize.fen[i,3] <- 0.1*log(10)*10^(sem.coef[i,2]*0.1)*sem.coef[i,3]
  }
}

sem.effectsize.fen$Percent <- 100*(sem.effectsize.fen$Estimate-1)

s.sem.AIC <- 2*(n-1)-2*s.sem.fen.simple$LL
s.moran.I.res.sem <- moran.test(s.sem.fen.simple$residuals, k.neigh.w, alternative = "two.sided")

sem.AIC <- 2*(n-1)-2*sem.fen.simple$LL
moran.I.res.sem <- moran.test(sem.fen.simple$residuals, k.neigh.w, alternative = "two.sided")

summary.table.simple.sem <- cbind(dplyr::select(sem.coef,Parameter),s.sem.coef[,2:3],sem.coef[,2:3],sem.effectsize.fen[,2:4]) %>%
                rbind(c("AIC",s.sem.AIC,"",sem.AIC,"","","","")) %>%
                rbind(c("Moran'I res", s.moran.I.res.sem$estimate[[1]],"",moran.I.res.sem$estimate[[1]], "","","",""))
summary.table.simple.sem[,-1] <- apply(summary.table.simple.sem[,-1],2,as.numeric)

```

```{r compare-estimates-simple}
n <- c(names(s.sem.coef),"model")
m <- cbind.data.frame(s.sem.coef.norge, model = "Norway")
o <- cbind.data.frame(s.sem.coef,model = "Fennoscandia")
  
scaled.df <- rbind(m,o)

scaled.plot <- ggplot(scaled.df, aes(group = model))+geom_col(aes(x=Estimate,y=Parameter, fill = model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Estimate-std.error,xmax=Estimate+std.error), position = "dodge", width = 0.5)+
  labs(x = "Scaled estimates",y = "Independent variables", subtitle = paste("Fennoscandia: AIC =",round(s.sem.AIC,2),"; Moran's I = ",round(s.moran.I.res.sem$estimate[[1]],2),"\nNorway: AIC =",round(s.sem.AIC.norge,2),"; Moran's I =",round(s.moran.I.res.sem.norge$estimate[[1]],2)))+
  theme_bw()+
  theme(legend.position = "bottom")

```

```{r compare-effect-size-simple}

n <- c(names(sem.effectsize.fen),"model")
m <- cbind.data.frame(sem.effectsize.norge,model = "Norway")
o <- cbind.data.frame(sem.effectsize.fen,model = "Fennoscandia")
  
h.df <- rbind(m,o)

effectsize.plot <- ggplot(h.df, aes(group = model))+
  geom_col(aes(x=Percent,y=Parameter, fill = model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Percent-(100*std.error),xmax=Percent+(100*std.error)), position = "dodge", width = 0.5)+
  labs(x = "Effect size in %", y = "", subtitle = paste("Fennoscandia: AIC =",round(sem.AIC,2),"; Moran's I = ",round(moran.I.res.sem$estimate[[1]],2),"\nNorway: AIC =",round(sem.AIC.norge,2),"; Moran's I =",round(moran.I.res.sem.norge$estimate[[1]],2)))+
  theme_bw()+theme(legend.position = "bottom")
```

**Once again, the effect size is expressed as % change of TOC concentration for:**

**- 10% increase of runoff**

**- 0.1 unit increase of NDVI and bogs.**

**These relative changes are arbitrarily fixed and do not represent the expected changes for the coming decades.**

```{r compare-plots-2, fig.dim = c(10,5), fig.cap = "Comparison of models for the Norwegian and Fennoscandia sets"}
cowplot::plot_grid(plotlist = list(scaled.plot,effectsize.plot),ncol=2)
```

The scaled estimates have slighly higher values for the Norwegian model compared to the Fennoscandia model, which is reflected in the effect size. Once again, NDVI is the predictor with the highest scaled estimate and the higher effect size. Log(runoff) has a large scale estimate but a smaller effect size for a 10%. change. The effect of bogs is similar for both Norway and Fennoscandia, with a little higher estimate and effect size. 

In the simpler model, NDVI effect size is higher than in the model including more variables. The SEM model predicted an `r round(sem.effectsize[which(sem.effectsize$Parameter == "ndvi"), which(names(sem.effectsize) == "Percent")],2)`%, while it predicts here `r round(sem.effectsize.fen[which(sem.effectsize.fen$Parameter == "ndvi"), which(names(sem.effectsize.fen) == "Percent")],0)` % and `r round(sem.effectsize.norge[which(sem.effectsize.norge$Parameter == "ndvi"), which(names(sem.effectsize.norge) == "Percent")],0)`% for Norway. 

The effect size of a relative change in bogs proportion and in log(runoff) are also smaller in the simpler model (`r round(sem.effectsize[which(sem.effectsize$Parameter == "bogs"), which(names(sem.effectsize) == "Percent")],0)`% and `r round(sem.effectsize.fen[which(sem.effectsize.fen$Parameter == "bogs"), which(names(sem.effectsize.fen) == "Percent")],0)` % for bogs,`r round(sem.effectsize[which(sem.effectsize$Parameter == "log.runoff"), which(names(sem.effectsize) == "Percent")],0)`% and `r round(sem.effectsize.fen[which(sem.effectsize.fen$Parameter == "log.runoff"), which(names(sem.effectsize.fen) == "Percent")],0)` % for log(runoff)  )

For the scaled model, the AIC is lower for the model fitted on Norway, but it is the contrary for the model (unscaled) used for calculating the effect size. **I don't think it is possible to compare AIC if the model is not fitted on the same original data.**


### Model with forest instead of NDVI

```{r sem-with-forest, eval = F}
k.neigh.w <- readRDS("k.neigh.w.Rdata")
norge.kmat <- readRDS("norge.kmat.Rdata")

fm <- log.toc ~ forest+log.runoff+bogs
sem.forest.fen <- errorsarlm(fm, data = fennoscandia,k.neigh.w)
sem.forest.norge <- errorsarlm(fm, data = norge, norge.kmat)

saveRDS(sem.forest.fen, "sem.forest.fen.Rdata")
saveRDS(sem.forest.norge, "sem.forest.norge.Rdata")

```

```{r sem-forest-results}

sem.forest.fen <- readRDS("sem.forest.fen.Rdata")
sem.forest.norge <- readRDS("sem.forest.norge.Rdata")

# fennoscandia
sem.coef <- sem.forest.fen$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef <- sem.coef %>% rownames_to_column(var = "Parameter")
sem.coef$std.error <- sem.forest.fen$rest.se[-1]

sem.effectsize.forest <- sem.coef[,1:3]

n <- length(sem.coef$Parameter)
m <- sem.coef$Parameter

for(i in 1:n){
  if(grepl("log",m[i])==T){
    sem.effectsize.forest[i,2] <- 1.1^(sem.coef[i,2])
    sem.effectsize.forest[i,3] <- 1.1^(sem.coef[i,2])*log(1.1)*sem.coef[i,3]
  }else if(m[i] %in% c("forest","bogs")){
    sem.effectsize.forest[i,2] <- 10^(sem.coef[i,2]*0.1)
    sem.effectsize.forest[i,3] <- 0.1*log(10)*10^(sem.coef[i,2]*0.1)*sem.coef[i,3]
  }
}

sem.effectsize.forest$Percent <- 100*(sem.effectsize.forest$Estimate-1)

sem.AIC <- 2*(n-1)-2*sem.forest.fen$LL
moran.I.res.sem <- moran.test(sem.forest.fen$residuals, k.neigh.w, alternative = "two.sided")

summary.table.sem.forest <- cbind(dplyr::select(sem.coef,Parameter),sem.coef[,2:3],sem.effectsize.forest[,2:4]) %>%
                rbind(c("AIC",sem.AIC,"","","","")) %>%
                rbind(c("Moran'I res", moran.I.res.sem$estimate[[1]], "","","",""))
summary.table.sem.forest[,-1] <- apply(summary.table.sem.forest[,-1],2,as.numeric)
``` 

```{r sem-forest-norge}
# norge
sem.coef.norge <- sem.forest.norge$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef.norge <- sem.coef.norge %>% rownames_to_column(var = "Parameter")
sem.coef.norge$std.error <- sem.forest.norge$rest.se[-1]

sem.effectsize.forest.norge <- sem.coef.norge[,1:3]

n <- length(sem.coef.norge$Parameter)
m <- sem.coef.norge$Parameter

for(i in 1:n){
  if(grepl("log",m[i])==T){
    sem.effectsize.forest.norge[i,2] <- 1.1^(sem.coef.norge[i,2])
    sem.effectsize.forest.norge[i,3] <- 1.1^(sem.coef[i,2])*log(1.1)*sem.coef.norge[i,3]
  }else if(m[i] %in% c("forest","bogs")){
    sem.effectsize.forest.norge[i,2] <- 10^(sem.coef.norge[i,2]*0.1)
    sem.effectsize.forest.norge[i,3] <- 0.1*log(10)*10^(sem.coef.norge[i,2]*0.1)*sem.coef.norge[i,3]
  }
}

sem.effectsize.forest.norge$Percent <- 100*(sem.effectsize.forest.norge$Estimate-1)


sem.AIC.norge <- 2*(n-1)-2*sem.forest.norge$LL
moran.I.res.sem.norge <- moran.test(sem.forest.norge$residuals, norge.kmat, alternative = "two.sided")

summary.table.sem.forest.norge <- cbind(dplyr::select(sem.coef.norge,Parameter),sem.coef.norge[,2:3],sem.effectsize.forest.norge[,2:4]) %>%
                rbind(c("AIC",sem.AIC.norge,"","","","")) %>%
                rbind(c("Moran'I res", moran.I.res.sem.norge$estimate[[1]], "","","",""))
summary.table.sem.forest.norge[,-1] <- apply(summary.table.sem.forest.norge[,-1],2,as.numeric)

```

```{r compare-effect-size-simple-forest, fig.cap = "Effect size for SEM model with forest as predictor", fig.align="center"}

n <- c(names(sem.effectsize.forest),"model")
m <- cbind.data.frame(sem.effectsize.forest,model = "Fennoscandia") %>% setNames(n)
o <- cbind.data.frame(sem.effectsize.forest.norge,model = "Norway")
  
h.df <- rbind(m,o)

effectsize.plot <- ggplot(h.df, aes(group = model))+
  geom_col(aes(x=Percent,y=Parameter, fill = model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Percent-(100*std.error),xmax=Percent+(100*std.error)), position = "dodge", width = 0.5)+
  labs(x = "Effect size in %", y = "", subtitle = paste("Fennoscandia: AIC =",round(sem.AIC,2),"; Moran's I = ",round(moran.I.res.sem$estimate[[1]],2),"\nNorway: AIC =",round(sem.AIC.norge,2),"; Moran's I =",round(moran.I.res.sem.norge$estimate[[1]],2)))+
  theme_bw()+theme(legend.position = "bottom")
print(effectsize.plot)
```

When computing SEM models with forest as a vegetation indicator instead of NDVI, the effect size of the proportion of bogs become more important than previously. The effect size of a 10% increase in forest cover is rather small  compared to a 0.1 unit increase of NDVI ((`r round(sem.effectsize.forest[which(sem.effectsize.forest$Parameter == "forest"), which(names(sem.effectsize.forest) == "Percent")],0)`% compared to `r round(sem.effectsize.fen[which(sem.effectsize.fen$Parameter == "forest"), which(names(sem.effectsize) == "Percent")],0)`% for Fennoscandia). 

On the contrary, including the forest instead of the NDVI gives more impact to the proportion of bogs (for Fennoscandia, `r round(sem.effectsize.forest[which(sem.effectsize.forest$Parameter == "bogs"), which(names(sem.effectsize.forest) == "Percent")],0)`% compared to `r round(sem.effectsize.fen[which(sem.effectsize.fen$Parameter == "bogs"), which(names(sem.effectsize) == "Percent")],0)`%, and even more for the model on the Norwegian dataset). The effect size of a 10% increase in runoff remains similar  (for Fennoscandia, `r round(sem.effectsize.forest[which(sem.effectsize.forest$Parameter == "log.runoff"), which(names(sem.effectsize.forest) == "Percent")],0)`% compared to `r round(sem.effectsize.fen[which(sem.effectsize.fen$Parameter == "log.runoff"), which(names(sem.effectsize) == "Percent")],0)`%, and even more for the model on the Norwegian dataset).

## Geographically Weighted Regression with NDVI

A geographically weighted model was fitted on the Fennoscandian dataset. The objective is to examine the regional relationship with the dependent and independent variables. A geographically weighted model computes a linear regression giving a stronger weight to the closest neighbours. The neighbours here are choosen to be the 500 nearest lakes, where weight for each lake is attributed following a gaussian distribution. The local regression coefficients are shown on Figure \@ref(fig:gwr-results). The map of measured TOC concentration (the concentration in mg/L is logged) is also presented for comparison.


```{r GWR-fennoscandia, eval = F}
fm <- log.toc~ndvi+log.runoff+bogs

library(GWmodel)
#bw.fennoscandia <- bw.gwr(fm, data = fennoscandia.spdf, kernel = "gaussian", adaptive = T)
gwr.fennoscandia <- gwr.basic(fm, data = fennoscandia.spdf, bw = 500, kernel = "gaussian", adaptive = T)

saveRDS(bw.fennoscandia, "bw.fennoscandia.Rdata")
saveRDS(gwr.fennoscandia, "gwr.fennoscandia.Rdata")
```

```{r gwr-results, fig.dim = c(10,6), fig.cap = "Maps of the GWR coefficients"}
bw.fennoscandia <- readRDS("bw.fennoscandia.Rdata")
gwr.fennoscandia <- readRDS("gwr.fennoscandia.Rdata")
k.neigh.w <- readRDS("k.neigh.w.Rdata")

gwr.coef <- gwr.fennoscandia$SDF@data

m <- c("ndvi","log.runoff","bogs")
n <- length(m)

gwr.effectsize <- gwr.coef[,2:(n+1)]

for(i in 1:dim(gwr.effectsize)[1]){
  for(j in 1:n){
  if(grepl("log",m[j])==T){
    gwr.effectsize[i,j] <- 1.1^(gwr.coef[i,j+1])
  }else if(m[j] %in% c("ndvi","bogs","arable","forest")){
    gwr.effectsize[i,j] <- 10^(gwr.coef[i,j+1]*0.1)
  }
  }
}

gwr.effectsize.percent <- 100*(gwr.effectsize-1)

coef.plot <- lapply(m,FUN = function(x)  f_plotspatial(data=fennoscandia,var=gwr.effectsize.percent[[x]],plottitle = x))
coef.plot$toc <- f_plotspatial(fennoscandia,var=gwr.coef$y,plottitle = "Observed toc (log)")
cowplot::plot_grid(plotlist = coef.plot,ncol=2)

gwr.AIC <- gwr.fennoscandia$GW.diagnostic$AICc
gwr.r2 <- gwr.fennoscandia$GW.diagnostic$gwR2.adj
gwr.moran <- moran.test(gwr.coef$Stud_residual,k.neigh.w,alternative = "two.sided")

summary.table.gwr <- data.frame(AIC = gwr.AIC,R2 = gwr.r2,Moran.I =gwr.moran$estimate[[1]])
                                
knitr::kable(summary.table.gwr,digits = 3, caption = "Model performance: AIC, mean R2 and Moran's I of residuals") %>%
  kable_styling(bootstrap_options = "bordered")
```

In GWR, NDVI remains the main predictor for the concentration of TOC. All the local effect sizes have positive values and range from 0 to +50%. In regions already forested or agricultural (southern Sweden, south-east Finland), the effect size of a 0.1 increase in NDVI is close to 0%, but in southern Norway an increase of NDVI could have a significant relative impact on TOC concentration. 

Here again the effect size of a 10% increase in runoff is mainly negative, between `r round(min(gwr.effectsize.percent$log.runoff),0)` % and  `r round(max(gwr.effectsize.percent$log.runoff),0)`%. The south-east part of Finland it the only one where the effect size is positive. The most negative effects are
located in the south-west region of Norway. 

A change of the proportion of bogs has almost not effect here except for a little spot in south-east Finland where both the highest (`r round(min(gwr.effectsize.percent$bogs),0)` %) and the lowest (`r round(min(gwr.effectsize.percent$bogs),0)`%) effect sizes are found. This local spot is not related to the original proportion of bogs (see Figure \@ref(fig::explore-bogs)). **there are rather low runoff values in this region, but no outliers of any sort. Where does this come from?**. In all the other regions, an increase in bog proportion would have a very low effect, comparable to the mean effect size calculated with the SEM model. 

```{r explore-bogs, fig.cap = "Effect size of an increase in bogs compared to the original proportion of bogs"}
plot(fennoscandia$bogs,gwr.effectsize.percent$bogs, xlab = "Proportion of bogs, %", ylab = "Effect size of a 10% increase in bogs, %")

```


### GWR with forest

```{r GWR-fennoscandia-forest, eval = F}
fm <- log.toc~forest+log.runoff+bogs

library(GWmodel)
#bw.fennoscandia.forest <- bw.gwr(fm, data = fennoscandia.spdf, kernel = "gaussian", adaptive = T)
gwr.fennoscandia.forest <- gwr.basic(fm, data = fennoscandia.spdf, bw = 500, kernel = "gaussian", adaptive = T)

saveRDS(bw.fennoscandia.forest, "bw.fennoscandia.forest.Rdata")
saveRDS(gwr.fennoscandia.forest, "gwr.fennoscandia.forest.Rdata")
```

```{r gwr-results-forest, fig.dim = c(10,6), fig.cap = "Maps of the GWR coefficients"}
bw.fennoscandia.forest <- readRDS("bw.fennoscandia.forest.Rdata")
gwr.fennoscandia.forest <- readRDS("gwr.fennoscandia.forest.Rdata")
k.neigh.w <- readRDS("k.neigh.w.Rdata")

gwr.coef <- gwr.fennoscandia.forest$SDF@data

m <- c("forest","log.runoff","bogs")
n <- length(m)

gwr.effectsize <- gwr.coef[,2:(n+1)]

for(i in 1:dim(gwr.effectsize)[1]){
  for(j in 1:n){
  if(grepl("log",m[j])==T){
    gwr.effectsize[i,j] <- 1.1^(gwr.coef[i,j+1])
  }else if(m[j] %in% c("ndvi","bogs","arable","forest")){
    gwr.effectsize[i,j] <- 10^(gwr.coef[i,j+1]*0.1)
  }
  }
}

gwr.effectsize.percent <- 100*(gwr.effectsize-1)

coef.plot <- lapply(m,FUN = function(x)  f_plotspatial(data=fennoscandia,var=gwr.effectsize.percent[[x]],plottitle = x))
coef.plot$toc <- f_plotspatial(fennoscandia,var=gwr.coef$y,plottitle = "Observed toc (log)")
cowplot::plot_grid(plotlist = coef.plot,ncol=2)

gwr.AIC <- gwr.fennoscandia.forest$GW.diagnostic$AICc
gwr.r2 <- gwr.fennoscandia.forest$GW.diagnostic$gwR2.adj
gwr.moran <- moran.test(gwr.coef$Stud_residual,k.neigh.w,alternative = "two.sided")

summary.table.gwr.forest <- data.frame(AIC = gwr.AIC,R2 = gwr.r2,Moran.I =gwr.moran$estimate[[1]])
                                
knitr::kable(summary.table.gwr.forest,digits = 3, caption = "Model performance: AIC, mean R2 and Moran's I of residuals") %>%
  kable_styling(bootstrap_options = "bordered")
```
Replacing NDVI by the proportion of forest does not change the local effect sizes of runoff in the model, and a similar spot of very high and very low effect sizes appears for the proportion of bogs. A similar spot is visible on the map representing the local effect sizes for an increase in forest proportion, but the effect sizes values are not unusual there. Once again, this spot is not explained by an unusual original proportion of forest (see Figure \@ref(fig::explore-forest))The range of effect sizes goes from `r round(min(gwr.effectsize.percent$forest),0)` % to  `r round(max(gwr.effectsize.percent$forest),0)`%. 

```{r explore-forest, fig.cap = "Effect size of an increase in forest compared to the original proportion of forest"}
plot(fennoscandia$forest,gwr.effectsize.percent$forest, xlab = "Proportion of forest, %", ylab = "Effect size of a 10% increase in forest, %")

```

### Conclusion GWR

GWR models are interesting to investigate local relationships between the dependent and independent variables, but the results might be complicated to interpret. The strength of a GWR model is also a drawback: by giving more weight to the closest neighbors, it also "artificially" emphasizes the local features of the data points, like a magnifying lens, resulting in an potentially exaggerated version of the reality. 
If the local effect sizes of an increase of NDVI, forest and runoff could be explained by the original conditions, the effect sizes of an increase in bogs were more diverse and there is no good explanation for the spot observed in Finland. 


# Forecast in water regions

Based on the results from the spatial error model, we tried to forecast future changes in TOC concentration. The forecast is based on the evaluation of the future values of the three main predictors: NDVI, runoff and bogs. 

We assume that the proportion of bogs will not change: therefore, it will be included in the model with a 0% increase.

We assume that the NDVI will increase, both because of global warming leading to longer growing seasons, and because of the Fennoscandian forest policies aiming at afforesting and intensifying the forest cover. Future NDVI was modeled based on the 1995 values, with the mean temperature and precipitation for the range 1970-2000. 

We assume that the mean runoff will increase, accordingly to climate simulations based on CMIP6. The future runoff values are extracted from the CRNM-CM6 model, and are calculated for the SSP1-2.6 and SSP3-7.0. 



# Discussion
*	according to LeNoe et al @LeNoe2021, limiting the harvest of wood would allow the forest to become a huge sink (more than 20 tC/ha).
*	Although it is not proven that afforestation leads to an increased storage of carbon in soils @TauStrand2021,
*	Forest industry can also contribute to reducing emissions by replacing fossil fuels @SwedishForestIndustries2019
*	The concentration of TOC in lakes is therefore a key proxy to estimate carbon fluxes from freshwater to the atmosphere, a flux often underestimated @Natchimuthu2016.


# Appendix

## Summary table LM and SEM Fennoscandia

```{r lm-table-results}
knitr::kable(summary.table.lm,digits = 3) %>%
  add_header_above(c("Model"=1,"Scaled LM" = 2, "LM" = 2, "Effect size" = 3,"SIM" = 2),italic = T) %>%
  column_spec(column = 8, bold = T) %>% 
  kable_styling(bootstrap_options = "bordered") %>%
  group_rows(group_label = "Model Evaluation", start_row = n+1,end_row=n+3)

knitr::kable(summary.table.sem,digits = 4) %>%
  add_header_above(c("Model"=1,"Scaled SEM" = 2, "SEM" = 2, "Effect size" = 3),italic = T) %>%
  kable_styling(bootstrap_options = "bordered") %>%
  column_spec(column = 8, bold = T) %>% 
  group_rows(group_label = "Model Evaluation", start_row = n+1,end_row=n+2)
```

## Summary tables simple model Norway

```{r summary-table-norway}
knitr::kable(summary.table.sem.norge,digits = 4) %>%
  add_header_above(c("Model"=1,"Scaled SEM" = 2,"SEM" = 2, "Effect size" = 3),italic = T) %>%
  kable_styling(bootstrap_options = "bordered") %>%
  column_spec(column = 8, bold = T) %>% 
  group_rows(group_label = "Model Evaluation", start_row = n+1,end_row=n+2)
```

## Summary tables simple model Fennoscandia

```{r summary-table-simple-fen}

knitr::kable(summary.table.simple.sem,digits = 4) %>%
  add_header_above(c("Model"=1,"Scaled SEM" = 2,"SEM" = 2, "Effect size" = 3),italic = T) %>%
  kable_styling(bootstrap_options = "bordered") %>%
  column_spec(column = 8, bold = T) %>% 
  group_rows(group_label = "Model Evaluation", start_row = n+1,end_row=n+2)
```

## Residual plots

```{r residual-plots}
# lm models: s.lm.fennoscandia and lm.fennoscandia

s.sem.fennoscandia <- readRDS("s.sem.fennoscandia.Rdata")
sem.fennoscandia <- readRDS("sem.fennoscandia.Rdata")

sem.norge.simple <- readRDS("sem.norge.simple.Rdata")
sem.fen.simple <- readRDS("sem.fen.simple.Rdata")

sem.forest.fen <- readRDS("sem.forest.fen.Rdata")
sem.forest.norge <- readRDS("sem.forest.norge.Rdata")

f_plotspatial(data = fennoscandia,var = s.lm.fennoscandia$residuals, plottitle = "Residuals for scaled LM")
f_plotspatial(data = fennoscandia,var = s.sem.fennoscandia$residuals, plottitle = "Residuals for scaled SEM")
f_plotspatial(data = fennoscandia,var = lm.fennoscandia$residuals, plottitle = "Residuals for LM")
f_plotspatial(data = fennoscandia,var = sem.fennoscandia$residuals, plottitle = "Residuals for SEM")
f_plotspatial(data = fennoscandia,var = sem.fen.simple$residuals, plottitle = "Residuals for SEM with ndvi, runoff et bogs for Fennoscandia")
f_plotspatial(data = norge,var = sem.norge.simple$residuals, plottitle = "Residuals for SEM with ndvi, runoff et bogs for Norway")
f_plotspatial(data = fennoscandia,var = sem.forest.fen$residuals, plottitle = "Residuals for SEM with forest")
f_plotspatial(data = norge,var = sem.forest.norge$residuals, plottitle = "Residuals for SEM with forest for Norway")

```


# References

```{r exit}
knitr::knit_exit()
```

# some extra code


```{r ndvi-forest}
ndvi.model <- errorsarlm(ndvi~forest+temp+alt, data = fennoscandia, k.neigh.w)
summary(ndvi.model)
plot(fennoscandia$ndvi,ndvi.model$fitted.values)
lm(fennoscandia$ndvi~ndvi.model$fitted.values) %>% summary()
f_plotspatial(fennoscandia,var=ndvi.model$residuals, plottitle = "residuals")
f_plotspatial(fennoscandia,var=ndvi.model$fitted.values, plottitle = "fitted values")


lm(ndvi~forest, data = fennoscandia) %>% summary()
lm(ndvi~forest+bogs, data = fennoscandia) %>% summary()
lm(ndvi~forest+bogs+arable, data = fennoscandia) %>% summary()
lm(ndvi~forest+bogs+temp+log.prec, data = fennoscandia) %>% summary()
lm(ndvi~forest+bogs+temp+log.prec, data = fennoscandia) %>% summary()
lm(ndvi~forest+bogs+temp+log.prec+slope, data = fennoscandia) %>% summary()
lm(ndvi~forest+bogs+log.prec, data = fennoscandia) %>% summary()

m <- c("log.toc","ndvi","log.runoff","log.prec","slope","temp","bogs","arable","forest","tndep")
pcr.ndvi <- prcomp(select(fennoscandia,m),scale=T)
factoextra::fviz_pca_var(pcr.ndvi)

lm(ndvi~forest+slope,data=fennoscandia) %>% summary()
```
* Precipitation
https://www.eea.europa.eu/data-and-maps/indicators/european-precipitation-2/assessment
5% is the minimum predicted increase in coastal regions in Norway, plut√¥t 20-30% √† l'int√©reur des terres

* Temperature: https://www.eea.europa.eu/data-and-maps/figures/trends-in-annual-temperature-across-1

RCP4.5 (intermediate scenario with a peak emission in 2040) = baseline scenario --> 3 to 4 degrees increase in Fennoscandia

RCP8.5 = worst case scenario: 5 to 6 degree increase in Fennoscandia

* Runoff
Increase in fennoscandia even during the dryest month(0 to 15)
https://www.eea.europa.eu/data-and-maps/indicators/river-flow-drought-3/assessment






```{r maps-fennoscandia}
uneven <- seq(1,50,2)
even <- seq(2,50,2)
map.list <- c()
for(i in 2:length(variables)){
  map <<- f_plotspatial(fennoscandia,fennoscandia[,variables[i]],plottitle = variables[i])+theme_void(base_size = 15)
  map.list[[even[i]]] <- map
}

```

```{r map-coef, fig.dim=c(10,30)}

for(i in 2:length(variables)){
  map <<- f_plotspatial(fennoscandia,gwr.fennoscandia$SDF@data[,variables[i]],plottitle = paste("coef",variables[i]))+theme_void(base_size = 15)
  map.list[[uneven[i]]] <- map
}

cowplot::plot_grid(plotlist = map.list,ncol=2)
```



