---
title: "Geographical modelling of TOC concentration"
author: "Camille M. Crapart"
date: "26 01 2022"

output: 
  bookdown::word_document2:
   toc: true
   toc_float: true
   number_sections: true
   fig_caption: true
   extra_dependencies: "subfig"
always_allow_html: true
bibliography: C:\\Users\\raine\\Documents\\UiO\\Bibtex\\Finstad.bib
csl: acs-earth-and-space-chemistry.csl
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F, error = F)
options(knitr.kable.NA="", kableExtra.auto_format = F)
```

```{r library, results = "hide"}
library(dplyr)
library(tibble)

library(DBI)
library(sf)
library(gimms)

library(ncdf4)
library(rgdal)

library(stringr)
library(png)

library(ggplot2)
library(cowplot)
library(RColorBrewer)

library(spdep)
library(spatialreg)

library(kableExtra)

library(gridExtra)
library(captioner)

source("f_plotspatial.R")

fennoscandia <- readRDS("fennoscandia.Rdata")
fennoscandia.spdf <- readRDS("fennoscandia.spdf.Rdata")
fennoscandia.33 <- readRDS("fennoscandia.33.rds")
norge <- fennoscandia %>% filter(nation == "Norway")

memory.limit(size = 100000)
fig_nums <- captioner() 
table_nums <- captioner(prefix = "Table")

compute.effect.size <- function(df.coef){

df.es <- df.coef[,1:3]
n <- length(df.es$Parameter)
m <- df.es$Parameter


for(i in 1:n){
  if(grepl("log",m[i])==T){
    df.es[i,2] <- 1.01^(df.coef[i,2])
    df.es[i,3] <- 1.01^(df.coef[i,2])*log(1.01)*df.coef[i,3]
  }else if(m[i] %in% c("NDVI","Bog","Arable","Forest")){
    df.es[i,2] <- exp(df.coef[i,2]*0.01)
    df.es[i,3] <- 0.01*df.coef[i,2]*df.coef[i,3]
  }else if(m[i] %in% c("TNdep")){
    df.es[i,2] <- exp(df.coef[i,2]*25)
    df.es[i,3] <- 25*exp(df.coef[i,2]*25)*df.coef[i,3]
  }
}

df.es$Percent <- 100*(df.es$Estimate-1)

return(df.es)

}

# other es
eslog <- 1.01
es <- 0.01
```

# Introduction 

In Nordic boreal lakes, increased flux of natural organic matter from catchments to rivers and lakes has resulted in a widespread darkening of freshwater, a phenomenon referred to as browning. This trend has been documented since the 80 @Monteith2007, when several monitoring programs were implemented to document the effect of acid deposition abatement policies. The two successive sulphur protocols of Helsinki in 1985 and in Oslo 1994 @UNECE were followed by regional synoptic surveys on water quality, one in 1986  @Henriksen1989 and one in 1995 (Northern European Lake Survey @Henriksen1998). The former covered 1 000 lakes in Norway, while the latter survey included also almost 4 000 lakes in Sweden, Finland, Denmark, as well as Scotland, Wales and Russian Kola and Karelia. A 50% decrease of acid rains was observed between the period 76-85 and the period 95-2001 @Menz2004. Since then the SO2 levels in European air has declined further by 74%, and the sulphate in dry and wet deposition decreased by 61 and 60%, respectively @Fagerli2019.  This has led to that the regional median values of sulphate in lakes have decreased by 41 and 61% in Northern and southern parts of Norway, Sweden, and Finland, respectively, between the period 2012-2016 to 1990-1994  @Garmo2020. Finstad et al. @Finstad2016 demonstrated that this reduced sulphate load has increased the solubility of dissolved organic matter (DOM), thereby increasing the concentration of organic matter in surface waters. @DeWit2007a. 

However, also other environmental factors are important in governing the brownification of the surface waters. A main pressure is climate change, with especially changing runoff patterns, expected to lead to an increased flushing of DOM to surface waters. @DeWit2016a. Longer growing seasons increase the primary production and thereby the biomass in the catchments @Finstad2016. In addition, there are land-use changes that tend towards more and more intensive forestry practices. Small-scale farming used out-field resources as grazing pastures for their husbandry @Myrstener2021. The abandonment of these practices has resulted in increased standing forest biomass. Finstad et al.5, modelling the increase of DOM concentrations in 70 Norwegian lakes over 30 years, found that the increase in terrestrial biomass (using Normalized difference vegetation index (NDVI) as its proxy) along with increasing temperature were significant drivers of freshwater DOM concentration.

Forest management is an essential tool in achieving the commitments in the Fennoscandian climate policies. @Sundnes2020 In line with the Declaration on Forest and Land Use signed on November 2021 @UNClimateChangeConferenceUK2021, the Fennoscandian governments consider forest as a leverage for offsetting their carbon emissions and reaching their zero-emission goals. @NordicCouncilofMinisters2021  With 43,5, 65,5 and 70,9% @OECD2020, respectively, of their territories covered with forest, Norway, Sweden and Finland are not subject to deforestation.  On the contrary, the boreal forest covering Fennoscandia is part of the largest organic carbon pool on Earth. According to Bradshaw et al. @Bradshaw2015, the mean value of the total organic carbon store in the boreal biome is about 1041,5 Pg, compared to 500 in the tropical forests. This carbon is mainly stored in soils, such as in peatlands. During the last centuries, a growth of boreal forests has been a net sink for CO2 . The increase in biomass is mainly because the forests benefited from a milder climate, with longer growing seasons, as well as the accumulation of reactive nitrogen from long-range transported air pollution. This enhanced growing rate partially compensated the CO2 emissions generated by deforestation in other parts of the world. @LeNoe2021. Current policies in the Nordics promote the intensification of the forest industry. In Norway, the ministry of Environment (MiljÃ¸direktoratet) subsidies densification of the planted areas and the afforestation of new so-called Climate forests   @Miljodirektoratet2013. In Sweden and Finland, where most of the forest area is productive, timber industry is a major economical resource. @RoyalSwedish2015 Forestry products account for 23% of the swedish total exports and the standing biomass doubled over the last 100 years @Narin. Formas, the Swedish government research council for sustainable development, promotes bioeconomy as a major climate mitigation tool. @Formas2012. Similarly, in Finland the national subsidy schemes aim at intensifying the forestry sector. A fifth of the Finnish export of goods come from the wood industry. @Forestry2014.  The Finnish forest legislation was renewed in the 2010s to improve its competitiveness while conserving its goals in terms of sustainability.

The planned intensification of forest management and afforestation has, on the other hand, raised concern regarding the water quality @NorskVann In Norway, 90% of the raw water used for drinking water comes from surface waters. @EnergifaktaNorge2020  . Browning has potential impact on the required raw water treatment to ensure potability of water.@Eikebrokk2018 In addition, brownification has impacts  on the local ecosystems and leads to increased greenhouse gases emissions from the lakes, especially in small lakes.@DeWit2018. 90% of the total organic matter in boreal lakes is dissolved (i.e., DOM) @Larsen2011 and has several key roles in the lake ecosystem. DOM is the main source of food and energy for heterotrophic bacteria. With darker waters, the light available for photosynthesis decreases, favouring heterotrophic bacteria above autotrophic bacteria, shifting the gas balance from a sink to a source of greenhouse gases  @Tranvik2009. In addition, the sunlight is absorbed by the coloured DOM, warming the upper layer of the lakes and causing prolonged stratification. Moreover, warm and dark water, with limited light availability, potentially disturb local species and fish production @Karlsson2009 @Craig2017. The current browning of freshwater lakes and rivers also entails the darkening of coastal waters, delaying phytoplankton spring blooms and decreasing primary production @Opdal2019a. Understanding the governing factors for DOM concentration under local anthropogenic and regional climatic stresses is therefore essential to forecast potential damages to the water quality and ecosystem services.

Larsen et al @Larsen2011a al28 developed in 2011 an empirical model for predicting the spatial variation of TOC concentrations (as a proxy for DOM) in the 1 000 Norwegian lakes of the 1995 Northern European Lake Survey. @Henriksen1998 The model was based on the lakes catchment characteristics, using catchment NDVI (Normalized Differential Vegetation Index), area fractions of bogs and area specific runoff as predictors. The current study expands on the DOM model basis by including almost 4 000 lakes and catchments from Sweden and Finland. 

To test the assumption that NDVI, %bogs and relative runoff are the main explanatory predictors for DOM additional catchment characteristics are initially included in the model. Furthermore, spatial error linear model and a geographically weighted model are used as spatial modelling tools to account for the spatial autocorrelation between the response and predictor variables. Based on the fitted model, the effect size (i.e., magnitude of effect) of a relative increase of each of the predictor variables are estimated. Finally, the fitted models are used to predict the runoff on DOM from the entire area of Fennoscandia by forecasting future average TOC concentration in the ensemble of Fenno-Scandinavian catchment water regions draining into the sea. These models allow us to test two hypotheses: 1) That climate change, with increased temperature and runoff, will increase the DOM concentration in Fennoscandian lake; and 2) That the climate forest policy is likely to exacerbate the ongoing brownification.


# Methods

## Data preparation 

The dataset comprised the `r dim(fennoscandia)[1]` lakes sampled during the Northern Lake Survey in 1995 @Henriksen1998. The TOC concentration is used as a proxy for the response variable DOM. @Henriksen1997. Eight explanatory parameters, describing each of the 4 736 catchments, were compiled as predictor variables (i.e., NDVI, proportion of forest (Forest), arable land (Arable) and peat (Bog), mean runoff intensity (Runoff), precipitation intensity (Precip) and temperature (Temp), total nitrogen (TN-dep)). These descriptors were computed as mean values of each parameter over the catchment (`r fig_nums("insert-maps", display = "c")`). The complete procedure for extraction, compilation and preparation of historic data is available in Supplementary 1. Here a short summary is presented. All logarithmic transformations use the natural logarithm.

* The total organic carbon (TOC) concentration (`r fig_nums("insert-maps", display = "c")`a) is a proxy for DOM. The data were extracted from the Northern Lake Survey dataset from 1995 , with the denomination mg C/L. As the TOC concentration values were skewed the data were log-transformed (log TOC) to normalize the distribution.

* Normalized difference vegetation index (NDVI) values (`r fig_nums("insert-maps", display = "c")`b) for the summer months (June, July and August) are used a proxy for the amount of biomass. They were downloaded from the GIMMS database and averaged  for 1994. I.e., the year preceding sampling. @TheNationalCenterforAtmosphericResearch2018. 

* Mean runoff (Runoff) values as L/m2/s (i.e., mm/s) were derived from the CORDEX model for the period 1960 to 199031 @CORDEX @Kreienkamp2012. As the runoff intensities were skewed the data were log-transformed (log Runoff) to normalize the distribution (`r fig_nums("insert-maps", display = "c")`c). 

* Mean temperature (Temp) in degrees of centigrade (ÂºC) (`r fig_nums("insert-maps", display = "c")`d) and precipitation (Precip) in mm/year for the years 1970 to 2000 in each catchment were downloaded from the WorldClim database. @WorldClim. As the precipitation distribution was not normally distributed the data were log transformed (log Precip) (`r fig_nums("insert-maps", display = "c")`e).

*	Proportions of bogs (`r fig_nums("insert-maps", display = "c")`f), forested area (`r fig_nums("insert-maps", display = "c")`g) and arable land (`r fig_nums("insert-maps", display = "c")`h) within each catchment are computed from the Corine Land Cover (CLC) database @CopernicusCLC,and correspond to the 2000 data, as land use data prior to this were not available. Several CLC categories were merged to create the three categories used in this study (see Supplementary 1). Although distributions of the different land use are not normally distributed they are not log transformed due to many zeros in the data. Other possible transformations (square, square roots) did not contribute to normalize the distribution. 

*	Total nitrogen deposition (TN-dep) data (sum of dry and wet deposition; `r fig_nums("insert-maps", display = "c")`i) were extracted from EMEP models.@EMEP. Data from 2000 were used as this were the first available data.


Future changes in climate parameters are based on predicted changes in climate drivers derived from the Coupled Model Intercomparison Project (Phase 6) (CMIP6), run by the World Climate Research Program @WRCP22 using two different socio-economic pathways: @Riahi2017 SSP1-2.6 as the best scenario, assuming the global warming will be limited to less than 2Â°C, and SSP 3-7.0 as the realistic worst-case scenario. @Hausfather2019 @CORDEX2021.Several institutions run the CMIP6 models to forecast future climate. Based on a review conducted by Raju et al., @Raju2020, the results from the model developed by the CRNM (Centre National de Recherches MÃ©tÃ©orologiques) were used to extract future runoff, temperature, and precipitation values.


## Spatial DOM models

Larsen et al. @Larsen2011 used a multiple linear regression model (LM) to predict the effect of climate change on the TOC concentration in 1 000 Norwegian lakes. In this study, including almost 4 000 lakes in Sweden and Finland, a similar LM is reproduced, confirming that biomass (measured as NDVI), %bog coverage (Bog), and log of runoff intensity (log Runoff) are the main explanatory factors for the spatial differences in DOM levels in Norway, Sweden, and Finland. The spatial autocorrelation of the response (TOC) and predictor variables (NDVI, Bog and Runoff) are then accounted for by fitting a Spatial Error Linear Model (SELM) and a Geographically Weighted Regression (GWR) model. The SELM includes the spatial autocorrelation in the error term, while the GWR model computes a model for each individual datapoint.

The LM and SELM models are fitted both on scaled and unscaled variables. The scaled estimates (i.e., slope âaâ as in the simple model $y = ax+b$) are used to compare the impact of the predictor variables on the same scale, while the unscaled estimates are used to estimate the effect sizes. The GWR model is fitted only with unscaled variables, as only the local effect sizes are assessed. The equations used to calculate the effect size for each pair response/predictor variable are explained in Supplementary 2. The GWR model computes a linear regression giving a stronger weight to the closest adjacent lakes. The considered neighbours are chosen to be the 500 nearest surrounding lakes, where weight for each lake is attributed following a gaussian distribution decline.

Future changes in DOM concentrations are forecasted using the fitted spatial error linear models based on main predictors. Future runoff scenarios of TOC are predicted based on predicted changes in future surface runoff. Future NDVI is modelled based on temperature and precipitation derived from CRNM, since no forecast exist for this index. The proportion of bogs is not expected to change, therefore no changes are made regarding their future evolution.

Polygons representing the water regions, were used to cover the whole territory of Fennoscandia, rather than only the catchments of the lakes included in the Northern Lake Survey. Water regions are the ensemble of the watercourse that drain to the sea within a coastal section.@NVE The water regions were computed from an elevation model (ref Anders). After cleaning, the dataset consisted of 1 392 polygons (see Supplementary 3).

```{r summary-of-models}
mymodels <- data.frame(Model = c("OLS (6)", "SELM (6)", "SELM (3)", "SELM (3F)", "GWR (3)", "GWR (3F)"), NSF = c("Y", "Y", "Y", "Y", "Y", "Y"), Norway = c("N", "N", "Y", "Y", "N", "N"), Estimates = c("S/U", "S/U", "S/U", "S/U", "U", "U")) 
knitr::kable(mymodels)

```


# Results

## Overview of variables {#overview}

### Mapping of predictor and response variable

Eight explanatory parameters, describing each of the `r dim(fennoscandia)[1]` catchments as predictor variables, were computed as mean values of each parameter over the catchment (`r fig_nums("insert-maps", display = "c")`) I.e., NDVI, proportion of forest (Forest), arable land (Arable) and peat (Bog), mean runoff intensity (Runoff), precipitation intensity (Precip) and temperature (Temp), total nitrogen (TN-dep).

```{r map-cat-variable, eval = F}
m <- c("TOC","NDVI","Runoff","Precip","Temp","Bog","Arable","Forest","TNdep")
u <- c("a) TOC concentration, mgC/L", "b) NDVI on scale 0 to 1", "c) Mean Runoff, mm/y","d) Mean annual precipitation,\n mm","e) Mean annual temperature,\n Â°C","f) Proportion of bogs","g) Proportion of\narable land","h) Proportion of forest","i) Total nitrogen\ndeposition, ug/m2")
couleurs <- c("YlOrRd","Greens","Blues","Blues","RdYlBu","YlOrBr","RdYlGn","YlGn","PuRd")
dir <- c(T,T,T,T,F,T,T,T,T)

for(i in m[c(1,8)]){
  
 mysf <- fennoscandia.33
 mypal <- brewer.pal(name = couleurs[which(m == i)], n = 9)
 display.brewer.pal(name = couleurs[which(m == i)], n = 9)
 midcol <- median(mysf[[i]])

 if(dir[which(m == i)] == T){
 map <- ggplot(mysf)+geom_sf(aes(fill = .data[[i]], col = .data[[i]]))+
                     scale_fill_gradient2(low = mypal[1], mid = mypal[5], high = mypal[9],
                                          midpoint = midcol,
                                          aesthetics = c("colour","fill"), 
                                          name = paste(u[grep(i,m)],"\n(",i,")",sep=""))+
    theme_minimal(base_size = 6)+
    theme(legend.position = "bottom")
    
  filename_i <- paste("map",i,"png",sep = ".")
  ggsave(plot = map, filename = filename_i, dpi = "retina", width = 6, height = 8, units = "cm")
  
 } else if(dir[which(m == i)] == F){
   map <- ggplot(mysf)+geom_sf(aes(fill = .data[[i]], col = .data[[i]]))+
                     scale_fill_gradient2(low = mypal[9], mid = mypal[5], high = mypal[1],
                                          midpoint = midcol,
                                          aesthetics = c("colour","fill"), 
                                          name = paste(u[grep(i,m)],"\n(",i,")",sep=""))+
    theme_minimal(base_size = 6)+
    theme(legend.position = "bottom")
    
  filename_i <- paste("map",i,"png",sep = ".")
  ggsave(plot = map, filename = filename_i, dpi = "retina", width = 6, height = 8, units = "cm")
   
 }
}
```

```{r insert-maps, fig.dim = c(6,9)}
knitr::include_graphics(c("map.TOC.png","map.ndvi.png","map.Runoff.png","map.Precip.png","map.temp.png","map.Bog.png","map.arable.png","map.forest.png","map.tndep.png"))
```

`r fig_nums("insert-maps", "Maps of DOM (TOC, a) and its predictor variables : Biomass (NDVI, b), mean runoff intensity (Runoff, c), temperature (Temp, d), precipitation intensity (Precip, e), peat (Bog, f), proportion of forest (Forest, c), and arable land (Arable, d), and total nitrogen deposition (TN-dep, i) in the studied catchments")`

### Correlations between predictor variables

`r table_nums("corrplot", "Correlation plot for predictor variables")`

```{r corrplot, fig.dim=c(4,4)}
m <- c("logTOC","NDVI","logRunoff","logPrecip","Temp","Bog","Arable","Forest","TNdep")
cor.mat <- cor(dplyr::select(fennoscandia,m[-1]))
corrplot::corrplot(cor.mat, method = "number",type = "lower", number.cex = 0.7, tl.cex = 0.7, cl.cex = 0.7)
```

Pearson correlation coefficients between the eight predictor variables are given in `r table_nums("corrplot", display = "c")`. All correlations are represented , regardless of their p-value. The highest Pearson correlation coefficient (r) is between TN-dep and Temp (r = `r round(cor(fennoscandia$Temp,fennoscandia$TNdep),2)`). This is due to that the N-deposition is highest in the warmer southern regions of Fennoscandia. Inherently, log Precip and log Runoff are correlated (r = `r round(cor(fennoscandia$logPrecip,fennoscandia$logRunoff),2)`). ), though runoff is expected to be a stronger predictor for DOM as it reflects more directly the potential variation in soil water flow-paths carrying DOM from soil to lakes. Log Precip and log Runoff can have both positive and negative effects on DOM concentration. In watersheds dominated by shallow soils, rock outcrop and peats (e.g., west coast of Norway), increased precipitation and runoff leads to an overall dilution of the DOM concentration in surface waters. On the other hand, in areas with till soil, the predominant water flow-path during wet periods is through the organic rich forest floor, flushing large amounts of DOM directly into the surface waters . @Vogt1990 During winter, a high amount of precipitation generates a deep snow layer that limits vegetation growth and thereby reduce the DOM production in the catchment. 

NDVI (`r fig_nums("rawndvi", display = "c")`) has as expected a strong positive correlation with % forest cover (`r fig_nums("rawclc", display = "c")`) (r = 0.58) (Table 1), although the two parameters do not provide the same information. NDVI does not distinguish between different types of vegetation, as it only reflects vegetation amount and density, which on the other hand is not accounted for in the land cover. Land cover data has a finer resolution than NDVI data. The minimum mapping unit in Corine Land Cover is 25 ha, for a minimum of 100 m linear feature, while NDVI has a much coarser resolution of 16 000 ha (8 km2). Moreover, the national mappings are based on satellite images that are interpreted in a semi-automatic manner, which results in slight deviations between countries. Finland and Sweden, for example, use two different methods to identify the forest cover.36 On the contrary, the NDVI is uniformly processed regardless of demographic regions. There are thus advantages and disadvantages regarding the use of NDVI and Forest cover. NDVI takes more into account the variations in amount of vegetation than type of vegetation, and thus more directly relevant to the production of DOM, while forest cover can be used to evaluate the impact of afforestation on the levels of DOM caused both response to climate change and forest management.

```{r rawndvi, fig.dim = c(3,5)}
knitr::include_graphics("NDVI/ndvi.fen.95.png")
```

`r fig_nums("rawndvi", "Map of average summer NDVI (June, July and August 1995) in Fennoscandia")`

```{r rawclc, fig.dim = c(8,5)}
knitr::include_graphics("Corine_Land_Cover/map-clc2.png")
```

`r fig_nums("rawclc", "Map of CORINE Land Cover (2000) in Norway, Sweden and Finland")`

### Spatial autocorrelation & VIF

Spatial autocorrelation and collinearity between the eight predictor variables in `r table_nums("corrplot", display = "c")` are evaluated using the Moranâs I index and the Variance Inflation Factor (VIF), respectively. The results are presented in `r table_nums("moran-vif-table", display = "c")`.


```{r neighbour-matrix,  eval = F}
library(spdep)
k.neigh.set <- knearneigh(fennoscandia.spdf, k = 100)
k.neigh.nb.set <- knn2nb(k.neigh.set)
k.neigh.w <- nb2listw(k.neigh.nb.set)
saveRDS(k.neigh.w,"k.neigh.w.Rdata")
```

```{r spatial-autocorrelation, eval = T}
k.neigh.w <- readRDS("k.neigh.w.Rdata")
moran.list <- c() 

m <- c("logTOC","NDVI","logRunoff","logPrecip","Temp","Bog","Arable","Forest","TNdep")

for (i in m){
  moran.list[[i]] <- moran.test(fennoscandia[,i],k.neigh.w, na.action = na.omit, alternative = "two.sided")
}

moran.df <- data.frame(m) %>% setNames("parameter")
moran.df$moran.I <- NA
moran.df$p.value <- NA

for (i in 1:length(moran.list)){
  moran.df$moran.I[i] <- moran.list[[i]]$estimate[1]
  moran.df$p.value[i] <- moran.list[[i]]$p.value
}

saveRDS(moran.df,"moran.df.Rdata")
```

```{r vif}
lm.all <- lm(data = fennoscandia, formula = as.formula(paste(m[1],"~",paste(m[-1],collapse = "+"))))
lm.vif <- car::vif(lm.all) %>% as.data.frame() %>% setNames("VIF")
```


```{r moran-vif-table}
moran.df <- readRDS("moran.df.Rdata")

moran.limit <- 1/(dim(fennoscandia)[1]-1)

moran.vif.df <- merge(moran.df,lm.vif, by.x = "parameter", by.y = 0)
moran.vif.df[,2:4] <- round(moran.vif.df[,2:4],2)

moran.vif.df[,-3] %>% 
  dplyr::mutate(
    VIF = cell_spec(VIF,color = ifelse(VIF > 3,"red", "black"), bold = ifelse(VIF > 5, T, F)),
    moran.I = cell_spec(moran.I,bold = ifelse(moran.I > moran.limit, T, F),color = ifelse(moran.I > 0.8, "red","black"))) %>%
  knitr::kable(digits = 2, 
    caption = table_nums("moran-vif-table",paste("Moran's I AND Variance Inflation Factor (VIF) of predictor and predictor variable (Moran's I limit = ", format(moran.limit,scientific = T, digits = 2),")",sep = "")),
    label = NA,
    escape = F,
    col.names = c("Predictor","Moran's I","VIF")) %>%    
  kable_styling(bootstrap_options = "bordered", position = "center")
        
```

The most spatial auto-correlated variables according to Moranâs I test (temperature, log of precipitation, and total N deposition) have also the highest VIF (`r table_nums("moran-vif-table", display = "c")`). Temperature has a VIF above 5 (VIF = `r round(lm.vif["Temp",],2)`) and was strongly correlated to TN-deposition (`r table_nums("corrplot", display = "c")`), as well as with NDVI and Forest. The high VIF value (VIF = `r round(lm.vif["logPrecip",],2)`) of log of precipitation is mainly due to its inherent strong correlation with log of runoff intensity. TN-deposition was not strongly correlated with the other explanatory variables, so it was included in the model although it has a high VIF value. However, temperature and log of precipitation were excluded.  



## Comparison of linear model and spatial error model 

Using the six selected predictor variables in [section 3.1]{#overview} A linear model (LM) and a Spatial Error Model (SELM) were fitted for the logTOC against the selected predictor variables. The Spatial Error Model takes into account the spatial autocorrelation of the predictor variables in the error term of the regression. To compare the two models, the Akaike Information Criterion was calculated.

Both models were fitted with and without scaled variables. The effect size calculated using the raw (non-scaled) coefficients according to the method explained in Supplementary 2. A comparison of the regression coefficients and effect size for each predictor variables is shown on `r fig_nums("compare-plots-1", display = "c")`. 

```{r lm-fennoscandia, results = T}
k.neigh.w <- readRDS("k.neigh.w.Rdata")

fm.s <- s.logTOC~s.NDVI+s.logRunoff+s.Bog+s.Arable+s.Forest+s.TNdep
s.lm.fennoscandia <- lm(fm.s, data = fennoscandia, na.action = na.exclude)
saveRDS(s.lm.fennoscandia,"s.lm.fennoscandia.rds")

fm <- logTOC~NDVI+logRunoff+Bog+Arable+Forest+TNdep
lm.fennoscandia <- lm(fm, data = fennoscandia, na.action = na.exclude)
saveRDS(lm.fennoscandia,"lm.fennoscandia.rds")

s.lm.r2 <- summary(s.lm.fennoscandia)$adj.r.squared
s.moran.I.res.lm <- lm.morantest(s.lm.fennoscandia, k.neigh.w, alternative = "two.sided")

lm.r2 <- summary(lm.fennoscandia)$adj.r.squared
moran.I.res.lm <- lm.morantest(lm.fennoscandia, k.neigh.w, alternative = "two.sided")

moran.limit.fennoscandia <- 1/(dim(fennoscandia)[1]-1)

s.lm.coef <- summary(s.lm.fennoscandia)$coefficients %>% as.data.frame()
s.lm.coef <- s.lm.coef[-1,] %>% rownames_to_column(var = "Parameter")

lm.coef <- summary(lm.fennoscandia)$coefficients %>% as.data.frame()
lm.coef <- lm.coef[-1,] %>% rownames_to_column(var = "Parameter")

lm.effectsize <- compute.effect.size(lm.coef)

```

```{r arm-sim-test-lm}
sm.fennoscandia <- arm::sim(lm.fennoscandia,n.sims = 100)

sm.coef <- sm.fennoscandia@coef[,-1]
sm.effectsize <- data.frame(parameter = colnames(sm.coef), effect.size = NA, std.error = NA)

n <- dim(sm.coef)[2]
m <- colnames(sm.coef)

for(i in 1:n){
  if(grepl("log",m[i])==T){
    sm.effectsize[i,2] <- mean(1.1^(sm.coef[,i]))
    sm.effectsize[i,3] <- sd(1.1^(sm.coef[,i])*log(1.1)*sm.coef[,i])
  }else if(m[i] %in% c("NDVI","Bog","Arable","Forest")){
    sm.effectsize[i,2] <- mean(exp(sm.coef[,i]*0.1))
    sm.effectsize[i,3] <- sd(0.1*exp(sm.coef[,i]*0.1)*sm.coef[,i])
  }else if(m[i] %in% c("TNdep")){
    sm.effectsize[i,2] <- mean(exp(sm.coef[,i]*250))
    sm.effectsize[i,3] <- sd(250*exp(sm.coef[,i]*250)*sm.coef[,i])
  }
}

```

```{r summary-table-lm}
summary.table.lm <- cbind(dplyr::select(lm.coef,Parameter),s.lm.coef[,2:3],lm.coef[,2:3],lm.effectsize[,2:4],sm.effectsize[,2:3]) %>%
                rbind(c("AIC",AIC(s.lm.fennoscandia),"",AIC(lm.fennoscandia),"","","","","","")) %>%
                rbind(c("R2",s.lm.r2,"",lm.r2,"","","","","","")) %>%
                rbind(c("Moran'I res",s.moran.I.res.lm$estimate[[1]],"",moran.I.res.lm$estimate[[1]],"","","","","",""))
summary.table.lm[,-1] <- apply(summary.table.lm[,-1],2,as.numeric)

saveRDS(summary.table.lm, "summary.table.lm.rds")

```

```{r sem, eval = F}
k.neigh.w <- readRDS("k.neigh.w.Rdata")

#lagrange <- lm.LMtests(lm.fennoscandia,k.neigh.w,test = c("LMerr","LMlag","RLMerr","RLMlag"))

fm.s <- s.logTOC~s.NDVI+s.logRunoff+s.Bog+s.Arable+s.Forest+s.TNdep
s.sem.fennoscandia <- errorsarlm(fm.s,fennoscandia,k.neigh.w)
saveRDS(s.sem.fennoscandia,"s.sem.fennoscandia.Rdata")

fm <- logTOC~NDVI+logRunoff+Bog+Arable+Forest+TNdep
sem.fennoscandia <- errorsarlm(fm,fennoscandia,k.neigh.w)
saveRDS(sem.fennoscandia,"sem.fennoscandia.Rdata")
```

```{r sem-results}
s.sem.fennoscandia <- readRDS("s.sem.fennoscandia.Rdata")
sem.fennoscandia <- readRDS("sem.fennoscandia.Rdata")
k.neigh.w <- readRDS("k.neigh.w.Rdata")


s.sem.coef <- s.sem.fennoscandia$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
s.sem.coef <- s.sem.coef %>% rownames_to_column(var = "Parameter")
s.sem.coef$std.error <- s.sem.fennoscandia$rest.se[-1]

sem.coef <- sem.fennoscandia$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef <- sem.coef %>% rownames_to_column(var = "Parameter")
sem.coef$std.error <- sem.fennoscandia$rest.se[-1]

sem.effectsize <- compute.effect.size(sem.coef)

# sem.effectsize <- sem.coef[,1:3]
# 
# n <- length(sem.coef$Parameter)
# m <- sem.coef$Parameter
# 
# for(i in 1:n){
#   if(grepl("log",m[i])==T){
#     sem.effectsize[i,2] <- 1.1^(sem.coef[i,2])
#     sem.effectsize[i,3] <- 1.1^(sem.coef[i,2])*log(1.1)*sem.coef[i,3]
#   }else if(m[i] %in% c("NDVI","Bog","Arable","Forest")){
#     sem.effectsize[i,2] <- exp(sem.coef[i,2]*0.1)
#     sem.effectsize[i,3] <- 0.1*exp(sem.coef[i,2]*0.1)*sem.coef[i,3]
#   }else if (m[i] %in% c("slope","Temp")){
#     sem.effectsize[i,2] <- exp(sem.coef[i,2]*1)
#     sem.effectsize[i,3] <- 1*exp(sem.coef[i,2]*1)*sem.coef[i,3]
#   }else if(m[i] %in% c("TNdep")){
#     sem.effectsize[i,2] <- exp(sem.coef[i,2]*250)
#     sem.effectsize[i,3] <- 250*exp(sem.coef[i,2]*250)*sem.coef[i,3]
#   }
# }
# 
# sem.effectsize$Percent <- 100*(sem.effectsize$Estimate-1)

s.sem.AIC <- 2*(n-1)-2*s.sem.fennoscandia$LL
sem.AIC <- 2*(n-1)-2*sem.fennoscandia$LL

s.moran.I.res.sem <- moran.test(s.sem.fennoscandia$residuals, k.neigh.w, alternative = "two.sided")

moran.I.res.sem <- moran.test(sem.fennoscandia$residuals, k.neigh.w, alternative = "two.sided")

summary.table.sem <- cbind(dplyr::select(sem.coef,Parameter),s.sem.coef[,2:3],sem.coef[,2:3],sem.effectsize[,2:4]) %>%
                rbind(c("AIC",s.sem.AIC,"",sem.AIC,"","","","")) %>%
                rbind(c("Moran'I res", s.moran.I.res.sem$estimate[[1]],"", moran.I.res.sem$estimate[[1]], "","","",""))
summary.table.sem[,-1] <- apply(summary.table.sem[,-1],2,as.numeric)

saveRDS(summary.table.sem, "summary.table.sem.rds")
```

```{r compare-estimates}
n <- c(names(s.sem.coef),"model")
m <- cbind.data.frame(s.lm.coef[,1:3],model = "LM") %>% setNames(n)
o <- cbind.data.frame(s.sem.coef,model = "SELM")
  
scaled.df <- rbind(m,o)
scaled.df$Parameter <- factor(scaled.df$Parameter, levels = c("s.TNdep","s.Forest","s.Arable","s.Bog","s.logRunoff","s.NDVI"))

scaled.plot <- ggplot(scaled.df, aes(group = model))+geom_col(aes(x=Estimate,y=Parameter, fill = model, col = model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Estimate-std.error,xmax=Estimate+std.error), position = "dodge", width = 0.5)+
  labs(x = "Scaled Estimate", y = "predictor variable", subtitle = paste("LM: AIC =",round(AIC(s.lm.fennoscandia),2),"; Moran's I = ",round(s.moran.I.res.lm$estimate[[1]],2),"\nSELM: AIC =",round(s.sem.AIC,2),"; Moran's I =",round(s.moran.I.res.sem$estimate[[1]],2)))+
  theme_bw()+theme(legend.position = "bottom")

```

```{r compare-effect-size}

n <- c(names(sem.effectsize),"model")
m <- cbind.data.frame(lm.effectsize,model = "LM") %>% setNames(n)
o <- cbind.data.frame(sem.effectsize,model = "SELM")
  
h.df <- rbind(m,o)
h.df$Parameter <- factor(h.df$Parameter, levels = c("TNdep","Forest","Arable","Bog","logRunoff","NDVI"))

effectsize.plot <- ggplot(h.df, aes(group = model))+
  geom_col(aes(x=Percent,y=Parameter, fill = model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Percent-(100*std.error),xmax=Percent+(100*std.error)), position = "dodge", width = 0.5)+
  labs(x = "Effect size in %", y = "", subtitle = paste("LM: AIC =",round(AIC(lm.fennoscandia),2),"; Moran's I = ",round(moran.I.res.lm$estimate[[1]],2),"\nSELM: AIC =",round(sem.AIC,2),"; Moran's I =",round(moran.I.res.sem$estimate[[1]],2)))+
  theme_bw()+theme(legend.position = "bottom")

```

```{r compare-plots-1, fig.dim = c(10,5)}
cowplot::plot_grid(plotlist = list(scaled.plot,effectsize.plot),ncol=2)
```

`r fig_nums(name = "compare-plots-1",caption = "Comparison of scaled estimate (left) and effect sizes for a 10% increase in the predictor variables (right) using LM and SELM models, based on the Fennoscandian dataset", display = "f")`

The effect sizes are expressed as % change in TOC concentration caused by a 10% increase in NDVI (0.1 on the NDVI index), runoff, bog and forest coverage and arable land (proportion increase of 0.1), and a 250 ug/m2  increase of nitrogen deposition (10% of the range of TNdep), respectively. These relative changes are arbitrarily chosen to represent the impact of each predictor variable on a comparable basis.

The scaled and effect size estimates are positive for an increase in NDVI, , Forest, Arable land and TN-dep, while the response is negative for an increase in log Runoff (`r fig_nums("compare-plots-1", display = "c")`). The SELM, having lower AIC (relative model fit) and Moranâs I (spatial autocorrelation) of the residuals , performs better than the LM, both with scaled and with unscaled variables. The estimates values by the two models are similar, though the LM tends to give higher values than the SELM. 

NDVI and log Runoff have the highest scaled response estimates (`r fig_nums("compare-plots-1", display = "c")`), with a significant difference between the LM and SELM. For these two parameters, the spatial lagged SELM provides lower response estimates, suggesting that using a LM over a varied region may over-estimate the impact of these parameters. Log Runoff has high scaled estimates but the effect size is low compared to the other parameters (`r round(s.lm.coef[which(s.lm.coef$Parameter == "s.logRunoff"), which(names(s.lm.coef) == "Estimate")],2)` for LM and `r round(s.sem.coef[which(s.sem.coef$Parameter == "s.logRunoff"), which(names(s.sem.coef) == "Estimate")],2)` for SELM).

Proportion of , Forest, and TN-dep have similar scaled estimate between 0,15 and 0,21, though their effect size differ significantly (`r fig_nums("compare-plots-1", display = "c")`). An 10% increase in the proportion of bog coverage would have a major impact, though this is  an unrealistic change, except in the case of local peat restoration project. A more realistic 10% increase in forest cover  will have a relative more limited though still clearly significant impact on the TOC: `r round(lm.effectsize[which(lm.effectsize$Parameter == "Forest"), which(names(lm.effectsize) == "Percent")],2)`% by LM and `r round(sem.effectsize[which(sem.effectsize$Parameter == "Forest"), which(names(sem.effectsize) == "Percent")],2)`% for SELM. TN-dep has the lowest effect size with about a `r round(sem.effectsize[which(sem.effectsize$Parameter == "TNdep"), which(names(sem.effectsize) == "Percent")],2)` % increase in TOC due to a 250 ug/m2 increase in reactive N loading. Although the annual Total N-deposition from long-range transported air pollution slowly decreases, the amount of reactive N continues to accumulate in these boral watersheds. Moreover, the use of Nitrogen fertilizers to increase forest production will serve to sustain  high N-saturation levels. 

A 10% increase in the proportion of arable land has a low scaled estimate (`r round(s.lm.coef[which(s.lm.coef$Parameter == "Arable"), which(names(s.lm.coef) == "Percent")],2)`) by LM and `r round(sem.effectsize[which(sem.coef$Parameter == "Arable"), which(names(sem.coef) == "Percent")],2)` for SELM. The effect size is however comparable to the effect of a 10% increase of forest for the LM model (`r round(lm.effectsize[which(lm.effectsize$Parameter == "Arable"), which(names(lm.effectsize) == "Percent")],2)` %) , albeit it remains lower for the SELM model (`r round(sem.effectsize[which(sem.effectsize$Parameter == "Arable"), which(names(sem.effectsize) == "Percent")],2)` %). The unscaled estimates for Forest and Arable are similar, while the scaled estimate of Arable is ten times smaller than the scaled estimate for Forest, the standard deviation of the proportion of arable land being much bigger. 



## Spatial error models with selected predictors

### Spatial error model on Norwegian and Fennoscandian datasets {#sem-simple}

Larsen et al. @Larsen2011a modelled TOC concentration based on NDVI, Runoff and proportion of bogs using the norwegian lakes from the Northern Lake Survey. The previous comparison between LM and SELM model fitted with 6 prefictors confirmed that these 3 parameters have the largest effect sizes. Therefore, we fitted a LM and a SELM model for the Norwegian dataset and for the Fennoscandian dataset based on these three parameters. 

To compare the results of this study to the results of , we fitted two models using only three predictors: NDVI, proportion of bogs and runoff. LM and SELM models were fitted for the entire dataset as well as for the Norwegian subset. The scaled estimates and the effect size were calculated similarly to the previous section.

Once again, the effect size is expressed as % change of TOC concentration for a 10% increase in NDVI, Runoff and Bog coverage. These relative changes are arbitrarily chosen to represent the impact of each predictor variable on a comparable basis.

```{r kmat, eval = F}
norge.spdf <- SpatialPointsDataFrame(norge[,c("longitude","latitude")],norge)

norge.kmat <- norge.spdf %>% knearneigh(k=50) %>% knn2nb %>% nb2listw
saveRDS(norge.kmat,"norge.kmat.Rdata")
```

```{r sem-simple-norway, eval = F}
norge.kmat <- readRDS("norge.kmat.Rdata")

s.fm <- s.logTOC~s.NDVI+s.logRunoff+s.Bog
s.sem.norge.simple <- errorsarlm(s.fm,norge,norge.kmat)
saveRDS(s.sem.norge.simple,"s.sem.norge.simple.Rdata")

fm <- logTOC~NDVI+logRunoff+Bog
sem.norge.simple <- errorsarlm(fm,norge,norge.kmat)
saveRDS(sem.norge.simple,"sem.norge.simple.Rdata")

```

```{r sem-simple-results-norway}
s.sem.norge.simple <- readRDS("s.sem.norge.simple.Rdata")
sem.norge.simple <- readRDS("sem.norge.simple.Rdata")
norge.kmat <- readRDS("norge.kmat.Rdata")


s.sem.coef.norge <- s.sem.norge.simple$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
s.sem.coef.norge <- s.sem.coef.norge %>% rownames_to_column(var = "Parameter")
s.sem.coef.norge$std.error <- s.sem.norge.simple$rest.se[-1]

sem.coef.norge <- sem.norge.simple$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef.norge <- sem.coef.norge %>% rownames_to_column(var = "Parameter")
sem.coef.norge$std.error <- sem.norge.simple$rest.se[-1]

sem.effectsize.norge <- compute.effect.size(sem.coef.norge)

# sem.effectsize.norge <- sem.coef.norge[,1:3]
# 
# n <- length(sem.coef.norge$Parameter)
# m <- sem.coef.norge$Parameter
# 
# for(i in 1:n){
#   if(grepl("log",m[i])==T){
#     sem.effectsize.norge[i,2] <- 1.1^(sem.coef.norge[i,2])
#     sem.effectsize.norge[i,3] <- 1.1^(sem.coef.norge[i,2])*log(1.1)*sem.coef.norge[i,3]
#   }else if(m[i] %in% c("NDVI","Bog","Arable")){
#     sem.effectsize.norge[i,2] <- exp(sem.coef.norge[i,2]*0.1)
#     sem.effectsize.norge[i,3] <- 0.1*exp(sem.coef.norge[i,2]*0.1)*sem.coef.norge[i,3]
#   }else if(m[i] %in% c("Temp","TNdep")){
#     sem.effectsize.norge[i,2] <- exp(sem.coef.norge[i,2]*1)
#     sem.effectsize.norge[i,3] <- 1*exp(sem.coef.norge[i,2]*1)*sem.coef.norge[i,3]
#   }
# }
# 
# sem.effectsize.norge$Percent <- 100*(sem.effectsize.norge$Estimate-1)

s.sem.AIC.norge <- 2*(n-1)-2*s.sem.norge.simple$LL
s.moran.I.res.sem.norge <- moran.test(s.sem.norge.simple$residuals, norge.kmat, alternative = "two.sided")

sem.AIC.norge <- 2*(n-1)-2*sem.norge.simple$LL
moran.I.res.sem.norge <- moran.test(sem.norge.simple$residuals, norge.kmat, alternative = "two.sided")

summary.table.sem.norge <- cbind(dplyr::select(sem.coef.norge,Parameter),s.sem.coef.norge[,2:3],sem.coef.norge[,2:3],sem.effectsize.norge[,2:4]) %>%
                rbind(c("AIC",s.sem.AIC,"",sem.AIC,"","","","")) %>%
                rbind(c("Moran'I res", s.moran.I.res.sem.norge$estimate[[1]],"",moran.I.res.sem.norge$estimate[[1]], "","","",""))
summary.table.sem.norge[,-1] <- apply(summary.table.sem.norge[,-1],2,as.numeric)

saveRDS(summary.table.sem.norge, "summary.table.sem.norge.rds")
```

```{r sem-simple-fennosandia, eval = F}
k.neigh.w <- readRDS("k.neigh.w.Rdata")

s.fm <- s.logTOC~s.NDVI+s.logRunoff+s.Bog
s.sem.fen.simple <- errorsarlm(s.fm,fennoscandia,k.neigh.w)
saveRDS(s.sem.fen.simple,"s.sem.fen.simple.Rdata")

fm <- logTOC~NDVI+logRunoff+Bog
sem.fen.simple <- errorsarlm(fm,fennoscandia,k.neigh.w)
saveRDS(sem.fen.simple,"sem.fen.simple.Rdata")

```

```{r sem-simple-results}
s.sem.fen.simple <- readRDS("s.sem.fen.simple.Rdata")
sem.fen.simple <- readRDS("sem.fen.simple.Rdata")
k.neigh.w <- readRDS("k.neigh.w.Rdata")

s.sem.coef.simple <- s.sem.fen.simple$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
s.sem.coef.simple <- s.sem.coef.simple %>% rownames_to_column(var = "Parameter")
s.sem.coef.simple$std.error <- s.sem.fen.simple$rest.se[-1]

sem.coef.simple <- sem.fen.simple$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef.simple <- sem.coef.simple %>% rownames_to_column(var = "Parameter")
sem.coef.simple$std.error <- sem.fen.simple$rest.se[-1]

sem.effectsize.fen <- compute.effect.size(sem.coef.simple)

# sem.effectsize.fen <- sem.coef.simple[,1:3]
# 
# n <- length(sem.coef.simple$Parameter)
# m <- sem.coef.simple$Parameter
# 
# for(i in 1:n){
#   if(grepl("log",m[i])==T){
#     sem.effectsize.fen[i,2] <- 1.1^(sem.coef.simple[i,2])
#     sem.effectsize.fen[i,3] <- 1.1^(sem.coef.simple[i,2])*log(1.1)*sem.coef.simple[i,3]
#   }else if(m[i] %in% c("NDVI","Bog","Forest")){
#     sem.effectsize.fen[i,2] <- exp(sem.coef.simple[i,2]*0.1)
#     sem.effectsize.fen[i,3] <- 0.1*exp(sem.coef.simple[i,2]*0.1)*sem.coef.simple[i,3]
#   }
# }
# 
# sem.effectsize.fen$Percent <- 100*(sem.effectsize.fen$Estimate-1)

s.sem.AIC <- 2*(n-1)-2*s.sem.fen.simple$LL
s.moran.I.res.sem <- moran.test(s.sem.fen.simple$residuals, k.neigh.w, alternative = "two.sided")

sem.AIC <- 2*(n-1)-2*sem.fen.simple$LL
moran.I.res.sem <- moran.test(sem.fen.simple$residuals, k.neigh.w, alternative = "two.sided")

summary.table.simple.sem <- cbind(dplyr::select(sem.coef,Parameter),s.sem.coef[,2:3],sem.coef[,2:3],sem.effectsize.fen[,2:4]) %>%
                rbind(c("AIC",s.sem.AIC,"",sem.AIC,"","","","")) %>%
                rbind(c("Moran'I res", s.moran.I.res.sem$estimate[[1]],"",moran.I.res.sem$estimate[[1]], "","","",""))
summary.table.simple.sem[,-1] <- apply(summary.table.simple.sem[,-1],2,as.numeric)

saveRDS(summary.table.simple.sem, "summary.table.simple.sem.rds")
```

```{r compare-estimates-simple}
n <- c(names(s.sem.coef),"model")
m <- cbind.data.frame(s.sem.coef.norge, model = "Norway")
o <- cbind.data.frame(s.sem.coef,model = "Fennoscandia")
  
scaled.df <- rbind(m,o)

scaled.plot <- ggplot(scaled.df, aes(group = model))+geom_col(aes(x=Estimate,y=Parameter, fill = model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Estimate-std.error,xmax=Estimate+std.error), position = "dodge", width = 0.5)+
  labs(x = "Scaled estimates",y = "predictor variables", subtitle = paste("Fennoscandia: AIC =",round(s.sem.AIC,2),"; Moran's I = ",round(s.moran.I.res.sem$estimate[[1]],2),"\nNorway: AIC =",round(s.sem.AIC.norge,2),"; Moran's I =",round(s.moran.I.res.sem.norge$estimate[[1]],2)))+
  theme_bw()+
  theme(legend.position = "bottom")

```

```{r compare-effect-size-simple}

n <- c(names(sem.effectsize.fen),"model")
m <- cbind.data.frame(sem.effectsize.norge,model = "Norway")
o <- cbind.data.frame(sem.effectsize.fen,model = "Fennoscandia")
  
h.df <- rbind(m,o)

effectsize.plot <- ggplot(h.df, aes(group = model))+
  geom_col(aes(x=Percent,y=Parameter, fill = model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Percent-(100*std.error),xmax=Percent+(100*std.error)), position = "dodge", width = 0.5)+
  labs(x = "Effect size in %", y = "", subtitle = paste("Fennoscandia: AIC =",round(sem.AIC,2),"; Moran's I = ",round(moran.I.res.sem$estimate[[1]],2),"\nNorway: AIC =",round(sem.AIC.norge,2),"; Moran's I =",round(moran.I.res.sem.norge$estimate[[1]],2)))+
  theme_bw()+theme(legend.position = "bottom")
```

```{r compare-plots-2, fig.dim = c(10,5)}
cowplot::plot_grid(plotlist = list(scaled.plot,effectsize.plot),ncol=2)
```

`r fig_nums(name = "compare-plots-2", caption = "Comparison of scaled estimates and effect sizes from the limited SELM  model based on the Norwegian (green) and Fennoscandian (orange) datasets.")`

In the  SELM model, based on the Fennoscandian dataset with only three predictor variables, the NDVI effect size (`r fig_nums("compare-plots-2",display = "c")`) is inherently higher than in the model including six variables (`r fig_nums("compare-plots-1",display = "c")`).  Including Forest and Arable land coverage and TN-deposition, the NDVI in the full SELM model predicted an `r round(sem.effectsize[which(sem.effectsize$Parameter == "NDVI"), which(names(sem.effectsize) == "Percent")],2)`% increase in TOC (`r fig_nums("compare-plots-1",display = "c")`), while using only the NDVI, log Runoff and Bog coverage in the 3-variable model, the NDVI predicts a `r round(sem.effectsize.fen[which(sem.effectsize.fen$Parameter == "NDVI"), which(names(sem.effectsize.fen) == "Percent")],2)`% increase in TOC (`r fig_nums("compare-plots-2",display = "c")`). The effect size of a relative increase in log Runoff is slightly more negative in the 3-variable model (`r fig_nums("compare-plots-2",display = "c")`) compared to the full model (`r fig_nums("compare-plots-1",display = "c")`) (i.e., `r round(sem.effectsize.fen[which(sem.effectsize.fen$Parameter == "logRunoff"), which(names(sem.effectsize.fen) == "Percent")],2)`% and `r round(sem.effectsize[which(sem.effectsize$Parameter == "logRunoff"), which(names(sem.effectsize) == "Percent")],2)` %), while  the effect of an increase in the proportion of  bogs was lower in the 3-variable model (`r fig_nums("compare-plots-2",display = "c")`) compared to the full model (`r fig_nums("compare-plots-1",display = "c")`) (i.e., `r round(sem.effectsize.fen[which(sem.effectsize.fen$Parameter == "logRunoff"), which(names(sem.effectsize.fen) == "Percent")],2)`% and `r round(sem.effectsize[which(sem.effectsize$Parameter == "logRunoff"), which(names(sem.effectsize) == "Percent")],2)`% and `r round(sem.effectsize.fen[which(sem.effectsize.fen$Parameter == "Bog"), which(names(sem.effectsize.fen) == "Percent")],2)`% and `r round(sem.effectsize[which(sem.effectsize$Parameter == "Bog"), which(names(sem.effectsize) == "Percent")],2)`%). Overall, as expected this indicates that disregarding the role of Forest, Arable and TN-deposition leads to a possible overestimation of the effect of NDVI and logRunoff, and underestimation of the effect of bog coverage.  

Likewise, the scaled estimates and effect sizes of the 3-variable SELM model are slightly higher when based on the Norwegian data compared to the Fennoscandian dataset (`r fig_nums("compare-plots-2",display = "c")`). Nevertheless, NDVI remains the sovereign predictor with the highest scaled estimate and the strongest effect size. That the model using only the Norwegian data is stronger than the Fennoscandian is likely be due to that the full span in the variables are included in the Norwegian dataset with less samples, thereby generating less noise.

### Spatial error model with forest as predictor instead of NDVI {#forest}

```{r sem-with-forest, eval = F}
k.neigh.w <- readRDS("k.neigh.w.Rdata")
norge.kmat <- readRDS("norge.kmat.Rdata")

fm <- logTOC ~ Forest+logRunoff+Bog

sem.forest.fen <- errorsarlm(fm, data = fennoscandia,k.neigh.w)

sem.forest.norge <- errorsarlm(fm, data = norge, norge.kmat)

saveRDS(sem.forest.fen, "sem.forest.fen.Rdata")
saveRDS(sem.forest.norge, "sem.forest.norge.Rdata")

```

```{r sem-forest-results}

sem.forest.fen <- readRDS("sem.forest.fen.Rdata")
sem.forest.norge <- readRDS("sem.forest.norge.Rdata")

# fennoscandia
sem.coef <- sem.forest.fen$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef <- sem.coef %>% rownames_to_column(var = "Parameter")
sem.coef$std.error <- sem.forest.fen$rest.se[-1]

sem.effectsize.forest <- compute.effect.size(sem.coef)

# sem.effectsize.forest <- sem.coef[,1:3]
# 
# n <- length(sem.coef$Parameter)
# m <- sem.coef$Parameter
# 
# for(i in 1:n){
#   if(grepl("log",m[i])==T){
#     sem.effectsize.forest[i,2] <- 1.1^(sem.coef[i,2])
#     sem.effectsize.forest[i,3] <- 1.1^(sem.coef[i,2])*log(1.1)*sem.coef[i,3]
#   }else if(m[i] %in% c("Forest","Bog")){
#     sem.effectsize.forest[i,2] <- exp(sem.coef[i,2]*0.1)
#     sem.effectsize.forest[i,3] <- 0.1*exp(sem.coef[i,2]*0.1)*sem.coef[i,3]
#   }
# }
# 
# sem.effectsize.forest$Percent <- 100*(sem.effectsize.forest$Estimate-1)

sem.AIC <- 2*(n-1)-2*sem.forest.fen$LL
moran.I.res.sem <- moran.test(sem.forest.fen$residuals, k.neigh.w, alternative = "two.sided")

summary.table.sem.forest <- cbind(dplyr::select(sem.coef,Parameter),sem.coef[,2:3],sem.effectsize.forest[,2:4]) %>%
                rbind(c("AIC",sem.AIC,"","","","")) %>%
                rbind(c("Moran'I res", moran.I.res.sem$estimate[[1]], "","","",""))
summary.table.sem.forest[,-1] <- apply(summary.table.sem.forest[,-1],2,as.numeric)
``` 

```{r sem-forest-norge}
# norge
sem.coef.norge <- sem.forest.norge$coefficients[-1] %>% as.data.frame() %>% 
              setNames("Estimate")
sem.coef.norge <- sem.coef.norge %>% rownames_to_column(var = "Parameter")
sem.coef.norge$std.error <- sem.forest.norge$rest.se[-1]

sem.effectsize.forest.norge <- compute.effect.size(sem.coef.norge)

# sem.effectsize.forest.norge <- sem.coef.norge[,1:3]
# 
# n <- length(sem.coef.norge$Parameter)
# m <- sem.coef.norge$Parameter
# 
# for(i in 1:n){
#   if(grepl("log",m[i])==T){
#     sem.effectsize.forest.norge[i,2] <- 1.1^(sem.coef.norge[i,2])
#     sem.effectsize.forest.norge[i,3] <- 1.1^(sem.coef[i,2])*log(1.1)*sem.coef.norge[i,3]
#   }else if(m[i] %in% c("Forest","Bog")){
#     sem.effectsize.forest.norge[i,2] <- exp(sem.coef.norge[i,2]*0.1)
#     sem.effectsize.forest.norge[i,3] <- 0.1*exp(sem.coef.norge[i,2]*0.1)*sem.coef.norge[i,3]
#   }
# }
# 
# sem.effectsize.forest.norge$Percent <- 100*(sem.effectsize.forest.norge$Estimate-1)


sem.AIC.norge <- 2*(n-1)-2*sem.forest.norge$LL
moran.I.res.sem.norge <- moran.test(sem.forest.norge$residuals, norge.kmat, alternative = "two.sided")

summary.table.sem.forest.norge <- cbind(dplyr::select(sem.coef.norge,Parameter),sem.coef.norge[,2:3],sem.effectsize.forest.norge[,2:4]) %>%
                rbind(c("AIC",sem.AIC.norge,"","","","")) %>%
                rbind(c("Moran'I res", moran.I.res.sem.norge$estimate[[1]], "","","",""))
summary.table.sem.forest.norge[,-1] <- apply(summary.table.sem.forest.norge[,-1],2,as.numeric)

```

```{r compare-effect-size-simple-forest}

n <- c(names(sem.effectsize.forest),"model")
m <- cbind.data.frame(sem.effectsize.forest,model = "Fennoscandia") %>% setNames(n)
o <- cbind.data.frame(sem.effectsize.forest.norge,model = "Norway")
  
h.df <- rbind(m,o)

effectsize.plot <- ggplot(h.df, aes(group = model))+
  geom_col(aes(x=Percent,y=Parameter, fill = model), position = "dodge", width = 0.5)+
  geom_errorbar(aes(y=Parameter,xmin = Percent-(100*std.error),xmax=Percent+(100*std.error)), position = "dodge", width = 0.5)+
  labs(x = "Effect size in %", y = "", subtitle = paste("Fennoscandia: AIC =",round(sem.AIC,2),"; Moran's I = ",round(moran.I.res.sem$estimate[[1]],2),"\nNorway: AIC =",round(sem.AIC.norge,2),"; Moran's I =",round(moran.I.res.sem.norge$estimate[[1]],2)))+
  theme_bw()+theme(legend.position = "bottom")
print(effectsize.plot)
```

`r fig_nums("compare-effect-size-simple-forest", "Effect size for SELM model with forest as predictor instead of NDVI")`

Replacing NDVI as explanatory variable in the SELM models with Forest cover renders a rather small effect size of a 10% increase in Forest cover (`r fig_nums("compare-effect-size-simple-forest", display = "c")`) compared to a 10% increase in NDVI (`r fig_nums("compare-plots-2", display = "c")`).  

On the contrary, considering Forest cover instead of NDVI yields greater impact to the proportion of bogs: 15% (`r fig_nums("compare-effect-size-simple-forest", display = "c")`) compared to 10% (`r fig_nums("compare-plots-2", display = "c")`) for Fennoscandian dataset, and even more for the model based on the Norwegian dataset. The effect size of a 10% increase in runoff remains unchanged at `r round(sem.effectsize.forest[which(sem.effectsize.forest$Parameter == "logRunoff"), which(names(sem.effectsize.forest) == "Percent")],0)`% and `r round(sem.effectsize.forest.norge[which(sem.effectsize.forest.norge$Parameter == "logRunoff"), which(names(sem.effectsize.forest.norge) == "Percent")],0)`%%, based on the Fennoscandian dataset and Norwegian dataset, respectively.


## Geographically Weighted Regression

A geographically weighted regression (GWR) model was fitted using the Fennoscandian dataset. The objective was to examine regional differences in relationships between response and predictor variables. It was hypothesized that the main explanatory factor for the DOM levels in surface waters differs between regions due to differences in the spatial ranges of the predictors. The local regression coefficients (slope, a) are shown on  `r fig_nums("gwr-results",display = "c")`. The map of measured logTOC concentration is also presented for reference.

### GWR with NDVI as predictor variable

```{r GWR-fennoscandia, eval = F}
fm <- logTOC~NDVI+logRunoff+Bog

library(GWmodel)
#bw.fennoscandia <- bw.gwr(fm, data = fennoscandia.spdf, kernel = "gaussian", adaptive = T)
gwr.fennoscandia <- gwr.basic(fm, data = fennoscandia.spdf, bw = 500, kernel = "gaussian", adaptive = T)

#saveRDS(bw.fennoscandia, "bw.fennoscandia.Rdata")
saveRDS(gwr.fennoscandia, "gwr.fennoscandia.Rdata")
```


```{r gwr-results, fig.dim = c(10,6)}
#bw.fennoscandia <- readRDS("bw.fennoscandia.Rdata")
gwr.fennoscandia <- readRDS("gwr.fennoscandia.Rdata")
k.neigh.w <- readRDS("k.neigh.w.Rdata")

gwr.coef <- gwr.fennoscandia$SDF@data

m <- c("NDVI","logRunoff","Bog")
n <- length(m)

gwr.effectsize <- gwr.coef[,2:(n+1)]

for(i in 1:dim(gwr.effectsize)[1]){
  for(j in 1:n){
  if(grepl("log",m[j])==T){
    gwr.effectsize[i,j] <- eslog^(gwr.coef[i,j+1])
  }else if(m[j] %in% c("NDVI","Bog","arable","forest")){
    gwr.effectsize[i,j] <- exp(gwr.coef[i,j+1]*es)
  }
  }
}

gwr.effectsize.percent <- 100*(gwr.effectsize-1)

saveRDS(gwr.effectsize.percent,"gwr.ndvi.effectsize.percent.rds")


coef.plot <- lapply(m,FUN = function(x)  f_plotspatial(data=fennoscandia,var=gwr.effectsize.percent[[x]],plottitle = x))
coef.plot$toc <- f_plotspatial(fennoscandia,var=gwr.coef$y,plottitle = "Observed toc (log)")
cowplot::plot_grid(plotlist = coef.plot,ncol=2)
```
`r fig_nums("gwr-results","Spatial distribution of local explanatory parameter coefficients from the GWR")`

```{r gwr-table}
gwr.AIC <- gwr.fennoscandia$GW.diagnostic$AICc
gwr.r2 <- gwr.fennoscandia$GW.diagnostic$gwR2.adj
gwr.moran <- moran.test(gwr.coef$Stud_residual,k.neigh.w,alternative = "two.sided")

summary.table.gwr <- data.frame(AIC = gwr.AIC,R2 = gwr.r2,Moran.I =gwr.moran$estimate[[1]])

knitr::kable(summary.table.gwr,digits = 3, caption = table_nums("gwr-results","GWR Model performance: Relative model fit (AIC), mean Variance (R2) and Spatial autocorrelation (Moranâs I) of residuals."), label = NA, col.names = c("AIC","R2","Moran's I")) %>%
  kable_styling(bootstrap_options = "bordered")
```

NDVI sustains its role as main predictor for the concentration of DOM in GWR. Local effect sizes range from 0 to +50%. In regions that are basically completely forested, such as south-east Finland (Figure 1g), or completely agricultural, such as southernmost Sweden (Figure 1h), the effect size of a 0.1 increase in NDVI is close to 0%. While in southern Norway and the northern parts of Norway, Sweden and Finland, where there is less forest and arable land, an increase of 0.1 unit NDVI is estimated to have a significant relative impact on TOC concentration (`r fig_nums("gwr-results", display = "c")`).

As also found for the SELM model the effect size of a 10% increase in runoff is mainly negative, though ranges from `r round(min(gwr.effectsize.percent$log.runoff),0)` % to `r round(max(gwr.effectsize.percent$log.runoff),0)`%.  The south-eastern Finland it the only region with low runoff intensity (`r fig_nums("insert-maps", display = "c")`c) where the effect size for the log of runoff is positive. The most negative effects are located in the south-west region of Norway , where there are the highest runoff intensities.

An unlikely change in the proportion of bogs has practically no effect,  except for a minor area in south-east Finland where both the highest (+`r round(min(gwr.effectsize.percent$Bog),0)` %) and the lowest (r round(min(gwr.effectsize.percent$Bog),0)`%) effect sizes are found. This local spot is not related to the original proportion of bogs (see Supplementary 2). 

### GWR with forest as predictor instead of NDVI

```{r GWR-fennoscandia-forest, eval = F}
fm <- log.toc~forest+log.runoff+Bog

library(GWmodel)
#bw.fennoscandia.forest <- bw.gwr(fm, data = fennoscandia.spdf, kernel = "gaussian", adaptive = T)
gwr.fennoscandia.forest <- gwr.basic(fm, data = fennoscandia.spdf, bw = 500, kernel = "gaussian", adaptive = T)

#saveRDS(bw.fennoscandia.forest, "bw.fennoscandia.forest.Rdata")
saveRDS(gwr.fennoscandia.forest, "gwr.fennoscandia.forest.Rdata")
```



```{r gwr-results-forest, fig.dim = c(10,6)}
#bw.fennoscandia.forest <- readRDS("bw.fennoscandia.forest.Rdata")
gwr.fennoscandia.forest <- readRDS("gwr.fennoscandia.forest.Rdata")
k.neigh.w <- readRDS("k.neigh.w.Rdata")

gwr.coef <- gwr.fennoscandia.forest$SDF@data

m <- c("Forest","logRunoff","Bog")
n <- length(m)

gwr.effectsize <- gwr.coef[,2:(n+1)]

for(i in 1:dim(gwr.effectsize)[1]){
  for(j in 1:n){
  if(grepl("log",m[j])==T){
    gwr.effectsize[i,j] <- eslog^(gwr.coef[i,j+1])
  }else if(m[j] %in% c("NDVI","Bog","Forest")){
    gwr.effectsize[i,j] <- exp(gwr.coef[i,j+1]*es)
  }
  }
}

gwr.effectsize.percent <- 100*(gwr.effectsize-1)
saveRDS(gwr.effectsize.percent,"gwr.forest.effectsize.percent.rds")

coef.plot <- lapply(m,FUN = function(x)  f_plotspatial(data=fennoscandia,var=gwr.effectsize.percent[[x]],plottitle = x))
coef.plot$toc <- f_plotspatial(fennoscandia,var=gwr.coef$y,plottitle = "Observed toc (log)")
cowplot::plot_grid(plotlist = coef.plot,ncol=2)
```

`r fig_nums("gwr-results-forest","Spatial distribution of local explanatory parameter coefficients from the GWR, with forest as predictor instead of NDVI.")`

```{r gwr-forest-table}
gwr.AIC <- gwr.fennoscandia.forest$GW.diagnostic$AICc
gwr.r2 <- gwr.fennoscandia.forest$GW.diagnostic$gwR2.adj
gwr.moran <- moran.test(gwr.coef$Stud_residual,k.neigh.w,alternative = "two.sided")

summary.table.gwr.forest <- data.frame(AIC = gwr.AIC,R2 = gwr.r2,Moran.I =gwr.moran$estimate[[1]])
                                
knitr::kable(summary.table.gwr.forest,digits = 3, caption = table_nums("gwr-results-forest","GWR Model performance with Forest land covers instead of NDVI: Relative model fit AIC, mean Variance (R2) and Spatial autocorrelation (Moranâs I) of residuals."),label = NA, col.names = c("AIC","R2","Moran's I")) %>%
  kable_styling(bootstrap_options = "bordered")
```


Replacing NDVI in the GWR model with the proportion of forest does not change the local effect sizes of runoff in the model, and a similar spot of very high and very low effect sizes appears for the proportion of bogs. A similar spot is visible on the map representing the local effect sizes for an increase in forest proportion, but the effect sizes values are not unusual there. Once again, this spot is not explained by an unusual original proportion of forest (see Supplementary 2). The range of effect sizes goes from `r round(min(gwr.effectsize.percent$forest),0)` % to `r round(max(gwr.effectsize.percent$forest),0)`%.

### Conclusion GWR

GWR models are interesting to investigate local relationships between the response and predictor variables, but the results might be complicated to interpret. The strength of a GWR model is also a drawback: by giving more weight to the closest neighbors, it also "artificially" emphasizes the local features of the data points, like a magnifying lens, resulting in an potentially exaggerated version of the reality. 
If the local effect sizes of an increase of NDVI, forest and runoff could be explained by the original conditions, the effect sizes of an increase in bogs were more diverse and there is no good explanation for the spot observed in Finland. 


## Forecast in water regions

Forecasted simulations of DOM are based on scenarios of changes in the three main predictors, NDVI, log Runoff and Bogs. The changes in temperature and precipitation (used to assess NDVI) and of Runoff simulations using CMIP6. The catchments included in the 1995 synoptic study were expanded to 1 392 water regions (see Supplementary 3) covering the entire Fennoscandia.   


In order to cover the whole territory of Fennoscandia, and not only some lakes catchment as with the Northern lake Survey, we used the polygons representing the water regions. Water regions are the ensemble of the watercourse that drain to the sea within a coastal section @NVE. The water regions were computed from an elevation model (ref Anders). After cleaning, the dataset is composed of 1392 polygons (see Supplementary 3). 


### Modelling of mean TOC in 1995 in water regions

NDVI, runoff and land cover in 1995 for the 1 392 water regions (`r fig_nums("wr-maps-95", display = "c")`) were extracted using the same protocol as for the Northern Lake Survey dataset. The average TOC concentration, not sampled for each of the water regions, was modelled using the spatial error model (SELM) fitted in [section 3.3](#sem-simple). 

```{r wr-maps-95, fig.scap= NA}
knitr::include_graphics(c("WR/wr.ndvi.plot.png","WR/wr.bogs.plot.png","WR/wr.runoff.plot.png","WR/wr.toc.png"))
```

`r fig_nums("wr-maps-95","Map of the mean values of predictor variables and modelled TOC as response parameter in the 1 392 water regions in 1995") `

### Forecast of predictor variables

Temperature and precipitation values were used to model future NDVI, since no forecast exist for this index. The proportion of bogs is not expected to change, therefore no hypothesis is taken concerning their future evolution.


#### Runoff 2041-2060

Future annual runoff intensities were extracted from the CRMP-CM6 model and averaged for the period 2041-2060 to match the temperature and precipitation data. The average forecasted and the differences in averaged runoff intensities compared to the period 1970-2000 for two different climate change assumptions are shown `r fig_nums("future_runoff",display = "c")`.

```{r future-runoff, fig.dim= c(6,8)}
knitr::include_graphics(c("WR/ssp126.runoff.png","WR/ssp126.runoff.diff.png","WR/ssp370.runoff.png","WR/ssp370.runoff.diff.png"))
```

`r fig_nums("future-runoff","Forecast of mean runoff intensities for the period 2041-2060 (i.e., 2050), and change in runoff compared to the average for 1995 to 2050, under SSP 1-2.6 (2ÂºC target) and SSP 3-7.0 (realistic worst-case) scenarios.")`

#### NDVI 2041-2060

There is no forecast for NDVI in CMIP6. Summer NDVI values for 2050 were instead predicted using a spatial error model based on forecast for temperature and precipitations in the period 2041-2060. This model was fitted using summer NDVI, temperature and precipitations in 1995 (mean 1970-2000). 

Average temperature and precipitation for 1995 were extracted from the Worldclim database @WorldClim. Future temperature and precipitation values are extracted from the CRNM-CM6 model. They are presented respectively in `r fig_nums("ssp-temp-prec", display = "c")`. Modelled future and changes in NDVI are shown in `r fig_nums("ssp-ndvi",display = "c")`.


```{r ssp-temp-prec, fig.dim= c(6,8)}
knitr::include_graphics(c("WR/ssp126.temp.png", "WR/ssp126.diff.temp.png", "WR/ssp370.temp.png","WR/ssp370.diff.temp.png","WR/ssp126.prec.png","WR/ssp126.diff.prec.png","WR/ssp370.prec.png","WR/ssp370.diff.prec.png"))
```

`r fig_nums("ssp-temp-prec","Forecast of mean temperature and precipitation for the period 2041-2060 (i.e., 2050), and changes in temperature and precipitation compared to the average for 1995 to 2050, under SSP 1-2.6 (2ÂºC target) and SSP 3-7.0 (realistic worst-case) scenarios.")`

```{r ssp-ndvi, fig.dim= c(6,8)}
knitr::include_graphics(c("WR/ssp126.ndvi.png","WR/ssp126.ndvi.diff.png","WR/ssp370.ndvi.png","WR/ssp370.ndvi.diff.png"))
```

`r fig_nums("ssp-ndvi","Prediction of mean summer NDVI for the period 2041-2060 (i.e., 2050), and changes in summer NDVI compared to the summer average for 1995 to 2050, under SSP 1-2.6 (2ÂºC target) and SSP 3-7.0 (realistic worst-case) scenarios.")`

### Forecast of mean DOM concentration in 2041-2060

Using the Spatial Error Linear Model (SELM), fitted for Fennoscandia in  [section 3.3](#sem-simple) the future DOM concentrations were predicted based on the 2ÂºC target and the realistic worst-case climate change scenarios (SPP 1-2.6 and SSP 3-7.0), respectively (`r fig_nums("wr-maps-95", display = "c")`).

```{r ssp-toc, fig.dim= c(6,8)}
knitr::include_graphics(c("WR/map.toc.126.png", "WR/map.toc.diff.126.png","WR/map.toc.370.png","WR/map.toc.diff.370.png"))
```

`r fig_nums("ssp-toc","Forecast of TOC concentration under SSP 1-2.6 and SSP 3.7-0 (mg/L)")`

The largest climate largest induced increases in DOM concentrations are predicted to mainly be in southern Sweden and in many very small coastal water regions. A slight decrease in DOM is predicted for mid Sweden and Finland under the 2ÂºC scenario, though this is less distinct for the more realistic worst-case scenario. 

```{r compare-ssp, fig.dim = c(10,20)}
knitr::include_graphics("WR/compare.ssp.png")
```

`r fig_nums("compare-ssp","Boxplot of ranges in Temperature, Precipitation, NDVI, Runoff and TOC in 1995 and for 2050 under the scenarios SSP1-2.6 and SSP3-7.0.")`

### Forecast of future DOM based on forest increase

An increase in forest cover as a nature-based solution (NbS) to sequester CO2 to abate climate change may have an impact on the DOM concentration in lakes. In this section, we use the model fitted in [section 3.5](#forest) to map the DOM concentration in water regions pending an increase in forest cover. 

We assessed the increase in forest cover based on numbers presented in policy papers.
* In Finland, 26,18 million ha @Lukestat are covered with forest and 90 000 are expected to be planted by 2065 @Lethonen2021. This represents roughly an mean increase of 0,34%
* In Sweden, the forest covers 28 million hectares @SwedishForestAgency2012. The Swedish forest policy includes the afforestation of 190 000 ha @StatensOffentligaUtredningar2020, representing a 0,07% increase.
* In Norway, the forest covers 8,443 million ha and the plan for afforestation is to increase this cover up to 9,78 million hectare, i.e. 14%.  

However, the potential increase in the proportion of forest cover differs for all the water regions as the proportion of forest in a region with a 100% forest cover cannot increase further. Likewise, it is unlikely that a water region with a 0% forest cover (bare rocks, glaciers) can be afforested. Therefore, the potential increase of forest cover was calculated using a simple equation:

$forest_{future} = forest_{present} + (1- forest_{present}) * forest_{present}$

Where $forest_{future}$ and $forest_{present}$ denote the ratio of future and present forest coverage over the total area in the water region, respectively. 

This formula attributes a maximum 25% increase of forest proportion to the catchments with 50% forest cover (50% increase), whereas the regions with 0 or 100% forest cover will have no increase. Using this approach, we find that the inner parts of southern Norway and Sweden, and most of Finland has a potential for an increase in forest close to 25%.


The forecast applies for year 2100, when all the planted trees will have reached maturity @Miljodirektoratet2013.


```{r map-increase-forest, fig.dim = c(6,8) }
knitr::include_graphics(c("WR/map.forest.png","WR/map.diff.forest.png"))
```

`r fig_nums("map-increase-forest","Estimated potential for increase of forest cover by the year 2050"`

```{r map-toc-forest, fig.dim = c(6,8) }
knitr::include_graphics(c("WR/map.toc.forest.png","WR/map.diff.toc.forest.png"))
```

`r fig_nums("map-toc-forest","Forecast of TOC concentration due to an increase of forest cover as a NbS to abate climate change.")`

Using the Spatial Error Linear Model, fitted for Fennoscandia in [section 3.5](#forest), the future TOC concentrations were predicted based on the estimated potential for the use of planting forest to sequester CO2 (`r fig_nums("map-increase-forest",display = "c"`), holding the log Runoff and Bog coverage constant. The simulations suggest that the increase in TOC would be highest where the TOC concentrations already are high, i.e., in Sweden and Finland, and lowest along the Norwegian western coast (`r fig_nums("map-toc-forest",display = "c"`).


# Discussion


## Key predictors for TOC concentration: vegetation cover and runoff

* Despite of a coarser resolution, the summer biomass, measured as NDVI (Figure 2), is a stronger predictor for TOC (Figure 4) than the proportion of forest (Figure 3). This is likely due to that the NDVI takes more into account the variations in amount of vegetation than type of vegetation.
* Nevertheless, forest cover is a significant predictor for TOC and can be used to evaluate the impact of afforestation on the levels of DOM caused both response to climate change (Figure 13) and forest planting to sequester CO2 (Figure 15) on TOC concentration in lakes. 
* The proportion of bogs is an irreplaceable and significant predictor for the spatial distribution of TOC (Figure 4). As the amount of bog is  unlikely to change over time it is nevertheless not an important predictor for temporal changes.
* Runoff intensity (mm/year) is a major spatial predictor for TOC, with higher runoff intensity having a negative effect on TOC concentration (Figure 4). The dilution effect is therefore on average stronger than the mobilisation of soil organic matter. The GWR model shows that it nonetheless depends on the local coefficient of variation. I.e., the effect size of a 10% increase in runoff is close to zero in eastern Finland, where the runoff is low and rather uniform, while it is -6% in western Norway, where the runoff intensity is high with large spatial differences.

## Impact of climate change on DOM concentration in lakes

* According to the fitted SELM, the effect size of a 10% temporal increase in log runoff is limited compared to the effect size of NDVI for the same relative change (Figure 4 and 5). 

* Based on the < 2ÂºC increase scenario (SSP126) the log of runoff will increase most in the north of Sweden. There will also be a slight increase in the mountains of southern Norway, mid Sweden and southeast of Finland (Figure 10). These are the same regions in which the average TOC concentration is modelled to decrease (Figure 13). On the contrary, in the south of Sweden and on the Norwegian western coast, the runoff is predicted to decrease. These are also the regions where the highest increase of TOC concentration (Figure 13). The increase of NDVI is highest on the west coast and northern Norway (Figure 12), though this increase is not reflected in the future TOC concentration (Figure 13). It can thus be concluded that the effect of an increased runoff dominates in the forecast of changes in TOC concentration.

* In the SSP370 scenario, the same trends are detectable, but the TOC increase expands into more water regions. The highest increases are once again found in the south of Sweden (Figure 13) where there is predicted less runoff (Figure 10) and decrease in biomass (Figure 12). Nevertheless, for many water regions, both NDVI and runoff will increase without leading to an increase of TOC concentration, rather a slight decrease. This is substantiating the importance of the dilution effect compared to the vegetation effect. 

* This article doesn't take into account the possible evolution of proportion of bogs. Bog cover evolves slowly but can be submitted to short-term extreme events, such as droughts. REF. Increased frequency, especially in the south of the boreal zone @Helbig2020. However, the TOC forecast in this article is based on 20-year averages of the main predictors (precipitation and temperature to predict NDVI,  as well as runoff). Therefore, extreme events have a limited impact on the TOC average.

## Impact of afforestation / densification / fertilization

* Forest model allows to assess the impact of afforestation
* NDVI model allows to assess the specific impact of densification / fertilization
* More forest -> more TOC in lakes, up to +2 mg/L (Figure 16).

* Modelling the TOC concentration in lakes based on the proportion of forest is a shortcut. Forest management, whether it is intensive, extensive, mono- or multispecies, will lead to different amount of soil organic carbon being produced and stored @Ameray2021. Therefore these results have to be interpreted as indicative only. 

# Conclusion

* NDVI is the predictor with the highest explanatory value in the spatial TOC model, while for temporal predictions the negative effect of changes runoff on TOC concentration is stronger.
* Afforestation as a nature-based solution for sequestering CO2 (i.e., Climate Forest) will lead to an increase in average TOC concentration. Increased runoff in some regions may balance this effect. 

# References

`r knitr::knit_exit()`

*	The concentration of TOC in lakes a key proxy to estimate carbon fluxes from freshwater to the atmosphere, a flux often underestimated @Natchimuthu2016.
* according to LeNoe et al @LeNoe2021, naturally growing, non-productive forest could be even bigger sinks of CO2 (more than 20 tC/ha).
*	Afforestation does not necessary lead to an increased storage of carbon in soils @TauStrand2021


