---
title: "TOC model extended"
author: "Camille M. Crapart"
date: "5 1 2022"
output: 
  bookdown::html_document2:
   toc: true
   toc_float: true
   number_sections: true
   fig_caption: true
   code_folding: hide
bibliography: C:\\Users\\raine\\Documents\\UiO\\Bibtex\\Finstad.bib
link-citations: yes

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, error = F, fig.align = "center", collapse = T)
options(knitr.kable.NA="", knitr.kable.format ="html")
```
```{r library}
library(dplyr)
library(tibble)

library(DBI)
library(sf)
library(gimms)

library(ncdf4)
library(rgdal)

library(stringr)
library(ggplot2)
library(RColorBrewer)
library(cowplot)
library(spdep)
library(spatialreg)

library(kableExtra)
library(reshape2)

source("f_plotspatial.R")

memory.limit(size = 160000)

library(captioner)
fig_nums <- captioner() 
table_nums <- captioner(prefix = "Table")
```
# Water regions data

## Connections to database

```{r download-water-regions, eval = F}
con <- dbConnect(RPostgreSQL::PostgreSQL(),user = "camille.crapart", password = "camille",host = "vm-srv-wallace.vm.ntnu.no", dbname = "nofa")
query <- paste("SELECT gid,geom FROM ","\"Hydrography\"",".waterregions_dem_10m_nosefi",sep = "")
query.2 <- paste("SELECT * FROM ","\"Hydrography\"",".Fenoscandia_LakeRegister",sep = "")
water.regions <- st_read(con,query = query)
lake.register <- st_read(con,query = query.2)
saveRDS(water.regions,"water.regions.Rdata")
```

```{r plot-regions, eval = F}
water.regions <- readRDS("water.regions.Rdata")
ggplot()+geom_sf(data=water.regions,aes(fill = gid))
```

```{r select-polygons, eval = F}
water.regions <- readRDS("water.regions.Rdata")
water.regions$area <- st_area(water.regions) %>% as.numeric()
area1 <- sum(water.regions$area)

wr.quantile <- quantile(water.regions$area, probs = c(0.99,0.995,0.999))
wr.sf <- water.regions %>% filter(area > wr.quantile[3])
area2 <- sum(wr.sf$area)

ratio <- area2/area1*100

map.wr <- ggplot(wr.sf) + geom_sf(aes(fill=gid,col=gid))
ggsave(plot = map.wr, filename = "WR/wr.sf.png",dpi = "retina", width = 10, height = 15, units = "cm")

saveRDS(wr.sf,"WR/wr.sf.rds")
```


The water regions polygons were computed with a seamless digital elevation model for Fennoscandia @ninanor. The model resulted in more than 200 000 water regions, most of them being extremely small polygons covering the coastal regions. In order to simplify the model and reduce the amount of data, we keep only the 0,001 % of the water regions that are the biggest. They account to more than 93% of the total surface covered by the initial amount of polygons.  

## NDVI

```{r extract-ndvi-wr, eval = F}
ndvi.max <- readRDS("ndvi.max.Rdata")
wr.sf <- readRDS("WR/wr.sf.rds")

summer.mean <- raster::stack(ndvi.max[[6]],ndvi.max[[7]],ndvi.max[[8]]) %>% mean()
summer.ndvi <- reclassify(summer.mean,cbind(-Inf, 0, NA), right=FALSE)
summer.scandinavia <- raster::crop(summer.ndvi,c(0,35,55,73))
writeRaster(summer.mean,"ndvi1994.tif",overwrite = T)

ndvi.wr <- raster::extract(summer.ndvi,wr.sf,fun = mean, df = T, sp = T, na.rm = T)
ndvi.wr$area <- NA
ndvi.wr$ndvi <- (floor(ndvi.wr$layer)/10)/1000
saveRDS(ndvi.wr, "WR/ndvi.wr.rds")

ggplot(ndvi.wr)+geom_sf(aes(fill=ndvi,col=ndvi))
```

```{r summer-ndvi-waterregions-old, eval = F}
# http://poles.tpdc.ac.cn/en/data/9775f2b4-7370-4e5e-a537-3482c9a83d88/
water.regions <- readRDS("water.regions.Rdata")

ndvi.1994 <- downloadGimms(x= 1994,y=1994,dsn = "NDVI")
ndvi.max <- monthlyComposite(ndvi.1994,monthlyIndices(ndvi.1994))
saveRDS(ndvi.max,"ndvi.max.Rdata")
ndvi.max <- readRDS("ndvi.max.Rdata")
summer.mean <- raster::stack(ndvi.max[[6]],ndvi.max[[7]],ndvi.max[[8]]) %>% mean()
summer.scandinavia <- raster::crop(summer.mean,c(0,35,55,73))
summer.scan <- reclassify(summer.scandinavia, cbind(-Inf, 0, NA), right=FALSE)
summer.scan.ndvi <- (floor(summer.scan)/10)/1000
writeRaster(summer.mean,"ndvi1994.tif")

png("NDVI/ndvi.fen.png", width = 30, height = 30, units = "cm", res = 300)
plot(summer.scan.ndvi, axes = F, box = F, main = "NDVI 1995",)
dev.off()

for(x in 0:287){
  start.x <- (x-1)*1000+1
  end.x <- x*1000
  ndvi <- raster::extract(summer.scan,water.regions[start.x:end.x,], fun = mean, df = T, sp = T)
  name.x <- paste("WR/NDVI/summer.ndvi.wr",x,"Rdata",sep = ".")
saveRDS(ndvi,name.x)
}

start.x <- (288-1)*1000+1
summer.ndvi.wr.288 <- raster::extract(summer.scan,water.regions[start.x:287886,], fun = mean, df = T, sp = T)
saveRDS(summer.ndvi.wr.288,"summer.ndvi.wr.288.Rdata")

summer.ndvi.wr.165 <- raster::extract(summer.scan,water.regions[164100:165000,], fun = mean, df = T, sp = T)
saveRDS(summer.ndvi.wr.165,"WR/NDVI/summer.ndvi.wr.165.Rdata")

list.ndvi.files <- list.files("WR/NDVI", full.names = T)
list.ndvi <- lapply(list.ndvi.files[-165],readRDS)

summer.ndvi.wr <- summer.ndvi.wr.165@data
for(x in 1:length(list.ndvi)){
  df <- list.ndvi[[x]]@data
  summer.ndvi.wr <<- rbind(summer.ndvi.wr, df)
  
}
names(summer.ndvi.wr) <- c("gid","ndvi")
summer.ndvi.wr$ndvi.value <- (floor(summer.ndvi.wr$ndvi)/10)/1000
summer.ndvi.wr$flag.value <- summer.ndvi.wr$ndvi - (floor(summer.ndvi.wr$ndvi)/10*10+1) 

saveRDS(summer.ndvi.wr, "summer.ndvi.wr.Rdata")
```

```{r check-values-nvi, eval = F}
summer.ndvi.wr <- readRDS("summer.ndvi.wr.Rdata")
water.regions <- readRDS("water.regions.Rdata")

missing.ndvi <- summer.ndvi.wr$gid[which(is.na(summer.ndvi.wr$ndvi.value)==T)]
missing.lines <- which(water.regions$gid %in% missing.ndvi)

ndvi.max <- readRDS("ndvi.max.Rdata")
summer.mean <- raster::stack(ndvi.max[[6]],ndvi.max[[7]],ndvi.max[[8]]) %>% mean()
summer.scandinavia <- raster::crop(summer.mean,c(0,35,55,73))
summer.scan <- reclassify(summer.scandinavia, cbind(-Inf, 0, NA), right=FALSE)
plot(summer.scan)
ndvi <- raster::extract(summer.scan,water.regions[missing.lines,], fun = mean, df = T, sp = T, na.rm = T,buffer=10,small = T)
saveRDS(ndvi,"missing.ndvi.Rdata")

ndvi.sf <- st_as_sf(ndvi)
summer.scan.df <-as.data.frame(summer.scan,xy=T) 
ggplot()+geom_sf(data=ndvi.sf,aes(fill=layer))

missing.ndvi.df <- ndvi@data
names(missing.ndvi.df) <- c("gid","ndvi")
missing.ndvi.df$ndvi.value <- (floor(missing.ndvi.df$ndvi)/10)/1000
missing.ndvi.df$flag.value <- missing.ndvi.df$ndvi - (floor(missing.ndvi.df$ndvi)/10*10+1) 

saveRDS(missing.ndvi.df, "missing.ndvi.df.Rdata")
```
```{r join-ndvi, eval = F}
missing.ndvi <- readRDS("missing.ndvi.Rdata")
summer.ndvi.total <- rbind(filter(summer.ndvi.wr,!is.na(ndvi)),missing.ndvi.df)
saveRDS(summer.ndvi.total,"summer.ndvi.total.Rdata")

summer.ndvi.sf <- merge(water.regions,summer.ndvi.total,by.x = "gid", by.y = "gid")
saveRDS(summer.ndvi.sf,"summer.ndvi.sf.Rdata")
ggplot()+geom_sf(data=summer.ndvi.sf,aes(fill=ndvi.value))
```
```{r plot-ndvi, eval = F}
summer.ndvi.sf <- readRDS("WR/summer.ndvi.sf.Rdata")
ggplot()+geom_sf(data=summer.ndvi.sf,aes(fill=ndvi.value))
```

## Runoff
```{r runoff-wr, eval = F}

runoff.raster <- "CORDEX/mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"
runoff.nc <- nc_open(runoff.raster)

runoff.stack <- raster::stack(runoff.raster, bands = c(1441:1812))
runoff.mean <- runoff.stack %>% mean() 

wr.sf <- readRDS("WR/wr.sf.rds")
runoff.wr95 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)
names(runoff.wr95) <- c("gid","area","runoff")
saveRDS(runoff.wr95,"WR/runoff.wr95.rds")

ggplot(st_as_sf(runoff.wr95))+geom_sf(aes(fill=runoff,col=runoff))

```

```{r runoff-wr-old, eval = F}
#runoff.tbl <- tbl(con,sql("SELECT ebint,mrros FROM public.cordex_prelim"))
#runoff.df <- runoff.tbl %>% as.data.frame()

water.regions <- readRDS("water.regions.Rdata")

runoff.file.60s <- "CORDEX/mrros_EUR-11_NCC-NorESM1-M_historical_r1i1p1_DMI-HIRHAM5_v3_mon_196101-197012.nc"
runoff.file.70s <- "CORDEX/mrros_EUR-11_NCC-NorESM1-M_historical_r1i1p1_DMI-HIRHAM5_v3_mon_197101-198012.nc"
runoff.file.80s <- "CORDEX/mrros_EUR-11_NCC-NorESM1-M_historical_r1i1p1_DMI-HIRHAM5_v3_mon_198101-199012.nc"
#runoff.file.80s <- "CORDEX/mrros_EUR-11_NCC-NorESM1-M_historical_r1i1p1_DMI-HIRHAM5_v3_mon_19101-199012.nc"


# get coordinates
runoff.nc <- nc_open(runoff.file.60s)
runoff.info <- GDALinfo(runoff.nc)
attr.runoff <- attr(runoff.info,"mdata")

rot.info <- attr.runoff[grep("^rotated",attr(runoff.info,"mdata"))]
coord <- sapply(rot.info, FUN = function(x) {
  unlist(str_split(x, pattern = "="))[2]})
coord.num<- round(as.numeric(coord[2:3]),2)

y <- coord.num[1]
x <- coord.num[2]

target.crs <- paste0("+proj=ob_tran +o_proj=longlat +o_lon_p=" , 
                     x, " +o_lat_p=", y, 
                     " +lon_0=180 +to_meter=0.0174532925199433")

# 60s
runoff.60.stack <- stack(runoff.file.60s, varname = "mrros")
runoff.60.mean  <- mean(runoff.60.stack)

projection(runoff.60.mean) <- CRS("EPSG:4326")
runoff.60.rotated <- projectRaster(runoff.60.mean,crs = target.crs)
runoff.60.wgs84 <- runoff.60.rotated
projection(runoff.60.wgs84) <- CRS("EPSG:4326")

for(x in 1:287){
  start.x <- (x-1)*1000+1
  end.x <- x*1000
  runoff.60s <- raster::extract(runoff.60.wgs84,water.regions[start.x:end.x,], fun = mean, na.rm = T, df = T, exact = F, sp = T)
  runoff.60.df <- runoff.60s@data
  names(runoff.60.df) <- c("ebint","runoff.60s")
  name.x <- paste("WR/runoff/runoff.60",x,"Rdata",sep = ".")
  saveRDS(runoff.60.df,name.x)
}

start.x <- (288-1)*1000+1
runoff.60.288 <- raster::extract(runoff.60.wgs84,water.regions[start.x:287886,], fun = mean, df = T, sp = T)
saveRDS(runoff.60.288,"WR/runoff/runoff.60.288.Rdata")



# 70s
runoff.70.stack <- stack(runoff.file.70s, varname = "mrros")
runoff.70.mean  <- mean(runoff.70.stack)

projection(runoff.70.mean) <- CRS("EPSG:4326")
runoff.70.rotated <- projectRaster(runoff.70.mean,crs = target.crs)
runoff.70.wgs84 <- runoff.70.rotated
projection(runoff.70.wgs84) <- CRS("EPSG:4326")

for(x in 99:287){
	start.x <- (x-1)*1000+1
	end.x <- x*1000
	runoff.70s <- raster::extract(runoff.70.wgs84,water.regions[start.x:end.x,],fun = mean, na.rM = T, df = T, exact = F, sp = T)
	runoff.70.df <- runoff.70s@data
	names(runoff.70.df) <- c("ebint","runoff.70")
	name.x <- paste("WR/runoff/runoff.70",x,"Rdata",sep = ".")
	saveRDS(runoff.70.df,name.x)
}

start.x <- (288-1)*1000+1
runoff.70.288 <- raster::extract(runoff.70.wgs84,water.regions[start.x:287886,],fun = mean, na.rM = T, df = T, exact = F, sp = T)
saveRDS(runoff.70.288,"WR/runoff/runoff.70.288.Rdata")



# 80s
runoff.80.stack <- stack(runoff.file.80s, varname = "mrros")
runoff.80.mean  <- mean(runoff.80.stack)

projection(runoff.80.mean) <- CRS("EPSG:4326")
runoff.80.rotated <- projectRaster(runoff.80.mean,crs = target.crs)
runoff.80.wgs84 <- runoff.80.rotated
projection(runoff.80.wgs84) <- CRS("EPSG:4326")


for(x in 1:287){
	start.x <- (x-1)*1000+1
	end.x <- x*1000
	runoff.80s <- raster::extract(runoff.80.wgs84,water.regions[start.x:end.x,],fun = mean, na.rM = T, df = T, exact = F, sp = T)
	runoff.80.df <- runoff.80s@data
	names(runoff.80.df) <- c("ebint","runoff.80")
	name.x <- paste("WR/runoff/runoff.80",x,"Rdata",sep = ".")
	saveRDS(runoff.80.df,name.x)
}

start.x <- (288-1)*1000+1
runoff.80.288 <- raster::extract(runoff.80.wgs84,water.regions[start.x:287886,],fun = mean, na.rM = T, df = T, exact = F, sp = T)
saveRDS(runoff.80.288,"WR/runoff/runoff.80.288.Rdata")

```


```{r gather-runoff-wr-old, eval = F}
list.files.runoff.60 <- list.files("WR/runoff",pattern = "runoff.60",full.names = T)

df.runoff.60 <- readRDS(list.files.runoff.60[210])@data %>% setNames(c("ebint","runoff.60s"))
for(x in list.files.runoff.60[-210]){
  df <- readRDS(x)
  df.runoff.60 <<- rbind(df.runoff.60,df)
}

list.files.runoff.70 <- list.files("WR/runoff",pattern = "runoff.70",full.names = T)

df.runoff.70 <- readRDS(list.files.runoff.70[210])@data %>% setNames(c("ebint","runoff.70"))
for(x in list.files.runoff.70[-210]){
  df <- readRDS(x)
  df.runoff.70 <<- rbind(df.runoff.70,df)
}

list.files.runoff.80 <- list.files("WR/runoff",pattern = "runoff.80",full.names = T)

df.runoff.80 <- readRDS(list.files.runoff.80[1])
for(x in list.files.runoff.80[-1]){
  df <- readRDS(x)
  df.runoff.80 <<- rbind(df.runoff.80,df)
}

runoff.df.wr <- merge(df.runoff.60,df.runoff.70, by = "ebint") %>% merge(df.runoff.80, by = "ebint")
runoff.df.wr$mean.runoff <- rowMeans(runoff.df.wr[,2:4])
saveRDS(runoff.df.wr, "runoff.df.wr.Rdata")


runoff.sf <- merge(water.regions,runoff.df.wr,by.x = "gid", by.y = "ebint")
saveRDS(runoff.sf,"runoff.sf.Rdata")
```


## Bogs and forest

```{r wr-bogs-forest, eval = F}
library(rgdal)
water.regions <- readRDS("water.regions.Rdata")
wr.corine <- st_transform(water.regions,CRS("EPSG:3035"))
saveRDS(wr.corine,"wr.corine.Rdata")
wr.corine <- readRDS("wr.corine.Rdata")
corine <- raster::raster("Corine_Land_Cover/U2006_CLC2000_V2020_20u1.tif")

for(x in 2615:2880){
  start.x <- (x-1)*100+1
  end.x <- x*100
  clc <- raster::extract(corine,wr.corine[start.x:end.x,])
  name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
  saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[start.x:end.x,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))
}

start.x <- 287801
end.x <- 287886
clc <- raster::extract(corine,wr.corine[start.x:end.x,])
name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[start.x:end.x,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))

miss <- c(74, 91,133, 138, 161, 304, 668, 1354, 1391, 1592, 1634, 1825, 2000, 2014, 2040, 2048, 2078, 2327, 2503, 2542, 2614)

library(R.utils)

for(x in miss){
  start.x <- (x-1)*100+1
  end.x <- x*100
  wr.x <- wr.corine[start.x:end.x,]
  for (y in 1:100){
  tryCatch(expr = {
    withTimeout(expr = {
    clc <- raster::extract(corine,wr.x[y,])
    name.x <- paste("WR/clc/clc.wr",x,y,"Rdata",sep = ".")
    saveRDS(clc,name.x)
    clc.tab <- sapply(clc, function(x) tabulate(x,45))
    clc.tab.area <- clc.tab*prod(res(corine))
    catchment.area <- colSums(clc.tab.area)
    clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
    names(clc.tab.prop) <- wr.x[y,]$gid
    saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,y,"Rdata",sep="."))
  }, 
  substitute = F, timeout = 15*60, onTimeout = "error")
  },
  
  finally = TimeoutException(next)
  )
  }
}

big <- c(91.18,91.19,133.51,138.89,161.61,304.92,668.15,1391.8,1592.6,1634.63,1825.60,2000.90,2040.26,2048.29,2078.63,2503.89,2542.2,2614.78)


x <- big[18]
start.x <- (trunc(x)-1)*100+(x-floor(x))*100
clc <- raster::extract(corine,wr.corine[start.x,])
name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[start.x,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))

```
```{r missing again, eval = F}
wr.corine <- readRDS("wr.corine.Rdata")


#missing by 100: 48,1727
for(x in c(1727)){
  start.x <- (x-1)*100+1
  end.x <- x*100
  wr.x <- wr.corine[start.x:end.x,]
  for (y in 1:100){
  tryCatch(expr = {
    withTimeout(expr = {
    clc <- raster::extract(corine,wr.x[y,])
    name.x <- paste("WR/clc/clc.wr",x,y,"Rdata",sep = ".")
    saveRDS(clc,name.x)
    clc.tab <- sapply(clc, function(x) tabulate(x,45))
    clc.tab.area <- clc.tab*prod(res(corine))
    catchment.area <- colSums(clc.tab.area)
    clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
    names(clc.tab.prop) <- wr.x[y,]$gid
    saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,y,"Rdata",sep="."))
  }, 
  substitute = F, timeout = 15*60, onTimeout = "error")
  },
  
  finally = TimeoutException(next)
  )
  }
}

missing.bis <- c(48.46,74.78,1391.9,1727.37,1825.60,2000.90,2014.83,2327.36)

x <- missing.bis[8]
start.x <- (trunc(x)-1)*100+(x-floor(x))*100
clc <- raster::extract(corine,wr.corine[start.x,])
name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[start.x,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))

# missing again: 74.78, 1825.60, 2000.90, + a hundred missing Only run 74.78
x <- 74.78
start.x <- (trunc(x)-1)*100+(x-floor(x))*100
clc <- raster::extract(corine,wr.corine[start.x,])
name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[start.x,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))

last.missing <- setdiff(wr.corine$gid,clc.wr.sf$gid) 

for(x in last.missing){
  line <- which(wr.corine$gid == x) 
  clc <- raster::extract(corine,wr.corine[line,])
  name.x <- paste("WR/clc/clc.wr",x,"Rdata",sep = ".")
  saveRDS(clc,name.x)
clc.tab <- sapply(clc, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- wr.corine[line,]$gid
saveRDS(clc.tab.prop,paste("WR/clc/clc.tab.prop",x,"Rdata",sep="."))
}

```

```{r gather-clc-wr, eval = F}
list.clc.tabs <- list.files("WR/clc",pattern = "clc.tab.prop", full.names = T)
list.clc <- lapply(list.clc.tabs,readRDS)

clc.wr <- list.clc[[1]] %>% t() %>% as.data.frame()
clc.wr$gid <- attr(list.clc[[1]],"names")[1:100]
for(x in 2:length(list.clc)){
  m <- list.clc[[x]] 
  df <- m %>% t() %>% as.data.frame() 
  df$gid <- attr(m,"names")[1:dim(df)[1]]
  clc.wr <<- rbind(clc.wr, df)
  }

saveRDS(clc.wr,"WR/clc/clc.wr.Rdata")


```
```{r get-forest-bogs, eval = F}
clc.wr <- readRDS("WR/clc/clc.wr.Rdata")
clc.wr.bogs <- select(clc.wr, c("gid","V36")) %>% setNames(c("gid","bogs"))
clc.wr.forest <- select(clc.wr,c("V23","V24","V25")) %>% rowSums() %>% as.data.frame() %>% setNames("forest")
clc.wr.glacier <- select(clc.wr,c("V34")) %>% rowSums() %>% as.data.frame() %>% setNames("glacier")
clc.wr.bare <- select(clc.wr,c("V31","V32","V33")) %>% rowSums() %>% as.data.frame() %>% setNames("bare")

clc.wr.sum <- cbind(clc.wr.bogs, clc.wr.forest,clc.wr.glacier, clc.wr.bare)
saveRDS(clc.wr.sum,"WR/clc/clc.wr.sum.Rdata")

```
```{r plot-forest-clc, eval = F}
clc.wr.sf <- readRDS("WR/clc.wr.sf.Rdata")
wr.forest <- ggplot()+geom_sf(data=clc.wr.sf,aes(fill=forest, col = forest))+
  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1, 
                       name = "Forest proportion")+
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = wr.forest, filename = "WR/wr.forest.png",dpi = "retina", width = 6, height = 8, units = "cm")
```

## Temperature and precipitation

Temperature in historical worldclim is in °C * 10 (to reduce file size). Precipitation are average monthly precipitation in mm. Here we use the mean monthly precipitation and temperature for the period 1970-2000. 

```{r model-ndvi-past, eval = F}
wr.sf <- readRDS("WR/wr.sf.rds")

bio.fennoscandia <- raster::getData(name = "worldclim", var = "bio", res = 2.5)

temp.wr <- raster::extract(bio.fennoscandia$bio1, wr.sf, fun = mean, df = T, sp = T, na.rm = T)
names(temp.wr) <- c("gid","area","temp")
temp.wr$temp <- temp.wr$temp / 10
saveRDS(temp.wr,"WR/temp.wr.rds")
#temp.wr <- readRDS("WR/temp.wr.rds")

prec.wr <- raster::extract(bio.fennoscandia$bio12, wr.sf, fun = mean, df = T, sp = T, na.rm = T)
names(prec.wr) <- c("gid","area","prec")
saveRDS(prec.wr,"WR/prec.wr.rds")
#prec.wr <- readRDS("WR/prec.wr.rds")

tp <- cbind(wr.sf[,1],temp.wr[,3]) %>% cbind(prec.wr[,3])
saveRDS(tp,"WR/tp.rds")

```

## Elevation
```{r altitude-wr, eval = F}
wr.sf <- readRDS("WR/wr.sf.rds")
alt.nor <- raster::getData("alt",country = "NOR", mask = T)
alt.swe <- raster::getData("alt",country = "SWE", mask = T)
alt.fin <- raster::getData("alt",country = "FIN", mask = T)

alt.list <- list(alt.nor,alt.swe,alt.fin)
alt <- do.call(raster::merge,alt.list)

alt.wr <- raster::extract(alt, dplyr::select(wr.sf, c("gid","geom")), sp = T, fun = mean, df = T, na.rm = T)
names(alt.wr) <- c("gid","alt")
saveRDS(alt.wr,"WR/alt.wr.rds")

slope.nor <- terrain(alt.nor, unit = "degrees")
slope.swe <- terrain(alt.swe, unit = "degrees")
slope.fin <- terrain(alt.fin, unit = "degrees")
slope.list <- list(slope.nor,slope.swe,slope.fin)
slope <- do.call(raster::merge,slope.list)

slope.nona <- reclassify(slope,cbind(NA,100), right = NA)

slope.wr <- raster::extract(slope,wr.sf, sp = T, df = T, fun = mean, na.rm = T)
names(slope.wr) <- c("gid","area","slope")
saveRDS(slope.wr, "WR/slope.wr.rds")
```
## Gathers wr dataset

```{r gather-dataset, eval = F}
ndvi.wr <- readRDS("WR/ndvi.wr.rds")
ndvi.wr$area <- NULL
runoff.wr95 <- readRDS("WR/runoff.wr95.rds")
runoff.wr95$area <- NULL
clc.wr.sum <- readRDS("WR/clc/clc.wr.sum.Rdata")
alt.wr <- readRDS("WR/alt.wr.rds")
slope.wr <- readRDS("WR/slope.wr.rds")
slope.wr$area <- NULL
tp <- readRDS("WR/tp.rds")
wr.sf <- readRDS("WR/wr.sf.rds")

all.wr.sf <- merge(wr.sf,runoff.wr95,by = "gid") %>% merge(ndvi.wr,by="gid") %>% merge(clc.wr.sum,by = "gid") %>% merge(st_drop_geometry(tp),by = "gid") %>% merge(alt.wr, by = "gid") %>% merge(slope.wr, by = "gid")

saveRDS(all.wr.sf, "WR/all.wr.sf.rds")

```

## WR dataframe


```{r gather-df, eval = F}

all.wr.sf <- readRDS("WR/all.wr.sf.rds")

wr.sf.95 <- all.wr.sf %>% filter(ndvi != 0) %>% filter(runoff > 0) %>% filter(is.na(bogs) == F) %>% filter(is.na(alt) == F) %>% filter(is.na(slope) == F)
wr.sf.95 <- wr.sf.95[!duplicated(wr.sf.95$gid),]
wr.sf.95$Runoff <- wr.sf.95$runoff *365*24*60*60 # from kg/m2/s to kg/m2/year or mm/y
wr.sf.95$logRunoff <- log(wr.sf.95$Runoff)


#map.wr95 <- ggplot()+geom_sf(data = wr.sf.95, aes(fill = ndvi, col = ndvi))+
#  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1, 
#                       name = "NDVI 1995")+
#  theme_minimal(base_size = 6)+
#  theme(legend.position = "bottom")
#ggsave(plot = map.wr95, filename = "WR/wr95.png",dpi = "retina", width = 10, height = 15, units = "cm")

sfc_point_to_matrix = function(x) {
  matrix(
    unlist(x, use.names = FALSE),
    nrow = length(x),
    byrow = TRUE,
    dimnames = list(1:length(x))
  )
}

wr.centroid <- st_centroid(wr.sf.95, of.largest.polygon = T)
coord <- sfc_point_to_matrix(wr.centroid$geometry) %>% as.data.frame() %>% setNames(c("Longitude","Latitude"))
wr.sf.95 <- cbind(wr.sf.95, coord)

wr.sf.95$area <- st_area(wr.sf.95)

saveRDS(wr.sf.95, "WR/wr.sf.95.rds")
```

```{r get-weird-cat-clc, eval = F}
noforest <- filter(wr.sf.95,forest == 0)
dplyr::select(noforest,c("gid","area")) 

#ggplot(noforest[which.max(noforest$area),])+geom_sf(aes(fill=as.factor(gid)))
weird.gid <- noforest$gid[which.max(noforest$area)]
weird.cat <- wr.sf.95 %>% filter(gid == weird.gid) %>% st_transform(CRS("EPSG:3035"))

corine <- raster::raster("Corine_Land_Cover/U2006_CLC2000_V2020_20u1.tif")

#weird.clc <- raster::extract(corine,weird.cat)
#saveRDS(weird.clc,"WR/clc/weird.clc.rds")

weird.clc <- readRDS("WR/clc/weird.clc.rds")
weird.tab <- sapply(weird.clc, function(x) tabulate(x,45))
weird.tabl.area <- weird.tab*prod(res(corine))
catchment.area <- colSums(weird.tabl.area)
weird.tab.prop <- sweep(weird.tabl.area,2,catchment.area, FUN = "/")

wr.sf.95$bogs[which(wr.sf.95$gid == weird.cat$gid)] <- weird.tab.prop[36]

wr.sf.95$forest[which(wr.sf.95$gid == weird.cat$gid)] <- weird.tab.prop[24]+weird.tab.prop[24]+weird.tab.prop[25]

wr.sf.95$glacier[which(wr.sf.95$gid == weird.cat$gid)] <- weird.tab.prop[34]

wr.sf.95$bare[which(wr.sf.95$gid == weird.cat$gid)] <- weird.tab.prop[31]+weird.tab.prop[32]+weird.tab.prop[33]

saveRDS(wr.sf.95,"WR/wr.sf.95.rds")
```

```{r final-df, eval= F}
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")

toreplace <- which(names(wr.sf.95) %in% c("ndvi","bogs","forest","glacier","bare","temp","prec","alt","slope"))
names(wr.sf.95)[toreplace] <- c("NDVI","Bog","Forest","Glacier","Bare","Temp","Precip","Alt","Slope")

wr.sf.95$area <- as.numeric(wr.sf.95$area)

saveRDS(wr.sf.95, "WR/wr.sf.95.rds")
```



```{r plot-variables, eval = F}
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")

mypal.b <- brewer.pal(name = "YlOrBr", n = 9)
wr.bogs <- ggplot(wr.sf.95)+geom_sf(aes(fill=Bog,col=Bog))+ 
  scale_fill_gradient2(low=mypal.b[1],mid=mypal.b[5],high = mypal.b[9],midpoint = median(wr.sf.95$Bog), aesthetics = c("fill","col"), name = "Proportion of bogs")+
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = wr.bogs, filename = "WR/wr.bogs.png",dpi = "retina", width = 6, height = 8, units = "cm")

mypal.n <- brewer.pal(name = "YlGn", n = 9)
wr.ndvi <- ggplot()+geom_sf(data = wr.sf.95,aes(fill=NDVI,col=NDVI))+ 
 scale_fill_gradient2(low=mypal.n[1],mid=mypal.n[5],high = mypal.n[9],midpoint = median(wr.sf.95$NDVI), aesthetics = c("fill","col"),name = "NDVI 1995") + 
   theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = wr.ndvi , filename = "WR/wr.ndvi.png",dpi = "retina", width = 6, height = 8, units = "cm")

mypal.r <- brewer.pal(name = "Blues", n = 9)
wr.runoff <- ggplot()+geom_sf(data = wr.sf.95,aes(fill=Runoff,col=Runoff))+ 
  scale_fill_gradient2(name = "Runoff, mm/y", low=mypal.r[1],mid=mypal.r[5],high = mypal.r[9],midpoint = median(wr.sf.95$Runoff), aesthetics = c("fill","col"))+
   theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = wr.runoff , filename = "WR/wr.runoff.png",dpi = "retina", width = 6, height = 8, units = "cm")

mypal.f <- brewer.pal(name = "YlGn", n = 9)
wr.forest <- ggplot(wr.sf.95)+geom_sf(aes(fill=Forest,col=Forest))+ 
  scale_fill_gradient2(name="Proportion of forest", low=mypal.f[1],mid=mypal.f[5],high = mypal.f[9],midpoint = median(wr.sf.95$Forest), aesthetics = c("fill","col"))+
   theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = wr.forest , filename = "WR/wr.forest.png",dpi = "retina", width = 6, height = 8, units = "cm")

```

# Model prediction 1995

We model the mean TOC concentration in all the water region in 1995 based on the simple SEM model of the previous section, using NDVI, bogs and runoff as predictors.

## Neighbour matrix

```{r wr-km, eval = F}
wr.centroid <- st_centroid(wr.sf.95, of_largest_polygon = T)

wr.neigh.set <- knearneigh(wr.centroid, k = 100)
wr.neigh.nb <- knn2nb(wr.neigh.set)
wr.kmat <- nb2listw(wr.neigh.nb)
saveRDS(wr.kmat,"WR/wr.kmat.rds")
```

## Model TOC

```{r sem-model-toc-wr-95, eval = F}
library(spatialreg)
sem.fen.simple <- readRDS("sem.fen.simple.Rdata")
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")

fm <- logTOC~NDVI+logRunoff+Bog
wr.pred <- predict(sem.fen.simple,wr.sf.95,wr.kmat, pred.type = "TS",legacy.mixed = F, zero.policy = T) %>% as.data.frame()

sem.pred.wr <- cbind(wr.sf.95,wr.pred$fit)
sem.pred.wr$TOC95 <- exp(sem.pred.wr$wr.pred.fit)

saveRDS(sem.pred.wr,"WR/sem.pred.wr.rds")

map.fit <- ggplot()+geom_sf(data = st_as_sf(sem.pred.wr), aes(fill = TOC95, col = TOC95))+
  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1, 
                       name = "Modelled TOC 1995 (mg/L)")+
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = map.fit, filename = "WR/wr.toc.png",dpi = "retina", width = 6, height = 8, units = "cm")

map.log <- ggplot()+geom_sf(data = sem.pred.wr, aes(fill = wr.pred.fit, col = wr.pred.fit))+
  scale_fill_distiller(type = "seq", palette = 8, aesthetics = c("colour","fill"), direction = 1, 
                       name = "Modelled log(TOC)")+
   theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
  
ggsave(plot = map.log, filename = "WR/wr.log.toc.png",dpi = "retina", width = 6, height = 8, units = "cm")
```


# Forecast

## Forecast of predictors

### Forecast NDVI 

#### Extract future temperature and precipitation 

```{r extract-future-temp, eval = F}
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")

ssp126.cnrm.temp <- raster::raster("worldclim_future/wc2.1_2.5m_bioc_CNRM-CM6-1_ssp126_2041-2060.tif", band = 1)
ssp370.cnrm.temp <- raster::raster("worldclim_future/wc2.1_2.5m_bioc_CNRM-CM6-1_ssp370_2041-2060.tif", band = 1)

ssp126.temp.wr <- raster::extract(ssp126.cnrm.temp,select(wr.sf.95,c("gid","geometry")),fun=mean,df = T, sp = T, na.rm =T)
names(ssp126.temp.wr) <- c("gid", "temp126")
saveRDS(ssp126.temp.wr,"WR/ssp126.temp.wr.rds")

ssp370.temp.wr <- raster::extract(ssp370.cnrm.temp,select(wr.sf.95,c("gid","geometry")),fun=mean,df = T, sp = T, na.rm = T)
names(ssp370.temp.wr) <- c("gid", "temp370")
saveRDS(ssp370.temp.wr,"WR/ssp370.temp.wr.rds")
```

```{r extract-future-temp-2100, eval = F}
wr.sf <- readRDS("WR/wr.sf.rds")

raster.ssp126.temp.2100 <- raster::raster("worldclim_future/wc2.1_30s_bioc_CNRM-CM6-1-HR_ssp126_2081-2100.tif", band = 1)
raster.ssp370.temp.2100 <- raster::raster("worldclim_future/wc2.1_30s_bioc_CNRM-CM6-1-HR_ssp370_2081-2100.tif", band = 1)

ssp126.temp.2100 <- raster::extract(raster.ssp126.temp.2100,dplyr::select(wr.sf,c("gid","geom")),fun=mean,df = T, sp = T, na.rm =T)
names(ssp126.temp.2100) <- c("gid", "temp126.2100")
saveRDS(ssp126.temp.2100,"WR/ssp126.temp.2100.rds")

ssp370.temp.2100 <- raster::extract(raster.ssp370.temp.2100,dplyr::select(wr.sf,c("gid","geom")),fun=mean,df = T, sp = T, na.rm = T)
names(ssp370.temp.2100) <- c("gid", "temp370.2100")
saveRDS(ssp370.temp.2100,"WR/ssp370.temp.2100.rds")
```

```{r extract-future-prec, eval = F}
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")

ssp126.cnrm.prec <- raster::raster("worldclim_future/wc2.1_2.5m_bioc_CNRM-CM6-1_ssp126_2041-2060.tif", band = 12)
ssp370.cnrm.prec <- raster::raster("worldclim_future/wc2.1_2.5m_bioc_CNRM-CM6-1_ssp370_2041-2060.tif", band = 12)

ssp126.prec.wr <- raster::extract(ssp126.cnrm.prec,select(wr.sf.95,c("gid","geometry")),fun=mean,df = T, sp = T, na.rm = T)
names(ssp126.prec.wr) <- c("gid", "prec126")
saveRDS(ssp126.prec.wr,"WR/ssp126.prec.wr.rds")

ssp370.prec.wr <- raster::extract(ssp370.cnrm.prec,dplyr::select(wr.sf.95,c("gid","geometry")),fun=mean,df = T, sp = T, na.rm = T)
names(ssp370.prec.wr) <- c("gid", "prec370")
saveRDS(ssp370.prec.wr,"WR/ssp370.prec.wr.rds")
```

```{r extract-future-prec-2100, eval = F}
wr.sf <- readRDS("WR/wr.sf.rds")

raster.ssp126.prec.2100 <- raster::raster("worldclim_future/wc2.1_30s_bioc_CNRM-CM6-1-HR_ssp126_2081-2100.tif", band = 12)
raster.ssp370.prec.2100.mean <- raster::raster("worldclim_future/wc2.1_30s_bioc_CNRM-CM6-1-HR_ssp370_2081-2100.tif", band = 12)

ssp126.prec.2100 <- raster::extract(raster.ssp126.prec.2100,dplyr::select(wr.sf,c("gid","geom")),fun=mean,df = T, sp = T, na.rm = T)
names(ssp126.prec.2100) <- c("gid", "prec126.2100")
saveRDS(ssp126.prec.2100,"WR/ssp126.prec.2100.rds")

ssp370.prec.2100 <- raster::extract(raster.ssp370.prec.2100.mean,dplyr::select(wr.sf,c("gid","geom")),fun=mean,df = T, sp = T, na.rm = T)
names(ssp370.prec.2100) <- c("gid", "prec370.2100")
saveRDS(ssp370.prec.2100,"WR/ssp370.prec.2100.rds")
```

```{r merge-temp-prec, eval = F}
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")

ssp126.temp.wr <- readRDS("WR/ssp126.temp.wr.rds")
ssp370.temp.wr <- readRDS("WR/ssp370.temp.wr.rds")
ssp126.prec.wr <- readRDS("WR/ssp126.prec.wr.rds")
ssp370.prec.wr <- readRDS("WR/ssp370.prec.wr.rds")

ssp126.temp.2100 <- readRDS("WR/ssp126.temp.2100.rds")
ssp370.temp.2100 <- readRDS("WR/ssp370.temp.2100.rds")
ssp126.prec.2100 <- readRDS("WR/ssp126.prec.2100.rds")
ssp370.prec.2100 <- readRDS("WR/ssp370.prec.2100.rds")

# SSP126
df.ssp126 <- dplyr::select(wr.sf.95, c("gid","area","Alt","Slope","Latitude")) %>% merge(ssp126.temp.wr, by = "gid") %>% merge(ssp126.prec.wr, by = "gid") %>% setNames(c("gid","area","Alt","Slope","Latitude","Temp","Precip","geometry")) 
saveRDS(df.ssp126, "WR/df.ssp126.rds")

# SSP 370
df.ssp370 <- dplyr::select(wr.sf.95, c("gid","area","Alt","Slope","Latitude")) %>% merge(ssp370.temp.wr, by = "gid") %>% merge(ssp370.prec.wr, by = "gid") %>% setNames(c("gid","area","Alt","Slope","Latitude","Temp","Precip","geometry")) 
saveRDS(df.ssp370, "WR/df.ssp370.rds")

# SSP126 2100
df.ssp126.2100 <- dplyr::select(wr.sf.95, c("gid","area","Alt","Slope","Latitude")) %>% merge(ssp126.temp.2100, by = "gid") %>% merge(ssp126.prec.2100, by = "gid") %>% setNames(c("gid","area","Alt","Slope","Latitude","Temp","Precip","geometry")) 
saveRDS(df.ssp126.2100, "WR/df.ssp126.2100.rds")

# SSP 370 2100
df.ssp370.2100 <- dplyr::select(wr.sf.95, c("gid","area","Alt","Slope","Latitude")) %>% merge(ssp370.temp.2100, by = "gid") %>% merge(ssp370.prec.2100, by = "gid") %>% setNames(c("gid","area","Alt","Slope","Latitude","Temp","Precip","geometry")) 
saveRDS(df.ssp370.2100, "WR/df.ssp370.2100.rds")

```


#### NDVI model based on past temperature and precipitation values

We model NDVI based on temperature and precipitation, and use this model to predict the future NDVI in 2050. 
Choice of future data: ssp 126 as best scenario, ssp 370 as worse scenario @Hausfather2019 @CORDEX2021
CRNM according to @Raju2020

Using a SELM model for NDVI, we notice that high residuals are observed in catchments where original NDVI is lower than 0,4. Myers-Smith et al. @Myers-Smith2020 show that the relationship between NDVI and the Arctic biomass is not linear: under 0,4, an increase in NDVI reflects the vegetalisation of bare ground, while over 0,4, an increase of NDVI reflects an increased productivity in established forests. 


```{r ndvi-model, eval = F}
wr.kmat <- readRDS("WR/wr.kmat.rds")
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")

cor.ndvi <- wr.sf.95 %>% st_drop_geometry() %>% cor()
corrplot::corrplot(cor.ndvi, method = "number")

ndvi.model <- errorsarlm(formula = NDVI~Temp+log(Precip)+log(Alt), data = wr.sf.95, listw = wr.kmat)
AIC <- 2*(3-1)-2*ndvi.model$LL
plot(wr.sf.95$NDVI, ndvi.model$fitted.values)
abline(a = 0, b = 1)

saveRDS(ndvi.model, "WR/ndvi.model.rds")

sem.residuals <- cbind(wr.sf.95, ndvi.model$residuals)

ndvi.sem.residuals.plot <- ggplot(sem.residuals)+geom_sf(aes(fill=ndvi.model.residuals,col=ndvi.model.residuals))+
  scale_fill_gradient2(low="#B03060",mid="#FFFFBF",high = "#008B45",midpoint = 0, aesthetics = c("fill","col"),
                       name = "NDVI model residuals") + 
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
ggsave(plot = ndvi.sem.residuals.plot,filename = "WR/ndvi.sem.residuals.plot.png",dpi = "retina", width = 6, height = 8, units = "cm")
```

```{r tests-ndvi, eval = F}
library(betareg)
library(VGAM)

# tests
regmat <- wr.sf.95 %>% st_drop_geometry() %>% select(c("Alt","Temp","Precip")) %>% as.matrix()

beta.ndvi <- betareg.fit(x = regmat, y = wr.sf.95$NDVI, type = "BR", 
                         weights = wr.sf.95$area, control = betareg.control(phi =F))
beta.ndvi <- betareg(NDVI ~ Temp+Alt+area, data = wr.sf.95, link = "logit", weights = wr.sf.95$area)

plot(wr.sf.95$NDVI, beta.ndvi$fitted.values)

spatial.beta.ndvi <- errorsarlm(formula = logclink(NDVI)~Temp+log(Precip)+log(Alt), data = fennoscandia, listw = k.neigh.w)
plot(logclink(fennoscandia$NDVI), spatial.beta.ndvi$fitted.values)
plot(fennoscandia$NDVI, logclink(spatial.beta.ndvi$fitted.values))


beta.resi <- cbind(wr.sf.95, spatial.beta.ndvi$residuals)
ggplot(beta.resi)+geom_point(aes(x = Longitude, y = Latitude, col = spatial.beta.ndvi.residuals))+scale_color_gradient2(high = "darkgreen", low = "red", mid = "white", midpoint = 0)

beta.resi.plot <- ggplot(beta.resi)+geom_sf(aes(fill = spatial.beta.ndvi.residuals, col = spatial.beta.ndvi.residuals))+scale_color_gradient2(high = "darkgreen", low = "red", mid = "white", midpoint = 0, aesthetics = c("fill", "col"))+theme_classic(base_size = 6)+theme(legend.position = "bottom")
ggsave(plot = beta.resi.plot, filename = "WR/beta.resi.png",dpi = "retina", width = 6, height = 8, units = "cm")


# quadratic
summary(m1 <- lm(NDVI ~ (Temp + I(Temp^2)) * (log(Precip) + I(log(Precip)^2)), data = wr.sf.95))
summary(m1 <- step(m1))
plot(wr.sf.95$NDVI, predict(m1),  pch = ".", main="NDVI", xlab="Observed", ylab="Predicted - quadratic",abline(0,1))

#poly 
summary(m2 <- lm(NDVI ~ poly(cbind(Temp, log(Precip)), degree = 5), data = wr.sf.95))
summary(m2 <- step(m2))
plot(wr.sf.95$NDVI, predict(m2),  pch = ".", main="NDVI", xlab="Observed", ylab="Predicted - poly ",abline(0,1))

#lm
summary(m3 <- lm(NDVI ~ Temp * log(Precip), data = wr.sf.95))
summary(m3 <- step(m3))
plot(wr.sf.95$NDVI, predict(m3),  pch = ".", main="NDVI", xlab="Observed", ylab="Predicted",abline(0,1))


```

```{r ndvi-model-fen}
fennoscandia <- readRDS("fennoscandia.rds")
fennoscandia.spdf <- readRDS("fennoscandia.spdf.rds")
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")

quadra.lm.ndvi <- lm(NDVI ~ (Temp + I(Temp^2)) * (log(Precip) + I(log(Precip)^2)), data = fennoscandia)
quadra.lm.ndvi <- step(quadra.lm.ndvi)
summary(quadra.lm.ndvi)
plot(fennoscandia$NDVI, quadra.lm.ndvi$fitted.values)

fennoscandia.ndvi.model <- fennoscandia.spdf %>% st_as_sf() %>% mutate(ndvi.residuals = quadra.lm.ndvi$residuals) 

ggplot(fennoscandia.ndvi.model)+geom_point(aes(x=longitude, y = latitude, col = quadra.lm.ndvi$residuals))+
  scale_color_gradient2(high = "darkgreen", low = "red", mid = "white", midpoint = 0, aesthetics = c("fill", "col"))+theme_classic(base_size = 6)+theme(legend.position = "bottom")
resi.plot <- ggplot(fennoscandia.ndvi.model)+geom_sf(aes(fill = ndvi.residuals, col = ndvi.residuals), size = 0.5)+
  scale_color_gradient2(high = "darkgreen", low = "red", mid = "white", midpoint = 0, aesthetics = c("fill", "col"))+theme_classic(base_size = 6)+theme(legend.position = "bottom")
ggsave(plot = resi.plot,filename = "WR/quadra.ndvi.residuals.plot.png",dpi = "retina", width = 6, height = 8, units = "cm")

wr.ndvi.test.2 <- predict(object = quadra.lm.ndvi, newdata = wr.sf.95)
plot(wr.sf.95$NDVI, wr.ndvi.test.2)
wr.ndvi.model <- wr.sf.95 %>% mutate(ndvi.predicted = wr.ndvi.test.2, ndvi.residuals = wr.ndvi.test.2-wr.sf.95$NDVI)

resi.plot.wr <- ggplot(wr.ndvi.model)+geom_sf(aes(fill = ndvi.residuals, col = ndvi.residuals), size = 0.5)+
  scale_color_gradient2(high = "darkgreen", low = "red", mid = "white", midpoint = 0, aesthetics = c("fill", "col"))+theme_classic(base_size = 6)+theme(legend.position = "bottom")
ggsave(plot = resi.plot.wr,filename = "WR/wr.ndvi.residuals.plot.png",dpi = "retina", width = 6, height = 8, units = "cm")
```


#### Forecast NDVI in 2050 and 2100

```{r model-future-ndvi, eval = F}
df.ssp126 <- readRDS("WR/df.ssp126.rds")
df.ssp370 <- readRDS("WR/df.ssp370.rds")
df.ssp126.2100 <- readRDS("WR/df.ssp126.2100.rds")
df.ssp370.2100 <- readRDS("WR/df.ssp370.2100.rds")
ndvi.model <- readRDS("WR/ndvi.model.rds")
wr.kmat <- readRDS("WR/wr.kmat.rds")
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")

#NDVI 126 2050
ndvi.ssp126.fit <- predict(object = spatial.beta.ndvi, newdata = df.ssp126, pred.type = "TS", legacy.mixed = F, zero.policy = T) %>% as.data.frame() %>% setNames(c("ndvi","trend","signal"))

plot(wr.sf.95$NDVI, logclink(ndvi.ssp126.fit$ndvi, inverse = T))
plot(logclink(wr.sf.95$NDVI), ndvi.ssp126.fit$ndvi)

ndvi.ssp126.fit <- predict(object = quadra.lm.ndvi, newdata = df.ssp126) 

plot(wr.sf.95$NDVI, ndvi.ssp126.fit)

ndvi.ssp126 <- cbind(df.ssp126, ndvi.ssp126.fit) %>% setNames(c("gid","area","Alt","Slope","Latitude","Temp","Precip","NDVI","trend","signal","geometry"))

saveRDS(ndvi.ssp126,"WR/ndvi.ssp126.rds")

# NDVI 370 2050
ndvi.ssp370.fit <- predict(object = ndvi.model, newdata = df.ssp370, listw = wr.kmat, pred.type = "TS", legacy.mixed = F, zero.policy = T) %>% as.data.frame() %>% setNames(c("ndvi","trend","signal"))

ndvi.ssp370 <- cbind(df.ssp370, ndvi.ssp370.fit) %>% setNames(c("gid","area","Alt","Slope","Latitude","Temp","Precip","NDVI","trend","signal","geometry"))

saveRDS(ndvi.ssp370,"WR/ndvi.ssp370.rds")


#NDVI 126 2010
ndvi.ssp126.2100.fit <- predict(object = ndvi.model, newdata = df.ssp126.2100, pred.type = "TS", legacy.mixed = F, zero.policy = T) %>% as.data.frame() %>% setNames(c("ndvi","trend","signal"))

ndvi.ssp126.2100 <- cbind(df.ssp126.2100, ndvi.ssp126.2100.fit) %>% setNames(c("gid","area","Alt","Slope","Latitude","Temp","Precip","NDVI","trend","signal","geometry"))

saveRDS(ndvi.ssp126.2100,"WR/ndvi.ssp126.2100.rds")


#NDVI 370 2100
ndvi.ssp370.2100.fit <- predict(object = ndvi.model, newdata = df.ssp370.2100, listw = wr.kmat, pred.type = "TS", legacy.mixed = F, zero.policy = T) %>% setNames(c("ndvi","trend","signal"))
ndvi.ssp370.2100 <- cbind(df.ssp370.2100, ndvi.ssp370.2100.fit) %>% setNames(c("gid","area","Alt","Slope","Latitude","Temp","Precip","NDVI","trend","signal","geometry"))

saveRDS(ndvi.ssp370.2100,"WR/ndvi.ssp370.2100.rds")

```

```{r model-future-ndvi-quadra, eval = F}
df.ssp126 <- readRDS("WR/df.ssp126.rds")
df.ssp370 <- readRDS("WR/df.ssp370.rds")
df.ssp126.2100 <- readRDS("WR/df.ssp126.2100.rds")
df.ssp370.2100 <- readRDS("WR/df.ssp370.2100.rds")
ndvi.model <- readRDS("WR/ndvi.model.rds")
wr.kmat <- readRDS("WR/wr.kmat.rds")
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")

#NDVI 126 2050

ndvi.ssp126.fit <- predict(object = quadra.lm.ndvi, newdata = df.ssp126) 
plot(wr.sf.95$NDVI, ndvi.ssp126.fit)

ndvi.ssp126 <- cbind(df.ssp126, ndvi.ssp126.fit) %>% setNames(c("gid","area","Alt","Slope","Latitude","Temp","Precip","NDVI","geometry"))

saveRDS(ndvi.ssp126,"WR/ndvi.ssp126.rds")

# NDVI 370 2050
ndvi.ssp370.fit <- predict(object = quadra.lm.ndvi, newdata = df.ssp370)

ndvi.ssp370 <- cbind(df.ssp370, ndvi.ssp370.fit) %>% setNames(c("gid","area","Alt","Slope","Latitude","Temp","Precip","NDVI","geometry"))

saveRDS(ndvi.ssp370,"WR/ndvi.ssp370.rds")


#NDVI 126 2010
ndvi.ssp126.2100.fit <- predict(object = quadra.lm.ndvi, newdata = df.ssp126.2100)

ndvi.ssp126.2100 <- cbind(df.ssp126.2100, ndvi.ssp126.2100.fit) %>% setNames(c("gid","area","Alt","Slope","Latitude","Temp","Precip","NDVI","geometry"))

saveRDS(ndvi.ssp126.2100,"WR/ndvi.ssp126.2100.rds")


#NDVI 370 2100
ndvi.ssp370.2100.fit <- predict(object = quadra.lm.ndvi, newdata = df.ssp370.2100)
ndvi.ssp370.2100 <- cbind(df.ssp370.2100, ndvi.ssp370.2100.fit) %>% setNames(c("gid","area","Alt","Slope","Latitude","Temp","Precip","NDVI","geometry"))

saveRDS(ndvi.ssp370.2100,"WR/ndvi.ssp370.2100.rds")

```


### Forecast runoff 2050 and 2100


In the historical dataset in Worldclim, the runoff is given as a yearly average in kg/m2/s, or mm/s. 

In the CNRM-CM6 forecast we get the monthly forecast for runoff (in mm/s) and convert it in mm/y.

```{r extract-future-runoff, eval = F}
wr.sf <- readRDS("WR/wr.sf.rds")

ssp126.runoff.wr <- raster::stack("CORDEX_future/mrros_Lmon_CNRM-CM6-1-HR_ssp126_r1i1p1f2_gr_201501-210012.nc", bands = c(313:552))
ssp126.runoff.wr.mean <- ssp126.runoff.wr %>% mean() 

ssp126.runoff <- raster::extract(ssp126.runoff.wr.mean,dplyr::select(wr.sf,c("gid","geom")),fun=mean,df = T, sp = T)
names(ssp126.runoff) <- c("gid","runoff")
ssp126.runoff$Runoff <- ssp126.runoff$runoff *365*24*60*60
saveRDS(ssp126.runoff,"WR/ssp126.runoff.rds")

ssp370.runoff.wr <- raster::stack("CORDEX_future/mrros_Lmon_CNRM-CM6-1-HR_ssp370_r1i1p1f2_gr_201501-210012.nc", bands = c(313:552))
ssp370.runoff.wr.mean <- ssp370.runoff.wr %>% mean()

ssp370.runoff <- raster::extract(ssp370.runoff.wr.mean,dplyr::select(wr.sf,c("gid","geom")),fun=mean,df = T, sp = T)
names(ssp370.runoff) <- c("gid","runoff")
ssp370.runoff$Runoff <- ssp370.runoff$runoff *365*24*60*60

saveRDS(ssp370.runoff,"WR/ssp370.runoff.rds")
```

```{r extract-future-runoff-2100, eval = F}
wr.sf <- readRDS("WR/wr.sf.rds")

raster.ssp126.runoff.2100 <- raster::stack("CORDEX_future/mrros_Lmon_CNRM-CM6-1-HR_ssp126_r1i1p1f2_gr_201501-210012.nc", bands = c(805:1032))
raster.ssp126.runoff.2100.mean <- raster.ssp126.runoff.2100 %>% mean() 

ssp126.runoff.2100 <- raster::extract(raster.ssp126.runoff.2100.mean,dplyr::select(wr.sf,c("gid","geom")),fun=mean,df = T, sp = T)
names(ssp126.runoff.2100) <- c("gid","runoff")
ssp126.runoff.2100$Runoff <- ssp126.runoff.2100$runoff *365*24*60*60
saveRDS(ssp126.runoff.2100,"WR/ssp126.runoff.2100.rds")

raster.ssp370.runoff.2100 <- raster::stack("CORDEX_future/mrros_Lmon_CNRM-CM6-1-HR_ssp370_r1i1p1f2_gr_201501-210012.nc", bands = c(805:1032))
raster.ssp370.runoff.2100.mean <- raster.ssp370.runoff.2100 %>% mean()

ssp370.runoff.2100 <- raster::extract(raster.ssp370.runoff.2100.mean,dplyr::select(wr.sf,c("gid","geom")),fun=mean,df = T, sp = T)
names(ssp370.runoff.2100) <- c("gid","runoff")
ssp370.runoff.2100$Runoff <- ssp370.runoff.2100$runoff *365*24*60*60
saveRDS(ssp370.runoff.2100,"WR/ssp370.runoff.2100.rds")
```




### Gather datasets and plot

```{r future-wr, eval = F}
ndvi.ssp126 <- readRDS("WR/ndvi.ssp126.rds")
ndvi.ssp370 <- readRDS("WR/ndvi.ssp370.rds") 
ssp126.runoff <- readRDS("WR/ssp126.runoff.rds")
ssp370.runoff <- readRDS("WR/ssp370.runoff.rds")

ndvi.ssp126.2100 <- readRDS("WR/ndvi.ssp126.2100.rds")
ndvi.ssp370.2100 <- readRDS("WR/ndvi.ssp370.2100.rds") 
ssp126.runoff.2100 <- readRDS("WR/ssp126.runoff.2100.rds")
ssp370.runoff.2100 <- readRDS("WR/ssp370.runoff.2100.rds")

wr.sf.95 <- readRDS("WR/wr.sf.95.rds")

# 2050 -----

wr.sf.126.2050 <- dplyr::select(wr.sf.95, c("gid","Bog","Runoff","logRunoff","Temp","Precip","NDVI")) %>% setNames(c("gid","Bog","Runoff95","logRunoff95","Temp95","Prec95","NDVI95","geometry")) %>% merge(st_drop_geometry(ndvi.ssp126), by = "gid") %>% merge(st_drop_geometry(st_as_sf(ssp126.runoff)), by = "gid")

wr.sf.370.2050 <- dplyr::select(wr.sf.95, c("gid","Bog","Runoff","logRunoff","Temp","Precip","NDVI")) %>% setNames(c("gid","Bog","Runoff95","logRunoff95","Temp95","Prec95","NDVI95","geometry")) %>% merge(st_drop_geometry(ndvi.ssp370), by = "gid") %>% merge(st_drop_geometry(st_as_sf(ssp370.runoff)), by = "gid")

na.lines.126 <- which(complete.cases(st_drop_geometry(wr.sf.126.2050))==F)
na.lines.370 <- which(complete.cases(st_drop_geometry(wr.sf.370.2050))==F)

wr.sf.126.2050 <- wr.sf.126.2050[-na.lines.126,]
wr.sf.370.2050 <- wr.sf.370.2050[-na.lines.370,]

wr.sf.126.2050$logRunoff <- wr.sf.126.2050$Runoff %>% log()
wr.sf.370.2050$logRunoff <- wr.sf.370.2050$Runoff %>% log()

saveRDS(wr.sf.126.2050, "WR/wr.sf.126.2050.rds")
saveRDS(wr.sf.370.2050, "WR/wr.sf.370.2050.rds")

# 2100 ----

wr.sf.126.2100 <- dplyr::select(wr.sf.95, c("gid","Bog","Runoff","logRunoff","Temp","Precip","NDVI")) %>% setNames(c("gid","Bog","Runoff95","logRunoff95","Temp95","Prec95","NDVI95","geometry")) %>% merge(st_drop_geometry(ndvi.ssp126.2100), by = "gid") %>% merge(st_drop_geometry(st_as_sf(ssp126.runoff.2100)), by = "gid")

wr.sf.370.2100 <- dplyr::select(wr.sf.95, c("gid","Bog","Runoff","logRunoff","Temp","Precip","NDVI")) %>% setNames(c("gid","Bog","Runoff95","logRunoff95","Temp95","Prec95","NDVI95","geometry")) %>% merge(st_drop_geometry(ndvi.ssp370.2100), by = "gid") %>% merge(st_drop_geometry(st_as_sf(ssp370.runoff.2100)), by = "gid")

na.lines.126 <- which(complete.cases(st_drop_geometry(wr.sf.126.2100))==F)
na.lines.370 <- which(complete.cases(st_drop_geometry(wr.sf.370.2100))==F)

wr.sf.126.2100 <- wr.sf.126.2100[-na.lines.126,]
wr.sf.370.2100 <- wr.sf.370.2100[-na.lines.370,]

wr.sf.126.2100$logRunoff <- wr.sf.126.2100$Runoff %>% log()
wr.sf.370.2100$logRunoff <- wr.sf.370.2100$Runoff %>% log()

saveRDS(wr.sf.126.2100, "WR/wr.sf.126.2100.rds")
saveRDS(wr.sf.370.2100, "WR/wr.sf.370.2100.rds")

```

```{r create-plots-forecasts, eval = F}
wr.sf.126.2050 <- readRDS("WR/wr.sf.126.2050.rds")
wr.sf.126.2100 <- readRDS("WR/wr.sf.126.2100.rds")
wr.sf.370.2050 <- readRDS("WR/wr.sf.370.2050.rds")
wr.sf.370.2100 <- readRDS("WR/wr.sf.370.2100.rds")

diff.var <- function(sf, vars1, vars2){

      sf2 <- sf
  
    for (i in 1:length(vars2)){
    newname <- paste("diff", vars2[i], sep = "")
    
    if(vars2[i] %in% c("Temp","NDVI")){
    
    x <- sf2[,vars2[i]] %>% st_drop_geometry()
    y <- sf2[,vars1[i]] %>% st_drop_geometry()
    z <- x-y
    
    names(z) <- newname
    sf2 <- cbind(sf2, z)
    
    } else if(vars2[i] %in% c("Precip", "Runoff")){
    
    x <- sf2[,vars2[i]] %>% st_drop_geometry()
    y <- sf2[,vars1[i]] %>% st_drop_geometry()
   
    z <- x - y
    names(z) <- newname
    sf2 <- cbind(sf2, z)
    
    }
    }
      
    return(sf2)
}

wr.sf.126.2050 <- diff.var(wr.sf.126.2050, vars1 = c("Temp95","Prec95","NDVI95","Runoff95"), vars2 = c("Temp","Precip","NDVI","Runoff"))
wr.sf.370.2050 <- diff.var(wr.sf.370.2050, vars1 = c("Temp95","Prec95","NDVI95","Runoff95"), vars2 = c("Temp","Precip","NDVI","Runoff"))
wr.sf.126.2100 <- diff.var(wr.sf.126.2100, vars1 = c("Temp95","Prec95","NDVI95","Runoff95"), vars2 = c("Temp","Precip","NDVI","Runoff"))
wr.sf.370.2100 <- diff.var(wr.sf.370.2100, vars1 = c("Temp95","Prec95","NDVI95","Runoff95"), vars2 = c("Temp","Precip","NDVI","Runoff"))

list.sf <- list(wr.sf.126.2050, wr.sf.126.2100, wr.sf.370.2050, wr.sf.370.2100)
names(list.sf) <- c("SSP126.2050", "SSP126.2100", "SSP370.2050", "SSP370.2100")

all.diff <- data.frame(gid = c(wr.sf.126.2050$gid, wr.sf.370.2050$gid, wr.sf.126.2100$gid, wr.sf.370.2100$gid))

for(x in c("diffTemp","diffPrecip","diffNDVI","diffRunoff")){
  all.vec <- c()
  
  for(i in 1:length(list.sf)){
  vec <- select(st_drop_geometry(list.sf[[i]]),all_of(x))
  all.vec <<- rbind(all.vec,vec)
  }
  all.diff <- cbind(all.diff, all.vec)
}

max.lim <- apply(all.diff, 2, max, na.rm = T)
min.lim <- apply(all.diff, 2, min, na.rm = T)

# x1 <- filter(wr.sf.126.2050, NDVI95 > 0.4)
# x2 <- filter(wr.sf.370.2050, NDVI95 > 0.4)
# x3 <- filter(wr.sf.126.2100, NDVI95 > 0.4)
# x4 <- filter(wr.sf.370.2100, NDVI95 > 0.4)
# all.ndvi <- c(x1$NDVI/x1$NDVI95*100-100,x2$NDVI/x2$NDVI95*100-100, x3$NDVI/x3$NDVI95*100-100, x4$NDVI/x4$NDVI95*100-100)

palettes <- data.frame(diffTemp =  brewer.pal(name = "RdYlBu", n = 9)[c(1,5,9)],
                       diffPrecip =  brewer.pal(name = "RdYlBu", n = 9)[c(9,5,1)],
                       diffNDVI <-  brewer.pal(name = "RdYlGn", n = 9)[c(9,5,1)],
                       diffRunoff <-  brewer.pal(name = "RdYlBu", n = 9)[c(9,5,1)])
legends <- c("Difference Temperature (°C)", "Difference Precipitation (mm/y)", "Difference NDVI", "Difference Runoff (mm/y)")

diffs <- c("diffTemp","diffPrecip","diffNDVI","diffRunoff")


for(i in c(1:length(list.sf))){
  for(x in diffs[c(2,4)]){
  g <- ggplot(list.sf[[i]])+geom_sf(aes(fill = .data[[x]], col = .data[[x]])) + 
  scale_fill_gradient2(low=palettes[3, grep(x,names(palettes))],mid=palettes[2, grep(x,names(palettes))],high = palettes[1, grep(x,names(palettes))],
                       midpoint = 0, aesthetics = c("fill","col"),
                       name = paste(legends[grep(x, diffs)],"\n",names(list.sf)[i], sep = ""), limits = c(min.lim[[x]], max.lim[[x]])) + 
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
  
  ggsave(plot = g, filename = paste("WR/", names(list.sf)[i], ".", x, ".png",sep = ""),dpi = "retina", width = 6, height = 8, units = "cm")
}
}

```

```{r print-plot-forecast-temp, fig.dim = c(6,8)}
knitr::include_graphics(c("WR/SSP126.2050.diffTemp.png","WR/SSP370.2050.diffTemp.png","WR/SSP126.2100.diffTemp.png","WR/SSP370.2100.diffTemp.png"))
```

`r fig_nums("future-temp","Forecast of mean temperature intensities for the period 2041-2060 (i.e., 2050) and for the period 2081-2100 (i.e., 2100), and change in temperature compared to the average for 1995 to 2050, under SSP 1-2.6 (2ºC target) and SSP 3-7.0 (realistic worst-case) scenarios.")`

```{r print-plot-forecast-precip, fig.dim = c(6,8)}
knitr::include_graphics(c("WR/SSP126.2050.diffPrecip.png","WR/SSP370.2050.diffPrecip.png","WR/SSP126.2100.diffPrecip.png","WR/SSP370.2100.diffPrecip.png"))
```

`r fig_nums("future-precipitation","Forecast of mean precipitation intensities for the period 2041-2060 (i.e., 2050) and for the period 2081-2100 (i.e., 2100), and change in precipitation compared to the average for 1995 to 2050, under SSP 1-2.6 (2ºC target) and SSP 3-7.0 (realistic worst-case) scenarios.")`

```{r print-plot-forecast-ndvi, fig.dim = c(6,8)}
knitr::include_graphics(c("WR/SSP126.2050.diffNDVI.png","WR/SSP370.2050.diffNDVI.png","WR/SSP126.2100.diffNDVI.png","WR/SSP370.2100.diffNDVI.png"))
```

`r fig_nums("future-ndvi","Forecast of mean NDVI for the period 2041-2060 (i.e., 2050) and for the period 2081-2100 (i.e., 2100), and change in NDVI compared to the average for 1995 to 2050, under SSP 1-2.6 (2ºC target) and SSP 3-7.0 (realistic worst-case) scenarios.")`

```{r print-plot-forecast-runoff, fig.dim = c(6,8)}
knitr::include_graphics(c("WR/SSP126.2050.diffRunoff.png","WR/SSP370.2050.diffRunoff.png","WR/SSP126.2100.diffRunoff.png","WR/SSP370.2100.diffRunoff.png"))
```

`r fig_nums("future-runoff","Forecast of mean runoff intensities for the period 2041-2060 (i.e., 2050) and for the period 2081-2100 (i.e., 2100), and change in runoff compared to the average for 1995 to 2050, under SSP 1-2.6 (2ºC target) and SSP 3-7.0 (realistic worst-case) scenarios.")`

## Forecast TOC for 2050 and 2100


### Forecast TOC SSP126 2050

```{r sem-model-toc-ssp126-2050, eval = F}
sem.fen.simple <- readRDS("sem.fen.simple.Rdata")
wr.sf.126.2050 <- readRDS("WR/wr.sf.126.2050.rds")
sem.pred.wr <- readRDS("WR/sem.pred.wr.rds")

fm <- logTOC~NDVI+logRunoff+Bog

wr.pred.ssp126 <- predict(sem.fen.simple,wr.sf.126.2050,wr.kmat, pred.type = "TS",legacy.mixed = F, zero.policy = T) %>% as.data.frame()

wr.ssp126 <- cbind(wr.sf.126.2050,wr.pred.ssp126)
wr.ssp126$TOC <- exp(wr.ssp126$fit)
wr.ssp126 <- merge(wr.ssp126, select(st_drop_geometry(sem.pred.wr),c("gid","wr.pred.fit","TOC95")))
saveRDS(wr.ssp126,"WR/wr.ssp126.2050.rds")

```

### Forecast TOC SSP370 2050

```{r sem-model-toc-ssp370-2050, eval = F}
sem.fen.simple <- readRDS("sem.fen.simple.Rdata")
wr.sf.370.2050 <- readRDS("WR/wr.sf.370.2050.rds")
sem.pred.wr <- readRDS("WR/sem.pred.wr.rds")

fm <- logTOC~NDVI+logRunoff+Bog

wr.pred.ssp370 <- predict(sem.fen.simple,wr.sf.370.2050,wr.kmat, pred.type = "TS",legacy.mixed = F, zero.policy = T) %>% as.data.frame()

wr.ssp370 <- cbind(wr.sf.370.2050,wr.pred.ssp370)
wr.ssp370$TOC <- exp(wr.ssp370$fit)
wr.ssp370 <- merge(wr.ssp370, select(st_drop_geometry(sem.pred.wr),c("gid","wr.pred.fit","TOC95")))
saveRDS(wr.ssp370,"WR/wr.ssp370.2050.rds")
```

### Forecast TOC SSP126 2100

```{r sem-model-toc-ssp126-2100, eval = F}
sem.fen.simple <- readRDS("sem.fen.simple.Rdata")
wr.sf.126.2100 <- readRDS("WR/wr.sf.126.2100.rds")
sem.pred.wr <- readRDS("WR/sem.pred.wr.rds")

fm <- logTOC~NDVI+logRunoff+Bog

wr.pred.ssp126 <- predict(sem.fen.simple,wr.sf.126.2100,wr.kmat, pred.type = "TS",legacy.mixed = F, zero.policy = T) %>% as.data.frame()

wr.ssp126 <- cbind(wr.sf.126.2100,wr.pred.ssp126)
wr.ssp126$TOC <- exp(wr.ssp126$fit)
wr.ssp126 <- merge(wr.ssp126, select(st_drop_geometry(sem.pred.wr),c("gid","wr.pred.fit","TOC95")))
saveRDS(wr.ssp126,"WR/wr.ssp126.2100.rds")

```


### Forecast TOC SSP370 2100

```{r sem-model-toc-ssp370-2100, eval = F}
sem.fen.simple <- readRDS("sem.fen.simple.Rdata")
wr.sf.370.2100 <- readRDS("WR/wr.sf.370.2100.rds")
sem.pred.wr <- readRDS("WR/sem.pred.wr.rds")

fm <- logTOC~NDVI+logRunoff+Bog

wr.pred.ssp370 <- predict(sem.fen.simple,wr.sf.370.2100,wr.kmat, pred.type = "TS",legacy.mixed = F, zero.policy = T) %>% as.data.frame()

wr.ssp370 <- cbind(wr.sf.370.2100,wr.pred.ssp370)
wr.ssp370$TOC <- exp(wr.ssp370$fit)
wr.ssp370 <- merge(wr.ssp370, select(st_drop_geometry(sem.pred.wr),c("gid","wr.pred.fit","TOC95")))
saveRDS(wr.ssp370,"WR/wr.ssp370.2100.rds")
```

### Plot Forecast TOC

```{r boxplots-ssp126}
sem.pred.wr <- readRDS("WR/sem.pred.wr.rds")
wr.ssp126 <- readRDS("WR/wr.ssp126.rds")
wr.ssp370 <- readRDS("WR/wr.ssp370.rds")

temperature <- c(sem.pred.wr$Temp,wr.ssp126$temp126,wr.ssp370$temp370)
precipitation <- c(sem.pred.wr$Precip,wr.ssp126$prec126,wr.ssp370$prec370)
ndvi <- c(sem.pred.wr$NDVI,wr.ssp126$ndvi126,wr.ssp370$ndvi370)
runoff <- c(sem.pred.wr$Runoff,wr.ssp126$runoff126,wr.ssp370$runoff370)
toc <- c(sem.pred.wr$TOC95,wr.ssp126$toc,wr.ssp370$toc)

neworder <- c("1995","SSP126","SSP370")
model <- factor(c(rep("1995",dim(sem.pred.wr)[1]),rep("SSP126", dim(wr.ssp126)[1]), rep("SSP370", dim(wr.ssp370)[1])),levels = neworder)

compare.ssp <- data.frame(value = c(temperature, precipitation, ndvi, runoff,toc), variable = c(rep("Temperature (°C)", length(temperature)), rep("Precipitation (mm)", length(precipitation)), rep("NDVI",length(ndvi)), rep("Runoff (mm/y)",length(runoff)), rep("TOC (mg/L)", length(toc))), model = rep(model,5)) 

ggplot(compare.ssp)+geom_boxplot(aes(y= value,col=variable))+
  labs(y="", x = "")+scale_color_brewer(type = "seq",palette = "Dark2",direction = -1)+
  theme_minimal()+
  theme(legend.position = "", axis.text.x = element_blank())+
  facet_grid(cols = vars(model), rows = vars(factor(variable, levels = c("Temperature (°C)","Precipitation (mm)","NDVI","Runoff (mm/y)","TOC (mg/L)"))), scales = "free_y", shrink = T)
ggsave("WR/compare.ssp.png", width = 10, height = 20, units = "cm", dpi = "retina")

```

```{r plots-forecast-toc, eval = F}
wr.ssp126.2050 <- readRDS("WR/wr.ssp126.2050.rds")
wr.ssp370.2050 <- readRDS("WR/wr.ssp370.2050.rds")
wr.ssp126.2100 <- readRDS("WR/wr.ssp126.2100.rds")
wr.ssp370.2100 <- readRDS("WR/wr.ssp370.2100.rds")

diff.var <- function(sf, vars1, vars2){

      sf2 <- sf
  
    newname <- paste("diff", vars2, sep = "")
    
    x <- sf2[,vars2] %>% st_drop_geometry()
    y <- sf2[,vars1] %>% st_drop_geometry()
    z <- x-y
    
    names(z) <- newname
    sf2 <- cbind(sf2, z)
    
    newname2 <- paste("diff", vars2,".percent", sep = "")
    
    w <- x/y*100-100
    names(w) <- newname2
    sf2 <- cbind(sf2, w)
    
    return(sf2)
}

wr.ssp126.2050 <- diff.var(wr.ssp126.2050, vars1 = c("TOC95"), vars2 = c("TOC"))
wr.ssp370.2050 <- diff.var(wr.ssp370.2050, vars1 = c("TOC95"), vars2 = c("TOC"))
wr.ssp126.2100 <- diff.var(wr.ssp126.2100, vars1 = c("TOC95"), vars2 = c("TOC"))
wr.ssp370.2100 <- diff.var(wr.ssp370.2100, vars1 = c("TOC95"), vars2 = c("TOC"))

list.sf <- list(wr.ssp126.2050, wr.ssp126.2100, wr.ssp370.2050, wr.ssp370.2100)
names(list.sf) <- c("SSP126.2050", "SSP126.2100", "SSP370.2050", "SSP370.2100")

all.diff <- data.frame(gid = c(wr.ssp126.2050$gid, wr.ssp370.2050$gid, wr.ssp126.2100$gid, wr.ssp370.2100$gid))

for(x in c("diffTOC","diffTOC.percent")){
  all.vec <- c()
  
  for(i in 1:length(list.sf)){
  vec <- select(st_drop_geometry(list.sf[[i]]),all_of(x))
  all.vec <<- rbind(all.vec,vec)
  }
  all.diff <- cbind(all.diff, all.vec)
}

max.lim <- apply(all.diff, 2, max, na.rm = T)
min.lim <- apply(all.diff, 2, min, na.rm = T)

palettes <- data.frame(diffTOC =  brewer.pal(name = "RdBu", n = 9)[c(1,5,9)],
                       diffTOC.percent = brewer.pal(name = "RdBu", n = 9)[c(1,5,9)])
legends <- c("Difference TOC (mg/L)", "Difference TOC (%)")

diffs <- c("diffTOC","diffTOC.percent")


for(i in c(1:length(list.sf))){
  for(x in diffs){
  g <- ggplot(list.sf[[i]])+geom_sf(aes(fill = .data[[x]], col = .data[[x]])) + 
  scale_fill_gradient2(low=palettes[3, grep(x,names(palettes))],
                       mid=palettes[2, grep(x,names(palettes))],
                       high = palettes[1, grep(x,names(palettes))],
                       midpoint = 0, aesthetics = c("fill","col"),
                       name = paste(legends[grep(x, diffs)],"\n",names(list.sf)[i], sep = ""), 
                       limits = c(min.lim[[x]], max.lim[[x]]))+
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
  
  ggsave(plot = g, filename = paste("WR/", names(list.sf)[i], ".", x, ".png",sep = ""),dpi = "retina", width = 6, height = 8, units = "cm")
}
}


      
for(i in c(1:length(list.sf))){
  for(x in diffs[1]){
  g <- ggplot(list.sf[[i]])+geom_sf(aes(fill = .data[[x]], col = .data[[x]])) + 
  scale_fill_gradientn(colors = brewer.pal(name = "RdBu", n = 3), limits = c(-5,8), values = c(0,0.38,1), aesthetics = c("fill","col"),  
                       name = paste(legends[grep(x, diffs)],"\n",names(list.sf)[i], sep = "")) + 
  theme_minimal(base_size = 6)+
  theme(legend.position = "bottom")
  
  ggsave(plot = g, filename = paste("WR/", names(list.sf)[i], ".", x, ".png",sep = ""),dpi = "retina", width = 6, height = 8, units = "cm")
}
}                




```

# Sea watersheds

The drainage basin of the Baltic sea was 
https://sdi.eea.europa.eu/catalogue/srv/eng/catalog.search#/metadata/f86c56e9-d8a0-42ba-b1c7-

Baltic sea drainage basin: https://www.grida.no/resources/5324

Approximately matching the borders Norway/Sweden/Finland. 

```{r compute-discharge}
wr.sf.95 <- readRDS("WR/wr.sf.95.rds")
wr.centroid <- st_centroid(wr.sf.95, of_largest_polygon = T) %>% select("gid","geometry")
sem.pred.wr <- readRDS("WR/sem.pred.wr.rds")

nor <- st_read("Country_shapefile/norway.shp") %>% st_transform(st_crs(wr.centroid))
swe <- st_read("Country_shapefile/sweden.shp") %>% st_transform(st_crs(wr.centroid))
fin <- st_read("Country_shapefile/finland.shp") %>% st_transform(st_crs(wr.centroid))

wr.norge <- wr.centroid[nor,]
wr.norge$Nation <- "Norway"
wr.sweden <- wr.centroid[swe,]
wr.sweden$Nation <- "Sweden"
wr.finland <- wr.centroid[fin,]
wr.finland$Nation <- "Finland"
wr.nation <- rbind(wr.norge,wr.sweden,wr.finland)

wr.sf.95 <- wr.sf.95 %>% sp::merge(dplyr::select(st_drop_geometry(wr.nation), c("gid","Nation")), by = "gid") %>% sp::merge(dplyr::select(st_drop_geometry(sem.pred.wr), c("gid","wr.pred.fit","TOC95")), by = "gid")
names(wr.sf.95[which(names(wr.sf.95) == "TOC95")]) <- "TOC"

wr.ssp126.2050 <- readRDS("WR/wr.ssp126.2050.rds")%>% sp::merge(dplyr::select(st_drop_geometry(wr.nation), c("gid","Nation")), by = "gid") 
wr.ssp370.2050 <- readRDS("WR/wr.ssp370.2050.rds") %>% sp::merge(dplyr::select(st_drop_geometry(wr.nation), c("gid","Nation")), by = "gid") 
wr.ssp126.2100 <- readRDS("WR/wr.ssp126.2100.rds") %>% sp::merge(dplyr::select(st_drop_geometry(wr.nation), c("gid","Nation")), by = "gid") 
wr.ssp370.2100 <- readRDS("WR/wr.ssp370.2100.rds") %>% sp::merge(dplyr::select(st_drop_geometry(wr.nation), c("gid","Nation")), by = "gid") 

list.sf <- list(wr.sf.95, wr.ssp126.2050, wr.ssp126.2100, wr.ssp370.2050, wr.ssp370.2100)
names(list.sf) <- c("Data1995","SSP126.2050", "SSP126.2100", "SSP370.2050", "SSP370.2100")

export <- function(sf){
  discharge <- sf$Runoff*sf$area # Q in L/y
  toc.export <- discharge * sf$TOC * 10^(-15) # amount of exported TOC in Tg/y 
  sf2 <- cbind(sf,discharge,toc.export)
  return(sf2)
}

list.sf <- lapply(list.sf, export)

list.mean <- c()

for(i in 1:length(list.sf)){
  list.mean[[i]] <- list.sf[[i]] %>% st_drop_geometry() %>% group_by(Nation) %>% summarise(total = sum(toc.export)) %>% as.data.frame()
}

names(list.mean) <- names(list.sf)

list.diff <- c()

for(i in 1:length(list.mean)){
  df1 <- list.mean[[1]]
  df2 <- list.mean[[i]]
  diff <- df2[,2] - df1[,2]
  
  x <- cbind(list.mean[[i]],diff)
  names(x) <- c("Nation", names(list.mean)[i], paste("diff", names(list.mean)[i], sep = ""))
  list.diff[[i]] <- x
}

toc.export.df <- list.diff[[1]] %>% merge(list.diff[[2]], by = "Nation") %>% merge(list.diff[[3]], by = "Nation") %>% merge(list.diff[[4]], by = "Nation") %>% merge(list.diff[[5]], by = "Nation") %>% melt(id.vars = c("Nation"), value.name = "TOC_ton")

toc.export.df$Model <- NA
m.126 <- grep("126",toc.export.df$variable)
m.370 <- grep("370",toc.export.df$variable)

toc.export.df$Model[m.126] <- "SSP126"
toc.export.df$Model[m.370] <- "SSP370"
toc.export.df$Model[-c(m.126,m.370)] <- "Historical"

toc.export.df$Year <- NA
m.95 <- grep("95",toc.export.df$variable)
m.2050 <- grep("2050",toc.export.df$variable)
m.2100 <- grep("2100",toc.export.df$variable)

toc.export.df$Year[m.95] <- "1995"
toc.export.df$Year[m.2050] <- "2050"
toc.export.df$Year[m.2100] <- "2100"

toc.export.df$Diff <- NA
m.d <- grep("diff",toc.export.df$variable)

toc.export.df$Diff[m.d] <- "D"
toc.export.df$Diff[-m.d] <- "A"

ggplot(filter(toc.export.df, Diff == "D")) + geom_point(aes(x=Year, y = TOC_ton, col = Model, shape= Model)) +
  geom_path(aes(x=Year, y = TOC_ton, col = Model, shape= Model, group = Model), size = 0.3) +
  labs(x="Year", y= "TOC (Tg)")+
  scale_color_manual(values = c("firebrick4","steelblue4","darkorange"))+
  facet_grid(rows=vars(Nation))+
  geom_abline(slope = 0, intercept = 0, col = "firebrick4", size = 0.3)+
  theme_bw(base_size = 5)
ggsave(filename = "WR/TOC_export.png", dpi = "retina", width = 8, height = 6, units = "cm")

```
